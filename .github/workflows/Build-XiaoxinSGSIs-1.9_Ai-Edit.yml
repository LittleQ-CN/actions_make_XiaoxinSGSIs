name: Build_XiaoxinSGSIs_Ai-Edit [1.9]
on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    steps:

      - name: "Checkout Code (æ£€å‡ºä»£ç )"
        uses: actions/checkout@v4
        
      - name: "Check Config Status (æ£€æŸ¥é…ç½®æ–‡ä»¶)"
        run: |
          # Check sgsi.json config file (æ£€æŸ¥sgsi.jsoné…ç½®æ–‡ä»¶)
          if [[ ! -f "sgsi.json" ]]; then
            echo "::error::âŒ Missing sgsi.json config file (ç¼ºå°‘sgsi.jsoné…ç½®æ–‡ä»¶)"
            exit 1
          fi
          
          # Check sgsi.sh file (æ£€æŸ¥sgsi.shæ–‡ä»¶)
          if [[ -f "SGSI-build-tool/10/sgsi.sh" ]]; then
            echo "âœ… Detected configured sgsi.sh file (æ£€æµ‹åˆ°å·²é…ç½®sgsi.shæ–‡ä»¶)"
          else
            echo "â„¹ï¸ No custom sgsi.sh detected, using default config (æœªæ£€æµ‹åˆ°è‡ªå®šä¹‰sgsi.shæ–‡ä»¶ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®)"
          fi
       
      - name: "Clean Up Environment (æ¸…ç†ç¯å¢ƒ)"
        run: |
          echo "ğŸ—‘ï¸ Starting full cleanup (å¯åŠ¨å…¨é¢æ¸…ç†)..."
          sudo apt-get autoremove -y --purge
          sudo apt-get clean
          sudo rm -rf /usr/share.docker /etc/mysql /etc/php /etc/apt/sources.list.d || true
          echo "âœ… Cleanup complete! Disk space (æ¸…ç†å®Œæˆï¼ç£ç›˜ç©ºé—´):"
          df -h
       
      - name: "Parse Config Variables (è§£æé…ç½®å˜é‡)"
        id: config
        run: |
          # Use more robust JSON parsing (ä½¿ç”¨æ›´å¥å£®çš„JSONè§£ææ–¹å¼)
          rom_url=$(jq -r '.rom_url // empty' sgsi.json)
          if [[ -z "$rom_url" ]]; then
            echo "::error::âŒ Missing rom_url field in sgsi.json (sgsi.jsonä¸­ç¼ºå°‘rom_urlå­—æ®µ)"
            exit 1
          fi
          
          {
            echo "rom_url=$rom_url"
            echo "rom_name=$(jq -r '.rom_name // "unknown_rom"' sgsi.json)"
            echo "pack_sgsi=$(jq -r '.pack_sgsi // "SGSI.zip"' sgsi.json)"
            echo "make_miui=$(jq -r '.make_miui // "false"' sgsi.json)"
            echo "make_flyme=$(jq -r '.make_flyme // "false"' sgsi.json)"
            echo "make_coloros=$(jq -r '.make_coloros // "false"' sgsi.json)"
            echo "make_h2os=$(jq -r '.make_h2os // "false"' sgsi.json)"
            echo "make_smartisanos=$(jq -r '.make_smartisanos // "false"' sgsi.json)"
            echo "make_zui=$(jq -r '.make_zui // "false"' sgsi.json)"
            echo "make_super=$(jq -r '.make_super // "false"' sgsi.json)"
          } >> $GITHUB_OUTPUT
           
      - name: "Install Essential Tools (å®‰è£…åŸºç¡€å·¥å…·)"
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 curl jq brotli android-sdk-libsparse-utils zip unzip
          echo "âœ… åŸºç¡€å·¥å…·å®‰è£…å®Œæˆ"
          
      - name: "Download Build Tools (ä¸‹è½½æ„å»ºå·¥å…·)"
        run: |
          tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar"
          filename="SGSI-build-tool.tar"
          
          echo "ğŸ”§ Starting build tools download (å¼€å§‹ä¸‹è½½æ„å»ºå·¥å…·)..."
          max_retries=5
          retry_delay=10
          
          for i in $(seq 1 $max_retries); do
            if curl -fL -o "$filename" "$tool_url"; then
              echo "âœ… Download successful (ä¸‹è½½æˆåŠŸ)"
              break
            else
              echo "âŒ Download failed (å°è¯• $i/$max_retries) (ä¸‹è½½å¤±è´¥)"
              if [ $i -eq $max_retries ]; then
                echo "::error::âŒ Build tools download failed (æ„å»ºå·¥å…·ä¸‹è½½å¤±è´¥)"
                exit 1
              fi
              echo "ğŸ”„ Retrying in ${retry_delay}seconds (${retry_delay}ç§’åé‡è¯•)..."
              sleep $retry_delay
            fi
          done
          
      - name: "Initialize Build Environment (åˆå§‹åŒ–æ„å»ºç¯å¢ƒ)"
        run: |
          echo "ğŸ“‚ Extracting build tools (è§£å‹æ„å»ºå·¥å…·)..."
          if ! sudo tar -xf SGSI-build-tool.tar; then
            echo "::error::âŒ Failed to extract build tools (è§£å‹æ„å»ºå·¥å…·å¤±è´¥)"
            exit 1
          fi
          
          # Set execute permissions (è®¾ç½®æ‰§è¡Œæƒé™)
          sudo find SGSI-build-tool -name "*.sh" -exec chmod +x {} \;
          
          echo "âœ… Environment initialization complete (ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ)"
          
      - name: "Fix Toolchain Issues (ä¿®å¤å·¥å…·é“¾é—®é¢˜) - æ–¹æ¡ˆä¸€"
        run: |
          cd SGSI-build-tool/10
          echo "ğŸ› ï¸ Fixing binary compatibility (ä¿®å¤äºŒè¿›åˆ¶å…¼å®¹æ€§)..."
          
          # åˆ›å»ºå¿…è¦ç›®å½•
          sudo mkdir -p bin
          
          # åªé“¾æ¥ç¡®å®å­˜åœ¨çš„å·¥å…·
          for tool in brotli simg2img img2simg; do
            if command -v $tool >/dev/null 2>&1; then
              sudo ln -sf "$(command -v $tool)" bin/$tool
              echo "âœ… Linked $tool from $(command -v $tool)"
            else
              echo "::warning::âš ï¸ Tool not found: $tool (æœªæ‰¾åˆ°å·¥å…·: $tool)"
            fi
          done
          
          # ç‰¹æ®Šå¤„ç†mke2fs
          if [ -f "/usr/sbin/mke2fs" ]; then
            sudo ln -sf "/usr/sbin/mke2fs" bin/mke2fs
            echo "âœ… Linked mke2fs from /usr/sbin/mke2fs"
          elif command -v mke2fs >/dev/null 2>&1; then
            sudo ln -sf "$(command -v mke2fs)" bin/mke2fs
            echo "âœ… Linked mke2fs from $(command -v mke2fs)"
          else
            echo "::warning::âš ï¸ mke2fs not found (æœªæ‰¾åˆ°mke2fs)"
          fi
          
          # e2fsdroidå¯èƒ½ä¸å­˜åœ¨ï¼Œè·³è¿‡å®ƒ
          if command -v e2fsdroid >/dev/null 2>&1; then
            sudo ln -sf "$(command -v e2fsdroid)" bin/e2fsdroid
            echo "âœ… Linked e2fsdroid from $(command -v e2fsdroid)"
          else
            echo "â„¹ï¸ e2fsdroid not found, skipping (æœªæ‰¾åˆ°e2fsdroidï¼Œè·³è¿‡)"
          fi
          
          echo "âœ… Essential binary tools linked (å¿…éœ€äºŒè¿›åˆ¶å·¥å…·é“¾æ¥å®Œæˆ)"
          cd ../..
          
      - name: "Fix Toolchain Issues - å¤‡ç”¨æ–¹æ¡ˆ"
        if: failure()
        run: |
          cd SGSI-build-tool/10
          echo "ğŸ› ï¸ Using alternative toolchain fix method (ä½¿ç”¨å¤‡ç”¨å·¥å…·é“¾ä¿®å¤æ–¹æ³•)..."
          
          # åˆ›å»ºå¿…è¦ç›®å½•
          sudo mkdir -p bin
          
          # è°ƒè¯•ï¼šæ˜¾ç¤ºå½“å‰ç›®å½•å’Œæƒé™
          echo "=== Debug Info (è°ƒè¯•ä¿¡æ¯) ==="
          pwd
          ls -la
          echo "============================"
          
          # é€ä¸ªå·¥å…·å¤„ç†ï¼Œæ·»åŠ è¯¦ç»†è°ƒè¯•
          tools=("brotli" "simg2img" "img2simg" "mke2fs")
          
          for tool in "${tools[@]}"; do
            echo "Processing tool: $tool"
            
            # å°è¯•å¤šç§æ–¹å¼æŸ¥æ‰¾å·¥å…·
            tool_path=""
            if command -v $tool >/dev/null 2>&1; then
              tool_path=$(command -v $tool)
              echo "  Found via command -v: $tool_path"
            elif [ -f "/usr/bin/$tool" ]; then
              tool_path="/usr/bin/$tool"
              echo "  Found in /usr/bin: $tool_path"
            elif [ -f "/usr/sbin/$tool" ]; then
              tool_path="/usr/sbin/$tool"
              echo "  Found in /usr/sbin: $tool_path"
            elif [ -f "/bin/$tool" ]; then
              tool_path="/bin/$tool"
              echo "  Found in /bin: $tool_path"
            else
              echo "  âŒ Tool not found: $tool"
              continue
            fi
            
            # åˆ›å»ºç¬¦å·é“¾æ¥
            if [ -n "$tool_path" ]; then
              if sudo ln -sf "$tool_path" "bin/$tool"; then
                echo "  âœ… Successfully linked $tool"
                # éªŒè¯é“¾æ¥
                if [ -L "bin/$tool" ]; then
                  echo "  ğŸ”— Link verified: $(readlink "bin/$tool")"
                else
                  echo "  âš ï¸ Link creation may have failed"
                fi
              else
                echo "  âŒ Failed to create link for $tool"
              fi
            fi
            echo "---"
          done
          
          echo "=== Final bin directory contents ==="
          ls -la bin/ || echo "bin directory does not exist"
          echo "==================================="
          
          echo "âœ… Toolchain fixing completed (å·¥å…·é“¾ä¿®å¤å®Œæˆ)"
          cd ../..
          
      - name: "Fix Directory Permissions (ä¿®å¤ç›®å½•æƒé™)"
        run: |
          echo "Fixing SGSI-build-tool directory permissions (ä¿®å¤SGSI-build-toolç›®å½•æƒé™)..."
          sudo chown -R $(id -u):$(id -g) SGSI-build-tool
          sudo chmod -R 755 SGSI-build-tool
          echo "âœ… Directory permissions fixed (ç›®å½•æƒé™å·²ä¿®å¤)"
          
      - name: "Download ROM File (ä¸‹è½½ROMæ–‡ä»¶)"
        run: |
          rom_path="SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
          rom_url="${{ steps.config.outputs.rom_url }}"
          filename="${{ steps.config.outputs.rom_name }}"
          
          # Create target directory (åˆ›å»ºç›®æ ‡ç›®å½•)
          sudo mkdir -p "$(dirname "$rom_path")"
          
          echo "ğŸš€ Starting ROM download: $filename"
          echo "ğŸ“¥ URL: $rom_url"
          
          max_retries=5
          retry_delay=30
          download_success=false
          
          for i in $(seq 1 $max_retries); do
            echo "Attempt $i/$max_retries (å°è¯• $i/$max_retries)..."
            
            # Prefer aria2 if available (ä¼˜å…ˆä½¿ç”¨aria2)
            if command -v aria2c &> /dev/null; then
              echo "âš¡ Using aria2 download (multi-threaded) (ä½¿ç”¨aria2ä¸‹è½½ - å¤šçº¿ç¨‹)"
              if sudo aria2c -x 8 -s 8 -k 1M --check-certificate=false "$rom_url" -d "$(dirname "$rom_path")" -o "$(basename "$rom_path")"; then
                echo "âœ… aria2 download successful (aria2ä¸‹è½½æˆåŠŸ)"
                download_success=true
                break
              else
                echo "âŒ aria2 download failed (aria2ä¸‹è½½å¤±è´¥)"
                # æ¸…ç†å¯èƒ½çš„æŸåæ–‡ä»¶
                sudo rm -f "$rom_path" 2>/dev/null || true
              fi
            fi
            
            # Fallback to curl (å¤‡ç”¨curl)
            if [ "$download_success" = false ] && command -v curl &> /dev/null; then
              echo "âš¡ Using curl download (ä½¿ç”¨curlä¸‹è½½)"
              if sudo curl -fL -C - --retry 3 --retry-delay 10 -o "$rom_path" "$rom_url"; then
                echo "âœ… curl download successful (curlä¸‹è½½æˆåŠŸ)"
                download_success=true
                break
              else
                echo "âŒ curl download failed (curlä¸‹è½½å¤±è´¥)"
                sudo rm -f "$rom_path" 2>/dev/null || true
              fi
            fi
            
            if [ $i -eq $max_retries ]; then
              echo "::error::âŒ ROM download failed after $max_retries attempts (ROMä¸‹è½½å¤±è´¥ï¼Œå·²å°è¯• $max_retries æ¬¡)"
              exit 1
            fi
            
            echo "ğŸ”„ Retrying in ${retry_delay}seconds (${retry_delay}ç§’åé‡è¯•)..."
            sleep $retry_delay
          done
          
          # éªŒè¯ä¸‹è½½æ–‡ä»¶
          if [ -f "$rom_path" ]; then
            file_size=$(stat -c%s "$rom_path" 2>/dev/null || echo "0")
            if [ "$file_size" -lt 1024 ]; then
              echo "::error::âŒ Downloaded file is too small ($file_size bytes), likely corrupted (ä¸‹è½½æ–‡ä»¶è¿‡å°ï¼Œå¯èƒ½å·²æŸå)"
              exit 1
            fi
            echo -e "\nğŸ‰ Download completed (ä¸‹è½½å®Œæˆ)"
            echo "ğŸ“¦ File info (æ–‡ä»¶ä¿¡æ¯): $(sudo ls -lh "$rom_path")"
            echo "ğŸ“Š File size: $(numfmt --to=iec $file_size)"
          else
            echo "::error::âŒ Download file not found (ä¸‹è½½æ–‡ä»¶æœªæ‰¾åˆ°)"
            exit 1
          fi

      - name: "Configure ROM Specific Settings (é…ç½®ROMç‰¹å®šè®¾ç½®)"
        run: |
          echo "Starting ROM-specific configuration (å¼€å§‹é…ç½®ROMç‰¹å®šè®¾ç½®)..."
          
          # Determine ROM type (ç¡®å®šROMç±»å‹)
          rom_type="Generic"
          if [ "${{ steps.config.outputs.make_miui }}" = "true" ]; then rom_type="MIUI"; fi
          if [ "${{ steps.config.outputs.make_flyme }}" = "true" ]; then rom_type="Flyme"; fi
          if [ "${{ steps.config.outputs.make_coloros }}" = "true" ]; then rom_type="ColorOS"; fi
          if [ "${{ steps.config.outputs.make_h2os }}" = "true" ]; then rom_type="H2OS"; fi
          if [ "${{ steps.config.outputs.make_smartisanos }}" = "true" ]; then rom_type="SmartisanOS"; fi
          if [ "${{ steps.config.outputs.make_zui }}" = "true" ]; then rom_type="ZUI"; fi
          
          echo "â„¹ï¸ Detected ROM type: $rom_type (æ£€æµ‹åˆ°çš„ROMç±»å‹: $rom_type)"
          
          # Configure Super SGSI (é…ç½®Super SGSI)
          if [ "${{ steps.config.outputs.make_super }}" = "true" ]; then
            echo "Configuring Super SGSI (é…ç½®Super SGSI)..."
            if [[ -f "SGSI-build-tool/10/make.sh" ]]; then
              sudo sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' SGSI-build-tool/10/make.sh
              echo "Super SGSI configuration completed (Super SGSIé…ç½®å®Œæˆ)"
            else
              echo "::warning::âš ï¸ make.sh script not found, skipping Super SGSI configuration (æœªæ‰¾åˆ°make.shè„šæœ¬ï¼Œè·³è¿‡Super SGSIé…ç½®)"
            fi
          fi
          
          # Clean up old fixbug script (æ¸…ç†æ—§çš„fixbugè„šæœ¬)
          sudo rm -f SGSI-build-tool/10/fixbug/fixbug.sh
          
          # ColorOS special handling (ColorOSç‰¹æ®Šå¤„ç†)
          if [ "$rom_type" = "ColorOS" ]; then
            echo "Decrypting ColorOS OZIP package (è§£å¯†ColorOS OZIPåŒ…)..."
            if [[ -f "SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py" ]]; then
              sudo python3 SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py "SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
              sudo rm -f "SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
              echo "ColorOS ROM decryption completed (ColorOS ROMè§£å¯†å®Œæˆ)"
            else
              echo "::error::âŒ ozipdecrypt.py script not found (æœªæ‰¾åˆ°ozipdecrypt.pyè„šæœ¬)"
              exit 1
            fi
          fi
          
          # Apply ROM-specific fix scripts (åº”ç”¨ROMç‰¹å®šçš„ä¿®å¤è„šæœ¬)
          if [[ -f "fix/${rom_type}.sh" ]]; then
            echo "Applying $rom_type configuration script (åº”ç”¨$rom_typeé…ç½®è„šæœ¬)..."
            sudo cp "fix/${rom_type}.sh" SGSI-build-tool/10/fixbug/fixbug.sh
            sudo chmod +x SGSI-build-tool/10/fixbug/fixbug.sh
            echo "$rom_type configuration completed ($rom_typeé…ç½®å®Œæˆ)"
          else
            echo "â„¹ï¸ $rom_type configuration script not found, using generic configuration (æ‰¾ä¸åˆ°$rom_typeé…ç½®è„šæœ¬ï¼Œä½¿ç”¨é€šç”¨é…ç½®)"
          fi
            
          echo "ROM-specific configuration completed (ROMç‰¹å®šè®¾ç½®é…ç½®å®Œæˆ)"
          
      - name: "Fix Script Syntax Errors (ä¿®å¤è„šæœ¬è¯­æ³•é”™è¯¯)"
        run: |
          cd SGSI-build-tool/10
          
          echo "Checking and fixing SGSI.sh script errors (æ£€æŸ¥å¹¶ä¿®å¤SGSI.shè„šæœ¬é”™è¯¯)..."
          if [[ -f "SGSI.sh" ]]; then
            # More precise fixes to avoid over-replacement (æ›´ç²¾ç¡®çš„ä¿®å¤ä»¥é¿å…è¿‡åº¦æ›¿æ¢)
            sudo sed -i 's/\[ *\] *== *"\(.*\)" *]/\[ -n "\1" ]/g' SGSI.sh
            sudo sed -i 's/==/=/g' SGSI.sh
            echo "âœ… Script syntax errors fixed (å·²ä¿®å¤è„šæœ¬è¯­æ³•é”™è¯¯)"
          else
            echo "::warning::âš ï¸ SGSI.sh script not found (æœªæ‰¾åˆ°SGSI.shè„šæœ¬)"
          fi
          cd ../..
          
      - name: "Prepare Build Files (å‡†å¤‡æ„å»ºæ–‡ä»¶)"
        run: |
          echo "Preparing build scripts and tools (å‡†å¤‡æ„å»ºè„šæœ¬å’Œå·¥å…·)..."
          
          # Copy custom build scripts (å¤åˆ¶è‡ªå®šä¹‰æ„å»ºè„šæœ¬)
          if [[ -d "make" ]]; then
            echo "Moving build scripts (ç§»åŠ¨æ„å»ºè„šæœ¬)..."
            sudo cp -v make/*.sh SGSI-build-tool/10/
          fi
          
          # Copy binary tools (å¤åˆ¶äºŒè¿›åˆ¶å·¥å…·)
          if [[ -d "bin" ]]; then
            echo "Moving binary tools (ç§»åŠ¨äºŒè¿›åˆ¶å·¥å…·)..."
            sudo mkdir -p SGSI-build-tool/10/bin
            sudo cp -v bin/* SGSI-build-tool/10/bin/
          fi
          
          # Update symbolic links (æ›´æ–°ç¬¦å·é“¾æ¥)
          cd SGSI-build-tool/10
          for tool in brotli simg2img; do
            if command -v $tool >/dev/null 2>&1; then
              sudo ln -sf $(which $tool) bin/$tool
            fi
          done
          cd ../..
          
          echo "âœ… Build files preparation completed (æ„å»ºæ–‡ä»¶å‡†å¤‡å®Œæˆ)"
          
      - name: "Build SGSI Image (æ„å»ºSGSIé•œåƒ)"
        id: build_sgsi
        run: |
          cd SGSI-build-tool/10
          
          echo "ğŸ—ï¸ Starting SGSI build (å¼€å§‹æ„å»ºSGSI)..."
          echo "ğŸ“ Build log will be saved to make.log (æ„å»ºæ—¥å¿—å°†ä¿å­˜åˆ°make.log)"
          
          # è®¾ç½®æ„å»ºè¶…æ—¶å’Œæ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†
          build_start=$(date +%s)
          timeout 90m bash -c '
            set -o pipefail
            if ! sudo bash make.sh 2>&1 | tee make.log; then
              echo "::error::âŒ Build failed with exit code $? (æ„å»ºå¤±è´¥ï¼Œé€€å‡ºä»£ç : $?)"
              
              # åˆ†æå¸¸è§é”™è¯¯
              if grep -q "out of memory" make.log; then
                echo "::error::ğŸ’¥ Build failed due to insufficient memory (å†…å­˜ä¸è¶³å¯¼è‡´æ„å»ºå¤±è´¥)"
              elif grep -q "No space left" make.log; then
                echo "::error::ğŸ’¥ Build failed due to disk space (ç£ç›˜ç©ºé—´ä¸è¶³å¯¼è‡´æ„å»ºå¤±è´¥)"
              elif grep -q "Permission denied" make.log; then
                echo "::error::ğŸ’¥ Build failed due to permission issues (æƒé™é—®é¢˜å¯¼è‡´æ„å»ºå¤±è´¥)"
              fi
              
              echo "=== Last 200 lines of build log (æ„å»ºæ—¥å¿—æœ€å200è¡Œ) ==="
              tail -200 make.log
              echo "========================"
              exit 1
            fi
          ' || exit $?
          
          build_end=$(date +%s)
          build_duration=$((build_end - build_start))
          echo "â±ï¸ Build completed in $(($build_duration / 60)) minutes and $(($build_duration % 60)) seconds (æ„å»ºç”¨æ—¶: $(($build_duration / 60))åˆ†$(($build_duration % 60))ç§’)"
          
          echo "ğŸ‰ SGSI image build completed (SGSIé•œåƒæ„å»ºå®Œæˆ)"
          
          # ä¿®å¤æ„å»ºäº§å‡ºæ–‡ä»¶æƒé™
          echo "ğŸ”’ Fixing permissions for build output files (ä¿®å¤æ„å»ºäº§å‡ºæ–‡ä»¶æƒé™)..."
          sudo chown -R $(id -u):$(id -g) out/
          sudo chmod -R 755 out/
          
          # éªŒè¯æ„å»ºäº§å‡º
          if [[ ! -d "./out/system" ]]; then
            echo "::error::âŒ Build output directory 'out/system' not found (æ„å»ºäº§å‡ºç›®å½• 'out/system' æœªæ‰¾åˆ°)"
            exit 1
          fi
          
          # Extract detailed device information from build.prop (ä»build.propæå–è¯¦ç»†è®¾å¤‡ä¿¡æ¯)
          if [[ -f "./out/system/system/build.prop" ]]; then
            # ç¡®ä¿æ–‡ä»¶å¯è¯»
            sudo chmod 644 ./out/system/system/build.prop
            
            # Device model (è®¾å¤‡å‹å·)
            model=$(grep 'ro.product.model' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            echo "ğŸ“± Extracted device model: $model (æå–çš„è®¾å¤‡å‹å·: $model)"
            
            # Device codename (æœºå‹ä»£å·)
            device_codename=$(grep -E 'ro.product.(device|name|board|hardware)' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            echo "ğŸ”¤ Extracted device codename: $device_codename (æå–çš„æœºå‹ä»£å·: $device_codename)"
            
            # Security patch date (å®‰å…¨è¡¥ä¸æ—¥æœŸ)
            security_patch=$(grep 'ro.build.version.security_patch' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            echo "ğŸ”’ Security patch date: $security_patch (å®‰å…¨è¡¥ä¸æ—¥æœŸ: $security_patch)"
            
            # Android version (Androidç‰ˆæœ¬å·)
            android_version=$(grep 'ro.build.version.release' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            echo "ğŸ“± Android version: $android_version (Androidç‰ˆæœ¬å·: $android_version)"
            
            # Build date (æ„å»ºæ—¥æœŸ)
            build_date=$(grep 'ro.build.date' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            echo "ğŸ“… Build date: $build_date (æ„å»ºæ—¥æœŸ: $build_date)"
            
            # ROM-specific version info (ROMç‰¹å®šç‰ˆæœ¬ä¿¡æ¯)
            rom_version=$(grep -E 'ro.(build|system|product).(version|display).(incremental|id|name)' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            echo "ğŸ”„ ROM version: $rom_version (ROMç‰ˆæœ¬: $rom_version)"
            
            # Build ID (æ„å»ºID)
            build_id=$(grep 'ro.build.id' ./out/system/system/build.prop | head -1 | cut -d'=' -f 2 | tr -d '[:space:]' || echo "Unknown")
            echo "ğŸ†” Build ID: $build_id (æ„å»ºID: $build_id)"
            
            # Output all extracted information (è¾“å‡ºæ‰€æœ‰æå–çš„ä¿¡æ¯)
            echo "model=$model" >> $GITHUB_OUTPUT
            echo "device_codename=$device_codename" >> $GITHUB_OUTPUT
            echo "security_patch=$security_patch" >> $GITHUB_OUTPUT
            echo "android_version=$android_version" >> $GITHUB_OUTPUT
            echo "build_date=$build_date" >> $GITHUB_OUTPUT
            echo "rom_version=$rom_version" >> $GITHUB_OUTPUT
            echo "build_id=$build_id" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ build.prop file not found (æœªæ‰¾åˆ°build.propæ–‡ä»¶)"
            echo "model=Unknown" >> $GITHUB_OUTPUT
            echo "device_codename=Unknown" >> $GITHUB_OUTPUT
            echo "security_patch=Unknown" >> $GITHUB_OUTPUT
            echo "android_version=Unknown" >> $GITHUB_OUTPUT
            echo "build_date=Unknown" >> $GITHUB_OUTPUT
            echo "rom_version=Unknown" >> $GITHUB_OUTPUT
            echo "build_id=Unknown" >> $GITHUB_OUTPUT
          fi
           
      - name: "Package Patches (æ‰“åŒ…è¡¥ä¸æ–‡ä»¶)"
        run: |
          echo "=== å¼€å§‹æ‰“åŒ…è¡¥ä¸æ–‡ä»¶ ==="
          
          # ç¡®ä¿è¡¥ä¸ç›®å½•å­˜åœ¨
          if [[ ! -d "Patch" ]]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ°Patchç›®å½•ï¼Œè·³è¿‡è¡¥ä¸æ‰“åŒ…"
            exit 0
          fi

          # åˆ›å»ºç›®æ ‡ç›®å½•
          sudo mkdir -p SGSI-build-tool/10/SGSI/
          
          # æ£€æŸ¥æ¯ä¸ªè¡¥ä¸ç›®å½•å¹¶æ‰“åŒ…
          patch_count=0
          for i in {1..3}; do
            patch_dir="Patch/Patch${i}"
            output_file="Patch${i}.zip"
            
            if [[ -d "$patch_dir" ]] && [[ -n "$(ls -A "$patch_dir" 2>/dev/null)" ]]; then
              echo "ğŸ“¦ æ‰“åŒ…è¡¥ä¸: $patch_dir â†’ $output_file"
              if ! zip -r -q "$output_file" "$patch_dir"/*; then
                echo "::warning::âš ï¸ è¡¥ä¸æ‰“åŒ…å¤±è´¥: $patch_dir"
                # æ¸…ç†å¯èƒ½çš„ä¸å®Œæ•´æ–‡ä»¶
                rm -f "$output_file" 2>/dev/null || true
              else
                echo "âœ… è¡¥ä¸æ‰“åŒ…æˆåŠŸ: $output_file ($(stat -c%s "$output_file" | numfmt --to=iec) bytes)"
                sudo mv "$output_file" SGSI-build-tool/10/SGSI/
                ((patch_count++))
              fi
            else
              echo "â„¹ï¸ è¡¥ä¸ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º: $patch_dir"
            fi
          done
          
          echo "âœ… è¡¥ä¸æ–‡ä»¶æ‰“åŒ…å®Œæˆï¼ŒæˆåŠŸæ‰“åŒ… $patch_count ä¸ªè¡¥ä¸"
          if [[ $patch_count -gt 0 ]]; then
            echo "ç§»åŠ¨åçš„è¡¥ä¸æ–‡ä»¶:"
            sudo ls -lh SGSI-build-tool/10/SGSI/Patch*.zip
          fi

      - name: "Package Output Files (æ‰“åŒ…è¾“å‡ºæ–‡ä»¶)"
        run: |
          cd SGSI-build-tool/10
          
          echo "=== Packaging step (æ‰“åŒ…æ­¥éª¤) ==="
          
          # éªŒè¯SGSIç›®å½•å­˜åœ¨ä¸”æœ‰å†…å®¹
          if [[ ! -d "SGSI" ]]; then
            echo "::error::âŒ SGSI directory does not exist! (SGSIç›®å½•ä¸å­˜åœ¨ï¼)"
            echo "Current directory contents (å½“å‰ç›®å½•å†…å®¹):"
            ls -la
            exit 1
          fi
          
          if [[ -z "$(ls -A SGSI/ 2>/dev/null)" ]]; then
            echo "::error::âŒ SGSI directory is empty! (SGSIç›®å½•ä¸ºç©ºï¼)"
            exit 1
          fi
          
          # åˆ›å»ºè¾“å‡ºæ–‡ä»¶å
          output_file="${{ steps.config.outputs.pack_sgsi }}"
          
          # ä¿®å¤æ–‡ä»¶æ‰€æœ‰æƒ
          echo "Fixing file ownership (ä¿®å¤æ–‡ä»¶æ‰€æœ‰æƒ)..."
          sudo chown -R $(id -u):$(id -g) SGSI/
          sudo chmod -R 755 SGSI/
          
          # æ‰“åŒ…æ–‡ä»¶ï¼Œæ·»åŠ è¿›åº¦æ˜¾ç¤º
          echo "Packaging SGSI to: $output_file"
          if ! zip -r -q "$output_file" SGSI/*; then
            echo "::error::âŒ Packaging failed! (æ‰“åŒ…å¤±è´¥ï¼)"
            exit 1
          fi
          
          # éªŒè¯æ‰“åŒ…æ–‡ä»¶
          if [[ ! -f "$output_file" ]]; then
            echo "::error::âŒ Output file was not created (è¾“å‡ºæ–‡ä»¶æœªåˆ›å»º)"
            exit 1
          fi
          
          file_size=$(stat -c%s "$output_file")
          if [[ $file_size -eq 0 ]]; then
            echo "::error::âŒ Output file is empty (è¾“å‡ºæ–‡ä»¶ä¸ºç©º)"
            exit 1
          fi
          
          echo "âœ… Package created: $output_file ($(numfmt --to=iec-i $file_size))"
          
          # å‡†å¤‡ä¸Šä¼ ç›®å½•
          mkdir -p "${GITHUB_WORKSPACE}/upload"
          max_size=2000000000  # 2GB
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°å¹¶åœ¨éœ€è¦æ—¶åˆ†å·
          if [[ $file_size -gt $max_size ]]; then
            echo "âš ï¸ File too large, splitting into parts (æ–‡ä»¶è¿‡å¤§ï¼Œè¿›è¡Œåˆ†å·æ‰“åŒ…)..."
            split -b 1500m -d -a 1 "$output_file" "${output_file}_part"
            # ç§»åŠ¨åˆ†å·æ–‡ä»¶åˆ°ä¸Šä¼ ç›®å½•
            mv "${output_file}_part"* "${GITHUB_WORKSPACE}/upload/"
            # åˆ é™¤åŸå§‹å¤§æ–‡ä»¶
            rm "$output_file"
            echo "Split file list (åˆ†å·æ–‡ä»¶åˆ—è¡¨):"
            ls -lh "${GITHUB_WORKSPACE}/upload"
          else
            echo "Moving file to upload directory (ç§»åŠ¨æ–‡ä»¶åˆ°ä¸Šä¼ ç›®å½•)"
            mv "$output_file" "${GITHUB_WORKSPACE}/upload/"
          fi
          
          # ç¡®ä¿ä¸Šä¼ ç›®å½•æœ‰å†…å®¹
          echo "=== Upload directory contents (ä¸Šä¼ ç›®å½•å†…å®¹) ==="
          ls -lh "${GITHUB_WORKSPACE}/upload" || { echo "âŒ Upload directory is empty!"; exit 1; }
          echo "===================="
          
          # ä¿å­˜ä¸Šä¼ ç›®å½•è·¯å¾„
          echo "UPLOAD_DIR=${GITHUB_WORKSPACE}/upload" >> $GITHUB_ENV
             
      - name: "Upload to GitHub Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: sgsi-build-artifacts
          path: ${{ env.UPLOAD_DIR }}/*
          retention-days: 30
        continue-on-error: true
             
      - name: "Generate Release Tag and Time Info (ç”Ÿæˆå‘å¸ƒæ ‡ç­¾å’Œæ—¶é—´ä¿¡æ¯)"
        id: release_tag
        run: |
          # ç”Ÿæˆç²¾ç®€æ ‡ç­¾ï¼šæ—¥æœŸ_æ—¶é—´-ç³»ç»Ÿ[MIUI]-å·¥å…·ç®±ç‰ˆæœ¬
          current_date=$(TZ='Asia/Shanghai' date +"%Y%m%d")
          timestamp=$(TZ='Asia/Shanghai' date +"%H%M")
          
          # ç¡®å®šROMç±»å‹
          rom_type="Generic"
          if [ "${{ steps.config.outputs.make_miui }}" = "true" ]; then rom_type="MIUI"; fi
          if [ "${{ steps.config.outputs.make_flyme }}" = "true" ]; then rom_type="Flyme"; fi
          if [ "${{ steps.config.outputs.make_coloros }}" = "true" ]; then rom_type="ColorOS"; fi
          if [ "${{ steps.config.outputs.make_h2os }}" = "true" ]; then rom_type="H2OS"; fi
          if [ "${{ steps.config.outputs.make_smartisanos }}" = "true" ]; then rom_type="SmartisanOS"; fi
          if [ "${{ steps.config.outputs.make_zui }}" = "true" ]; then rom_type="ZUI"; fi
          
          # ç”Ÿæˆç²¾ç®€æ ‡ç­¾
          release_tag="${current_date}_${timestamp}-${rom_type}-1.9"
          echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
          
          # è·å–å½“å‰æ„å»ºæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
          build_time=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %p %I:%M")
          build_time=$(echo "$build_time" | sed -e 's/AM/ä¸Šåˆ/' -e 's/PM/ä¸‹åˆ/')
          build_time="${build_time} [åŒ—äº¬æ—¶é—´]"
          echo "build_time=$build_time" >> $GITHUB_OUTPUT
          
          # å¤„ç†åŸæ„å»ºæ—¥æœŸ
          original_build_date="${{ steps.build_sgsi.outputs.build_date }}"
          if [[ "$original_build_date" != "Unknown" ]]; then
            parsed_date=$(echo "$original_build_date" | sed -E 's/([a-zA-Z]{3})([a-zA-Z]{3})([0-9]{2})([0-9]{2}:[0-9]{2}:[0-9]{2})([A-Z]{3})([0-9]{4})/\1 \2 \3 \4 \5 \6/' 2>/dev/null)
            formatted_date=$(date -d "$parsed_date" "+%Y-%m-%d %H:%M:%S %Z" 2>/dev/null || echo "$original_build_date")
            echo "formatted_build_date=$formatted_date" >> $GITHUB_OUTPUT
          else
            echo "formatted_build_date=Unknown" >> $GITHUB_OUTPUT
          fi
          
          # ç”ŸæˆåŸåŒ…æœºå‹æ˜¾ç¤º
          model="${{ steps.build_sgsi.outputs.model }}"
          device_codename="${{ steps.build_sgsi.outputs.device_codename }}"
          if [[ "$model" == "Unknown" && "$device_codename" == "Unknown" ]]; then
            source_device="Unknown"
          elif [[ "$model" == "Unknown" ]]; then
            source_device="$device_codename"
          elif [[ "$device_codename" == "Unknown" ]]; then
            source_device="$model"
          else
            source_device="$model [$device_codename]"
          fi
          echo "source_device=$source_device" >> $GITHUB_OUTPUT
          
          echo "rom_type=$rom_type" >> $GITHUB_OUTPUT
          
          # è¾“å‡ºè°ƒè¯•ä¿¡æ¯
          echo "Generated release tag: $release_tag (ç”Ÿæˆçš„å‘å¸ƒæ ‡ç­¾: $release_tag)"
          echo "Build time: $build_time (æ„å»ºæ—¶é—´: $build_time)"
          echo "ROM type: $rom_type (ROM ç±»å‹: $rom_type)"
          
      - name: "Create Release (åˆ›å»ºå‘å¸ƒ)"
        uses: softprops/action-gh-release@v1
        with:
          # å‘å¸ƒåç§°ï¼ˆæŒ‰ç…§æ‚¨çš„è¦æ±‚ä¿®æ”¹ï¼‰
          name: "Auto Build SGSI With XiaoxinTools [${{ steps.release_tag.outputs.release_tag }}]"
          # å‘å¸ƒæ ‡ç­¾ï¼ˆç²¾ç®€æ ¼å¼ä¿æŒä¸å˜ï¼‰
          tag_name: "${{ steps.release_tag.outputs.release_tag }}"
          # ä¸Šä¼ æ‰€æœ‰æ‰“åŒ…åçš„æ–‡ä»¶
          files: "${{ env.UPLOAD_DIR }}/*"
          # å‘å¸ƒæè¿°
          body: |
            ##  ğŸ“± SGSI Build Information (æ„å»ºä¿¡æ¯)
            
            ### åŸºç¡€ä¿¡æ¯ (Basic Info)
            - **æ„å»ºæ—¶é—´ (Built at):** ${{ steps.release_tag.outputs.build_time }}
            - **åŸåŒ…æœºå‹ (Source Device):** ${{ steps.release_tag.outputs.source_device }}
            - **ROM ç±»å‹ (ROM Type):** ${{ steps.release_tag.outputs.rom_type }}
            - **Android ç‰ˆæœ¬ (Android Version):** ${{ steps.build_sgsi.outputs.android_version }}
            - **ROM ç‰ˆæœ¬ (ROM Version):** ${{ steps.build_sgsi.outputs.rom_version }}
            - **æ„å»º ID (Build ID):** ${{ steps.build_sgsi.outputs.build_id }}
            - **å®‰å…¨è¡¥ä¸ (Security Patch):** ${{ steps.build_sgsi.outputs.security_patch }}
            - **åŸæ„å»ºæ—¥æœŸ (Source Build Date):** ${{ steps.release_tag.outputs.formatted_build_date }}
            
            ### ä¸‹è½½é“¾æ¥ (Download Links)
            - **GitHub Artifactsï¼ˆ30å¤©ä¿ç•™ï¼‰:** [ç‚¹å‡»ä¸‹è½½](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)
            
            ### å…¶ä»–ä¿¡æ¯ (Other Info)
            - **æ„å»ºå·¥å…· (Build Tools):** XiaoxinTools_1.9 (Only for Android 10/AB)
            - **æ„å»ºæ—¥å¿— (Build Log):** [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) (ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†æ—¥å¿—)
            
            ---
            
             âš ï¸ **å®éªŒæ€§æ„å»º (Experimental Build):**  
            This is an experimental build and may have stability issues. Please test before using as a daily driver.  
            è¿™æ˜¯å®éªŒæ€§æ„å»ºï¼Œå¯èƒ½å­˜åœ¨ç¨³å®šæ€§é—®é¢˜ï¼Œè¯·æµ‹è¯•åå†ä½œä¸ºä¸»åŠ›ç³»ç»Ÿä½¿ç”¨ã€‚
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: "Completion Notification (å®Œæˆé€šçŸ¥)"
        if: success()
        run: |
          echo "ğŸ‰ Build completed! (æ„å»ºå®Œæˆ!)"
          echo "Release tag: ${{ steps.release_tag.outputs.release_tag }} (å‘å¸ƒæ ‡ç­¾)"
          echo "Artifact location: ${{ env.UPLOAD_DIR }} (äº§ç‰©ä½ç½®)"
