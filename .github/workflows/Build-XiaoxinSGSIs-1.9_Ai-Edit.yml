name: Build_XiaoxinSGSIs_Ai-Edit [1.9]
on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘ï¼ˆé¿å…è¯¯è§¦å‘ï¼‰
jobs:
  build:
    runs-on: ubuntu-22.04  # ç¨³å®šçš„Ubuntuç‰ˆæœ¬
    timeout-minutes: 120    # å»¶é•¿è¶…æ—¶æ—¶é—´ï¼ˆé¿å…æ„å»ºä¸­æ–­ï¼‰
    steps:

      # 1. æ£€å‡ºä»£ç ï¼ˆå¿…é€‰ï¼‰
      - name: "Checkout Code (æ£€å‡ºä»£ç )"
        uses: actions/checkout@v4

      # 2. æ£€æŸ¥é…ç½®æ–‡ä»¶ï¼ˆé¿å…é—æ¼å…³é”®é…ç½®ï¼‰
      - name: "Check Config Status (æ£€æŸ¥é…ç½®æ–‡ä»¶)"
        run: |
          # æ£€æŸ¥sgsi.jsonæ˜¯å¦å­˜åœ¨ï¼ˆæ ¸å¿ƒé…ç½®æ–‡ä»¶ï¼‰
          if [[ ! -f "sgsi.json" ]]; then
            echo "::error::âŒ ç¼ºå°‘sgsi.jsoné…ç½®æ–‡ä»¶ï¼è¯·æ·»åŠ åé‡è¯•ã€‚"
            exit 1
          fi
          # æ£€æŸ¥sgsi.shæ˜¯å¦å­˜åœ¨ï¼ˆè‡ªå®šä¹‰æ„å»ºè„šæœ¬ï¼‰
          if [[ -f "SGSI-build-tool/10/sgsi.sh" ]]; then
            echo "âœ… æ£€æµ‹åˆ°è‡ªå®šä¹‰sgsi.shè„šæœ¬ï¼Œå°†ä½¿ç”¨è¯¥è„šæœ¬æ„å»ºã€‚"
          else
            echo "â„¹ï¸ æœªæ£€æµ‹åˆ°è‡ªå®šä¹‰sgsi.shè„šæœ¬ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®ã€‚"
          fi

      # 3. æ¸…ç†ç¯å¢ƒï¼ˆé‡Šæ”¾ç£ç›˜ç©ºé—´ï¼‰
      - name: "Clean Up Environment (æ¸…ç†ç¯å¢ƒ)"
        run: |
          echo "ğŸ—‘ï¸ å¼€å§‹å…¨é¢æ¸…ç†ç¯å¢ƒ..."
          sudo apt-get autoremove -y --purge  # å¸è½½æ— ç”¨è½¯ä»¶
          sudo apt-get clean                 # æ¸…ç†APTç¼“å­˜
          sudo rm -rf /usr/share.docker /etc/mysql /etc/php /etc/apt/sources.list.d || true  # åˆ é™¤å†—ä½™ç›®å½•
          echo "âœ… æ¸…ç†å®Œæˆï¼å½“å‰ç£ç›˜ç©ºé—´ï¼š"
          df -h  # æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ

      # 4. è§£æé…ç½®å˜é‡ï¼ˆä»sgsi.jsonæå–å…³é”®å‚æ•°ï¼‰
      - name: "Parse Config Variables (è§£æé…ç½®å˜é‡)"
        id: config
        run: |
          # æå–rom_urlï¼ˆå¿…é€‰ï¼ŒROMä¸‹è½½é“¾æ¥ï¼‰
          rom_url=$(jq -r '.rom_url // empty' sgsi.json)
          if [[ -z "$rom_url" ]]; then
            echo "::error::âŒ sgsi.jsonä¸­ç¼ºå°‘rom_urlå­—æ®µï¼è¯·æ·»åŠ ROMä¸‹è½½é“¾æ¥ã€‚"
            exit 1
          fi
          # æå–å…¶ä»–å˜é‡ï¼ˆå¸¦é»˜è®¤å€¼ï¼Œé¿å…ç©ºå€¼ï¼‰
          {
            echo "rom_url=$rom_url"
            # æ›¿æ¢rom_nameä¸­çš„ç©ºæ ¼ï¼ˆé¿å…æ–‡ä»¶åé—®é¢˜ï¼‰
            echo "rom_name=$(jq -r '.rom_name // "unknown_rom" | gsub("\\s+"; "_")' sgsi.json)"
            # æ›¿æ¢pack_sgsiä¸­çš„ç©ºæ ¼ï¼ˆé¿å…æ‰“åŒ…åçš„æ–‡ä»¶åé—®é¢˜ï¼‰
            echo "pack_sgsi=$(jq -r '.pack_sgsi // "SGSI.zip" | gsub("\\s+"; "_")' sgsi.json)"
            echo "make_miui=$(jq -r '.make_miui // "false"' sgsi.json)"
            echo "make_flyme=$(jq -r '.make_flyme // "false"' sgsi.json)"
            echo "make_coloros=$(jq -r '.make_coloros // "false"' sgsi.json)"
            echo "make_h2os=$(jq -r '.make_h2os // "false"' sgsi.json)"
            # ä¿®æ­£ï¼šå°†j -ræ”¹ä¸ºjq -rï¼ˆæ­£ç¡®è§£æJSONï¼‰
            echo "make_smartisanos=$(jq -r '.make_smartisanos // "false"' sgsi.json)"
            echo "make_zui=$(jq -r '.make_zui // "false"' sgsi.json)"
            echo "make_super=$(jq -r '.make_super // "false"' sgsi.json)"
          } >> $GITHUB_OUTPUT

      # 5. å®‰è£…åŸºç¡€å·¥å…·ï¼ˆè§£å†³ä¾èµ–ç¼ºå¤±ï¼‰
      - name: "Install Essential Tools (å®‰è£…åŸºç¡€å·¥å…·)"
        run: |
          sudo apt-get update  # æ›´æ–°APTæº
          # æ·»åŠ zipï¼ˆç”¨äºè¡¥ä¸æ‰“åŒ…ï¼‰å’Œunzipï¼ˆå¯é€‰ï¼Œç”¨äºè§£å‹ï¼‰
          sudo apt-get install -y aria2 curl jq brotli android-sdk-libsparse-utils zip
          echo "âœ… åŸºç¡€å·¥å…·å®‰è£…å®Œæˆï¼"

      # 6. ä¸‹è½½æ„å»ºå·¥å…·ï¼ˆé‡è¯•æœºåˆ¶é¿å…ä¸‹è½½å¤±è´¥ï¼‰
      - name: "Download Build Tools (ä¸‹è½½æ„å»ºå·¥å…·)"
        run: |
          tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar"
          filename="SGSI-build-tool.tar"
          echo "ğŸ”§ å¼€å§‹ä¸‹è½½æ„å»ºå·¥å…·ï¼ˆé‡è¯•5æ¬¡ï¼‰..."
          max_retries=5
          retry_delay=10
          for i in $(seq 1 $max_retries); do
            if curl -fL -o "$filename" "$tool_url"; then
              echo "âœ… æ„å»ºå·¥å…·ä¸‹è½½æˆåŠŸï¼"
              break
            else
              echo "âŒ æ„å»ºå·¥å…·ä¸‹è½½å¤±è´¥ï¼ˆå°è¯•$i/$max_retriesï¼‰..."
              if [ $i -eq $max_retries ]; then
                echo "::error::âŒ æ„å»ºå·¥å…·ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é“¾æ¥æ˜¯å¦æœ‰æ•ˆï¼"
                exit 1
              fi
              echo "ğŸ”„ $retry_delayç§’åé‡è¯•..."
              sleep $retry_delay
            fi
          done

      # 7. åˆå§‹åŒ–æ„å»ºç¯å¢ƒï¼ˆè§£å‹å·¥å…·å¹¶è®¾ç½®æƒé™ï¼‰
      - name: "Initialize Build Environment (åˆå§‹åŒ–æ„å»ºç¯å¢ƒ)"
        run: |
          echo "ğŸ“‚ è§£å‹æ„å»ºå·¥å…·..."
          if ! sudo tar -xf SGSI-build-tool.tar; then
            echo "::error::âŒ æ„å»ºå·¥å…·è§£å‹å¤±è´¥ï¼"
            exit 1
          fi
          # ç»™æ‰€æœ‰.shè„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
          sudo find SGSI-build-tool -name "*.sh" -exec chmod +x {} \;
          echo "âœ… æ„å»ºç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼"

      # 8. ä¿®å¤å·¥å…·é“¾é—®é¢˜ï¼ˆè§£å†³äºŒè¿›åˆ¶å…¼å®¹æ€§ï¼‰
      - name: "Fix Toolchain Issues (ä¿®å¤å·¥å…·é“¾é—®é¢˜)"
        run: |
          cd SGSI-build-tool/10
          echo "ğŸ› ï¸ ä¿®å¤å·¥å…·é“¾äºŒè¿›åˆ¶å…¼å®¹æ€§..."
          sudo mkdir -p bin  # åˆ›å»ºbinç›®å½•ï¼ˆå­˜æ”¾ç¬¦å·é“¾æ¥ï¼‰
          # ä¸ºå…³é”®å·¥å…·åˆ›å»ºç¬¦å·é“¾æ¥ï¼ˆé¿å…è·¯å¾„é—®é¢˜ï¼‰
          for tool in brotli simg2img img2simg mke2fs; do
            tool_location=$(which $tool 2>/dev/null)
            if [[ -n "$tool_location" ]]; then
              sudo ln -sf "$tool_location" bin/$tool
              echo "âœ… æˆåŠŸé“¾æ¥$toolåˆ°binç›®å½•ï¼"
            else
              echo "::warning::âš ï¸ æœªæ‰¾åˆ°å·¥å…·$toolï¼Œå¯èƒ½å½±å“æ„å»ºï¼"
            fi
          done
          cd ../..
          echo "âœ… å·¥å…·é“¾ä¿®å¤å®Œæˆï¼"

      # 9. ä¿®å¤ç›®å½•æƒé™ï¼ˆé¿å…æƒé™ä¸è¶³å¯¼è‡´æ„å»ºå¤±è´¥ï¼‰
      - name: "Fix Directory Permissions (ä¿®å¤ç›®å½•æƒé™)"
        run: |
          echo "ğŸ”’ ä¿®å¤SGSI-build-toolç›®å½•æƒé™..."
          sudo chown -R $(id -u):$(id -g) SGSI-build-tool  # å°†ç›®å½•æ‰€æœ‰æƒäº¤ç»™å½“å‰ç”¨æˆ·
          sudo chmod -R 755 SGSI-build-tool                # è®¾ç½®è¯»å†™æ‰§è¡Œæƒé™
          echo "âœ… ç›®å½•æƒé™ä¿®å¤å®Œæˆï¼"

      # 10. ä¸‹è½½ROMæ–‡ä»¶ï¼ˆå¤šçº¿ç¨‹ä¸‹è½½+æ–­ç‚¹ç»­ä¼ ï¼‰
      - name: "Download ROM File (ä¸‹è½½ROMæ–‡ä»¶)"
        run: |
          rom_path="SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
          rom_url="${{ steps.config.outputs.rom_url }}"
          filename="${{ steps.config.outputs.rom_name }}"
          sudo mkdir -p "$(dirname "$rom_path")"  # åˆ›å»ºROMå­˜æ”¾ç›®å½•
          echo "ğŸš€ å¼€å§‹ä¸‹è½½ROMæ–‡ä»¶ï¼š$filenameï¼ˆé‡è¯•5æ¬¡ï¼‰..."
          max_retries=5
          retry_delay=30
          for i in $(seq 1 $max_retries); do
            echo "å°è¯•$i/$max_retries..."
            # ä¼˜å…ˆä½¿ç”¨aria2å¤šçº¿ç¨‹ä¸‹è½½ï¼ˆæ›´å¿«ï¼‰
            if command -v aria2c &> /dev/null; then
              echo "âš¡ ä½¿ç”¨aria2å¤šçº¿ç¨‹ä¸‹è½½..."
              if sudo aria2c -x 8 -s 8 -k 1M "$rom_url" -d "$(dirname "$rom_path")" -o "$(basename "$rom_path")"; then
                echo "âœ… ROMæ–‡ä»¶ä¸‹è½½æˆåŠŸï¼"
                break
              fi
            fi
            # å¤‡ç”¨curlä¸‹è½½ï¼ˆæ–­ç‚¹ç»­ä¼ ï¼‰
            echo "âš¡ ä½¿ç”¨curlæ–­ç‚¹ç»­ä¼ ä¸‹è½½..."
            if sudo curl -fL -C - -o "$rom_path" "$rom_url"; then
              echo "âœ… ROMæ–‡ä»¶ä¸‹è½½æˆåŠŸï¼"
              break
            fi
            if [ $i -eq $max_retries ]; then
              echo "::error::âŒ ROMæ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æœ‰æ•ˆï¼"
              exit 1
            fi
            echo "ğŸ”„ $retry_delayç§’åé‡è¯•..."
            sleep $retry_delay
          done
          # æ˜¾ç¤ºROMæ–‡ä»¶ä¿¡æ¯ï¼ˆéªŒè¯ä¸‹è½½æ˜¯å¦å®Œæ•´ï¼‰
          echo "ğŸ“¦ ROMæ–‡ä»¶ä¿¡æ¯ï¼š"
          sudo ls -lh "$rom_path"

      # 11. é…ç½®ROMç‰¹å®šè®¾ç½®ï¼ˆé€‚é…ä¸åŒROMç±»å‹ï¼‰
      - name: "Configure ROM Specific Settings (é…ç½®ROMç‰¹å®šè®¾ç½®)"
        run: |
          echo "ğŸ”§ å¼€å§‹é…ç½®ROMç‰¹å®šè®¾ç½®..."
          # ç¡®å®šROMç±»å‹ï¼ˆä»configå˜é‡ä¸­è·å–ï¼‰
          rom_type="Generic"
          if [ "${{ steps.config.outputs.make_miui }}" = "true" ]; then rom_type="MIUI"; fi
          if [ "${{ steps.config.outputs.make_flyme }}" = "true" ]; then rom_type="Flyme"; fi
          if [ "${{ steps.config.outputs.make_coloros }}" = "true" ]; then rom_type="ColorOS"; fi
          if [ "${{ steps.config.outputs.make_h2os }}" = "true" ]; then rom_type="H2OS"; fi
          if [ "${{ steps.config.outputs.make_smartisanos }}" = "true" ]; then rom_type="SmartisanOS"; fi
          if [ "${{ steps.config.outputs.make_zui }}" = "true" ]; then rom_type="ZUI"; fi
          echo "â„¹ï¸ æ£€æµ‹åˆ°ROMç±»å‹ï¼š$rom_type"
          # é…ç½®Super SGSIï¼ˆå¦‚æœéœ€è¦ï¼‰
          if [ "${{ steps.config.outputs.make_super }}" = "true" ]; then
            echo "ğŸ› ï¸ é…ç½®Super SGSI..."
            if [[ -f "SGSI-build-tool/10/make.sh" ]]; then
              sudo sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' SGSI-build-tool/10/make.sh
              echo "âœ… Super SGSIé…ç½®å®Œæˆï¼"
            else
              echo "::warning::âš ï¸ æœªæ‰¾åˆ°make.shè„šæœ¬ï¼Œè·³è¿‡Super SGSIé…ç½®ï¼"
            fi
          fi
          # æ¸…ç†æ—§çš„fixbugè„šæœ¬
          sudo rm -f SGSI-build-tool/10/fixbug/fixbug.sh
          # ColorOSç‰¹æ®Šå¤„ç†ï¼ˆè§£å¯†OZIPåŒ…ï¼‰
          if [ "$rom_type" = "ColorOS" ]; then
            echo "ğŸ”“ è§£å¯†ColorOS OZIPåŒ…..."
            if [[ -f "SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py" ]]; then
              sudo python3 SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py "SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
              sudo rm -f "SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
              echo "âœ… ColorOS OZIPåŒ…è§£å¯†å®Œæˆï¼"
            else
              echo "::error::âŒ æœªæ‰¾åˆ°ozipdecrypt.pyè„šæœ¬ï¼Œæ— æ³•è§£å¯†ColorOS ROMï¼"
              exit 1
            fi
          fi
          # åº”ç”¨ROMç‰¹å®šä¿®å¤è„šæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [[ -f "fix/${rom_type}.sh" ]]; then
            echo "ğŸ› ï¸ åº”ç”¨$rom_typeä¿®å¤è„šæœ¬..."
            sudo cp "fix/${rom_type}.sh" SGSI-build-tool/10/fixbug/fixbug.sh
            sudo chmod +x SGSI-build-tool/10/fixbug/fixbug.sh
            echo "âœ… $rom_typeä¿®å¤è„šæœ¬åº”ç”¨å®Œæˆï¼"
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°$rom_typeä¿®å¤è„šæœ¬ï¼Œä½¿ç”¨é€šç”¨é…ç½®ï¼"
          fi
          echo "âœ… ROMç‰¹å®šè®¾ç½®é…ç½®å®Œæˆï¼"

      # 12. ä¿®å¤è„šæœ¬è¯­æ³•é”™è¯¯ï¼ˆé¿å…æ„å»ºæ—¶è„šæœ¬å´©æºƒï¼‰
      - name: "Fix Script Syntax Errors (ä¿®å¤è„šæœ¬è¯­æ³•é”™è¯¯)"
        run: |
          cd SGSI-build-tool/10
          echo "ğŸ” æ£€æŸ¥å¹¶ä¿®å¤SGSI.shè„šæœ¬è¯­æ³•é”™è¯¯..."
          if [[ -f "SGSI.sh" ]]; then
            # ä¿®å¤ç©ºæ•°ç»„åˆ¤æ–­ï¼ˆ[ ] == "" â†’ [ -n "" ]ï¼‰
            sudo sed -i 's/\[ *\] *== *"\(.*\)" *]/\[ -n "\1" ]/g' SGSI.sh
            # ä¿®å¤ç›¸ç­‰åˆ¤æ–­ï¼ˆ== â†’ =ï¼Œé¿å…bashè¯­æ³•é”™è¯¯ï¼‰
            sudo sed -i 's/==/=/g' SGSI.sh
            echo "âœ… SGSI.shè„šæœ¬è¯­æ³•é”™è¯¯ä¿®å¤å®Œæˆï¼"
          else
            echo "::warning::âš ï¸ æœªæ‰¾åˆ°SGSI.shè„šæœ¬ï¼Œè·³è¿‡è¯­æ³•ä¿®å¤ï¼"
          fi
          cd ../..

      # 13. å‡†å¤‡æ„å»ºæ–‡ä»¶ï¼ˆå¤åˆ¶è‡ªå®šä¹‰è„šæœ¬å’Œå·¥å…·ï¼‰
      - name: "Prepare Build Files (å‡†å¤‡æ„å»ºæ–‡ä»¶)"
        run: |
          echo "ğŸ“¦ å‡†å¤‡æ„å»ºæ–‡ä»¶..."
          # å¤åˆ¶è‡ªå®šä¹‰æ„å»ºè„šæœ¬ï¼ˆå¦‚æœæœ‰ï¼‰
          if [[ -d "make" ]]; then
            echo "ğŸ“„ å¤åˆ¶è‡ªå®šä¹‰æ„å»ºè„šæœ¬..."
            sudo cp -v make/*.sh SGSI-build-tool/10/
          fi
          # å¤åˆ¶äºŒè¿›åˆ¶å·¥å…·ï¼ˆå¦‚æœæœ‰ï¼‰
          if [[ -d "bin" ]]; then
            echo "ğŸ”§ å¤åˆ¶äºŒè¿›åˆ¶å·¥å…·..."
            sudo mkdir -p SGSI-build-tool/10/bin
            sudo cp -v bin/* SGSI-build-tool/10/bin/
          fi
          # æ›´æ–°ç¬¦å·é“¾æ¥ï¼ˆç¡®ä¿å·¥å…·å¯ç”¨ï¼‰
          cd SGSI-build-tool/10
          for tool in brotli simg2img; do
            if command -v $tool >/dev/null 2>&1; then
              sudo ln -sf $(which $tool) bin/$tool
            fi
          done
          cd ../..
          echo "âœ… æ„å»ºæ–‡ä»¶å‡†å¤‡å®Œæˆï¼"

      # 14. æ„å»ºSGSIé•œåƒï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼Œè¶…æ—¶è®¾ç½®ä¸º60åˆ†é’Ÿï¼‰
      - name: "Build SGSI Image (æ„å»ºSGSIé•œåƒ)"
        id: build_sgsi
        run: |
          cd SGSI-build-tool/10
          echo "ğŸ—ï¸ å¼€å§‹æ„å»ºSGSIé•œåƒï¼ˆè¶…æ—¶60åˆ†é’Ÿï¼‰..."
          # ä½¿ç”¨timeoutè®¾ç½®è¶…æ—¶ï¼Œé¿å…æ— é™ç­‰å¾…
          timeout 60m bash -c '
            if ! sudo bash make.sh 2>&1 | tee make.log; then
              echo "::error::âŒ SGSIé•œåƒæ„å»ºå¤±è´¥ï¼"
              echo "=== æ„å»ºæ—¥å¿—æœ€å100è¡Œ ==="
              tail -100 make.log
              echo "========================"
              exit 1
            fi
          ' || exit $?
          echo "ğŸ‰ SGSIé•œåƒæ„å»ºå®Œæˆï¼"
          # ä¿®å¤æ„å»ºäº§å‡ºæ–‡ä»¶æƒé™ï¼ˆé¿å…åç»­æ­¥éª¤æ— æ³•è®¿é—®ï¼‰
          echo "ğŸ”’ ä¿®å¤æ„å»ºäº§å‡ºæ–‡ä»¶æƒé™..."
          sudo chown -R $(id -u):$(id -g) out/
          sudo chmod -R 755 out/
          # ä»build.propæå–è®¾å¤‡ä¿¡æ¯ï¼ˆç”¨äºå‘å¸ƒæè¿°ï¼‰
          if [[ -f "./out/system/system/build.prop" ]]; then
            sudo chmod 644 ./out/system/system/build.prop  # ç¡®ä¿æ–‡ä»¶å¯è¯»
            # æå–è®¾å¤‡å‹å·
            model=$(grep 'ro.product.model' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            # æå–æœºå‹ä»£å·
            device_codename=$(grep -E 'ro.product.(device|name|board|hardware)' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            # æå–å®‰å…¨è¡¥ä¸æ—¥æœŸ
            security_patch=$(grep 'ro.build.version.security_patch' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            # æå–Androidç‰ˆæœ¬
            android_version=$(grep 'ro.build.version.release' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            # æå–æ„å»ºæ—¥æœŸ
            build_date=$(grep 'ro.build.date' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            # æå–ROMç‰ˆæœ¬
            rom_version=$(grep -E 'ro.(build|system|product).(version|display).(incremental|id|name)' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            # æå–æ„å»ºID
            build_id=$(grep 'ro.build.id' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            # è¾“å‡ºæå–çš„ä¿¡æ¯ï¼ˆç”¨äºåç»­æ­¥éª¤ï¼‰
            echo "model=$model" >> $GITHUB_OUTPUT
            echo "device_codename=$device_codename" >> $GITHUB_OUTPUT
            echo "security_patch=$security_patch" >> $GITHUB_OUTPUT
            echo "android_version=$android_version" >> $GITHUB_OUTPUT
            echo "build_date=$build_date" >> $GITHUB_OUTPUT
            echo "rom_version=$rom_version" >> $GITHUB_OUTPUT
            echo "build_id=$build_id" >> $GITHUB_OUTPUT
            echo "ğŸ“± æå–çš„è®¾å¤‡ä¿¡æ¯ï¼š"
            echo "å‹å·ï¼š$model"
            echo "ä»£å·ï¼š$device_codename"
            echo "Androidç‰ˆæœ¬ï¼š$android_version"
          else
            echo "::warning::âš ï¸ æœªæ‰¾åˆ°build.propæ–‡ä»¶ï¼Œæ— æ³•æå–è®¾å¤‡ä¿¡æ¯ï¼"
            # è¾“å‡ºé»˜è®¤å€¼ï¼ˆé¿å…åç»­æ­¥éª¤å‡ºé”™ï¼‰
            echo "model=Unknown" >> $GITHUB_OUTPUT
            echo "device_codename=Unknown" >> $GITHUB_OUTPUT
            echo "security_patch=Unknown" >> $GITHUB_OUTPUT
            echo "android_version=Unknown" >> $GITHUB_OUTPUT
            echo "build_date=Unknown" >> $GITHUB_OUTPUT
            echo "rom_version=Unknown" >> $GITHUB_OUTPUT
            echo "build_id=Unknown" >> $GITHUB_OUTPUT
          fi
          cd ../..

      # 15. æ‰“åŒ…è¡¥ä¸æ–‡ä»¶ï¼ˆæ–°å¢æ­¥éª¤ï¼Œå¤„ç†Patchç›®å½•ï¼‰
      - name: "Package Patches (æ‰“åŒ…è¡¥ä¸æ–‡ä»¶)"
        run: |
          echo "=== å¼€å§‹æ‰“åŒ…è¡¥ä¸æ–‡ä»¶ ==="
          # æ£€æŸ¥Patchç›®å½•æ˜¯å¦å­˜åœ¨
          if [[ ! -d "Patch" ]]; then
            echo "â„¹ï¸ æœªæ‰¾åˆ°Patchç›®å½•ï¼Œè·³è¿‡è¡¥ä¸æ‰“åŒ…ï¼"
            exit 0
          fi
          # åˆ›å»ºè¡¥ä¸è¾“å‡ºç›®å½•
          sudo mkdir -p SGSI-build-tool/10/SGSI/
          # æ‰“åŒ…Patch1-Patch3ç›®å½•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          for i in {1..3}; do
            patch_dir="Patch/Patch${i}"
            output_file="Patch${i}.zip"
            if [[ -d "$patch_dir" ]]; then
              echo "ğŸ“¦ æ‰“åŒ…è¡¥ä¸ï¼š$patch_dir â†’ $output_file"
              if ! zip -r "$output_file" "$patch_dir"/*; then
                echo "::warning::âš ï¸ è¡¥ä¸$iæ‰“åŒ…å¤±è´¥ï¼"
              else
                echo "âœ… è¡¥ä¸$iæ‰“åŒ…æˆåŠŸï¼"
                sudo mv "$output_file" SGSI-build-tool/10/SGSI/
              fi
            else
              echo "â„¹ï¸ è¡¥ä¸ç›®å½•$patch_dirä¸å­˜åœ¨ï¼Œè·³è¿‡ï¼"
            fi
          done
          # æ˜¾ç¤ºæ‰“åŒ…åçš„è¡¥ä¸æ–‡ä»¶
          echo "=== æ‰“åŒ…åçš„è¡¥ä¸æ–‡ä»¶ ==="
          sudo ls -lh SGSI-build-tool/10/SGSI/Patch*.zip || true
          echo "âœ… è¡¥ä¸æ–‡ä»¶æ‰“åŒ…å®Œæˆï¼"

      # 16. æ‰“åŒ…è¾“å‡ºæ–‡ä»¶ï¼ˆæ•´åˆSGSIå’Œè¡¥ä¸æ–‡ä»¶ï¼‰
      - name: "Package Output Files (æ‰“åŒ…è¾“å‡ºæ–‡ä»¶)"
        run: |
          cd SGSI-build-tool/10
          echo "=== å¼€å§‹æ‰“åŒ…è¾“å‡ºæ–‡ä»¶ ==="
          # æ£€æŸ¥SGSIç›®å½•æ˜¯å¦å­˜åœ¨ï¼ˆæ ¸å¿ƒäº§å‡ºç›®å½•ï¼‰
          if [[ ! -d "SGSI" ]]; then
            echo "::error::âŒ SGSIç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¤±è´¥ï¼"
            exit 1
          fi
          # æ£€æŸ¥è¡¥ä¸æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
          patch_count=$(ls SGSI/Patch*.zip 2>/dev/null | wc -l)
          if [[ $patch_count -gt 0 ]]; then
            echo "âœ… æ£€æµ‹åˆ°$patch_countä¸ªè¡¥ä¸æ–‡ä»¶ï¼Œå°†ä¸€èµ·æ‰“åŒ…ï¼"
          else
            echo "â„¹ï¸ æœªæ£€æµ‹åˆ°è¡¥ä¸æ–‡ä»¶ï¼Œä»…æ‰“åŒ…SGSIé•œåƒï¼"
          fi
          # è·å–è¾“å‡ºæ–‡ä»¶åï¼ˆæ¥è‡ªconfigå˜é‡ï¼‰
          output_file="${{ steps.config.outputs.pack_sgsi }}"
          echo "ğŸ“¦ æ‰“åŒ…è¾“å‡ºæ–‡ä»¶ï¼š$output_file"
          # ä¿®å¤æ–‡ä»¶æ‰€æœ‰æƒï¼ˆé¿å…æ‰“åŒ…æ—¶æƒé™é—®é¢˜ï¼‰
          sudo chown -R $(id -u):$(id -g) SGSI/
          # æ‰“åŒ…SGSIç›®å½•ï¼ˆåŒ…å«é•œåƒå’Œè¡¥ä¸ï¼‰
          if ! zip -r "$output_file" SGSI/*; then
            echo "::error::âŒ è¾“å‡ºæ–‡ä»¶æ‰“åŒ…å¤±è´¥ï¼"
            exit 1
          fi
          # å‡†å¤‡ä¸Šä¼ ç›®å½•ï¼ˆç”¨äºåç»­å‘å¸ƒï¼‰
          mkdir -p "${GITHUB_WORKSPACE}/upload"
          # æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé¿å…GitHub Releaseé™åˆ¶ï¼‰
          file_size=$(stat -c%s "$output_file")
          max_size=2000000000  # 2GBï¼ˆGitHub Releaseå•ä¸ªæ–‡ä»¶é™åˆ¶ï¼‰
          echo "ğŸ“¦ æ–‡ä»¶å¤§å°ï¼š$(numfmt --to=iec-i $file_size)"
          # å¦‚æœæ–‡ä»¶è¶…è¿‡2GBï¼Œåˆ†å·æ‰“åŒ…ï¼ˆ1.5GB/å·ï¼‰
          if [[ $file_size -gt $max_size ]]; then
            echo "âš ï¸ æ–‡ä»¶è¶…è¿‡2GBï¼Œåˆ†å·æ‰“åŒ…ï¼ˆ1.5GB/å·ï¼‰..."
            split -b 1500m -d -a 1 "$output_file" "${output_file}_part"
            # ç§»åŠ¨åˆ†å·æ–‡ä»¶åˆ°ä¸Šä¼ ç›®å½•
            mv "${output_file}_part"* "${GITHUB_WORKSPACE}/upload/"
            # åˆ é™¤åŸå§‹å¤§æ–‡ä»¶ï¼ˆèŠ‚çœç©ºé—´ï¼‰
            rm "$output_file"
            echo "=== åˆ†å·æ–‡ä»¶åˆ—è¡¨ ==="
            ls -lh "${GITHUB_WORKSPACE}/upload"
          else
            echo "ğŸ“¦ æ–‡ä»¶å¤§å°ç¬¦åˆè¦æ±‚ï¼Œç›´æ¥ç§»åŠ¨åˆ°ä¸Šä¼ ç›®å½•ï¼"
            mv "$output_file" "${GITHUB_WORKSPACE}/upload/"
          fi
          # æ˜¾ç¤ºä¸Šä¼ ç›®å½•å†…å®¹ï¼ˆéªŒè¯æ‰“åŒ…ç»“æœï¼‰
          echo "=== ä¸Šä¼ ç›®å½•å†…å®¹ ==="
          ls -lh "${GITHUB_WORKSPACE}/upload" || true
          # ä¿å­˜ä¸Šä¼ ç›®å½•è·¯å¾„ï¼ˆç”¨äºåç»­æ­¥éª¤ï¼‰
          echo "UPLOAD_DIR=${GITHUB_WORKSPACE}/upload" >> $GITHUB_ENV
          echo "âœ… è¾“å‡ºæ–‡ä»¶æ‰“åŒ…å®Œæˆï¼"
          cd ../..

      # 17. ç”Ÿæˆå‘å¸ƒæ ‡ç­¾å’Œæ—¶é—´ä¿¡æ¯ï¼ˆç²¾ç®€æ ‡ç­¾æ ¼å¼ï¼‰
      - name: "Generate Release Tag and Time Info (ç”Ÿæˆå‘å¸ƒæ ‡ç­¾å’Œæ—¶é—´ä¿¡æ¯)"
        id: release_tag
        run: |
          # ç”Ÿæˆç²¾ç®€æ ‡ç­¾ï¼ˆä¸¤ä½å¹´ä»½+æœˆæ—¥+å°æ—¶åˆ†é’Ÿï¼Œå¦‚251002_1930ï¼‰
          current_date=$(TZ='Asia/Shanghai' date +"%y%m%d")  # ä¸¤ä½å¹´ä»½ï¼ˆå¦‚25ï¼‰
          timestamp=$(TZ='Asia/Shanghai' date +"%H%M")       # å°æ—¶åˆ†é’Ÿï¼ˆå¦‚1930ï¼‰
          release_tag="${current_date}_${timestamp}"         # ç»„åˆæ ‡ç­¾ï¼ˆå¦‚251002_1930ï¼‰
          # ç”Ÿæˆæ„å»ºæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼Œæ ¼å¼ï¼š2025-10-02 ä¸‹åˆ 07:30 [åŒ—äº¬æ—¶é—´]ï¼‰
          build_time=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %p %I:%M")
          build_time=$(echo "$build_time" | sed -e 's/AM/ä¸Šåˆ/' -e 's/PM/ä¸‹åˆ/')  # å°†AM/PMè½¬æ¢ä¸ºä¸­æ–‡
          build_time="${build_time} [åŒ—äº¬æ—¶é—´]"
          # å¤„ç†åŸæ„å»ºæ—¥æœŸï¼ˆè§£å†³æ— ç©ºæ ¼æ ¼å¼é—®é¢˜ï¼Œå¦‚ThuJun1721:43:45CST2021â†’2021-06-17 21:43:45 CSTï¼‰
          original_build_date="${{ steps.build_sgsi.outputs.build_date }}"
          if [[ "$original_build_date" != "Unknown" ]]; then
            parsed_date=$(echo "$original_build_date" | sed -E 's/([a-zA-Z]{3})([a-zA-Z]{3})([0-9]{2})([0-9]{2}:[0-9]{2}:[0-9]{2})([A-Z]{3})([0-9]{4})/\1 \2 \3 \4 \5 \6/' 2>/dev/null)
            formatted_date=$(date -d "$parsed_date" "+%Y-%m-%d %H:%M:%S %Z" 2>/dev/null || echo "$original_build_date")
          else
            formatted_date="Unknown"
          fi
          # ç”ŸæˆåŸåŒ…æœºå‹æ˜¾ç¤ºï¼ˆå¤„ç†Unknownæƒ…å†µï¼‰
          model="${{ steps.build_sgsi.outputs.model }}"
          device_codename="${{ steps.build_sgsi.outputs.device_codename }}"
          if [[ "$model" == "Unknown" && "$device_codename" == "Unknown" ]]; then
            source_device="Unknown"
          elif [[ "$model" == "Unknown" ]]; then
            source_device="$device_codename"
          elif [[ "$device_codename" == "Unknown" ]]; then
            source_device="$model"
          else
            source_device="$model [$device_codename]"
          fi
          # ç¡®å®šROMç±»å‹ï¼ˆåŒä¹‹å‰é€»è¾‘ï¼‰
          rom_type="Generic"
          if [ "${{ steps.config.outputs.make_miui }}" = "true" ]; then rom_type="MIUI"; fi
          if [ "${{ steps.config.outputs.make_flyme }}" = "true" ]; then rom_type="Flyme"; fi
          if [ "${{ steps.config.outputs.make_coloros }}" = "true" ]; then rom_type="ColorOS"; fi
          if [ "${{ steps.config.outputs.make_h2os }}" = "true" ]; then rom_type="H2OS"; fi
          if [ "${{ steps.config.outputs.make_smartisanos }}" = "true" ]; then rom_type="SmartisanOS"; fi
          if [ "${{ steps.config.outputs.make_zui }}" = "true" ]; then rom_type="ZUI"; fi
          # è¾“å‡ºå˜é‡ï¼ˆç”¨äºåç»­æ­¥éª¤ï¼‰
          echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
          echo "build_time=$build_time" >> $GITHUB_OUTPUT
          echo "formatted_build_date=$formatted_date" >> $GITHUB_OUTPUT
          echo "source_device=$source_device" >> $GITHUB_OUTPUT
          echo "rom_type=$rom_type" >> $GITHUB_OUTPUT
          # è¾“å‡ºè°ƒè¯•ä¿¡æ¯ï¼ˆéªŒè¯æ ‡ç­¾æ ¼å¼ï¼‰
          echo "=== å‘å¸ƒæ ‡ç­¾ä¿¡æ¯ ==="
          echo "æ ‡ç­¾ï¼š$release_tagï¼ˆç²¾ç®€æ ¼å¼ï¼šä¸¤ä½å¹´ä»½+æœˆæ—¥+å°æ—¶åˆ†é’Ÿï¼‰"
          echo "æ„å»ºæ—¶é—´ï¼š$build_time"
          echo "ROMç±»å‹ï¼š$rom_type"

      # 18. ä¸Šä¼ åˆ°WeTransferï¼ˆæ–°å¢æ­¥éª¤ï¼Œç”Ÿæˆ7å¤©æœ‰æ•ˆé“¾æ¥ï¼‰
      - name: "Upload to WeTransfer (ä¸Šä¼ åˆ°WeTransfer)"
        id: upload_wetransfer
        run: |
          echo "=== å¼€å§‹ä¸Šä¼ åˆ°WeTransferï¼ˆ7å¤©æœ‰æ•ˆï¼‰ ==="
          # æ£€æŸ¥ä¸Šä¼ ç›®å½•æ˜¯å¦å­˜åœ¨ä¸”éç©º
          if [[ ! -d "${{ env.UPLOAD_DIR }}" || -z "$(ls -A ${{ env.UPLOAD_DIR }})" ]]; then
            echo "::warning::â„¹ï¸ ä¸Šä¼ ç›®å½•ä¸ºç©ºï¼Œè·³è¿‡WeTransferä¸Šä¼ ï¼"
            exit 0
          fi
          # è·å–ä¸Šä¼ ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼ˆå¤„ç†ç©ºæ ¼ï¼‰
          files=($(find "${{ env.UPLOAD_DIR }}" -type f -print0 | xargs -0))
          # æ„å»ºcurlå‘½ä»¤ï¼ˆæ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ ï¼Œå¤„ç†ç©ºæ ¼ï¼‰
          curl_cmd="curl -s "
          for file in "${files[@]}"; do
            curl_cmd+="-F 'file=@\"$file\"' "  # ç”¨å¼•å·åŒ…è£¹æ–‡ä»¶è·¯å¾„ï¼Œé¿å…ç©ºæ ¼é—®é¢˜
          done
          curl_cmd+="https://transfer.sh/?expire=7d"  # è®¾ç½®é“¾æ¥æœ‰æ•ˆæœŸä¸º7å¤©
          # æ‰§è¡Œä¸Šä¼ å¹¶æ•è·å“åº”
          response=$(eval "$curl_cmd")
          # å¤„ç†ä¸Šä¼ ç»“æœ
          if [[ $? -ne 0 || -z "$response" || "$response" == *"error"* ]]; then
            echo "::warning::âš ï¸ WeTransferä¸Šä¼ å¤±è´¥ï¼Œå“åº”ï¼š$response"
            exit 0
          fi
          # ä¿å­˜WeTransferé“¾æ¥ï¼ˆç”¨äºå‘å¸ƒæè¿°ï¼‰
          echo "link=$response" >> $GITHUB_OUTPUT
          echo "âœ… WeTransferä¸Šä¼ æˆåŠŸï¼é“¾æ¥ï¼š$responseï¼ˆ7å¤©æœ‰æ•ˆï¼‰"

      # 19. ä¸Šä¼ åˆ°GitHub Artifactsï¼ˆæ–°å¢æ­¥éª¤ï¼Œä¿ç•™30å¤©ï¼‰
      - name: "Upload to GitHub Artifacts (ä¸Šä¼ åˆ°GitHub Artifacts)"
        uses: actions/upload-artifact@v4
        with:
          name: sgsi-build-artifacts  # Artifactåç§°ï¼ˆå¯è‡ªå®šä¹‰ï¼‰
          path: ${{ env.UPLOAD_DIR }}/*  # ä¸Šä¼ ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
          retention-days: 30  # ä¿ç•™30å¤©ï¼ˆGitHubé»˜è®¤ï¼‰
        continue-on-error: true  # ä¸Šä¼ å¤±è´¥ä¸ä¸­æ–­å·¥ä½œæµ

      # 20. åˆ›å»ºGitHub Releaseï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼Œå‘å¸ƒæ„å»ºç»“æœï¼‰
      - name: "Create Release (åˆ›å»ºGitHub Release)"
        uses: softprops/action-gh-release@v1
        with:
          # å‘å¸ƒåç§°ï¼ˆåŒ…å«ç²¾ç®€æ ‡ç­¾å’Œå·¥å…·ç‰ˆæœ¬ï¼‰
          name: "Auto Build SGSI - XiaoxinTools 1.9-AB [${{ steps.release_tag.outputs.release_tag }}]"
          # å‘å¸ƒæ ‡ç­¾ï¼ˆç²¾ç®€æ ¼å¼ï¼Œå¦‚251002_1930ï¼‰
          tag_name: "${{ steps.release_tag.outputs.release_tag }}"
          # ä¸Šä¼ æ‰€æœ‰æ‰“åŒ…åçš„æ–‡ä»¶ï¼ˆæ¥è‡ªä¸Šä¼ ç›®å½•ï¼‰
          files: "${{ env.UPLOAD_DIR }}/*"
          # å‘å¸ƒæè¿°ï¼ˆåŒ…å«WeTransferé“¾æ¥å’Œè¯¦ç»†ä¿¡æ¯ï¼‰
          body: |
            ## ğŸ“± SGSI Build Release (SGSIæ„å»ºå‘å¸ƒ)
            
            ### ğŸ“Œ å…³é”®ä¿¡æ¯
            - **æ„å»ºæ—¶é—´**ï¼š${{ steps.release_tag.outputs.build_time }}
            - **åŸåŒ…æœºå‹**ï¼š${{ steps.release_tag.outputs.source_device }}
            - **ROMç±»å‹**ï¼š${{ steps.release_tag.outputs.rom_type }}
            - **Androidç‰ˆæœ¬**ï¼š${{ steps.build_sgsi.outputs.android_version }}
            - **å®‰å…¨è¡¥ä¸**ï¼š${{ steps.build_sgsi.outputs.security_patch }}
            - **åŸæ„å»ºæ—¥æœŸ**: ${{ steps.release_tag.outputs.formatted_build_date }}
            - **æ„å»ºID**ï¼š${{ steps.build_sgsi.outputs.build_id }}
            
            ### ğŸ“¥ ä¸‹è½½é“¾æ¥
            - **WeTransferï¼ˆ7å¤©æœ‰æ•ˆï¼‰**ï¼š${{ steps.upload_wetransfer.outputs.link }}
            - **GitHub Artifactsï¼ˆ30å¤©æœ‰æ•ˆï¼‰**ï¼š[ç‚¹å‡»ä¸‹è½½](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)
            
            ### â„¹ï¸ æ³¨æ„äº‹é¡¹
            - è¿™æ˜¯**å®éªŒæ€§æ„å»º**ï¼Œå¯èƒ½å­˜åœ¨ç¨³å®šæ€§é—®é¢˜ï¼Œè¯·æµ‹è¯•åå†ä½œä¸ºä¸»åŠ›ç³»ç»Ÿä½¿ç”¨ã€‚
            - è¡¥ä¸æ–‡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰ä½äºSGSIç›®å½•ä¸­ï¼Œå¦‚éœ€ä½¿ç”¨è¯·æ‰‹åŠ¨åˆ·å…¥ã€‚
            - æ„å»ºæ—¥å¿—ï¼š[ç‚¹å‡»æŸ¥çœ‹](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            ğŸ› ï¸ æ„å»ºå·¥å…·ï¼šXiaoxinTools 1.9-AB
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHubä»¤ç‰Œï¼ˆç”¨äºåˆ›å»ºReleaseï¼‰

      # 21. å®Œæˆé€šçŸ¥ï¼ˆæˆåŠŸæ—¶è¾“å‡ºæç¤ºï¼‰
      - name: "Completion Notification (å®Œæˆé€šçŸ¥)"
        if: success()
        run: |
          echo "ğŸ‰ æ„å»ºæµç¨‹å…¨éƒ¨å®Œæˆï¼"
          echo "ğŸ“Œ å‘å¸ƒæ ‡ç­¾ï¼š${{ steps.release_tag.outputs.release_tag }}"
          echo "ğŸ“¥ WeTransferé“¾æ¥ï¼š${{ steps.upload_wetransfer.outputs.link }}ï¼ˆ7å¤©æœ‰æ•ˆï¼‰"
          echo "ğŸ” è¯·å‰å¾€GitHub ReleaseæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼šhttps://github.com/${{ github.repository }}/releases/tag/${{ steps.release_tag.outputs.release_tag }}"
