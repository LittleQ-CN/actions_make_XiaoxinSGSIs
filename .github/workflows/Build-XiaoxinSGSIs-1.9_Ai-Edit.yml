name: Build_XiaoxinSGSIs_Ai-Edit [1.9]

on:
  workflow_dispatch:  # Manual trigger only / ä»…æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
      - name: Checkout Code (æ£€å‡ºä»£ç )
        uses: actions/checkout@v4
        
      - name: Initial Setup & Cleanup (åˆå§‹è®¾ç½®å’Œæ¸…ç†)
        run: |
          echo "ğŸ’¾ Initial disk space (åˆå§‹ç£ç›˜ç©ºé—´):"
          df -h
          echo "ğŸ§¹ Starting aggressive cleanup (å¼€å§‹æ¿€è¿›æ¸…ç†)..."
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/* /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"
          echo "âœ… Initial cleanup completed (åˆå§‹æ¸…ç†å®Œæˆ)"
          df -h
       
      - name: Configuration Check & Setup (é…ç½®æ£€æŸ¥å’Œè®¾ç½®)
        run: |
          echo "=== Configuration Check (é…ç½®æ£€æŸ¥) ==="
          if [[ ! -f "sgsi.json" ]]; then
            echo "::error::âŒ Missing sgsi.json config file (ç¼ºå°‘sgsi.jsoné…ç½®æ–‡ä»¶)"
            exit 1
          fi
          
          echo "âœ… sgsi.json file exists (sgsi.jsonæ–‡ä»¶å­˜åœ¨)"
          echo "File content (æ–‡ä»¶å†…å®¹):"
          cat sgsi.json
       
      - name: Parse Configuration (è§£æé…ç½®)
        id: config
        run: |
          echo "=== Parse Configuration (è§£æé…ç½®) ==="
          rom_url=$(jq -r '.rom_url // empty' sgsi.json)
          if [[ -z "$rom_url" ]]; then
            echo "::error::âŒ Missing rom_url field in sgsi.json (sgsi.jsonä¸­ç¼ºå°‘rom_urlå­—æ®µ)"
            exit 1
          fi
          
          echo "ğŸ“‹ Configuration Info (é…ç½®ä¿¡æ¯):"
          echo "ROM URL: $rom_url"
          echo "ROM Name: $(jq -r '.rom_name // "unknown_rom"' sgsi.json)"
          echo "Pack SGSI: $(jq -r '.pack_sgsi // "SGSI.zip"' sgsi.json)"
          
          {
            echo "rom_url=$rom_url"
            echo "rom_name=$(jq -r '.rom_name // "unknown_rom"' sgsi.json)"
            echo "pack_sgsi=$(jq -r '.pack_sgsi // "SGSI.zip"' sgsi.json)"
            echo "make_miui=$(jq -r '.make_miui // "false"' sgsi.json)"
            echo "make_flyme=$(jq -r '.make_flyme // "false"' sgsi.json)"
            echo "make_coloros=$(jq -r '.make_coloros // "false"' sgsi.json)"
            echo "make_h2os=$(jq -r '.make_h2os // "false"' sgsi.json)"
            echo "make_smartisanos=$(jq -r '.make_smartisanos // "false"' sgsi.json)"
            echo "make_zui=$(jq -r '.make_zui // "false"' sgsi.json)"
            echo "make_super=$(jq -r '.make_super // "false"' sgsi.json)"
          } >> $GITHUB_OUTPUT
           
      - name: Install Tools & Download Build Tools (å®‰è£…å·¥å…·å’Œä¸‹è½½æ„å»ºå·¥å…·)
        run: |
          echo "=== Install Essential Tools (å®‰è£…å¿…è¦å·¥å…·) ==="
          sudo apt-get update
          sudo apt-get install -y aria2 curl jq zip unzip python3 file
          sudo apt-get clean
          
          echo "ğŸ“¥ Downloading build tools (ä¸‹è½½æ„å»ºå·¥å…·)..."
          tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar"
          max_retries=5
          
          for i in $(seq 1 $max_retries); do
            echo "Attempt $i/$max_retries (å°è¯• $i/$max_retries)..."
            if curl -fL -o "SGSI-build-tool.tar" "$tool_url"; then
              echo "âœ… Download successful (ä¸‹è½½æˆåŠŸ)"
              break
            elif [ $i -eq $max_retries ]; then
              echo "::error::âŒ Build tools download failed (æ„å»ºå·¥å…·ä¸‹è½½å¤±è´¥)"
              exit 1
            fi
            sleep 10
          done
          
          echo "ğŸ“‚ Extracting build tools (è§£å‹æ„å»ºå·¥å…·)..."
          if ! sudo tar -xf SGSI-build-tool.tar; then
            echo "::error::âŒ Failed to extract build tools (è§£å‹æ„å»ºå·¥å…·å¤±è´¥)"
            exit 1
          fi
          
          rm -f SGSI-build-tool.tar
          echo "âœ… Environment setup completed (ç¯å¢ƒè®¾ç½®å®Œæˆ)"
          df -h
          
      - name: Setup Build Environment (è®¾ç½®æ„å»ºç¯å¢ƒ)
        run: |
          echo "=== Setup Build Environment (è®¾ç½®æ„å»ºç¯å¢ƒ) ==="
          
          # Remove existing setup script and replace with custom one
          sudo rm -rf SGSI-build-tool/10/setup.sh
          if [[ -f "bin/setup.sh" ]]; then
            sudo mv bin/setup.sh SGSI-build-tool/10/
          fi
          
          # Run setup script
          cd SGSI-build-tool/10
          if [[ -f "setup.sh" ]]; then
            sudo bash setup.sh
          fi
          cd ../..
          
          # Fix directory permissions
          sudo chown -R $(id -u):$(id -g) SGSI-build-tool
          sudo chmod -R 755 SGSI-build-tool
          echo "âœ… Build environment setup completed (æ„å»ºç¯å¢ƒè®¾ç½®å®Œæˆ)"

      - name: Download ROM File (ä¸‹è½½ROMæ–‡ä»¶)
        run: |
          rom_path="SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
          rom_url="${{ steps.config.outputs.rom_url }}"
          
          sudo mkdir -p "$(dirname "$rom_path")"
          echo "ğŸš€ Starting ROM download: ${{ steps.config.outputs.rom_name }}"
          
          max_retries=3
          download_success=false
          
          # Try aria2 first (ä¼˜å…ˆä½¿ç”¨aria2)
          if command -v aria2c &> /dev/null; then
            echo "âš¡ Using aria2 multi-threaded download (ä½¿ç”¨aria2å¤šçº¿ç¨‹ä¸‹è½½)"
            for i in $(seq 1 $max_retries); do
              if sudo aria2c -x 8 -s 8 -k 1M "$rom_url" -d "$(dirname "$rom_path")" -o "$(basename "$rom_path")"; then
                download_success=true
                break
              else
                echo "Download attempt $i/$max_retries failed with aria2 - retrying..."
                sudo rm -f "$rom_path" || true
                sleep 15
              fi
            done
          fi
          
          # Fallback to curl (å¤‡ç”¨curl)
          if [ "$download_success" = false ] && command -v curl &> /dev/null; then
            echo "âš¡ Using curl download (ä½¿ç”¨curlä¸‹è½½)"
            for i in $(seq 1 $max_retries); do
              if sudo curl -fL -o "$rom_path" "$rom_url"; then
                download_success=true
                break
              else
                echo "Download attempt $i/$max_retries failed with curl - retrying..."
                sudo rm -f "$rom_path" || true
                sleep 15
              fi
            done
          fi
          
          if [ ! -f "$rom_path" ]; then
            echo "::error::âŒ ROM download failed after $max_retries attempts (ROMä¸‹è½½å¤±è´¥)"
            exit 1
          fi
          
          file_size=$(stat -c%s "$rom_path" 2>/dev/null || echo "0")
          echo "ğŸ‰ ROM download completed: $(numfmt --to=iec $file_size) (ROMä¸‹è½½å®Œæˆ)"
          df -h

      - name: ROM Configuration (ROMé…ç½®)
        run: |
          echo "=== ROM Configuration (ROMé…ç½®) ==="
          
          # Determine ROM type and apply specific configuration
          rom_type="Generic"
          if [ "${{ steps.config.outputs.make_miui }}" = "true" ]; then 
            rom_type="MIUI"
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/MIUI.sh" ]]; then
              sudo cp fix/MIUI.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          if [ "${{ steps.config.outputs.make_flyme }}" = "true" ]; then 
            rom_type="Flyme" 
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/Flyme.sh" ]]; then
              sudo cp fix/Flyme.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          if [ "${{ steps.config.outputs.make_coloros }}" = "true" ]; then 
            rom_type="ColorOS"
            # ColorOS decryption
            if [[ -f "SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py" ]]; then
              echo "ğŸ”“ Decrypting ColorOS OZIP (è§£å¯†ColorOS OZIP)..."
              sudo python3 SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py "SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
              sudo rm -f "SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
            fi
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/ColorOS.sh" ]]; then
              sudo cp fix/ColorOS.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          if [ "${{ steps.config.outputs.make_h2os }}" = "true" ]; then 
            rom_type="H2OS"
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/H2OS.sh" ]]; then
              sudo cp fix/H2OS.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          if [ "${{ steps.config.outputs.make_smartisanos }}" = "true" ]; then 
            rom_type="SmartisanOS"
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/SmartisanOS.sh" ]]; then
              sudo cp fix/SmartisanOS.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          if [ "${{ steps.config.outputs.make_zui }}" = "true" ]; then 
            rom_type="ZUI"
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/ZUI.sh" ]]; then
              sudo cp fix/ZUI.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          # Super SGSI configuration
          if [ "${{ steps.config.outputs.make_super }}" = "true" ] && [[ -f "SGSI-build-tool/10/make.sh" ]]; then
            sudo sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' SGSI-build-tool/10/make.sh
            echo "âœ… Super SGSI configured (Super SGSIé…ç½®å®Œæˆ)"
          fi
          
          echo "ğŸ“± ROM Type: $rom_type (ROMç±»å‹: $rom_type)"
          echo "âœ… ROM configuration completed (ROMé…ç½®å®Œæˆ)"

      - name: Prepare Build Scripts (å‡†å¤‡æ„å»ºè„šæœ¬)
        run: |
          echo "=== Prepare Build Scripts (å‡†å¤‡æ„å»ºè„šæœ¬) ==="
          
          # Remove existing scripts
          rm -rf SGSI-build-tool/10/SGSI.sh SGSI-build-tool/10/makeimg.sh SGSI-build-tool/10/dynamic_SGSI.sh SGSI-build-tool/10/oppo.sh SGSI-build-tool/10/make.sh 2>/dev/null || true
          
          # Copy custom build scripts
          if [[ -d "make" ]]; then
            echo "ğŸ“ Copying build scripts (å¤åˆ¶æ„å»ºè„šæœ¬)..."
            for script in makeimg.sh SGSI.sh dynamic_SGSI.sh oppo.sh make.sh; do
              if [[ -f "make/$script" ]]; then
                sudo cp "make/$script" SGSI-build-tool/10/
                echo "âœ… Copied $script"
              fi
            done
          fi
          
          # Copy binary tools
          if [[ -d "bin" ]]; then
            echo "ğŸ”§ Copying binary tools (å¤åˆ¶äºŒè¿›åˆ¶å·¥å…·)..."
            for tool in mke2fs e2fsdroid; do
              if [[ -f "bin/$tool" ]]; then
                sudo mkdir -p SGSI-build-tool/10/bin
                sudo cp "bin/$tool" SGSI-build-tool/10/bin/
                echo "âœ… Copied $tool"
              fi
            done
          fi
          
          # Set execution permissions
          sudo find SGSI-build-tool/10 -name "*.sh" -exec chmod +x {} \;
          echo "âœ… Build scripts preparation completed (æ„å»ºè„šæœ¬å‡†å¤‡å®Œæˆ)"

      - name: Build SGSI Images (æ„å»ºSGSIé•œåƒ)
        id: build_sgsi
        run: |
          echo "=== Build SGSI Images (æ„å»ºSGSIé•œåƒ) ==="
          cd SGSI-build-tool/10
          
          echo "ğŸ§¹ Cleaning disk space before build (æ„å»ºå‰æ¸…ç†ç£ç›˜ç©ºé—´)..."
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
          
          echo "ğŸ—ï¸ Starting SGSI build (å¼€å§‹æ„å»ºSGSI)..."
          build_start=$(date +%s)
          
          if ! sudo bash make.sh 2>&1 | tee make.log; then
            echo "::error::âŒ Build failed (æ„å»ºå¤±è´¥)"
            
            # Error analysis
            if grep -q "out of memory" make.log; then
              echo "::error::ğŸ’¥ Insufficient memory (å†…å­˜ä¸è¶³)"
            elif grep -q "No space left" make.log; then
              echo "::error::ğŸ’¥ Disk space exhausted (ç£ç›˜ç©ºé—´è€—å°½)"
              df -h
            elif grep -q "Permission denied" make.log; then
              echo "::error::ğŸ’¥ Permission issues (æƒé™é—®é¢˜)"
            fi
            
            tail -100 make.log
            exit 1
          fi
          
          build_end=$(date +%s)
          build_duration=$((build_end - build_start))
          echo "â±ï¸ Build completed in $(($build_duration / 60))m $(($build_duration % 60))s (æ„å»ºç”¨æ—¶)"
          
          # Fix output permissions
          sudo chown -R $(id -u):$(id -g) out/
          sudo chmod -R 755 out/
          
          if [[ ! -d "./out/system" ]]; then
            echo "::error::âŒ Build output not found (æ„å»ºäº§å‡ºæœªæ‰¾åˆ°)"
            exit 1
          fi
          
          # Extract build info from build.prop
          if [[ -f "./out/system/system/build.prop" ]]; then
            sudo chmod 644 ./out/system/system/build.prop
            
            model=$(grep 'ro.product.model' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            android_version=$(grep 'ro.build.version.release' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            build_date=$(grep 'ro.build.date' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            
            {
              echo "model=$model"
              echo "android_version=$android_version" 
              echo "build_date=$build_date"
            } >> $GITHUB_OUTPUT
            
            echo "ğŸ“± Build Info: $model, Android $android_version, $build_date"
          else
            echo "model=Unknown" >> $GITHUB_OUTPUT
            echo "android_version=Unknown" >> $GITHUB_OUTPUT
            echo "build_date=Unknown" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸ’¾ Disk space after build (æ„å»ºåç£ç›˜ç©ºé—´):"
          df -h

      - name: Debug Environment (è°ƒè¯•ç¯å¢ƒ)
        run: |
          echo "=== Debug Environment (è°ƒè¯•ç¯å¢ƒ) ==="
          
          echo "ğŸ” Current user info (å½“å‰ç”¨æˆ·ä¿¡æ¯):"
          whoami
          id
          
          echo "ğŸ” Current directory (å½“å‰ç›®å½•):"
          pwd
          ls -la
          
          echo "ğŸ” Patch directory details (è¡¥ä¸ç›®å½•è¯¦æƒ…):"
          if [[ -d "Patch" ]]; then
            ls -la Patch/
            for i in 1 2 3; do
              patch_dir="Patch/Patch${i}"
              if [[ -d "$patch_dir" ]]; then
                echo "ğŸ“ Patch${i} details:"
                ls -la "$patch_dir"
                echo "ğŸ” Checking META-INF directory:"
                if [[ -d "$patch_dir/META-INF" ]]; then
                  ls -la "$patch_dir/META-INF/"
                  if [[ -d "$patch_dir/META-INF/com" ]]; then
                    ls -la "$patch_dir/META-INF/com/"
                    if [[ -d "$patch_dir/META-INF/com/google" ]]; then
                      ls -la "$patch_dir/META-INF/com/google/"
                      if [[ -d "$patch_dir/META-INF/com/google/android" ]]; then
                        ls -la "$patch_dir/META-INF/com/google/android/"
                      fi
                    fi
                  fi
                fi
              fi
            done
          fi
          
          echo "ğŸ” Disk space (ç£ç›˜ç©ºé—´):"
          df -h
          
          echo "ğŸ” Memory info (å†…å­˜ä¿¡æ¯):"
          free -h

      - name: Simple Patch Copy (ç®€å•è¡¥ä¸å¤åˆ¶)
        id: simple_patches
        run: |
          echo "=== Simple Patch Copy (ç®€å•è¡¥ä¸å¤åˆ¶) ==="
          
          # Disable error exit for this step
          set +e
          
          patch_count=0
          
          # Create SGSI directory with proper permissions
          echo "ğŸ”§ Creating SGSI directory (åˆ›å»ºSGSIç›®å½•)..."
          mkdir -p SGSI-build-tool/10/SGSI/
          chmod 755 SGSI-build-tool/10/SGSI/
          
          # Simple direct copy - no fancy methods
          for patch_num in 1 2 3; do
            patch_dir="Patch/Patch${patch_num}"
            target_dir="SGSI-build-tool/10/SGSI/Patch${patch_num}"
            
            if [[ -d "$patch_dir" ]]; then
              echo "ğŸ“¦ Copying Patch${patch_num} (å¤åˆ¶è¡¥ä¸${patch_num})..."
              
              # Remove target if exists
              if [[ -d "$target_dir" ]]; then
                rm -rf "$target_dir"
              fi
              
              # Simple copy command
              echo "ğŸ”„ Copy command: cp -r \"$patch_dir\" \"$target_dir\""
              cp -r "$patch_dir" "$target_dir"
              copy_exit_code=$?
              
              if [[ $copy_exit_code -eq 0 ]] && [[ -d "$target_dir" ]]; then
                ((patch_count++))
                echo "âœ… Patch${patch_num} copied successfully (è¡¥ä¸${patch_num}å¤åˆ¶æˆåŠŸ)"
                echo "ğŸ“ Target directory contents (ç›®æ ‡ç›®å½•å†…å®¹):"
                ls -la "$target_dir" | head -10
              else
                echo "âŒ Patch${patch_num} copy failed with exit code: $copy_exit_code (è¡¥ä¸${patch_num}å¤åˆ¶å¤±è´¥)"
                echo "ğŸ” Debug info:"
                echo "Source exists: $(test -d "$patch_dir" && echo "Yes" || echo "No")"
                echo "Target parent exists: $(test -d "$(dirname "$target_dir")" && echo "Yes" || echo "No")"
                echo "Target parent permissions: $(ls -ld "$(dirname "$target_dir")" 2>/dev/null || echo "N/A")"
              fi
            else
              echo "â„¹ï¸ Patch${patch_num} not found (è¡¥ä¸${patch_num}ä¸å­˜åœ¨)"
            fi
            echo "---"
          done
          
          # Re-enable error exit
          set -e
          
          echo "patch_count=$patch_count" >> $GITHUB_OUTPUT
          echo "âœ… Simple patch copy completed: $patch_count patches (ç®€å•è¡¥ä¸å¤åˆ¶å®Œæˆ: $patch_count ä¸ªè¡¥ä¸)"

      - name: Alternative Patch Method (æ›¿ä»£è¡¥ä¸æ–¹æ³•)
        id: alternative_patches
        if: steps.simple_patches.outputs.patch_count == '0'
        run: |
          echo "=== Alternative Patch Method (æ›¿ä»£è¡¥ä¸æ–¹æ³•) ==="
          
          set +e
          patch_count=0
          
          echo "ğŸ”„ Trying alternative patch methods (å°è¯•æ›¿ä»£è¡¥ä¸æ–¹æ³•)..."
          
          for patch_num in 1 2 3; do
            patch_dir="Patch/Patch${patch_num}"
            if [[ -d "$patch_dir" ]]; then
              echo "ğŸ“¦ Alternative method for Patch${patch_num} (è¡¥ä¸${patch_num}çš„æ›¿ä»£æ–¹æ³•)..."
              
              # Method 1: Use find and cpio
              echo "ğŸ”„ Method 1: find + cpio"
              if (cd "$patch_dir" && find . -print | cpio -pdum "SGSI-build-tool/10/SGSI/Patch${patch_num}" 2>/dev/null); then
                ((patch_count++))
                echo "âœ… Patch${patch_num} copied with cpio"
                continue
              fi
              
              # Method 2: Use python
              echo "ğŸ”„ Method 2: python"
              if python3 -c "
import shutil
import os
try:
    shutil.copytree('$patch_dir', 'SGSI-build-tool/10/SGSI/Patch${patch_num}')
    print('Python copy successful')
except Exception as e:
    print(f'Python copy failed: {e}')
    exit(1)
"; then
                ((patch_count++))
                echo "âœ… Patch${patch_num} copied with python"
                continue
              fi
              
              # Method 3: Manual file-by-file copy
              echo "ğŸ”„ Method 3: Manual file copy"
              mkdir -p "SGSI-build-tool/10/SGSI/Patch${patch_num}"
              if find "$patch_dir" -type f -exec cp --parents -t "SGSI-build-tool/10/SGSI/Patch${patch_num}" {} + 2>/dev/null; then
                ((patch_count++))
                echo "âœ… Patch${patch_num} copied manually"
              else
                echo "âŒ All alternative methods failed for Patch${patch_num}"
              fi
            fi
          done
          
          set -e
          echo "alternative_count=$patch_count" >> $GITHUB_OUTPUT
          echo "âœ… Alternative methods completed: $patch_count patches (æ›¿ä»£æ–¹æ³•å®Œæˆ: $patch_count ä¸ªè¡¥ä¸)"

      - name: Skip Patches if All Failed (å¦‚æœæ‰€æœ‰è¡¥ä¸éƒ½å¤±è´¥åˆ™è·³è¿‡)
        if: steps.simple_patches.outputs.patch_count == '0' && steps.alternative_patches.outputs.alternative_count == '0'
        run: |
          echo "âš ï¸ All patch methods failed, continuing without patches (æ‰€æœ‰è¡¥ä¸æ–¹æ³•éƒ½å¤±è´¥ï¼Œç»§ç»­ä½†ä¸åŒ…å«è¡¥ä¸)"
          mkdir -p SGSI-build-tool/10/SGSI/
          echo "Created empty SGSI directory (åˆ›å»ºäº†ç©ºçš„SGSIç›®å½•)"

      - name: Create Final Package (åˆ›å»ºæœ€ç»ˆåŒ…)
        run: |
          echo "=== Create Final Package (åˆ›å»ºæœ€ç»ˆåŒ…) ==="
          
          # Create upload directory
          mkdir -p upload
          
          # Check if SGSI directory exists and has content
          if [[ ! -d "SGSI-build-tool/10/SGSI" ]]; then
            echo "âš ï¸ SGSI directory does not exist, creating empty one (SGSIç›®å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºç©ºç›®å½•)"
            mkdir -p SGSI-build-tool/10/SGSI/
          fi
          
          echo "ğŸ“ Contents of SGSI directory (SGSIç›®å½•å†…å®¹):"
          ls -la SGSI-build-tool/10/SGSI/ 2>/dev/null || echo "Cannot list SGSI directory"
          
          output_file="${{ steps.config.outputs.pack_sgsi }}"
          
          echo "ğŸ“¦ Creating package: $output_file"
          
          # Create zip package
          if zip -r "$output_file" SGSI-build-tool/10/SGSI/ 2>/dev/null; then
            echo "âœ… Package created successfully (åŒ…åˆ›å»ºæˆåŠŸ)"
          else
            echo "âš ï¸ Standard zip failed, trying with no compression (æ ‡å‡†zipå¤±è´¥ï¼Œå°è¯•æ— å‹ç¼©)..."
            if zip -r -0 "$output_file" SGSI-build-tool/10/SGSI/ 2>/dev/null; then
              echo "âœ… Package created with no compression (æ— å‹ç¼©åŒ…åˆ›å»ºæˆåŠŸ)"
            else
              echo "âŒ All zip methods failed, creating empty package (æ‰€æœ‰zipæ–¹æ³•å¤±è´¥ï¼Œåˆ›å»ºç©ºåŒ…)..."
              mkdir -p temp_sgsi
              echo "No patches available" > temp_sgsi/README.txt
              zip "$output_file" temp_sgsi/README.txt
              rm -rf temp_sgsi
            fi
          fi
          
          # Verify the package was created
          if [[ ! -f "$output_file" ]]; then
            echo "::error::âŒ Package file was not created (åŒ…æ–‡ä»¶æœªåˆ›å»º)"
            exit 1
          fi
          
          # Move to upload directory
          mv "$output_file" upload/ 2>/dev/null || true
          
          echo "ğŸ“ Final artifacts in upload/ (æœ€ç»ˆäº§ç‰©):"
          ls -lh upload/ 2>/dev/null || echo "Upload directory is empty"
          
          # Set upload directory environment variable
          echo "UPLOAD_DIR=upload" >> $GITHUB_ENV
          
          echo "âœ… Final packaging completed (æœ€ç»ˆæ‰“åŒ…å®Œæˆ)"
          df -h

      - name: Create Release (åˆ›å»ºå‘å¸ƒ)
        id: create_release
        run: |
          echo "=== Create Release Info (åˆ›å»ºå‘å¸ƒä¿¡æ¯) ==="
          
          current_date=$(date +"%Y%m%d")
          timestamp=$(date +"%H%M")
          
          # Determine ROM type
          rom_type="Generic"
          if [ "${{ steps.config.outputs.make_miui }}" = "true" ]; then rom_type="MIUI"; fi
          if [ "${{ steps.config.outputs.make_flyme }}" = "true" ]; then rom_type="Flyme"; fi
          if [ "${{ steps.config.outputs.make_coloros }}" = "true" ]; then rom_type="ColorOS"; fi
          if [ "${{ steps.config.outputs.make_h2os }}" = "true" ]; then rom_type="H2OS"; fi
          if [ "${{ steps.config.outputs.make_smartisanos }}" = "true" ]; then rom_type="SmartisanOS"; fi
          if [ "${{ steps.config.outputs.make_zui }}" = "true" ]; then rom_type="ZUI"; fi
          
          release_tag="${current_date}-${timestamp}-${rom_type}-1.9"
          build_time=$(date +"%Y-%m-%d %H:%M")
          
          {
            echo "release_tag=$release_tag"
            echo "build_time=$build_time" 
            echo "rom_type=$rom_type"
          } >> $GITHUB_OUTPUT
          
          echo "ğŸ·ï¸ Release Tag: $release_tag"
          echo "ğŸ• Build Time: $build_time"
          echo "ğŸ“± ROM Type: $rom_type"

      - name: Upload Release (ä¸Šä¼ å‘å¸ƒ)
        uses: ncipollo/release-action@v1.8.6
        with:
          artifacts: '${{ env.UPLOAD_DIR }}/*'
          name: 'SGSI Build ${{ steps.create_release.outputs.release_tag }}'
          tag: '${{ steps.create_release.outputs.release_tag }}'
          body: |
            ## ğŸ“± SGSI Build Information
            
            ### Build Details
            - **Build Time:** ${{ steps.create_release.outputs.build_time }}
            - **ROM Type:** ${{ steps.create_release.outputs.rom_type }}
            - **Android Version:** ${{ steps.build_sgsi.outputs.android_version }}
            - **Device Model:** ${{ steps.build_sgsi.outputs.model }}
            - **Build Date:** ${{ steps.build_sgsi.outputs.build_date }}
            - **Patches Applied:** ${{ steps.simple_patches.outputs.patch_count || steps.alternative_patches.outputs.alternative_count || '0' }}
            
            ### Download
            Artifacts are available for download below.
            
            ### Notes
            This is an automated SGSI build using XiaoxinTools 1.9
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Completion Summary (å®Œæˆæ€»ç»“)
        if: success()
        run: |
          echo "ğŸ‰ Build Process Completed! (æ„å»ºè¿‡ç¨‹å®Œæˆ!)"
          echo "ğŸ·ï¸ Release: ${{ steps.create_release.outputs.release_tag }}"
          echo "ğŸ“¦ Artifacts: ${{ env.UPLOAD_DIR }}"
          echo "ğŸ“Š Simple Patches: ${{ steps.simple_patches.outputs.patch_count || '0' }}"
          echo "ğŸ”„ Alternative Patches: ${{ steps.alternative_patches.outputs.alternative_count || '0' }}"
          echo "ğŸ“± Device: ${{ steps.build_sgsi.outputs.model || 'Unknown' }}"
          echo "ğŸ¤– Android: ${{ steps.build_sgsi.outputs.android_version || 'Unknown' }}"
