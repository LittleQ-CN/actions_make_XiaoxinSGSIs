name: Build_XiaoxinSGSIs_Ai-Edit [1.9]

on:
  workflow_dispatch:  # Manual trigger only / ä»…æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
      - name: "Checkout Code (æ£€å‡ºä»£ç )"
        uses: actions/checkout@v4
        
      - name: "Initial Setup & Cleanup (åˆå§‹è®¾ç½®å’Œæ¸…ç†)"
        run: |
          echo "ğŸ’¾ Initial disk space (åˆå§‹ç£ç›˜ç©ºé—´):"
          df -h
          echo "ğŸ§¹ Starting aggressive cleanup (å¼€å§‹æ¿€è¿›æ¸…ç†)..."
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/* /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"
          echo "âœ… Initial cleanup completed (åˆå§‹æ¸…ç†å®Œæˆ)"
          df -h
       
      - name: "Configuration Check & Setup (é…ç½®æ£€æŸ¥å’Œè®¾ç½®)"
        run: |
          echo "=== Configuration Check (é…ç½®æ£€æŸ¥) ==="
          if [[ ! -f "sgsi.json" ]]; then
            echo "::error::âŒ Missing sgsi.json config file (ç¼ºå°‘sgsi.jsoné…ç½®æ–‡ä»¶)"
            exit 1
          fi
          
          echo "âœ… sgsi.json file exists (sgsi.jsonæ–‡ä»¶å­˜åœ¨)"
          echo "File content (æ–‡ä»¶å†…å®¹):"
          cat sgsi.json
       
      - name: "Parse Configuration (è§£æé…ç½®)"
        id: config
        run: |
          echo "=== Parse Configuration (è§£æé…ç½®) ==="
          rom_url=$(jq -r '.rom_url // empty' sgsi.json)
          if [[ -z "$rom_url" ]]; then
            echo "::error::âŒ Missing rom_url field in sgsi.json (sgsi.jsonä¸­ç¼ºå°‘rom_urlå­—æ®µ)"
            exit 1
          fi
          
          echo "ğŸ“‹ Configuration Info (é…ç½®ä¿¡æ¯):"
          echo "ROM URL: $rom_url"
          echo "ROM Name: $(jq -r '.rom_name // "unknown_rom"' sgsi.json)"
          echo "Pack SGSI: $(jq -r '.pack_sgsi // "SGSI.zip"' sgsi.json)"
          
          {
            echo "rom_url=$rom_url"
            echo "rom_name=$(jq -r '.rom_name // "unknown_rom"' sgsi.json)"
            echo "pack_sgsi=$(jq -r '.pack_sgsi // "SGSI.zip"' sgsi.json)"
            echo "make_miui=$(jq -r '.make_miui // "false"' sgsi.json)"
            echo "make_flyme=$(jq -r '.make_flyme // "false"' sgsi.json)"
            echo "make_coloros=$(jq -r '.make_coloros // "false"' sgsi.json)"
            echo "make_h2os=$(jq -r '.make_h2os // "false"' sgsi.json)"
            echo "make_smartisanos=$(jq -r '.make_smartisanos // "false"' sgsi.json)"
            echo "make_zui=$(jq -r '.make_zui // "false"' sgsi.json)"
            echo "make_super=$(jq -r '.make_super // "false"' sgsi.json)"
          } >> $GITHUB_OUTPUT
           
      - name: "Install Tools & Download Build Tools (å®‰è£…å·¥å…·å’Œä¸‹è½½æ„å»ºå·¥å…·)"
        run: |
          echo "=== Install Essential Tools (å®‰è£…å¿…è¦å·¥å…·) ==="
          sudo apt-get update
          sudo apt-get install -y aria2 curl jq zip unzip python3 file rsync
          sudo apt-get clean
          
          echo "ğŸ“¥ Downloading build tools (ä¸‹è½½æ„å»ºå·¥å…·)..."
          tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar"
          max_retries=5
          
          for i in $(seq 1 $max_retries); do
            echo "Attempt $i/$max_retries (å°è¯• $i/$max_retries)..."
            if curl -fL -o "SGSI-build-tool.tar" "$tool_url"; then
              echo "âœ… Download successful (ä¸‹è½½æˆåŠŸ)"
              break
            elif [ $i -eq $max_retries ]; then
              echo "::error::âŒ Build tools download failed (æ„å»ºå·¥å…·ä¸‹è½½å¤±è´¥)"
              exit 1
            fi
            sleep 10
          done
          
          echo "ğŸ“‚ Extracting build tools (è§£å‹æ„å»ºå·¥å…·)..."
          if ! sudo tar -xf SGSI-build-tool.tar; then
            echo "::error::âŒ Failed to extract build tools (è§£å‹æ„å»ºå·¥å…·å¤±è´¥)"
            exit 1
          fi
          
          rm -f SGSI-build-tool.tar
          echo "âœ… Environment setup completed (ç¯å¢ƒè®¾ç½®å®Œæˆ)"
          df -h
          
      - name: "Setup Build Environment (è®¾ç½®æ„å»ºç¯å¢ƒ)"
        run: |
          echo "=== Setup Build Environment (è®¾ç½®æ„å»ºç¯å¢ƒ) ==="
          
          # Remove existing setup script and replace with custom one
          sudo rm -rf SGSI-build-tool/10/setup.sh
          if [[ -f "bin/setup.sh" ]]; then
            sudo mv bin/setup.sh SGSI-build-tool/10/
          fi
          
          # Run setup script
          cd SGSI-build-tool/10
          if [[ -f "setup.sh" ]]; then
            sudo bash setup.sh
          fi
          cd ../..
          
          # Fix directory permissions
          sudo chown -R $(id -u):$(id -g) SGSI-build-tool
          sudo chmod -R 755 SGSI-build-tool
          echo "âœ… Build environment setup completed (æ„å»ºç¯å¢ƒè®¾ç½®å®Œæˆ)"

      - name: "Download ROM File (ä¸‹è½½ROMæ–‡ä»¶)"
        run: |
          rom_path="SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
          rom_url="${{ steps.config.outputs.rom_url }}"
          
          sudo mkdir -p "$(dirname "$rom_path")"
          echo "ğŸš€ Starting ROM download: ${{ steps.config.outputs.rom_name }}"
          
          max_retries=3
          download_success=false
          
          # Try aria2 first (ä¼˜å…ˆä½¿ç”¨aria2)
          if command -v aria2c &> /dev/null; then
            echo "âš¡ Using aria2 multi-threaded download (ä½¿ç”¨aria2å¤šçº¿ç¨‹ä¸‹è½½)"
            for i in $(seq 1 $max_retries); do
              if sudo aria2c -x 8 -s 8 -k 1M "$rom_url" -d "$(dirname "$rom_path")" -o "$(basename "$rom_path")"; then
                download_success=true
                break
              else
                echo "Download attempt $i/$max_retries failed with aria2 - retrying..."
                sudo rm -f "$rom_path" || true
                sleep 15
              fi
            done
          fi
          
          # Fallback to curl (å¤‡ç”¨curl)
          if [ "$download_success" = false ] && command -v curl &> /dev/null; then
            echo "âš¡ Using curl download (ä½¿ç”¨curlä¸‹è½½)"
            for i in $(seq 1 $max_retries); do
              if sudo curl -fL -o "$rom_path" "$rom_url"; then
                download_success=true
                break
              else
                echo "Download attempt $i/$max_retries failed with curl - retrying..."
                sudo rm -f "$rom_path" || true
                sleep 15
              fi
            done
          fi
          
          if [ ! -f "$rom_path" ]; then
            echo "::error::âŒ ROM download failed after $max_retries attempts (ROMä¸‹è½½å¤±è´¥)"
            exit 1
          fi
          
          file_size=$(stat -c%s "$rom_path" 2>/dev/null || echo "0")
          echo "ğŸ‰ ROM download completed: $(numfmt --to=iec $file_size) (ROMä¸‹è½½å®Œæˆ)"
          df -h

      - name: "ROM Configuration (ROMé…ç½®)"
        run: |
          echo "=== ROM Configuration (ROMé…ç½®) ==="
          
          # Determine ROM type and apply specific configuration
          rom_type="Generic"
          if [ "${{ steps.config.outputs.make_miui }}" = "true" ]; then 
            rom_type="MIUI"
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/MIUI.sh" ]]; then
              sudo cp fix/MIUI.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          if [ "${{ steps.config.outputs.make_flyme }}" = "true" ]; then 
            rom_type="Flyme" 
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/Flyme.sh" ]]; then
              sudo cp fix/Flyme.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          if [ "${{ steps.config.outputs.make_coloros }}" = "true" ]; then 
            rom_type="ColorOS"
            # ColorOS decryption
            if [[ -f "SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py" ]]; then
              echo "ğŸ”“ Decrypting ColorOS OZIP (è§£å¯†ColorOS OZIP)..."
              sudo python3 SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py "SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
              sudo rm -f "SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
            fi
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/ColorOS.sh" ]]; then
              sudo cp fix/ColorOS.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          if [ "${{ steps.config.outputs.make_h2os }}" = "true" ]; then 
            rom_type="H2OS"
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/H2OS.sh" ]]; then
              sudo cp fix/H2OS.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          if [ "${{ steps.config.outputs.make_smartisanos }}" = "true" ]; then 
            rom_type="SmartisanOS"
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/SmartisanOS.sh" ]]; then
              sudo cp fix/SmartisanOS.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          if [ "${{ steps.config.outputs.make_zui }}" = "true" ]; then 
            rom_type="ZUI"
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/ZUI.sh" ]]; then
              sudo cp fix/ZUI.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          # Super SGSI configuration
          if [ "${{ steps.config.outputs.make_super }}" = "true" ] && [[ -f "SGSI-build-tool/10/make.sh" ]]; then
            sudo sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' SGSI-build-tool/10/make.sh
            echo "âœ… Super SGSI configured (Super SGSIé…ç½®å®Œæˆ)"
          fi
          
          echo "ğŸ“± ROM Type: $rom_type (ROMç±»å‹: $rom_type)"
          echo "âœ… ROM configuration completed (ROMé…ç½®å®Œæˆ)"

      - name: "Prepare Build Scripts (å‡†å¤‡æ„å»ºè„šæœ¬)"
        run: |
          echo "=== Prepare Build Scripts (å‡†å¤‡æ„å»ºè„šæœ¬) ==="
          
          # Remove existing scripts
          rm -rf SGSI-build-tool/10/SGSI.sh SGSI-build-tool/10/makeimg.sh SGSI-build-tool/10/dynamic_SGSI.sh SGSI-build-tool/10/oppo.sh SGSI-build-tool/10/make.sh 2>/dev/null || true
          
          # Copy custom build scripts
          if [[ -d "make" ]]; then
            echo "ğŸ“ Copying build scripts (å¤åˆ¶æ„å»ºè„šæœ¬)..."
            for script in makeimg.sh SGSI.sh dynamic_SGSI.sh oppo.sh make.sh; do
              if [[ -f "make/$script" ]]; then
                sudo cp "make/$script" SGSI-build-tool/10/
                echo "âœ… Copied $script"
              fi
            done
          fi
          
          # Copy binary tools
          if [[ -d "bin" ]]; then
            echo "ğŸ”§ Copying binary tools (å¤åˆ¶äºŒè¿›åˆ¶å·¥å…·)..."
            for tool in mke2fs e2fsdroid; do
              if [[ -f "bin/$tool" ]]; then
                sudo mkdir -p SGSI-build-tool/10/bin
                sudo cp "bin/$tool" SGSI-build-tool/10/bin/
                echo "âœ… Copied $tool"
              fi
            done
          fi
          
          # Set execution permissions
          sudo find SGSI-build-tool/10 -name "*.sh" -exec chmod +x {} \;
          echo "âœ… Build scripts preparation completed (æ„å»ºè„šæœ¬å‡†å¤‡å®Œæˆ)"

      - name: "Build SGSI Images (æ„å»ºSGSIé•œåƒ)"
        id: build_sgsi
        run: |
          echo "=== Build SGSI Images (æ„å»ºSGSIé•œåƒ) ==="
          cd SGSI-build-tool/10
          
          echo "ğŸ§¹ Cleaning disk space before build (æ„å»ºå‰æ¸…ç†ç£ç›˜ç©ºé—´)..."
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
          
          echo "ğŸ—ï¸ Starting SGSI build (å¼€å§‹æ„å»ºSGSI)..."
          build_start=$(date +%s)
          
          if ! sudo bash make.sh 2>&1 | tee make.log; then
            echo "::error::âŒ Build failed (æ„å»ºå¤±è´¥)"
            
            # Error analysis
            if grep -q "out of memory" make.log; then
              echo "::error::ğŸ’¥ Insufficient memory (å†…å­˜ä¸è¶³)"
            elif grep -q "No space left" make.log; then
              echo "::error::ğŸ’¥ Disk space exhausted (ç£ç›˜ç©ºé—´è€—å°½)"
              df -h
            elif grep -q "Permission denied" make.log; then
              echo "::error::ğŸ’¥ Permission issues (æƒé™é—®é¢˜)"
            fi
            
            tail -100 make.log
            exit 1
          fi
          
          build_end=$(date +%s)
          build_duration=$((build_end - build_start))
          echo "â±ï¸ Build completed in $(($build_duration / 60))m $(($build_duration % 60))s (æ„å»ºç”¨æ—¶)"
          
          # Fix output permissions
          sudo chown -R $(id -u):$(id -g) out/
          sudo chmod -R 755 out/
          
          if [[ ! -d "./out/system" ]]; then
            echo "::error::âŒ Build output not found (æ„å»ºäº§å‡ºæœªæ‰¾åˆ°)"
            exit 1
          fi
          
          # Extract build info from build.prop
          if [[ -f "./out/system/system/build.prop" ]]; then
            sudo chmod 644 ./out/system/system/build.prop
            
            model=$(grep 'ro.product.model' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            device_codename=$(grep -E 'ro.product.(device|name|board|hardware)' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            security_patch=$(grep 'ro.build.version.security_patch' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            android_version=$(grep 'ro.build.version.release' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            build_date=$(grep 'ro.build.date' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            rom_version=$(grep -E 'ro.(build|system|product).(version|display).(incremental|id|name)' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            build_id=$(grep 'ro.build.id' ./out/system/system/build.prop | head -1 | cut -d'=' -f 2 | tr -d '[:space:]' || echo "Unknown")
            
            {
              echo "model=$model"
              echo "device_codename=$device_codename"
              echo "security_patch=$security_patch"
              echo "android_version=$android_version" 
              echo "build_date=$build_date"
              echo "rom_version=$rom_version"
              echo "build_id=$build_id"
            } >> $GITHUB_OUTPUT
            
            echo "ğŸ“± Build Info: $model, Android $android_version, $build_date"
          else
            echo "model=Unknown" >> $GITHUB_OUTPUT
            echo "device_codename=Unknown" >> $GITHUB_OUTPUT
            echo "security_patch=Unknown" >> $GITHUB_OUTPUT
            echo "android_version=Unknown" >> $GITHUB_OUTPUT
            echo "build_date=Unknown" >> $GITHUB_OUTPUT
            echo "rom_version=Unknown" >> $GITHUB_OUTPUT
            echo "build_id=Unknown" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸ’¾ Disk space after build (æ„å»ºåç£ç›˜ç©ºé—´):"
          df -h

      - name: "Clean Intermediate Files (æ¸…ç†ä¸­é—´æ–‡ä»¶)"
        run: |
          echo "=== Clean Intermediate Files (æ¸…ç†ä¸­é—´æ–‡ä»¶) ==="
          echo "ğŸ§¹ Cleaning intermediate files to free space (æ¸…ç†ä¸­é—´æ–‡ä»¶é‡Šæ”¾ç©ºé—´)..."
          sudo rm -rf SGSI-build-tool/10/tmp/*
          
          # Delete build log if too large
          if [[ -f "SGSI-build-tool/10/make.log" ]]; then
            log_size=$(stat -c%s "SGSI-build-tool/10/make.log")
            if [[ $log_size -gt 104857600 ]]; then
              echo "ğŸ—‘ï¸ Removing large build log (åˆ é™¤å¤§å‹æ„å»ºæ—¥å¿—)..."
              rm -f SGSI-build-tool/10/make.log
            fi
          fi
          
          echo "âœ… Intermediate files cleaned (ä¸­é—´æ–‡ä»¶å·²æ¸…ç†)"
          df -h

      - name: "Debug Patch Directory (è°ƒè¯•è¡¥ä¸ç›®å½•)"
        run: |
          echo "=== Debug Patch Directory (è°ƒè¯•è¡¥ä¸ç›®å½•) ==="
          echo "ğŸ“ Current working directory (å½“å‰å·¥ä½œç›®å½•):"
          pwd
          echo "ğŸ“ Directory structure (ç›®å½•ç»“æ„):"
          ls -la
          
          if [[ -d "Patch" ]]; then
            echo "âœ… Patch directory exists (è¡¥ä¸ç›®å½•å­˜åœ¨)"
            echo "ğŸ“ Patch directory contents (è¡¥ä¸ç›®å½•å†…å®¹):"
            ls -la Patch/
            
            for i in 1 2 3; do
              patch_dir="Patch/Patch${i}"
              if [[ -d "$patch_dir" ]]; then
                echo "âœ… $patch_dir exists ($patch_dir å­˜åœ¨)"
                echo "ğŸ“ $patch_dir contents ($patch_dir å†…å®¹):"
                ls -la "$patch_dir"
                file_count=$(find "$patch_dir" -type f | wc -l)
                echo "ğŸ“Š $patch_dir file count: $file_count ($patch_dir æ–‡ä»¶æ•°é‡: $file_count)"
              else
                echo "âŒ $patch_dir does not exist ($patch_dir ä¸å­˜åœ¨)"
              fi
            done
          else
            echo "âŒ Patch directory does not exist (è¡¥ä¸ç›®å½•ä¸å­˜åœ¨)"
          fi
          
          echo "ğŸ’¾ Current disk space (å½“å‰ç£ç›˜ç©ºé—´):"
          df -h

      - name: "Check Disk Space (æ£€æŸ¥ç£ç›˜ç©ºé—´)"
        run: |
          echo "ğŸ’¾ Disk space check (ç£ç›˜ç©ºé—´æ£€æŸ¥):"
          df -h
          available_space=$(df . | awk 'NR==2 {print $4}')
          if [[ $available_space -lt 1048576 ]]; then
            echo "âš ï¸ Low disk space, cleaning temp files (ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œæ¸…ç†ä¸´æ—¶æ–‡ä»¶)..."
            sudo rm -rf /tmp/* /var/tmp/*
            sudo apt-get clean
            echo "ğŸ’¾ Disk space after cleanup (æ¸…ç†åç£ç›˜ç©ºé—´):"
            df -h
          fi

      - name: "Package Patches - Method 1 (ZIPæ‰“åŒ…)"
        id: package_patches_zip
        run: |
          echo "=== Package Patches - ZIP Method (è¡¥ä¸æ‰“åŒ… - ZIPæ–¹æ³•) ==="
          
          # Ensure patch directory exists
          if [[ ! -d "Patch" ]]; then
            echo "â„¹ï¸ No Patch directory found, skipping patch packaging (æœªæ‰¾åˆ°Patchç›®å½•ï¼Œè·³è¿‡è¡¥ä¸æ‰“åŒ…)"
            echo "patch_method=none" >> $GITHUB_OUTPUT
            echo "patch_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Create target directory
          mkdir -p SGSI-build-tool/10/SGSI/
          
          echo "ğŸ’¾ Disk space before patch packaging (è¡¥ä¸æ‰“åŒ…å‰ç£ç›˜ç©ºé—´):"
          df -h
          
          # Check each patch directory and package
          patch_count=0
          for i in {1..3}; do
            patch_dir="Patch/Patch${i}"
            output_file="Patch${i}.zip"
            
            if [[ -d "$patch_dir" ]] && [[ -n "$(ls -A "$patch_dir" 2>/dev/null)" ]]; then
              echo "ğŸ“¦ Packaging patch $i: $patch_dir â†’ $output_file (æ‰“åŒ…è¡¥ä¸ $i)"
              
              # Check patch directory contents
              echo "ğŸ“ Patch directory contents (è¡¥ä¸ç›®å½•å†…å®¹):"
              ls -la "$patch_dir" || echo "Cannot list patch directory (æ— æ³•åˆ—å‡ºè¡¥ä¸ç›®å½•)"
              
              # Use safer packaging method
              echo "ğŸ”§ Starting packaging (å¼€å§‹æ‰“åŒ…)..."
              if (cd "$patch_dir" && zip -r "../$output_file" . -q); then
                echo "âœ… Patch packaging successful: $output_file (è¡¥ä¸æ‰“åŒ…æˆåŠŸ: $output_file)"
                # Check generated file
                if [[ -f "../$output_file" ]]; then
                  file_size=$(stat -c%s "../$output_file" 2>/dev/null || echo "0")
                  echo "ğŸ“¦ Package file size: $(numfmt --to=iec $file_size) (æ‰“åŒ…æ–‡ä»¶å¤§å°)"
                  # Try to move file
                  if mv "../$output_file" "SGSI-build-tool/10/SGSI/" 2>/dev/null; then
                    echo "âœ… File move successful (æ–‡ä»¶ç§»åŠ¨æˆåŠŸ)"
                    ((patch_count++))
                  elif sudo mv "../$output_file" "SGSI-build-tool/10/SGSI/" 2>/dev/null; then
                    echo "âœ… File move successful (using sudo) (æ–‡ä»¶ç§»åŠ¨æˆåŠŸ - ä½¿ç”¨sudo)"
                    ((patch_count++))
                  else
                    echo "âš ï¸ Cannot move file $output_file (æ— æ³•ç§»åŠ¨æ–‡ä»¶ $output_file)"
                    # Clean up file
                    rm -f "../$output_file" 2>/dev/null || true
                  fi
                else
                  echo "âŒ Package file not generated (æ‰“åŒ…æ–‡ä»¶æœªç”Ÿæˆ)"
                fi
              else
                echo "âŒ Patch packaging failed: $patch_dir (è¡¥ä¸æ‰“åŒ…å¤±è´¥: $patch_dir)"
                # Clean up possible incomplete files
                rm -f "../$output_file" 2>/dev/null || true
              fi
            else
              echo "â„¹ï¸ Patch directory does not exist or is empty: $patch_dir (è¡¥ä¸ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º: $patch_dir)"
            fi
            echo "---"
          done
          
          echo "âœ… Patch file packaging completed, successfully packaged $patch_count patches (è¡¥ä¸æ–‡ä»¶æ‰“åŒ…å®Œæˆï¼ŒæˆåŠŸæ‰“åŒ… $patch_count ä¸ªè¡¥ä¸)"
          
          # Save results
          echo "patch_method=zip" >> $GITHUB_OUTPUT
          echo "patch_count=$patch_count" >> $GITHUB_OUTPUT
          
          echo "ğŸ’¾ Disk space after packaging (æ‰“åŒ…åç£ç›˜ç©ºé—´):"
          df -h

      - name: "Package Patches - Method 2 (File Copy)"
        id: package_patches_copy
        if: steps.package_patches_zip.outputs.patch_count == '0'
        run: |
          echo "=== Package Patches - File Copy Method (è¡¥ä¸æ‰“åŒ… - æ–‡ä»¶å¤åˆ¶æ–¹æ³•) ==="
          
          # Check if patch directory exists
          if [[ ! -d "Patch" ]]; then
            echo "â„¹ï¸ No Patch directory found, skipping patch processing (æœªæ‰¾åˆ°Patchç›®å½•ï¼Œè·³è¿‡è¡¥ä¸å¤„ç†)"
            echo "patch_method=none" >> $GITHUB_OUTPUT
            echo "patch_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ğŸ’¾ Current disk space (å½“å‰ç£ç›˜ç©ºé—´):"
          df -h
          
          # First fix SGSI directory permissions
          echo "ğŸ”§ Fixing SGSI directory permissions (ä¿®å¤SGSIç›®å½•æƒé™)..."
          sudo mkdir -p SGSI-build-tool/10/SGSI/
          sudo chown -R $(id -u):$(id -g) SGSI-build-tool/10/SGSI/
          sudo chmod -R 755 SGSI-build-tool/10/SGSI/
          
          # Try simple file copying instead of packaging
          patch_count=0
          for i in 1 2 3; do
            patch_dir="Patch/Patch${i}"
            if [[ -d "$patch_dir" ]] && [[ -n "$(ls -A "$patch_dir" 2>/dev/null)" ]]; then
              echo "ğŸ“ Copying patch directory: $patch_dir (å¤åˆ¶è¡¥ä¸ç›®å½•: $patch_dir)"
              
              # Create target directory (don't use sudo, since we've fixed permissions)
              target_dir="SGSI-build-tool/10/SGSI/Patch${i}"
              mkdir -p "$target_dir"
              
              echo "ğŸ”§ Starting file copy (å¼€å§‹å¤åˆ¶æ–‡ä»¶)..."
              if cp -r "$patch_dir"/* "$target_dir"/ 2>/dev/null; then
                echo "âœ… Patch $i copy successful (è¡¥ä¸ $i å¤åˆ¶æˆåŠŸ)"
                ((patch_count++))
              else
                echo "âš ï¸ Patch $i copy failed, checking permissions (è¡¥ä¸ $i å¤åˆ¶å¤±è´¥ï¼Œæ£€æŸ¥æƒé™)..."
                # Check source and target directory permissions
                echo "ğŸ“ Source directory permissions: $(ls -ld "$patch_dir" 2>/dev/null || echo "æ— æ³•è®¿é—®")"
                echo "ğŸ“ Target directory permissions: $(ls -ld "$target_dir" 2>/dev/null || echo "æ— æ³•è®¿é—®")"
                
                # Try using tar to preserve permissions
                echo "ğŸ”„ Trying to copy using tar (å°è¯•ä½¿ç”¨tarå¤åˆ¶)..."
                if (cd "$patch_dir" && tar cf - . | (cd "$target_dir" && tar xf -)); then
                  echo "âœ… Patch $i copy successful (using tar) (è¡¥ä¸ $i å¤åˆ¶æˆåŠŸ - ä½¿ç”¨tar)"
                  ((patch_count++))
                else
                  echo "âŒ All copy methods failed for patch $i (è¡¥ä¸ $i æ‰€æœ‰å¤åˆ¶æ–¹æ³•éƒ½å¤±è´¥)"
                fi
              fi
            else
              echo "â„¹ï¸ Patch directory $patch_dir does not exist or is empty (è¡¥ä¸ç›®å½• $patch_dir ä¸å­˜åœ¨æˆ–ä¸ºç©º)"
            fi
            echo "---"
          done
          
          echo "Patch processing completed: $patch_count successful (è¡¥ä¸å¤„ç†å®Œæˆ: $patch_count ä¸ªæˆåŠŸ)"
          echo "Using file copy method instead of ZIP packaging (ä½¿ç”¨æ–‡ä»¶å¤åˆ¶æ–¹å¼æ›¿ä»£ZIPæ‰“åŒ…)"
          
          # Save results
          echo "patch_method=copy" >> $GITHUB_OUTPUT
          echo "patch_count=$patch_count" >> $GITHUB_OUTPUT
          
          echo "ğŸ’¾ Disk space after copying (å¤åˆ¶åç£ç›˜ç©ºé—´):"
          df -h

      - name: "Package Patches - Method 3 (Optimized ZIP)"
        id: package_patches_optimized
        if: steps.package_patches_zip.outputs.patch_count == '0' && steps.package_patches_copy.outputs.patch_count == '0'
        run: |
          echo "=== Package Patches - Optimized ZIP Method (è¡¥ä¸æ‰“åŒ… - ä¼˜åŒ–ZIPæ–¹æ³•) ==="
          
          if [[ ! -d "Patch" ]]; then
            echo "patch_method=none" >> $GITHUB_OUTPUT
            echo "patch_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Create target directory
          mkdir -p SGSI-build-tool/10/SGSI/
          
          patch_count=0
          # Only process existing patch directories
          for i in 1 2 3; do
            if [[ -d "Patch/Patch${i}" ]] && [[ -n "$(ls Patch/Patch${i}/ 2>/dev/null)" ]]; then
              echo "ğŸ”„ Creating optimized ZIP for Patch${i} (ä¸ºè¡¥ä¸${i}åˆ›å»ºä¼˜åŒ–ZIP)..."
              
              # Use optimized zip with compression level 0 (store only)
              if (cd "Patch/Patch${i}" && zip -r -0 "../Patch${i}.zip" . -q); then
                if [[ -f "Patch${i}.zip" ]]; then
                  mv "Patch${i}.zip" "SGSI-build-tool/10/SGSI/" && ((patch_count++))
                  echo "âœ… Optimized Patch${i} created (ä¼˜åŒ–è¡¥ä¸${i}åˆ›å»ºæˆåŠŸ)"
                fi
              fi
            fi
          done
          
          echo "patch_method=optimized_zip" >> $GITHUB_OUTPUT
          echo "patch_count=$patch_count" >> $GITHUB_OUTPUT
          echo "âœ… Optimized patch packaging completed (ä¼˜åŒ–è¡¥ä¸æ‰“åŒ…å®Œæˆ)"

      - name: "Create Final Package (åˆ›å»ºæœ€ç»ˆåŒ…)"
        run: |
          echo "=== Create Final Package (åˆ›å»ºæœ€ç»ˆåŒ…) ==="
          cd SGSI-build-tool/10
          
          echo "ğŸ“ Current directory: $(pwd)"
          echo "ğŸ“ Directory contents (ç›®å½•å†…å®¹):"
          ls -la
          
          # Verify SGSI directory exists and has content
          if [[ ! -d "SGSI" ]]; then
            echo "::error::âŒ SGSI directory does not exist! (SGSIç›®å½•ä¸å­˜åœ¨ï¼)"
            echo "ğŸ“ Current directory contents (å½“å‰ç›®å½•å†…å®¹):"
            ls -la
            exit 1
          fi
          
          if [[ -z "$(ls -A SGSI/ 2>/dev/null)" ]]; then
            echo "::error::âŒ SGSI directory is empty! (SGSIç›®å½•ä¸ºç©ºï¼)"
            echo "ğŸ“ SGSI directory contents (SGSIç›®å½•å†…å®¹):"
            ls -la SGSI/ || echo "Cannot list SGSI directory (æ— æ³•åˆ—å‡ºSGSIç›®å½•)"
            exit 1
          fi
          
          echo "ğŸ“ SGSI directory contents (SGSIç›®å½•å†…å®¹):"
          ls -la SGSI/
          
          # Create output filename
          output_file="${{ steps.config.outputs.pack_sgsi }}"
          
          # Fix file ownership
          echo "Fixing file ownership (ä¿®å¤æ–‡ä»¶æ‰€æœ‰æƒ)..."
          sudo chown -R $(id -u):$(id -g) SGSI/
          sudo chmod -R 755 SGSI/
          
          # Package files
          echo "Packaging SGSI to: $output_file"
          echo "ğŸ’¾ Disk space before packaging (æ‰“åŒ…å‰ç£ç›˜ç©ºé—´):"
          df -h
          
          if ! zip -r -q "$output_file" SGSI/*; then
            echo "::error::âŒ Packaging failed! (æ‰“åŒ…å¤±è´¥ï¼)"
            echo "Trying to package with verbose mode (å°è¯•ä½¿ç”¨è¯¦ç»†æ¨¡å¼é‡æ–°æ‰“åŒ…)..."
            if ! zip -r "$output_file" SGSI/*; then
              echo "::error::âŒ Verbose mode packaging also failed (è¯¦ç»†æ¨¡å¼æ‰“åŒ…ä¹Ÿå¤±è´¥)"
              exit 1
            fi
          fi
          
          # Verify package file
          if [[ ! -f "$output_file" ]]; then
            echo "::error::âŒ Output file was not created (è¾“å‡ºæ–‡ä»¶æœªåˆ›å»º)"
            exit 1
          fi
          
          file_size=$(stat -c%s "$output_file")
          if [[ $file_size -eq 0 ]]; then
            echo "::error::âŒ Output file is empty (è¾“å‡ºæ–‡ä»¶ä¸ºç©º)"
            exit 1
          fi
          
          echo "âœ… Package created: $output_file ($(numfmt --to=iec-i $file_size))"
          
          # Prepare upload directory
          mkdir -p "${GITHUB_WORKSPACE}/upload"
          max_size=2000000000  # 2GB
          
          # Check file size and split if necessary
          if [[ $file_size -gt $max_size ]]; then
            echo "âš ï¸ File too large, splitting into parts (æ–‡ä»¶è¿‡å¤§ï¼Œè¿›è¡Œåˆ†å·æ‰“åŒ…)..."
            split -b 1500m -d -a 1 "$output_file" "${output_file}_part"
            mv "${output_file}_part"* "${GITHUB_WORKSPACE}/upload/"
            rm "$output_file"
            echo "Split file list (åˆ†å·æ–‡ä»¶åˆ—è¡¨):"
            ls -lh "${GITHUB_WORKSPACE}/upload"
          else
            echo "Moving file to upload directory (ç§»åŠ¨æ–‡ä»¶åˆ°ä¸Šä¼ ç›®å½•)"
            mv "$output_file" "${GITHUB_WORKSPACE}/upload/"
          fi
          
          # Ensure upload directory has content
          echo "=== Upload directory contents (ä¸Šä¼ ç›®å½•å†…å®¹) ==="
          ls -lh "${GITHUB_WORKSPACE}/upload" || { echo "âŒ Upload directory is empty! (ä¸Šä¼ ç›®å½•ä¸ºç©ºï¼)"; exit 1; }
          echo "===================="
          
          # Save upload directory path
          echo "UPLOAD_DIR=${GITHUB_WORKSPACE}/upload" >> $GITHUB_ENV
          
          echo "ğŸ’¾ Final disk space (æœ€ç»ˆç£ç›˜ç©ºé—´):"
          df -h
             
      - name: "Upload to GitHub Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: sgsi-build-artifacts
          path: ${{ env.UPLOAD_DIR }}/*
          retention-days: 30
        continue-on-error: true
             
      - name: "Generate Release Tag and Time Info (ç”Ÿæˆå‘å¸ƒæ ‡ç­¾å’Œæ—¶é—´ä¿¡æ¯)"
        id: release_tag
        run: |
          current_date=$(TZ='Asia/Shanghai' date +"%Y%m%d")
          timestamp=$(TZ='Asia/Shanghai' date +"%H%M")
          
          rom_type="Generic"
          if [ "${{ steps.config.outputs.make_miui }}" = "true" ]; then rom_type="MIUI"; fi
          if [ "${{ steps.config.outputs.make_flyme }}" = "true" ]; then rom_type="Flyme"; fi
          if [ "${{ steps.config.outputs.make_coloros }}" = "true" ]; then rom_type="ColorOS"; fi
          if [ "${{ steps.config.outputs.make_h2os }}" = "true" ]; then rom_type="H2OS"; fi
          if [ "${{ steps.config.outputs.make_smartisanos }}" = "true" ]; then rom_type="SmartisanOS"; fi
          if [ "${{ steps.config.outputs.make_zui }}" = "true" ]; then rom_type="ZUI"; fi
          
          release_tag="${current_date}_${timestamp}-${rom_type}-1.9"
          echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
          
          build_time=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %p %I:%M")
          build_time=$(echo "$build_time" | sed -e 's/AM/ä¸Šåˆ/' -e 's/PM/ä¸‹åˆ/')
          build_time="${build_time} [åŒ—äº¬æ—¶é—´]"
          echo "build_time=$build_time" >> $GITHUB_OUTPUT
          
          original_build_date="${{ steps.build_sgsi.outputs.build_date }}"
          if [[ "$original_build_date" != "Unknown" ]]; then
            parsed_date=$(echo "$original_build_date" | sed -E 's/([a-zA-Z]{3})([a-zA-Z]{3})([0-9]{2})([0-9]{2}:[0-9]{2}:[0-9]{2})([A-Z]{3})([0-9]{4})/\1 \2 \3 \4 \5 \6/' 2>/dev/null)
            formatted_date=$(date -d "$parsed_date" "+%Y-%m-%d %H:%M:%S %Z" 2>/dev/null || echo "$original_build_date")
            echo "formatted_build_date=$formatted_date" >> $GITHUB_OUTPUT
          else
            echo "formatted_build_date=Unknown" >> $GITHUB_OUTPUT
          fi
          
          model="${{ steps.build_sgsi.outputs.model }}"
          device_codename="${{ steps.build_sgsi.outputs.device_codename }}"
          if [[ "$model" == "Unknown" && "$device_codename" == "Unknown" ]]; then
            source_device="Unknown"
          elif [[ "$model" == "Unknown" ]]; then
            source_device="$device_codename"
          elif [[ "$device_codename" == "Unknown" ]]; then
            source_device="$model"
          else
            source_device="$model [$device_codename]"
          fi
          echo "source_device=$source_device" >> $GITHUB_OUTPUT
          
          echo "rom_type=$rom_type" >> $GITHUB_OUTPUT
          
          echo "Generated release tag: $release_tag (ç”Ÿæˆçš„å‘å¸ƒæ ‡ç­¾: $release_tag)"
          echo "Build time: $build_time (æ„å»ºæ—¶é—´: $build_time)"
          echo "ROM type: $rom_type (ROM ç±»å‹: $rom_type)"
          
      - name: "Create Release (åˆ›å»ºå‘å¸ƒ)"
        uses: softprops/action-gh-release@v1
        with:
          name: "Auto Build SGSI With XiaoxinTools [${{ steps.release_tag.outputs.release_tag }}]"
          tag_name: "${{ steps.release_tag.outputs.release_tag }}"
          files: "${{ env.UPLOAD_DIR }}/*"
          body: |
            ##  ğŸ“± SGSI Build Information (æ„å»ºä¿¡æ¯)
            
            ### åŸºç¡€ä¿¡æ¯ (Basic Info)
            - **æ„å»ºæ—¶é—´ (Built at):** ${{ steps.release_tag.outputs.build_time }}
            - **åŸåŒ…æœºå‹ (Source Device):** ${{ steps.release_tag.outputs.source_device }}
            - **ROM ç±»å‹ (ROM Type):** ${{ steps.release_tag.outputs.rom_type }}
            - **Android ç‰ˆæœ¬ (Android Version):** ${{ steps.build_sgsi.outputs.android_version }}
            - **ROM ç‰ˆæœ¬ (ROM Version):** ${{ steps.build_sgsi.outputs.rom_version }}
            - **æ„å»º ID (Build ID):** ${{ steps.build_sgsi.outputs.build_id }}
            - **å®‰å…¨è¡¥ä¸ (Security Patch):** ${{ steps.build_sgsi.outputs.security_patch }}
            - **åŸæ„å»ºæ—¥æœŸ (Source Build Date):** ${{ steps.release_tag.outputs.formatted_build_date }}
            - **è¡¥ä¸æ‰“åŒ…æ–¹å¼:** ${{ steps.package_patches_zip.outputs.patch_method || steps.package_patches_copy.outputs.patch_method || steps.package_patches_optimized.outputs.patch_method || 'None' }}
            - **è¡¥ä¸æ•°é‡:** ${{ steps.package_patches_zip.outputs.patch_count || steps.package_patches_copy.outputs.patch_count || steps.package_patches_optimized.outputs.patch_count || '0' }}
            
            ### ä¸‹è½½é“¾æ¥ (Download Links)
            - **GitHub Artifactsï¼ˆ30å¤©ä¿ç•™ï¼‰:** [ç‚¹å‡»ä¸‹è½½](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)
            
            ### å…¶ä»–ä¿¡æ¯ (Other Info)
            - **æ„å»ºå·¥å…· (Build Tools):** XiaoxinTools_1.9 (Only for Android 10/AB)
            - **æ„å»ºæ—¥å¿— (Build Log):** [View Details](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) (ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†æ—¥å¿—)
            
            ---
            
             âš ï¸ **å®éªŒæ€§æ„å»º (Experimental Build):**  
            This is an experimental build and may have stability issues. Please test before using as a daily driver.  
            è¿™æ˜¯å®éªŒæ€§æ„å»ºï¼Œå¯èƒ½å­˜åœ¨ç¨³å®šæ€§é—®é¢˜ï¼Œè¯·æµ‹è¯•åå†ä½œä¸ºä¸»åŠ›ç³»ç»Ÿä½¿ç”¨ã€‚
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: "Completion Notification (å®Œæˆé€šçŸ¥)"
        if: success()
        run: |
          echo "ğŸ‰ Build completed! (æ„å»ºå®Œæˆ!)"
          echo "Release tag: ${{ steps.release_tag.outputs.release_tag }} (å‘å¸ƒæ ‡ç­¾)"
          echo "Artifact location: ${{ env.UPLOAD_DIR }} (äº§ç‰©ä½ç½®)"
          echo "Patch method: ${{ steps.package_patches_zip.outputs.patch_method || steps.package_patches_copy.outputs.patch_method || steps.package_patches_optimized.outputs.patch_method || 'None' }}"
          echo "Patch count: ${{ steps.package_patches_zip.outputs.patch_count || steps.package_patches_copy.outputs.patch_count || steps.package_patches_optimized.outputs.patch_count || '0' }}"
