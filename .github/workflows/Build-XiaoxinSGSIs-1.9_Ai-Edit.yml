name: Build_XiaoxinSGSIs_Ai-Edit [1.9]

on:
  workflow_dispatch:  # Manual trigger only / ä»…æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
      - name: Checkout Code (æ£€å‡ºä»£ç )
        uses: actions/checkout@v4
        
      - name: Initial Setup & Cleanup (åˆå§‹è®¾ç½®å’Œæ¸…ç†)
        run: |
          echo "ğŸ’¾ Initial disk space (åˆå§‹ç£ç›˜ç©ºé—´):"
          df -h
          echo "ğŸ§¹ Starting aggressive cleanup (å¼€å§‹æ¿€è¿›æ¸…ç†)..."
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/* /usr/share/dotnet /opt/ghc /usr/local/share/boost "$AGENT_TOOLSDIRECTORY"
          echo "âœ… Initial cleanup completed (åˆå§‹æ¸…ç†å®Œæˆ)"
          df -h
       
      - name: Configuration Check & Setup (é…ç½®æ£€æŸ¥å’Œè®¾ç½®)
        run: |
          echo "=== Configuration Check (é…ç½®æ£€æŸ¥) ==="
          if [[ ! -f "sgsi.json" ]]; then
            echo "::error::âŒ Missing sgsi.json config file (ç¼ºå°‘sgsi.jsoné…ç½®æ–‡ä»¶)"
            exit 1
          fi
          
          echo "âœ… sgsi.json file exists (sgsi.jsonæ–‡ä»¶å­˜åœ¨)"
          echo "File content (æ–‡ä»¶å†…å®¹):"
          cat sgsi.json
       
      - name: Parse Configuration (è§£æé…ç½®)
        id: config
        run: |
          echo "=== Parse Configuration (è§£æé…ç½®) ==="
          rom_url=$(jq -r '.rom_url // empty' sgsi.json)
          if [[ -z "$rom_url" ]]; then
            echo "::error::âŒ Missing rom_url field in sgsi.json (sgsi.jsonä¸­ç¼ºå°‘rom_urlå­—æ®µ)"
            exit 1
          fi
          
          echo "ğŸ“‹ Configuration Info (é…ç½®ä¿¡æ¯):"
          echo "ROM URL: $rom_url"
          echo "ROM Name: $(jq -r '.rom_name // "unknown_rom"' sgsi.json)"
          echo "Pack SGSI: $(jq -r '.pack_sgsi // "SGSI.zip"' sgsi.json)"
          
          {
            echo "rom_url=$rom_url"
            echo "rom_name=$(jq -r '.rom_name // "unknown_rom"' sgsi.json)"
            echo "pack_sgsi=$(jq -r '.pack_sgsi // "SGSI.zip"' sgsi.json)"
            echo "make_miui=$(jq -r '.make_miui // "false"' sgsi.json)"
            echo "make_flyme=$(jq -r '.make_flyme // "false"' sgsi.json)"
            echo "make_coloros=$(jq -r '.make_coloros // "false"' sgsi.json)"
            echo "make_h2os=$(jq -r '.make_h2os // "false"' sgsi.json)"
            echo "make_smartisanos=$(jq -r '.make_smartisanos // "false"' sgsi.json)"
            echo "make_zui=$(jq -r '.make_zui // "false"' sgsi.json)"
            echo "make_super=$(jq -r '.make_super // "false"' sgsi.json)"
          } >> $GITHUB_OUTPUT
           
      - name: Install Tools & Download Build Tools (å®‰è£…å·¥å…·å’Œä¸‹è½½æ„å»ºå·¥å…·)
        run: |
          echo "=== Install Essential Tools (å®‰è£…å¿…è¦å·¥å…·) ==="
          sudo apt-get update
          sudo apt-get install -y aria2 curl jq zip unzip python3 file
          sudo apt-get clean
          
          echo "ğŸ“¥ Downloading build tools (ä¸‹è½½æ„å»ºå·¥å…·)..."
          tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar"
          max_retries=5
          
          for i in $(seq 1 $max_retries); do
            echo "Attempt $i/$max_retries (å°è¯• $i/$max_retries)..."
            if curl -fL -o "SGSI-build-tool.tar" "$tool_url"; then
              echo "âœ… Download successful (ä¸‹è½½æˆåŠŸ)"
              break
            elif [ $i -eq $max_retries ]; then
              echo "::error::âŒ Build tools download failed (æ„å»ºå·¥å…·ä¸‹è½½å¤±è´¥)"
              exit 1
            fi
            sleep 10
          done
          
          echo "ğŸ“‚ Extracting build tools (è§£å‹æ„å»ºå·¥å…·)..."
          if ! sudo tar -xf SGSI-build-tool.tar; then
            echo "::error::âŒ Failed to extract build tools (è§£å‹æ„å»ºå·¥å…·å¤±è´¥)"
            exit 1
          fi
          
          rm -f SGSI-build-tool.tar
          echo "âœ… Environment setup completed (ç¯å¢ƒè®¾ç½®å®Œæˆ)"
          df -h
          
      - name: Setup Build Environment (è®¾ç½®æ„å»ºç¯å¢ƒ)
        run: |
          echo "=== Setup Build Environment (è®¾ç½®æ„å»ºç¯å¢ƒ) ==="
          
          # Remove existing setup script and replace with custom one
          sudo rm -rf SGSI-build-tool/10/setup.sh
          if [[ -f "bin/setup.sh" ]]; then
            sudo mv bin/setup.sh SGSI-build-tool/10/
          fi
          
          # Run setup script
          cd SGSI-build-tool/10
          if [[ -f "setup.sh" ]]; then
            sudo bash setup.sh
          fi
          cd ../..
          
          # Fix directory permissions
          sudo chown -R $(id -u):$(id -g) SGSI-build-tool
          sudo chmod -R 755 SGSI-build-tool
          echo "âœ… Build environment setup completed (æ„å»ºç¯å¢ƒè®¾ç½®å®Œæˆ)"

      - name: Download ROM File (ä¸‹è½½ROMæ–‡ä»¶)
        run: |
          rom_path="SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
          rom_url="${{ steps.config.outputs.rom_url }}"
          
          sudo mkdir -p "$(dirname "$rom_path")"
          echo "ğŸš€ Starting ROM download: ${{ steps.config.outputs.rom_name }}"
          
          max_retries=3
          download_success=false
          
          # Try aria2 first (ä¼˜å…ˆä½¿ç”¨aria2)
          if command -v aria2c &> /dev/null; then
            echo "âš¡ Using aria2 multi-threaded download (ä½¿ç”¨aria2å¤šçº¿ç¨‹ä¸‹è½½)"
            for i in $(seq 1 $max_retries); do
              if sudo aria2c -x 8 -s 8 -k 1M "$rom_url" -d "$(dirname "$rom_path")" -o "$(basename "$rom_path")"; then
                download_success=true
                break
              else
                echo "Download attempt $i/$max_retries failed with aria2 - retrying..."
                sudo rm -f "$rom_path" || true
                sleep 15
              fi
            done
          fi
          
          # Fallback to curl (å¤‡ç”¨curl)
          if [ "$download_success" = false ] && command -v curl &> /dev/null; then
            echo "âš¡ Using curl download (ä½¿ç”¨curlä¸‹è½½)"
            for i in $(seq 1 $max_retries); do
              if sudo curl -fL -o "$rom_path" "$rom_url"; then
                download_success=true
                break
              else
                echo "Download attempt $i/$max_retries failed with curl - retrying..."
                sudo rm -f "$rom_path" || true
                sleep 15
              fi
            done
          fi
          
          if [ ! -f "$rom_path" ]; then
            echo "::error::âŒ ROM download failed after $max_retries attempts (ROMä¸‹è½½å¤±è´¥)"
            exit 1
          fi
          
          file_size=$(stat -c%s "$rom_path" 2>/dev/null || echo "0")
          echo "ğŸ‰ ROM download completed: $(numfmt --to=iec $file_size) (ROMä¸‹è½½å®Œæˆ)"
          df -h

      - name: ROM Configuration (ROMé…ç½®)
        run: |
          echo "=== ROM Configuration (ROMé…ç½®) ==="
          
          # Determine ROM type and apply specific configuration
          rom_type="Generic"
          if [ "${{ steps.config.outputs.make_miui }}" = "true" ]; then 
            rom_type="MIUI"
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/MIUI.sh" ]]; then
              sudo cp fix/MIUI.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          if [ "${{ steps.config.outputs.make_flyme }}" = "true" ]; then 
            rom_type="Flyme" 
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/Flyme.sh" ]]; then
              sudo cp fix/Flyme.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          if [ "${{ steps.config.outputs.make_coloros }}" = "true" ]; then 
            rom_type="ColorOS"
            # ColorOS decryption
            if [[ -f "SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py" ]]; then
              echo "ğŸ”“ Decrypting ColorOS OZIP (è§£å¯†ColorOS OZIP)..."
              sudo python3 SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py "SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
              sudo rm -f "SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
            fi
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/ColorOS.sh" ]]; then
              sudo cp fix/ColorOS.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          if [ "${{ steps.config.outputs.make_h2os }}" = "true" ]; then 
            rom_type="H2OS"
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/H2OS.sh" ]]; then
              sudo cp fix/H2OS.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          if [ "${{ steps.config.outputs.make_smartisanos }}" = "true" ]; then 
            rom_type="SmartisanOS"
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/SmartisanOS.sh" ]]; then
              sudo cp fix/SmartisanOS.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          if [ "${{ steps.config.outputs.make_zui }}" = "true" ]; then 
            rom_type="ZUI"
            sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
            if [[ -f "fix/ZUI.sh" ]]; then
              sudo cp fix/ZUI.sh SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          fi
          
          # Super SGSI configuration
          if [ "${{ steps.config.outputs.make_super }}" = "true" ] && [[ -f "SGSI-build-tool/10/make.sh" ]]; then
            sudo sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' SGSI-build-tool/10/make.sh
            echo "âœ… Super SGSI configured (Super SGSIé…ç½®å®Œæˆ)"
          fi
          
          echo "ğŸ“± ROM Type: $rom_type (ROMç±»å‹: $rom_type)"
          echo "âœ… ROM configuration completed (ROMé…ç½®å®Œæˆ)"

      - name: Prepare Build Scripts (å‡†å¤‡æ„å»ºè„šæœ¬)
        run: |
          echo "=== Prepare Build Scripts (å‡†å¤‡æ„å»ºè„šæœ¬) ==="
          
          # Remove existing scripts
          rm -rf SGSI-build-tool/10/SGSI.sh SGSI-build-tool/10/makeimg.sh SGSI-build-tool/10/dynamic_SGSI.sh SGSI-build-tool/10/oppo.sh SGSI-build-tool/10/make.sh 2>/dev/null || true
          
          # Copy custom build scripts
          if [[ -d "make" ]]; then
            echo "ğŸ“ Copying build scripts (å¤åˆ¶æ„å»ºè„šæœ¬)..."
            for script in makeimg.sh SGSI.sh dynamic_SGSI.sh oppo.sh make.sh; do
              if [[ -f "make/$script" ]]; then
                sudo cp "make/$script" SGSI-build-tool/10/
                echo "âœ… Copied $script"
              fi
            done
          fi
          
          # Copy binary tools
          if [[ -d "bin" ]]; then
            echo "ğŸ”§ Copying binary tools (å¤åˆ¶äºŒè¿›åˆ¶å·¥å…·)..."
            for tool in mke2fs e2fsdroid; do
              if [[ -f "bin/$tool" ]]; then
                sudo mkdir -p SGSI-build-tool/10/bin
                sudo cp "bin/$tool" SGSI-build-tool/10/bin/
                echo "âœ… Copied $tool"
              fi
            done
          fi
          
          # Set execution permissions
          sudo find SGSI-build-tool/10 -name "*.sh" -exec chmod +x {} \;
          echo "âœ… Build scripts preparation completed (æ„å»ºè„šæœ¬å‡†å¤‡å®Œæˆ)"

      - name: Build SGSI Images (æ„å»ºSGSIé•œåƒ)
        id: build_sgsi
        run: |
          echo "=== Build SGSI Images (æ„å»ºSGSIé•œåƒ) ==="
          cd SGSI-build-tool/10
          
          echo "ğŸ§¹ Cleaning disk space before build (æ„å»ºå‰æ¸…ç†ç£ç›˜ç©ºé—´)..."
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
          
          echo "ğŸ—ï¸ Starting SGSI build (å¼€å§‹æ„å»ºSGSI)..."
          build_start=$(date +%s)
          
          if ! sudo bash make.sh 2>&1 | tee make.log; then
            echo "::error::âŒ Build failed (æ„å»ºå¤±è´¥)"
            
            # Error analysis
            if grep -q "out of memory" make.log; then
              echo "::error::ğŸ’¥ Insufficient memory (å†…å­˜ä¸è¶³)"
            elif grep -q "No space left" make.log; then
              echo "::error::ğŸ’¥ Disk space exhausted (ç£ç›˜ç©ºé—´è€—å°½)"
              df -h
            elif grep -q "Permission denied" make.log; then
              echo "::error::ğŸ’¥ Permission issues (æƒé™é—®é¢˜)"
            fi
            
            tail -100 make.log
            exit 1
          fi
          
          build_end=$(date +%s)
          build_duration=$((build_end - build_start))
          echo "â±ï¸ Build completed in $(($build_duration / 60))m $(($build_duration % 60))s (æ„å»ºç”¨æ—¶)"
          
          # Fix output permissions
          sudo chown -R $(id -u):$(id -g) out/
          sudo chmod -R 755 out/
          
          if [[ ! -d "./out/system" ]]; then
            echo "::error::âŒ Build output not found (æ„å»ºäº§å‡ºæœªæ‰¾åˆ°)"
            exit 1
          fi
          
          # Extract build info from build.prop
          if [[ -f "./out/system/system/build.prop" ]]; then
            sudo chmod 644 ./out/system/system/build.prop
            
            model=$(grep 'ro.product.model' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            android_version=$(grep 'ro.build.version.release' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            build_date=$(grep 'ro.build.date' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            
            {
              echo "model=$model"
              echo "android_version=$android_version" 
              echo "build_date=$build_date"
            } >> $GITHUB_OUTPUT
            
            echo "ğŸ“± Build Info: $model, Android $android_version, $build_date"
          else
            echo "model=Unknown" >> $GITHUB_OUTPUT
            echo "android_version=Unknown" >> $GITHUB_OUTPUT
            echo "build_date=Unknown" >> $GITHUB_OUTPUT
          fi
          
          echo "ğŸ’¾ Disk space after build (æ„å»ºåç£ç›˜ç©ºé—´):"
          df -h

      - name: Debug Patch Directory Structure (è°ƒè¯•è¡¥ä¸ç›®å½•ç»“æ„)
        run: |
          echo "=== Debug Patch Directory Structure (è°ƒè¯•è¡¥ä¸ç›®å½•ç»“æ„) ==="
          
          echo "ğŸ“ Current working directory (å½“å‰å·¥ä½œç›®å½•):"
          pwd
          
          echo "ğŸ“ Root directory structure (æ ¹ç›®å½•ç»“æ„):"
          ls -la
          
          echo "ğŸ“ Patch directory structure (è¡¥ä¸ç›®å½•ç»“æ„):"
          if [[ -d "Patch" ]]; then
            ls -la Patch/
            for i in 1 2 3; do
              patch_dir="Patch/Patch${i}"
              if [[ -d "$patch_dir" ]]; then
                echo "ğŸ“ Patch${i} directory contents (Patch${i} ç›®å½•å†…å®¹):"
                ls -la "$patch_dir"
                echo "ğŸ“Š Patch${i} file count (æ–‡ä»¶æ•°é‡): $(find "$patch_dir" -type f | wc -l)"
              else
                echo "âŒ Patch${i} directory not found (Patch${i} ç›®å½•ä¸å­˜åœ¨)"
              fi
            done
          else
            echo "âŒ Patch directory not found (è¡¥ä¸ç›®å½•ä¸å­˜åœ¨)"
          fi
          
          echo "ğŸ” Checking SGSI directory permissions (æ£€æŸ¥SGSIç›®å½•æƒé™):"
          if [[ -d "SGSI-build-tool/10/SGSI" ]]; then
            ls -la SGSI-build-tool/10/SGSI/
          else
            echo "SGSI directory does not exist yet (SGSIç›®å½•å°šä¸å­˜åœ¨)"
          fi

      - name: Fix All Permissions (ä¿®å¤æ‰€æœ‰æƒé™)
        run: |
          echo "=== Fix All Permissions (ä¿®å¤æ‰€æœ‰æƒé™) ==="
          
          # Fix patch directory permissions
          for patch_num in 1 2 3; do
            patch_dir="Patch/Patch${patch_num}"
            if [[ -d "$patch_dir" ]]; then
              echo "ğŸ”§ Fixing permissions for $patch_dir (ä¿®å¤ $patch_dir æƒé™)..."
              sudo chown -R $(id -u):$(id -g) "$patch_dir"
              sudo chmod -R 755 "$patch_dir"
              echo "âœ… Permissions fixed for $patch_dir"
            fi
          done
          
          # Ensure SGSI directory exists and has correct permissions
          echo "ğŸ”§ Creating and fixing SGSI directory permissions (åˆ›å»ºå¹¶ä¿®å¤SGSIç›®å½•æƒé™)..."
          sudo mkdir -p SGSI-build-tool/10/SGSI/
          sudo chown -R $(id -u):$(id -g) SGSI-build-tool/10/SGSI/
          sudo chmod -R 755 SGSI-build-tool/10/SGSI/
          
          echo "âœ… All permissions fixed (æ‰€æœ‰æƒé™å·²ä¿®å¤)"

      - name: Process Patch Files (å¤„ç†è¡¥ä¸æ–‡ä»¶)
        id: process_patches
        run: |
          echo "=== Process Patch Files (å¤„ç†è¡¥ä¸æ–‡ä»¶) ==="
          
          # Clean up temporary files to free space
          sudo rm -rf SGSI-build-tool/10/tmp/*
          
          # Check disk space
          available_space=$(df . | awk 'NR==2 {print $4}')
          if [[ $available_space -lt 1048576 ]]; then
            echo "âš ï¸ Low disk space, cleaning temp files (ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œæ¸…ç†ä¸´æ—¶æ–‡ä»¶)..."
            sudo rm -rf /tmp/* /var/tmp/*
            sudo apt-get clean
          fi
          
          patch_count=0
          failed_patches=0
          
          # Process each patch directory with comprehensive error handling
          for patch_num in 1 2 3; do
            patch_dir="Patch/Patch${patch_num}"
            if [[ -d "$patch_dir" ]] && [[ -n "$(ls -A "$patch_dir" 2>/dev/null)" ]]; then
              echo "ğŸ“¦ Processing Patch${patch_num} (å¤„ç†è¡¥ä¸${patch_num})..."
              
              # Create target directory
              target_dir="SGSI-build-tool/10/SGSI/Patch${patch_num}"
              echo "ğŸ“ Target directory: $target_dir (ç›®æ ‡ç›®å½•)"
              
              # Remove existing target directory to avoid conflicts
              if [[ -d "$target_dir" ]]; then
                echo "ğŸ—‘ï¸ Removing existing target directory (åˆ é™¤ç°æœ‰ç›®æ ‡ç›®å½•)..."
                sudo rm -rf "$target_dir"
              fi
              
              # Method 1: Simple copy with detailed error reporting
              echo "ğŸ”„ Attempting simple copy (å°è¯•ç®€å•å¤åˆ¶)..."
              if cp -r "$patch_dir" "$target_dir" 2>&1; then
                ((patch_count++))
                echo "âœ… Patch${patch_num} copied successfully (è¡¥ä¸${patch_num}å¤åˆ¶æˆåŠŸ)"
              else
                echo "âš ï¸ Simple copy failed, trying with sudo (ç®€å•å¤åˆ¶å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨sudo)..."
                
                # Method 2: Copy with sudo
                if sudo cp -r "$patch_dir" "$target_dir" 2>&1; then
                  ((patch_count++))
                  echo "âœ… Patch${patch_num} copied with sudo (è¡¥ä¸${patch_num}ä½¿ç”¨sudoå¤åˆ¶æˆåŠŸ)"
                else
                  echo "âš ï¸ Sudo copy failed, trying rsync (sudoå¤åˆ¶å¤±è´¥ï¼Œå°è¯•rsync)..."
                  
                  # Method 3: Use rsync
                  if rsync -av "$patch_dir/" "$target_dir/" 2>&1; then
                    ((patch_count++))
                    echo "âœ… Patch${patch_num} copied with rsync (è¡¥ä¸${patch_num}ä½¿ç”¨rsyncå¤åˆ¶æˆåŠŸ)"
                  else
                    echo "âš ï¸ Rsync failed, trying tar (rsyncå¤±è´¥ï¼Œå°è¯•tar)..."
                    
                    # Method 4: Use tar for copying
                    if (cd "$(dirname "$patch_dir")" && tar cf - "$(basename "$patch_dir")") | (cd "SGSI-build-tool/10/SGSI/" && tar xf -) 2>&1; then
                      ((patch_count++))
                      echo "âœ… Patch${patch_num} copied using tar (è¡¥ä¸${patch_num}é€šè¿‡tarå¤åˆ¶æˆåŠŸ)"
                    else
                      echo "âŒ All copy methods failed for Patch${patch_num} (æ‰€æœ‰å¤åˆ¶æ–¹æ³•éƒ½å¤±è´¥)"
                      ((failed_patches++))
                      
                      # Debug information
                      echo "ğŸ” Debug information for Patch${patch_num}:"
                      echo "Source: $patch_dir"
                      echo "Target: $target_dir"
                      echo "Source exists: $(test -d "$patch_dir" && echo "Yes" || echo "No")"
                      echo "Target parent exists: $(test -d "$(dirname "$target_dir")" && echo "Yes" || echo "No")"
                      echo "Source permissions: $(ls -ld "$patch_dir" 2>/dev/null || echo "N/A")"
                      echo "Target parent permissions: $(ls -ld "$(dirname "$target_dir")" 2>/dev/null || echo "N/A")"
                    fi
                  fi
                fi
              fi
              
              # Verify the copy was successful
              if [[ -d "$target_dir" ]] && [[ -n "$(ls -A "$target_dir" 2>/dev/null)" ]]; then
                echo "âœ… Patch${patch_num} verification passed (è¡¥ä¸${patch_num}éªŒè¯é€šè¿‡)"
              else
                echo "âŒ Patch${patch_num} verification failed (è¡¥ä¸${patch_num}éªŒè¯å¤±è´¥)"
                ((failed_patches++))
              fi
              
            else
              echo "â„¹ï¸ Patch${patch_num} directory not found or empty (è¡¥ä¸${patch_num}ç›®å½•ä¸å­˜åœ¨æˆ–ä¸ºç©º)"
            fi
            echo "---"
          done
          
          echo "patch_count=$patch_count" >> $GITHUB_OUTPUT
          echo "failed_patches=$failed_patches" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š Patch processing summary (è¡¥ä¸å¤„ç†æ‘˜è¦):"
          echo "âœ… Successful: $patch_count"
          echo "âŒ Failed: $failed_patches"
          
          # Show final directory structure
          echo "ğŸ“ Final SGSI directory structure (æœ€ç»ˆSGSIç›®å½•ç»“æ„):"
          ls -la SGSI-build-tool/10/SGSI/ 2>/dev/null || echo "Cannot list SGSI directory"
          
          df -h

      - name: Create Final Package (åˆ›å»ºæœ€ç»ˆåŒ…)
        if: steps.process_patches.outputs.failed_patches == '0'
        run: |
          echo "=== Create Final Package (åˆ›å»ºæœ€ç»ˆåŒ…) ==="
          
          # Create upload directory
          mkdir -p upload
          
          # Verify SGSI directory exists and has content
          if [[ ! -d "SGSI-build-tool/10/SGSI" ]]; then
            echo "::error::âŒ SGSI directory does not exist (SGSIç›®å½•ä¸å­˜åœ¨)"
            exit 1
          fi
          
          echo "ğŸ“ Contents of SGSI directory (SGSIç›®å½•å†…å®¹):"
          ls -la SGSI-build-tool/10/SGSI/ || echo "Cannot list SGSI directory"
          
          output_file="${{ steps.config.outputs.pack_sgsi }}"
          
          # Fix permissions before packaging
          sudo chown -R $(id -u):$(id -g) SGSI-build-tool/10/SGSI/
          sudo chmod -R 755 SGSI-build-tool/10/SGSI/
          
          echo "ğŸ“¦ Creating package: $output_file"
          
          # Create zip package with better error handling
          cd SGSI-build-tool/10/SGSI
          
          echo "ğŸ” Files to be packaged (å°†è¦æ‰“åŒ…çš„æ–‡ä»¶):"
          find . -type f | head -20
          
          # Go back to root directory and create zip
          cd ../../../
          
          # Use more robust zip command
          if ! zip -r -q "$output_file" SGSI-build-tool/10/SGSI/; then
            echo "âš ï¸ Standard zip failed, trying with different options (æ ‡å‡†zipå¤±è´¥ï¼Œå°è¯•ä¸åŒé€‰é¡¹)..."
            if ! zip -r -q -0 "$output_file" SGSI-build-tool/10/SGSI/; then
              echo "::error::âŒ All zip methods failed (æ‰€æœ‰zipæ–¹æ³•éƒ½å¤±è´¥)"
              exit 1
            fi
          fi
          
          # Verify the package was created
          if [[ ! -f "$output_file" ]]; then
            echo "::error::âŒ Package file was not created (åŒ…æ–‡ä»¶æœªåˆ›å»º)"
            exit 1
          fi
          
          # Check file size and split if necessary
          file_size=$(stat -c%s "$output_file" 2>/dev/null || echo "0")
          max_size=2097152000  # 2GB
          
          echo "ğŸ“Š Package size: $(numfmt --to=iec $file_size)"
          
          if [[ $file_size -gt $max_size ]]; then
            echo "âš ï¸ Package exceeds 2GB, splitting into 1024MB segments (åŒ…è¶…è¿‡2GBï¼Œåˆ†å·å¤„ç†)..."
            
            # Split using tar and split (more reliable method)
            tar -cpzf - "$output_file" | split -d -b 1024m - "upload/${output_file}."
            echo "âœ… Split packaging completed (åˆ†å·æ‰“åŒ…å®Œæˆ)"
            
            # Remove original large file
            rm -f "$output_file"
          else
            echo "ğŸ“¤ Moving single package to upload directory (ç§»åŠ¨å•åŒ…åˆ°ä¸Šä¼ ç›®å½•)"
            mv "$output_file" upload/
          fi
          
          echo "ğŸ“ Final artifacts in upload/ (æœ€ç»ˆäº§ç‰©):"
          ls -lh upload/
          
          # Set upload directory environment variable
          echo "UPLOAD_DIR=upload" >> $GITHUB_ENV
          
          echo "âœ… Final packaging completed (æœ€ç»ˆæ‰“åŒ…å®Œæˆ)"
          df -h

      - name: Skip Packaging Due to Patch Errors (ç”±äºè¡¥ä¸é”™è¯¯è·³è¿‡æ‰“åŒ…)
        if: steps.process_patches.outputs.failed_patches != '0'
        run: |
          echo "âš ï¸ Skipping final packaging due to patch errors (ç”±äºè¡¥ä¸é”™è¯¯è·³è¿‡æœ€ç»ˆæ‰“åŒ…)"
          echo "Failed patches: ${{ steps.process_patches.outputs.failed_patches }}"
          mkdir -p upload
          echo "UPLOAD_DIR=upload" >> $GITHUB_ENV

      - name: Create Release (åˆ›å»ºå‘å¸ƒ)
        id: create_release
        run: |
          echo "=== Create Release Info (åˆ›å»ºå‘å¸ƒä¿¡æ¯) ==="
          
          current_date=$(date +"%Y%m%d")
          timestamp=$(date +"%H%M")
          
          # Determine ROM type
          rom_type="Generic"
          if [ "${{ steps.config.outputs.make_miui }}" = "true" ]; then rom_type="MIUI"; fi
          if [ "${{ steps.config.outputs.make_flyme }}" = "true" ]; then rom_type="Flyme"; fi
          if [ "${{ steps.config.outputs.make_coloros }}" = "true" ]; then rom_type="ColorOS"; fi
          if [ "${{ steps.config.outputs.make_h2os }}" = "true" ]; then rom_type="H2OS"; fi
          if [ "${{ steps.config.outputs.make_smartisanos }}" = "true" ]; then rom_type="SmartisanOS"; fi
          if [ "${{ steps.config.outputs.make_zui }}" = "true" ]; then rom_type="ZUI"; fi
          
          release_tag="${current_date}-${timestamp}-${rom_type}-1.9"
          build_time=$(date +"%Y-%m-%d %H:%M")
          
          {
            echo "release_tag=$release_tag"
            echo "build_time=$build_time" 
            echo "rom_type=$rom_type"
          } >> $GITHUB_OUTPUT
          
          echo "ğŸ·ï¸ Release Tag: $release_tag"
          echo "ğŸ• Build Time: $build_time"
          echo "ğŸ“± ROM Type: $rom_type"

      - name: Upload Release (ä¸Šä¼ å‘å¸ƒ)
        uses: ncipollo/release-action@v1.8.6
        with:
          artifacts: '${{ env.UPLOAD_DIR }}/*'
          name: 'SGSI Build ${{ steps.create_release.outputs.release_tag }}'
          tag: '${{ steps.create_release.outputs.release_tag }}'
          body: |
            ## ğŸ“± SGSI Build Information
            
            ### Build Details
            - **Build Time:** ${{ steps.create_release.outputs.build_time }}
            - **ROM Type:** ${{ steps.create_release.outputs.rom_type }}
            - **Android Version:** ${{ steps.build_sgsi.outputs.android_version }}
            - **Device Model:** ${{ steps.build_sgsi.outputs.model }}
            - **Build Date:** ${{ steps.build_sgsi.outputs.build_date }}
            - **Patches Applied:** ${{ steps.process_patches.outputs.patch_count }}
            - **Patch Errors:** ${{ steps.process_patches.outputs.failed_patches }}
            
            ### Download
            Artifacts are available for download below.
            
            ### Notes
            This is an automated SGSI build using XiaoxinTools 1.9
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Completion Summary (å®Œæˆæ€»ç»“)
        if: success()
        run: |
          echo "ğŸ‰ Build Completed Successfully! (æ„å»ºæˆåŠŸå®Œæˆ!)"
          echo "ğŸ·ï¸ Release: ${{ steps.create_release.outputs.release_tag }}"
          echo "ğŸ“¦ Artifacts: ${{ env.UPLOAD_DIR }}"
          echo "ğŸ“Š Patches: ${{ steps.process_patches.outputs.patch_count }}"
          echo "âŒ Patch Errors: ${{ steps.process_patches.outputs.failed_patches }}"
          echo "ğŸ“± Device: ${{ steps.build_sgsi.outputs.model }}"
          echo "ğŸ¤– Android: ${{ steps.build_sgsi.outputs.android_version }}"
