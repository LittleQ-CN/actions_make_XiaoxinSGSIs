name: Build_XiaoxinSGSIs_Ai-Edit [1.9]
on:
  workflow_dispatch:  # Manual trigger only (ä»…æ‰‹åŠ¨è§¦å‘)

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120
    
    steps:
      - name: "Checkout Code (æ£€å‡ºä»£ç )"
        uses: actions/checkout@v4
        
      - name: "Environment Setup (ç¯å¢ƒè®¾ç½®)"
        run: |
          # Check configuration files (æ£€æŸ¥é…ç½®æ–‡ä»¶)
          if [[ ! -f "sgsi.json" ]]; then
            echo "::error::âŒ Missing sgsi.json config file (ç¼ºå°‘sgsi.jsoné…ç½®æ–‡ä»¶)"
            exit 1
          fi
          
          # Install essential tools (å®‰è£…åŸºç¡€å·¥å…·)
          sudo apt-get update
          sudo apt-get install -y \
            aria2 curl jq brotli \
            android-sdk-libsparse-utils \
            zip unzip file \
            python3 python3-pip
          echo "âœ… Environment setup completed (ç¯å¢ƒè®¾ç½®å®Œæˆ)"

      - name: "Parse Configuration (è§£æé…ç½®)"
        id: config
        run: |
          # Robust JSON parsing (å¥å£®çš„JSONè§£æ)
          rom_url=$(jq -r '.rom_url // empty' sgsi.json)
          if [[ -z "$rom_url" ]]; then
            echo "::error::âŒ Missing rom_url field in sgsi.json (sgsi.jsonä¸­ç¼ºå°‘rom_urlå­—æ®µ)"
            exit 1
          fi
          
          {
            echo "rom_url=$rom_url"
            echo "rom_name=$(jq -r '.rom_name // "unknown_rom"' sgsi.json)"
            echo "pack_sgsi=$(jq -r '.pack_sgsi // "SGSI.zip"' sgsi.json)"
            echo "make_miui=$(jq -r '.make_miui // "false"' sgsi.json)"
            echo "make_flyme=$(jq -r '.make_flyme // "false"' sgsi.json)"
            echo "make_coloros=$(jq -r '.make_coloros // "false"' sgsi.json)"
            echo "make_h2os=$(jq -r '.make_h2os // "false"' sgsi.json)"
            echo "make_smartisanos=$(jq -r '.make_smartisanos // "false"' sgsi.json)"
            echo "make_zui=$(jq -r '.make_zui // "false"' sgsi.json)"
            echo "make_super=$(jq -r '.make_super // "false"' sgsi.json)"
            echo "upload_wetransfer=$(jq -r '.upload_wetransfer // "false"' sgsi.json)"
          } >> $GITHUB_OUTPUT

      - name: "Download Resources (ä¸‹è½½èµ„æº)"
        run: |
          # Download build tools (ä¸‹è½½æ„å»ºå·¥å…·)
          tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar"
          echo "ğŸ”§ Downloading build tools (å¼€å§‹ä¸‹è½½æ„å»ºå·¥å…·)..."
          
          max_retries=5
          for i in $(seq 1 $max_retries); do
            if curl -fL -o "SGSI-build-tool.tar" "$tool_url"; then
              echo "âœ… Build tools download successful (æ„å»ºå·¥å…·ä¸‹è½½æˆåŠŸ)"
              break
            else
              echo "âŒ Download failed (attempt $i/$max_retries) (ä¸‹è½½å¤±è´¥)"
              [[ $i -eq $max_retries ]] && exit 1
              sleep 10
            fi
          done
          
          # Download ROM file (ä¸‹è½½ROMæ–‡ä»¶)
          rom_path="SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
          sudo mkdir -p "$(dirname "$rom_path")"
          echo "ğŸš€ Downloading ROM: ${{ steps.config.outputs.rom_name }}"
          
          for i in $(seq 1 $max_retries); do
            if sudo aria2c -x 8 -s 8 -k 1M --continue=true \
               "${{ steps.config.outputs.rom_url }}" \
               -d "$(dirname "$rom_path")" \
               -o "$(basename "$rom_path")"; then
              echo "âœ… ROM download successful (ROMä¸‹è½½æˆåŠŸ)"
              break
            elif sudo curl -fL -C - -o "$rom_path" "${{ steps.config.outputs.rom_url }}"; then
              echo "âœ… ROM download successful (curl) (ROMä¸‹è½½æˆåŠŸ)"
              break
            else
              echo "âŒ ROM download failed (attempt $i/$max_retries) (ROMä¸‹è½½å¤±è´¥)"
              [[ $i -eq $max_retries ]] && exit 1
              sleep 30
            fi
          done

      - name: "Build Environment Setup (æ„å»ºç¯å¢ƒè®¾ç½®)"
        run: |
          # Extract and setup build tools (è§£å‹å¹¶è®¾ç½®æ„å»ºå·¥å…·)
          echo "ğŸ“‚ Setting up build environment (è®¾ç½®æ„å»ºç¯å¢ƒ)..."
          sudo tar -xf SGSI-build-tool.tar || exit 1
          sudo find SGSI-build-tool -name "*.sh" -exec chmod +x {} \;
          
          # Fix toolchain and permissions (ä¿®å¤å·¥å…·é“¾å’Œæƒé™)
          cd SGSI-build-tool/10
          sudo mkdir -p bin
          for tool in brotli simg2img img2simg mke2fs e2fsck resize2fs file; do
            if tool_path=$(which "$tool" 2>/dev/null) || [[ -x "/usr/bin/$tool" ]]; then
              sudo ln -sf "${tool_path:-/usr/bin/$tool}" "bin/$tool"
              echo "âœ… Linked $tool (å·²é“¾æ¥$tool)"
            else
              echo "::warning::âš ï¸ Tool not found: $tool (æœªæ‰¾åˆ°å·¥å…·: $tool)"
            fi
          done
          
          sudo chown -R $(id -u):$(id -g) ../..
          sudo chmod -R 755 ../..
          echo "âœ… Build environment ready (æ„å»ºç¯å¢ƒå‡†å¤‡å®Œæˆ)"

      - name: "ROM Configuration (ROMé…ç½®)"
        run: |
          echo "ğŸ”§ Configuring ROM settings (é…ç½®ROMè®¾ç½®)..."
          
          # Determine ROM type (ç¡®å®šROMç±»å‹)
          rom_type="Generic"
          [[ "${{ steps.config.outputs.make_miui }}" = "true" ]] && rom_type="MIUI"
          [[ "${{ steps.config.outputs.make_flyme }}" = "true" ]] && rom_type="Flyme"
          [[ "${{ steps.config.outputs.make_coloros }}" = "true" ]] && rom_type="ColorOS"
          [[ "${{ steps.config.outputs.make_h2os }}" = "true" ]] && rom_type="H2OS"
          [[ "${{ steps.config.outputs.make_smartisanos }}" = "true" ]] && rom_type="SmartisanOS"
          [[ "${{ steps.config.outputs.make_zui }}" = "true" ]] && rom_type="ZUI"
          
          echo "â„¹ï¸ ROM type: $rom_type (ROMç±»å‹: $rom_type)"
          
          # Super SGSI configuration (Super SGSIé…ç½®)
          if [[ "${{ steps.config.outputs.make_super }}" = "true" && -f "SGSI-build-tool/10/make.sh" ]]; then
            sudo sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' SGSI-build-tool/10/make.sh
            echo "âœ… Super SGSI configured (Super SGSIé…ç½®å®Œæˆ)"
          fi
          
          # ColorOS decryption (ColorOSè§£å¯†)
          if [[ "$rom_type" = "ColorOS" && -f "SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py" ]]; then
            sudo python3 SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py \
              "SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
            sudo rm -f "SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
            echo "âœ… ColorOS ROM decrypted (ColorOS ROMè§£å¯†å®Œæˆ)"
          fi
          
          # Apply ROM-specific fixes (åº”ç”¨ROMç‰¹å®šä¿®å¤)
          if [[ -f "fix/${rom_type}.sh" ]]; then
            sudo cp "fix/${rom_type}.sh" SGSI-build-tool/10/fixbug/fixbug.sh
            sudo chmod +x SGSI-build-tool/10/fixbug/fixbug.sh
            echo "âœ… $rom_type configuration applied (å·²åº”ç”¨$rom_typeé…ç½®)"
          fi
          
          # Fix script syntax errors (ä¿®å¤è„šæœ¬è¯­æ³•é”™è¯¯)
          cd SGSI-build-tool/10
          echo "Checking and fixing SGSI.sh script errors (æ£€æŸ¥å¹¶ä¿®å¤SGSI.shè„šæœ¬é”™è¯¯)..."
          if [[ -f "SGSI.sh" ]]; then
            # ä¿®å¤ç¬¬9è¡Œå’Œç¬¬12è¡Œçš„å˜é‡å¼•ç”¨é—®é¢˜
            # å°† [ $dynamic = 'y' ] ä¿®å¤ä¸º [ "$dynamic" = 'y' ]
            sudo sed -i '9s/\[ \$dynamic = /[ "$dynamic" = /' SGSI.sh
            sudo sed -i '12s/\[ \$dynamic = /[ "$dynamic" = /' SGSI.sh
            
            # ä¿®å¤å…¶ä»–å¯èƒ½çš„å˜é‡å¼•ç”¨é—®é¢˜
            sudo sed -i 's/\[ \$light = /[ "$light" = /g' SGSI.sh
            sudo sed -i 's/\[ \$mane = /[ "$mane" = /g' SGSI.sh
            
            echo "âœ… Script syntax errors fixed (å·²ä¿®å¤è„šæœ¬è¯­æ³•é”™è¯¯)"
            
            # æ˜¾ç¤ºä¿®å¤åçš„ç›¸å…³è¡Œ
            echo "=== Fixed lines 9 and 12 (ä¿®å¤åçš„ç¬¬9è¡Œå’Œç¬¬12è¡Œ) ==="
            sed -n '9p;12p' SGSI.sh
            echo "=================================================="
          else
            echo "::warning::âš ï¸ SGSI.sh script not found (æœªæ‰¾åˆ°SGSI.shè„šæœ¬)"
          fi
          
          # Prepare build files (å‡†å¤‡æ„å»ºæ–‡ä»¶)
          if [[ -d "../make" ]]; then
            sudo cp -v ../make/*.sh ./
          fi
          if [[ -d "../bin" ]]; then
            sudo mkdir -p bin
            sudo cp -v ../bin/* bin/
          fi
          
          cd ../..

      - name: "Build Process (æ„å»ºè¿‡ç¨‹)"
        id: build_sgsi
        run: |
          cd SGSI-build-tool/10
          
          echo "ğŸ—ï¸ Starting SGSI build (å¼€å§‹æ„å»ºSGSI)..."
          {
            echo "=== Build Started (æ„å»ºå¼€å§‹) ==="
            echo "Start Time (å¼€å§‹æ—¶é—´): $(date)"
            echo "=============================="
          } > build_monitor.log
          
          # Build with monitoring (å¸¦ç›‘æ§çš„æ„å»º)
          timeout 75m bash -c '
            # Disk space monitoring (ç£ç›˜ç©ºé—´ç›‘æ§)
            while true; do
              echo "Disk usage (ç£ç›˜ä½¿ç”¨): $(df -h / | tail -1)" >> build_monitor.log
              sleep 300
            done &
            disk_monitor_pid=$!
            
            if ! sudo bash make.sh 2>&1 | tee -a make.log build_monitor.log; then
              echo "::error::âŒ Build failed! (æ„å»ºå¤±è´¥ï¼)"
              kill $disk_monitor_pid 2>/dev/null || true
              echo "=== Last 100 lines of build log (æ„å»ºæ—¥å¿—æœ€å100è¡Œ) ==="
              tail -100 make.log
              exit 1
            fi
            
            kill $disk_monitor_pid 2>/dev/null || true
          ' || exit $?
          
          echo "ğŸ‰ SGSI build completed (SGSIæ„å»ºå®Œæˆ)"
          
          # Fix permissions and extract info (ä¿®å¤æƒé™å¹¶æå–ä¿¡æ¯)
          sudo chown -R $(id -u):$(id -g) out/
          sudo chmod -R 755 out/
          
          if [[ -f "./out/system/system/build.prop" ]]; then
            sudo chmod 644 ./out/system/system/build.prop
            {
              echo "model=$(grep 'ro.product.model' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")"
              echo "device_codename=$(grep -E 'ro.product.(device|name|board|hardware)' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")"
              echo "security_patch=$(grep 'ro.build.version.security_patch' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")"
              echo "android_version=$(grep 'ro.build.version.release' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")"
              echo "build_date=$(grep 'ro.build.date' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")"
              echo "rom_version=$(grep -E 'ro.(build|system|product).(version|display).(incremental|id|name)' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")"
              echo "build_id=$(grep 'ro.build.id' ./out/system/system/build.prop | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")"
            } >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ build.prop not found (æœªæ‰¾åˆ°build.propæ–‡ä»¶)"
            echo "model=Unknown" >> $GITHUB_OUTPUT
            echo "device_codename=Unknown" >> $GITHUB_OUTPUT
            echo "security_patch=Unknown" >> $GITHUB_OUTPUT
            echo "android_version=Unknown" >> $GITHUB_OUTPUT
            echo "build_date=Unknown" >> $GITHUB_OUTPUT
            echo "rom_version=Unknown" >> $GITHUB_OUTPUT
            echo "build_id=Unknown" >> $GITHUB_OUTPUT
          fi

      - name: "Package Output (æ‰“åŒ…è¾“å‡º)"
        run: |
          echo "ğŸ“¦ Packaging output files (æ‰“åŒ…è¾“å‡ºæ–‡ä»¶)..."
          
          # Package patches (æ‰“åŒ…è¡¥ä¸)
          if [[ -d "Patch" ]]; then
            sudo mkdir -p SGSI-build-tool/10/SGSI/
            for i in {1..3}; do
              patch_dir="Patch/Patch${i}"
              if [[ -d "$patch_dir" ]]; then
                zip -r "Patch${i}.zip" "$patch_dir"/* && \
                sudo mv "Patch${i}.zip" SGSI-build-tool/10/SGSI/ && \
                echo "âœ… Patched packaged: Patch${i} (è¡¥ä¸æ‰“åŒ…å®Œæˆ)"
              fi
            done
          fi
          
          # Package SGSI files (æ‰“åŒ…SGSIæ–‡ä»¶)
          cd SGSI-build-tool/10
          if [[ ! -d "SGSI" ]]; then
            echo "::error::âŒ SGSI directory missing (SGSIç›®å½•ä¸å­˜åœ¨)"
            exit 1
          fi
          
          output_file="${{ steps.config.outputs.pack_sgsi }}"
          sudo chown -R $(id -u):$(id -g) SGSI/
          
          if zip -r "$output_file" SGSI/*; then
            echo "âœ… SGSI packaged successfully (SGSIæ‰“åŒ…æˆåŠŸ)"
          else
            echo "::error::âŒ Packaging failed (æ‰“åŒ…å¤±è´¥)"
            exit 1
          fi
          
          # Prepare upload directory (å‡†å¤‡ä¸Šä¼ ç›®å½•)
          mkdir -p "${GITHUB_WORKSPACE}/upload"
          file_size=$(stat -c%s "$output_file")
          max_size=2000000000  # 2GB
          
          if [[ $file_size -gt $max_size ]]; then
            echo "âš ï¸ File too large, splitting (æ–‡ä»¶è¿‡å¤§ï¼Œè¿›è¡Œåˆ†å·)"
            split -b 1500m -d -a 1 "$output_file" "${output_file}_part"
            mv "${output_file}_part"* "${GITHUB_WORKSPACE}/upload/"
            rm "$output_file"
          else
            mv "$output_file" "${GITHUB_WORKSPACE}/upload/"
          fi
          
          echo "UPLOAD_DIR=${GITHUB_WORKSPACE}/upload" >> $GITHUB_ENV
          echo "ğŸ“ Upload directory ready (ä¸Šä¼ ç›®å½•å‡†å¤‡å®Œæˆ)"

      - name: "Upload Services (ä¸Šä¼ æœåŠ¡)"
        run: |
          echo "ğŸŒ Uploading to services (ä¸Šä¼ åˆ°å„æœåŠ¡)..."
          
          # WeTransfer upload (WeTransferä¸Šä¼ )
          if [[ "${{ steps.config.outputs.upload_wetransfer }}" = "true" && -n "$(ls -A ${{ env.UPLOAD_DIR }})" ]]; then
            response=$(curl -s -F "file=@${{ env.UPLOAD_DIR }}/*" "https://transfer.sh/?expire=7d")
            if [[ $? -eq 0 && -n "$response" && "$response" != *"error"* ]]; then
              echo "link=$response" >> $GITHUB_OUTPUT
              echo "âœ… WeTransfer upload successful (WeTransferä¸Šä¼ æˆåŠŸ): $response"
            else
              echo "::warning::âš ï¸ WeTransfer upload failed (WeTransferä¸Šä¼ å¤±è´¥)"
            fi
          fi

      - name: "Upload Artifacts (ä¸Šä¼ åˆ¶å“)"
        uses: actions/upload-artifact@v4
        with:
          name: sgsi-build-artifacts
          path: ${{ env.UPLOAD_DIR }}/*
          retention-days: 30
        continue-on-error: true

      - name: "Generate Release Info (ç”Ÿæˆå‘å¸ƒä¿¡æ¯)"
        id: release_tag
        run: |
          # Generate unique tag (ç”Ÿæˆå”¯ä¸€æ ‡ç­¾)
          current_date=$(TZ='Asia/Shanghai' date +"%Y%m%d")
          timestamp=$(TZ='Asia/Shanghai' date +"%H%M%S")
          release_tag="${current_date}_${timestamp}"
          
          # Format build time (æ ¼å¼åŒ–æ„å»ºæ—¶é—´)
          build_time=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %p %I:%M")
          build_time=$(echo "$build_time" | sed -e 's/AM/ä¸Šåˆ/' -e 's/PM/ä¸‹åˆ/')
          build_time="${build_time} [åŒ—äº¬æ—¶é—´]"
          
          # Format source build date (æ ¼å¼åŒ–æºæ„å»ºæ—¥æœŸ)
          original_build_date="${{ steps.build_sgsi.outputs.build_date }}"
          if [[ "$original_build_date" != "Unknown" ]]; then
            parsed_date=$(echo "$original_build_date" | sed -E 's/([a-zA-Z]{3})([a-zA-Z]{3})([0-9]{2})([0-9]{2}:[0-9]{2}:[0-9]{2})([A-Z]{3})([0-9]{4})/\1 \2 \3 \4 \5 \6/')
            formatted_date=$(date -d "$parsed_date" "+%Y-%m-%d %H:%M:%S %Z" 2>/dev/null || echo "$original_build_date")
          else
            formatted_date="Unknown"
          fi
          
          # Determine source device (ç¡®å®šæºè®¾å¤‡)
          model="${{ steps.build_sgsi.outputs.model }}"
          device_codename="${{ steps.build_sgsi.outputs.device_codename }}"
          if [[ "$model" == "Unknown" && "$device_codename" == "Unknown" ]]; then
            source_device="Unknown"
          elif [[ "$model" == "Unknown" ]]; then
            source_device="$device_codename"
          elif [[ "$device_codename" == "Unknown" ]]; then
            source_device="$model"
          else
            source_device="$model [$device_codename]"
          fi
          
          # Determine ROM type (ç¡®å®šROMç±»å‹)
          rom_type="Generic"
          [[ "${{ steps.config.outputs.make_miui }}" = "true" ]] && rom_type="MIUI"
          [[ "${{ steps.config.outputs.make_flyme }}" = "true" ]] && rom_type="Flyme"
          [[ "${{ steps.config.outputs.make_coloros }}" = "true" ]] && rom_type="ColorOS"
          [[ "${{ steps.config.outputs.make_h2os }}" = "true" ]] && rom_type="H2OS"
          [[ "${{ steps.config.outputs.make_smartisanos }}" = "true" ]] && rom_type="SmartisanOS"
          [[ "${{ steps.config.outputs.make_zui }}" = "true" ]] && rom_type="ZUI"
          
          {
            echo "release_tag=$release_tag"
            echo "build_time=$build_time"
            echo "formatted_build_date=$formatted_date"
            echo "source_device=$source_device"
            echo "rom_type=$rom_type"
          } >> $GITHUB_OUTPUT

      - name: "Create Release (åˆ›å»ºå‘å¸ƒ)"
        uses: softprops/action-gh-release@v1
        with:
          name: "Auto Build SGSI - XiaoxinTools 1.9-AB [${{ steps.release_tag.outputs.release_tag }}]"
          tag_name: "${{ steps.release_tag.outputs.release_tag }}"
          files: "${{ env.UPLOAD_DIR }}/*"
          body: |
            ## ğŸ“± SGSI Build Information (æ„å»ºä¿¡æ¯)
            
            ### Basic Info (åŸºç¡€ä¿¡æ¯)
            - **Built at (æ„å»ºæ—¶é—´):** ${{ steps.release_tag.outputs.build_time }}
            - **Source Device (åŸåŒ…æœºå‹):** ${{ steps.release_tag.outputs.source_device }}
            - **ROM Type (ROMç±»å‹):** ${{ steps.release_tag.outputs.rom_type }}
            - **Android Version (Androidç‰ˆæœ¬):** ${{ steps.build_sgsi.outputs.android_version }}
            - **ROM Version (ROMç‰ˆæœ¬):** ${{ steps.build_sgsi.outputs.rom_version }}
            - **Build ID (æ„å»ºID):** ${{ steps.build_sgsi.outputs.build_id }}
            - **Security Patch (å®‰å…¨è¡¥ä¸):** ${{ steps.build_sgsi.outputs.security_patch }}
            - **Source Build Date (åŸæ„å»ºæ—¥æœŸ):** ${{ steps.release_tag.outputs.formatted_build_date }}
            
            ### Download Links (ä¸‹è½½é“¾æ¥)
            - **WeTransfer (7 days) (7å¤©æœ‰æ•ˆ):** ${{ steps.upload_wetransfer.outputs.link }}
            - **GitHub Artifacts (30 days) (30å¤©ä¿ç•™):** [Download (ç‚¹å‡»ä¸‹è½½)](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)
            
            ### Other Info (å…¶ä»–ä¿¡æ¯)
            - **Build Tools (æ„å»ºå·¥å…·):** XiaoxinTools_1.9 (Only for Android 10/AB)
            - **Build Log (æ„å»ºæ—¥å¿—):** [View Details (ç‚¹å‡»æŸ¥çœ‹)](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            
            âš ï¸ **Experimental Build (å®éªŒæ€§æ„å»º):**  
            This is an experimental build and may have stability issues. Please test before using as a daily driver.  
            è¿™æ˜¯å®éªŒæ€§æ„å»ºï¼Œå¯èƒ½å­˜åœ¨ç¨³å®šæ€§é—®é¢˜ï¼Œè¯·æµ‹è¯•åå†ä½œä¸ºä¸»åŠ›ç³»ç»Ÿä½¿ç”¨ã€‚
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "Cleanup and Notify (æ¸…ç†å’Œé€šçŸ¥)"
        if: always()
        run: |
          # Cleanup intermediate files (æ¸…ç†ä¸­é—´æ–‡ä»¶)
          sudo rm -rf SGSI-build-tool/10/tmp/* || true
          sudo rm -rf SGSI-build-tool/10/out/system/ || true
          
          # Save logs (ä¿å­˜æ—¥å¿—)
          if [[ -f "SGSI-build-tool/10/make.log" ]]; then
            mkdir -p "${GITHUB_WORKSPACE}/logs"
            cp SGSI-build-tool/10/make.log "${GITHUB_WORKSPACE}/logs/" || true
          fi
          
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "ğŸ‰ Build completed successfully! (æ„å»ºæˆåŠŸå®Œæˆï¼)"
            echo "ğŸ“ Artifacts: ${{ env.UPLOAD_DIR }}"
          else
            echo "âŒ Build failed or cancelled (æ„å»ºå¤±è´¥æˆ–è¢«å–æ¶ˆ)"
            echo "=== Error Summary (é”™è¯¯æ€»ç»“) ==="
            if [[ -f "SGSI-build-tool/10/make.log" ]]; then
              grep -i -A5 -B5 "error\|failed" SGSI-build-tool/10/make.log | tail -50 || true
            fi
          fi
          
          echo "ğŸ’¾ Final disk space (æœ€ç»ˆç£ç›˜ç©ºé—´):"
          df -h
