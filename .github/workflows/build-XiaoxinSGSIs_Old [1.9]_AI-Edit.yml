name: build_XiaoxinSGSIs_Ai-Edit [1.9-AB]

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘ï¼ˆManual Triggerï¼‰

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120  # æ„å»ºè¶…æ—¶æ—¶é—´ï¼ˆ120åˆ†é’Ÿï¼‰

    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆè·å–ä»“åº“ä¸­çš„é…ç½®æ–‡ä»¶å’Œè„šæœ¬ï¼‰
      - name: "Checkout Code (æ£€å‡ºä»£ç )"
        uses: actions/checkout@v4
        
      # 2. æ£€æŸ¥é…ç½®æ–‡ä»¶çŠ¶æ€ï¼ˆç¡®ä¿sgsi.jsonå­˜åœ¨ä¸”åŒ…å«å¿…è¦å­—æ®µï¼‰
      - name: "Check Config Status (æ£€æŸ¥é…ç½®æ–‡ä»¶çŠ¶æ€)"
        run: |
          # æ£€æŸ¥sgsi.jsonæ˜¯å¦å­˜åœ¨
          if [[ ! -f "sgsi.json" ]]; then
            echo "::error::âŒ ç¼ºå°‘é…ç½®æ–‡ä»¶sgsi.jsonï¼ˆMissing config file sgsi.jsonï¼‰"
            exit 1
          fi
          
          # æ£€æŸ¥rom_urlå­—æ®µæ˜¯å¦å­˜åœ¨ï¼ˆå¿…å¡«ï¼‰
          rom_url=$(jq -r '.rom_url // empty' sgsi.json)
          if [[ -z "$rom_url" ]]; then
            echo "::error::âŒ sgsi.jsonä¸­ç¼ºå°‘rom_urlå­—æ®µï¼ˆMissing rom_url in sgsi.jsonï¼‰"
            exit 1
          fi
          
          # æ£€æŸ¥rom_nameå­—æ®µæ˜¯å¦å­˜åœ¨ï¼ˆå¿…å¡«ï¼‰
          rom_name=$(jq -r '.rom_name // empty' sgsi.json)
          if [[ -z "$rom_name" ]]; then
            echo "::error::âŒ sgsi.jsonä¸­ç¼ºå°‘rom_nameå­—æ®µï¼ˆMissing rom_name in sgsi.jsonï¼‰"
            exit 1
          fi
          
          # æ£€æŸ¥pack_sgsiå­—æ®µæ˜¯å¦å­˜åœ¨ï¼ˆå¿…å¡«ï¼‰
          pack_sgsi=$(jq -r '.pack_sgsi // empty' sgsi.json)
          if [[ -z "$pack_sgsi" ]]; then
            echo "::error::âŒ sgsi.jsonä¸­ç¼ºå°‘pack_sgsiå­—æ®µï¼ˆMissing pack_sgsi in sgsi.jsonï¼‰"
            exit 1
          fi
          
          echo "âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡ï¼ˆConfig file validatedï¼‰"
       
      # 3. æ¸…ç†ç¯å¢ƒï¼ˆé‡Šæ”¾ç£ç›˜ç©ºé—´ï¼Œé¿å…æ„å»ºå¤±è´¥ï¼‰
      - name: "Clean Up Environment (æ¸…ç†ç¯å¢ƒ)"
        run: |
          echo "ğŸ—‘ï¸ æ­£åœ¨æ¸…ç†ç¯å¢ƒï¼ˆCleaning up environmentï¼‰..."
          sudo apt-get autoremove -y --purge  # å¸è½½æ— ç”¨åŒ…
          sudo apt-get clean  # æ¸…ç†APTç¼“å­˜
          sudo rm -rf /usr/share/docker /etc/mysql /etc/php /etc/apt/sources.list.d  # åˆ é™¤æ— å…³ç›®å½•
          df -h  # æ˜¾ç¤ºå½“å‰ç£ç›˜ç©ºé—´
          echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆï¼ˆEnvironment cleanedï¼‰"
       
      # 4. è§£æé…ç½®å˜é‡ï¼ˆä»sgsi.jsonæå–å‚æ•°ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨ï¼‰
      - name: "Parse Config Variables (è§£æé…ç½®å˜é‡)"
        id: config
        run: |
          # ä»sgsi.jsonæå–æ‰€æœ‰å­—æ®µï¼ˆå¸¦é»˜è®¤å€¼ï¼‰
          jq -r 'to_entries[] | "config_\(.key)=\(.value // "unknown")"' sgsi.json >> $GITHUB_OUTPUT
          
          # è¡¥å……ROMç±»å‹é»˜è®¤å€¼ï¼ˆå¦‚æœæœªæŒ‡å®šï¼‰
          if [[ -z "${{ steps.config.outputs.config_rom_type }}" ]]; then
            echo "config_rom_type=Generic" >> $GITHUB_OUTPUT
          fi
          
          echo "âœ… é…ç½®å˜é‡è§£æå®Œæˆï¼ˆConfig variables parsedï¼‰"
           
      # 5. å®‰è£…åŸºç¡€å·¥å…·ï¼ˆaria2ä¸‹è½½ã€jqè§£æJSONã€brotliå‹ç¼©ç­‰ï¼‰
      - name: "Install Essential Tools (å®‰è£…åŸºç¡€å·¥å…·)"
        run: |
          echo "ğŸ”§ æ­£åœ¨å®‰è£…åŸºç¡€å·¥å…·ï¼ˆInstalling essential toolsï¼‰..."
          sudo apt-get update
          sudo apt-get install -y aria2 curl jq brotli android-sdk-libsparse-utils
          echo "âœ… åŸºç¡€å·¥å…·å®‰è£…å®Œæˆï¼ˆEssential tools installedï¼‰"
          
      # 6. ä¸‹è½½æ„å»ºå·¥å…·ï¼ˆä»GitHub Releaseä¸‹è½½XiaoxinTools 1.9ï¼‰
      - name: "Download Build Tools (ä¸‹è½½æ„å»ºå·¥å…·)"
        run: |
          tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar"
          filename="SGSI-build-tool.tar"
          max_retries=5  # æœ€å¤§é‡è¯•æ¬¡æ•°
          retry_delay=10  # é‡è¯•é—´éš”ï¼ˆç§’ï¼‰
          
          echo "ğŸ”— æ­£åœ¨ä¸‹è½½æ„å»ºå·¥å…·ï¼ˆDownloading build toolsï¼‰: $tool_url"
          
          # å¤šé‡è¯•ä¸‹è½½ï¼ˆä¼˜å…ˆaria2ï¼Œå¤‡ç”¨curlï¼‰
          for i in $(seq 1 $max_retries); do
            if aria2c -x 8 -s 8 -k 1M -o "$filename" "$tool_url"; then
              echo "âœ… æ„å»ºå·¥å…·ä¸‹è½½æˆåŠŸï¼ˆBuild tools downloadedï¼‰"
              break
            elif curl -fL -o "$filename" "$tool_url"; then
              echo "âœ… æ„å»ºå·¥å…·ä¸‹è½½æˆåŠŸï¼ˆBuild tools downloaded via curlï¼‰"
              break
            else
              echo "âŒ ä¸‹è½½å¤±è´¥ï¼ˆå°è¯• $i/$max_retriesï¼‰ï¼ˆDownload failedï¼‰"
              if [ $i -eq $max_retries ]; then
                echo "::error::âŒ æ„å»ºå·¥å…·ä¸‹è½½å¤±è´¥ï¼ˆBuild tools download failedï¼‰"
                exit 1
              fi
              sleep $retry_delay
            fi
          done
          
      # 7. åˆå§‹åŒ–æ„å»ºç¯å¢ƒï¼ˆè§£å‹å·¥å…·åŒ…å¹¶è®¾ç½®æ‰§è¡Œæƒé™ï¼‰
      - name: "Initialize Build Environment (åˆå§‹åŒ–æ„å»ºç¯å¢ƒ)"
        run: |
          echo "ğŸ“‚ æ­£åœ¨è§£å‹æ„å»ºå·¥å…·ï¼ˆExtracting build toolsï¼‰..."
          sudo tar -xf SGSI-build-tool.tar  # è§£å‹å·¥å…·åŒ…
          sudo chmod -R +x SGSI-build-tool/**/*.sh  # ç»™æ‰€æœ‰è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
          echo "âœ… æ„å»ºç¯å¢ƒåˆå§‹åŒ–å®Œæˆï¼ˆBuild environment initializedï¼‰"
          
      # 8. ä¿®å¤å·¥å…·é“¾é—®é¢˜ï¼ˆè§£å†³äºŒè¿›åˆ¶å…¼å®¹æ€§é—®é¢˜ï¼Œé¿å…æ„å»ºé”™è¯¯ï¼‰
      - name: "Fix Toolchain Issues (ä¿®å¤å·¥å…·é“¾é—®é¢˜)"
        run: |
          cd SGSI-build-tool/10  # è¿›å…¥Android 10æ„å»ºç›®å½•
          echo "ğŸ› ï¸ æ­£åœ¨ä¿®å¤å·¥å…·é“¾é—®é¢˜ï¼ˆFixing toolchain issuesï¼‰..."
          
          sudo mkdir -p bin  # åˆ›å»ºbinç›®å½•ï¼Œç”¨äºå­˜æ”¾å·¥å…·é“¾æ¥
          # é“¾æ¥å¿…è¦çš„å·¥å…·ï¼ˆé¿å…äºŒè¿›åˆ¶æ–‡ä»¶æ‰¾ä¸åˆ°ï¼‰
          for tool in brotli simg2img img2simg mke2fs; do
            tool_path=$(which $tool)  # è·å–å·¥å…·è·¯å¾„
            if [[ -n "$tool_path" ]]; then
              sudo ln -sf "$tool_path" bin/$tool  # åˆ›å»ºç¬¦å·é“¾æ¥
              echo "âœ… é“¾æ¥å·¥å…·æˆåŠŸï¼ˆLinked toolï¼‰: $tool -> $tool_path"
            else
              echo "::warning::âš ï¸ æœªæ‰¾åˆ°å·¥å…·ï¼ˆTool not foundï¼‰: $tool"
            fi
          done
          
          cd ../..  # è¿”å›æ ¹ç›®å½•
          echo "âœ… å·¥å…·é“¾é—®é¢˜ä¿®å¤å®Œæˆï¼ˆToolchain fixedï¼‰"
          
      # 9. ä¸‹è½½ROMæ–‡ä»¶ï¼ˆä»é…ç½®çš„rom_urlä¸‹è½½åŸå§‹ROMåŒ…ï¼‰
      - name: "Download ROM File (ä¸‹è½½ROMæ–‡ä»¶)"
        run: |
          rom_url="${{ steps.config.outputs.config_rom_url }}"
          rom_name="${{ steps.config.outputs.config_rom_name }}"
          target_dir="SGSI-build-tool/10/tmp"  # ROMå­˜å‚¨ç›®å½•
          
          echo "ğŸš€ æ­£åœ¨ä¸‹è½½ROMæ–‡ä»¶ï¼ˆDownloading ROMï¼‰: $rom_name"
          echo "ğŸ“¥ ROMé“¾æ¥ï¼ˆROM URLï¼‰: $rom_url"
          
          sudo mkdir -p "$target_dir"  # åˆ›å»ºç›®æ ‡ç›®å½•
          
          # å¤šé‡è¯•ä¸‹è½½ï¼ˆä¼˜å…ˆaria2ï¼‰
          max_retries=5
          retry_delay=10
          
          for i in $(seq 1 $max_retries); do
            if aria2c -x 8 -s 8 -k 1M -d "$target_dir" -o "$rom_name" "$rom_url"; then
              echo "âœ… ROMä¸‹è½½æˆåŠŸï¼ˆROM downloadedï¼‰"
              break
            elif curl -fL -o "$rom_name" "$rom_url"; then
              echo "âœ…  ROMä¸‹è½½æˆåŠŸï¼ˆROM downloaded via curlï¼‰"
              break
            else
              echo "âŒ ä¸‹è½½å¤±è´¥ï¼ˆå°è¯• $i/$max_retriesï¼‰ï¼ˆDownload failedï¼‰"
              if [ $i -eq $max_retries ]; then
                echo "::error::âŒ ROMæ–‡ä»¶ä¸‹è½½å¤±è´¥ï¼ˆROM file download failedï¼‰"
                exit 1
              fi
              sleep $retry_delay
            fi
          done
          
          # éªŒè¯ROMæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [[ ! -f "$target_dir/$rom_name" ]]; then
            echo "::error::âŒ ROMæ–‡ä»¶æœªæ‰¾åˆ°ï¼ˆROM file not foundï¼‰"
            exit 1
          fi
          
          echo "ğŸ“¦ ROMæ–‡ä»¶ä¿¡æ¯ï¼ˆROM infoï¼‰: $(ls -lh "$target_dir/$rom_name")"
          
      # 10. é…ç½®ROMç‰¹å®šè®¾ç½®ï¼ˆæ ¹æ®ROMç±»å‹åº”ç”¨ä¸åŒçš„ä¿®å¤é€»è¾‘ï¼‰
      - name: "Configure ROM Specific Settings (é…ç½®ROMç‰¹å®šè®¾ç½®)"
        run: |
          cd SGSI-build-tool/10
          rom_type="${{ steps.config.outputs.config_rom_type }}"  # è·å–ROMç±»å‹ï¼ˆå¦‚MIUIã€ColorOSï¼‰
          echo "âš™ï¸ æ­£åœ¨é…ç½®ROMç‰¹å®šè®¾ç½®ï¼ˆConfiguring $rom_type settingsï¼‰..."
          
          # 1. é…ç½®Super SGSIï¼ˆå¦‚æœéœ€è¦ï¼‰
          if [[ "${{ steps.config.outputs.config_make_super }}" == "true" ]]; then
            echo "ğŸ”§ æ­£åœ¨é…ç½®Super SGSIï¼ˆConfiguring Super SGSIï¼‰..."
            sudo sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' make.sh  # ä¿®æ”¹make.shè„šæœ¬
            echo "âœ… Super SGSIé…ç½®å®Œæˆï¼ˆSuper SGSI configuredï¼‰"
          fi
          
          # 2. ColorOSå¤„ç†ï¼ˆè§£å¯†OZIPåŒ…ï¼‰
          if [[ "$rom_type" == "ColorOS" ]]; then
            echo "ğŸ”“ æ­£åœ¨è§£å¯†ColorOS ROMï¼ˆDecrypting ColorOS ROMï¼‰..."
            if [[ -f "oppo_ozip/ozipdecrypt.py" ]]; then
              sudo python3 oppo_ozip/ozipdecrypt.py "tmp/${{ steps.config.outputs.config_rom_name }}"  # è§£å¯†
              sudo rm -f "tmp/${{ steps.config.outputs.config_rom_name }}"  # åˆ é™¤åŸå§‹OZIPåŒ…
              echo "âœ… ColorOS ROMè§£å¯†æˆåŠŸï¼ˆColorOS ROM decryptedï¼‰"
            else
              echo "::error::âŒ æœªæ‰¾åˆ°ozipdecrypt.pyï¼Œæ— æ³•è§£å¯†ColorOS ROMï¼ˆozipdecrypt.py not foundï¼‰"
              exit 1
            fi
          fi
          
          # 3. åº”ç”¨ROMç‰¹å®šä¿®å¤è„šæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [[ -f "../../fix/${rom_type}.sh" ]]; then
            echo "ğŸ“ æ­£åœ¨åº”ç”¨$rom_typeä¿®å¤è„šæœ¬ï¼ˆApplying $rom_type fix scriptï¼‰..."
            sudo cp "../../fix/${rom_type}.sh" fixbug/fixbug.sh  # å¤åˆ¶ä¿®å¤è„šæœ¬
            sudo chmod +x fixbug/fixbug.sh  # æ·»åŠ æ‰§è¡Œæƒé™
            echo "âœ… $rom_typeä¿®å¤è„šæœ¬åº”ç”¨å®Œæˆï¼ˆ$rom_type fix script appliedï¼‰"
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°$rom_typeä¿®å¤è„šæœ¬ï¼ˆNo $rom_type fix script foundï¼‰"
          fi
          
          cd ../..
          echo "âœ… ROMç‰¹å®šè®¾ç½®å®Œæˆï¼ˆROM specific settings configuredï¼‰"
          
      # 11. ä¿®å¤è„šæœ¬è¯­æ³•é”™è¯¯ï¼ˆè§£å†³SGSI.shä¸­çš„è¯­æ³•é—®é¢˜ï¼‰
      - name: "Fix Script Syntax Errors (ä¿®å¤è„šæœ¬è¯­æ³•é”™è¯¯)"
        run: |
          cd SGSI-build-tool/10
          echo "ğŸ” æ­£åœ¨ä¿®å¤è„šæœ¬è¯­æ³•é”™è¯¯ï¼ˆFixing script syntax errorsï¼‰..."
          
          if [[ -f "SGSI.sh" ]]; then
            sudo sed -i 's/\[ *\] *== *"\(.*\)" *]/\[ -n "\1" ]/g' SGSI.sh  # ä¿®å¤æ¡ä»¶åˆ¤æ–­è¯­æ³•
            sudo sed -i 's/==/=/g' SGSI.sh  # å°†==æ›¿æ¢ä¸º=ï¼ˆé¿å…è¯­æ³•é”™è¯¯ï¼‰
            echo "âœ… SGSI.shè¯­æ³•ä¿®å¤å®Œæˆï¼ˆSGSI.sh syntax fixedï¼‰"
          else
            echo "::warning::âš ï¸ æœªæ‰¾åˆ°SGSI.shï¼Œè·³è¿‡è¯­æ³•ä¿®å¤ï¼ˆSGSI.sh not foundï¼‰"
          fi
          
          cd ../..
          
      # 12. å‡†å¤‡æ„å»ºæ–‡ä»¶ï¼ˆå¤åˆ¶è‡ªå®šä¹‰è„šæœ¬å’Œå·¥å…·ï¼‰
      - name: "Prepare Build Files (å‡†å¤‡æ„å»ºæ–‡ä»¶)"
        run: |
          echo "ğŸ“¦ æ­£åœ¨å‡†å¤‡æ„å»ºæ–‡ä»¶ï¼ˆPreparing build filesï¼‰..."
          
          # å¤åˆ¶è‡ªå®šä¹‰makeè„šæœ¬ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [[ -d "make" ]]; then
            sudo cp -v make/*.sh SGSI-build-tool/10/  # å¤åˆ¶è„šæœ¬
            echo "âœ… è‡ªå®šä¹‰makeè„šæœ¬å¤åˆ¶å®Œæˆï¼ˆCustom make scripts copiedï¼‰"
          fi
          
          # å¤åˆ¶è‡ªå®šä¹‰äºŒè¿›åˆ¶å·¥å…·ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          if [[ -d "bin" ]]; then
            sudo mkdir -p SGSI-build-tool/10/bin  # åˆ›å»ºbinç›®å½•
            sudo cp -v bin/* SGSI-build-tool/10/bin/  # å¤åˆ¶å·¥å…·
            echo "âœ… è‡ªå®šä¹‰äºŒè¿›åˆ¶å·¥å…·å¤åˆ¶å®Œæˆï¼ˆCustom binaries copiedï¼‰"
          fi
          
          echo "âœ… æ„å»ºæ–‡ä»¶å‡†å¤‡å®Œæˆï¼ˆBuild files preparedï¼‰"
          
      # 13. æ„å»ºSGSIé•œåƒï¼ˆæ‰§è¡Œæ„å»ºè„šæœ¬ï¼Œç”ŸæˆSGSIé•œåƒï¼‰
      - name: "Build SGSI Image (æ„å»ºSGSIé•œåƒ)"
        id: build_sgsi
        run: |
          cd SGSI-build-tool/10
          echo "ğŸ—ï¸ æ­£åœ¨æ„å»ºSGSIé•œåƒï¼ˆBuilding SGSI imageï¼‰..."
          
          # æ‰§è¡Œæ„å»ºè„šæœ¬ï¼ˆè¶…æ—¶60åˆ†é’Ÿï¼‰
          if ! timeout 60m bash make.sh 2>&1 | tee make.log; then
            echo "::error::âŒ SGSIæ„å»ºå¤±è´¥ï¼ˆSGSI build failedï¼‰"
            tail -100 make.log  # æ˜¾ç¤ºæœ€å100è¡Œæ—¥å¿—ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜
            exit 1
          fi
          
          echo "ğŸ‰ SGSIæ„å»ºæˆåŠŸï¼ˆSGSI build succeededï¼‰"
          
          ##############################################################################
          # æ–°å¢ï¼šä¿®å¤æ„å»ºäº§å‡ºæ–‡ä»¶æƒé™ï¼ˆè§£å†³åç»­è¯»å–build.propæ—¶çš„æƒé™é—®é¢˜ï¼‰
          ##############################################################################
          echo "ğŸ”’ Fixing permissions for build output files (ä¿®å¤æ„å»ºäº§å‡ºæ–‡ä»¶æƒé™)..."
          sudo chown -R $(id -u):$(id -g) out/  # å°†out/ç›®å½•æ‰€æœ‰æƒæ”¹ä¸ºå½“å‰ç”¨æˆ·
          sudo chmod -R 755 out/  # è®¾ç½®out/ç›®å½•è¯»å†™æ‰§è¡Œæƒé™
          echo "âœ… Build output permissions fixed (æ„å»ºäº§å‡ºæ–‡ä»¶æƒé™ä¿®å¤å®Œæˆ)"
          
          ##############################################################################
          # ä¼˜åŒ–ï¼šä»build.propæå–è¯¦ç»†è®¾å¤‡ä¿¡æ¯ï¼ˆæ”¯æŒæ›´å¤šROMç±»å‹çš„ç‰ˆæœ¬ä¿¡æ¯è·å–ï¼‰
          ##############################################################################
          build_prop_path="./out/system/system/build.prop"
          if [[ -f "$build_prop_path" ]]; then
            # ç¡®ä¿build.propå¯è¯»ï¼ˆé˜²æ­¢æƒé™é—æ¼ï¼‰
            sudo chmod 644 "$build_prop_path"
            
            # 1. è®¾å¤‡å‹å·ï¼ˆDevice Modelï¼‰
            model=$(grep 'ro.product.model' "$build_prop_path" | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            # 2. æœºå‹ä»£å·ï¼ˆDevice Codenameï¼‰
            device_codename=$(grep -E 'ro.product.(device|name|board|hardware)' "$build_prop_path" | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            # 3. å®‰å…¨è¡¥ä¸æ—¥æœŸï¼ˆSecurity Patch Dateï¼‰
            security_patch=$(grep 'ro.build.version.security_patch' "$build_prop_path" | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            # 4. Androidç‰ˆæœ¬å·ï¼ˆAndroid Versionï¼‰
            android_version=$(grep 'ro.build.version.release' "$build_prop_path" | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            # 5. åŸæ„å»ºæ—¥æœŸï¼ˆOriginal Build Dateï¼‰
            build_date=$(grep 'ro.build.date' "$build_prop_path" | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            # 6. ROMç‰¹å®šç‰ˆæœ¬ä¿¡æ¯ï¼ˆROM-specific Versionï¼‰- å°è¯•å¤šç§é”®åé€‚åº”ä¸åŒROMï¼ˆMIUI/ColorOS/OneUIç­‰ï¼‰
            rom_version=$(grep -E 'ro.(build|system|product).(version|display).(incremental|id|name)' "$build_prop_path" | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            # 7. æ„å»ºIDï¼ˆBuild IDï¼‰
            build_id=$(grep 'ro.build.id' "$build_prop_path" | head -1 | cut -d'=' -f2 | tr -d '[:space:]' || echo "Unknown")
            
            # è¾“å‡ºæå–çš„ä¿¡æ¯ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
            echo "ğŸ“± Extracted Device Model: $modelï¼ˆæå–çš„è®¾å¤‡å‹å·ï¼‰"
            echo "ğŸ”¤ Extracted Device Codename: $device_codenameï¼ˆæå–çš„æœºå‹ä»£å·ï¼‰"
            echo "ğŸ”’ Security Patch Date: $security_patchï¼ˆå®‰å…¨è¡¥ä¸æ—¥æœŸï¼‰"
            echo "ğŸ“± Android Version: $android_versionï¼ˆAndroidç‰ˆæœ¬å·ï¼‰"
            echo "ğŸ“… Original Build Date: $build_dateï¼ˆåŸæ„å»ºæ—¥æœŸï¼‰"
            echo "ğŸ”„ ROM Version: $rom_versionï¼ˆROMç‰ˆæœ¬ï¼‰"
            echo "ğŸ†” Build ID: $build_idï¼ˆæ„å»ºIDï¼‰"
            
            # å°†ä¿¡æ¯è¾“å‡ºåˆ°GitHubå˜é‡ï¼ˆä¾›åç»­æ­¥éª¤ä½¿ç”¨ï¼‰
            {
              echo "model=$model"
              echo "device_codename=$device_codename"
              echo "security_patch=$security_patch"
              echo "android_version=$android_version"
              echo "build_date=$build_date"
              echo "rom_version=$rom_version"
              echo "build_id=$build_id"
            } >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ build.prop file not found (æœªæ‰¾åˆ°build.propæ–‡ä»¶)"
            # è¾“å‡ºé»˜è®¤å€¼ï¼ˆé¿å…åç»­æ­¥éª¤æŠ¥é”™ï¼‰
            {
              echo "model=Unknown"
              echo "device_codename=Unknown"
              echo "security_patch=Unknown"
              echo "android_version=Unknown"
              echo "build_date=Unknown"
              echo "rom_version=Unknown"
              echo "build_id=Unknown"
            } >> $GITHUB_OUTPUT
          fi
          ##############################################################################
           
      # 14. æ‰“åŒ…è¾“å‡ºæ–‡ä»¶ï¼ˆå°†SGSIé•œåƒæ‰“åŒ…ä¸ºZIPï¼Œè¶…è¿‡2GBåˆ†å·ï¼‰
      - name: "Package Output Files (æ‰“åŒ…è¾“å‡ºæ–‡ä»¶)"
        run: |
          cd SGSI-build-tool/10
          echo "ğŸ“¦ æ­£åœ¨æ‰“åŒ…è¾“å‡ºæ–‡ä»¶ï¼ˆPackaging output filesï¼‰..."
          
          # éªŒè¯SGSIç›®å½•æ˜¯å¦å­˜åœ¨ï¼ˆæ„å»ºäº§ç‰©ï¼‰
          if [[ ! -d "SGSI" ]]; then
            echo "::error::âŒ æœªæ‰¾åˆ°SGSIç›®å½•ï¼Œæ„å»ºå¤±è´¥ï¼ˆSGSI directory not foundï¼‰"
            exit 1
          fi
          
          # æ‰“åŒ…ä¸ºZIPæ–‡ä»¶ï¼ˆä½¿ç”¨é…ç½®çš„pack_sgsiåç§°ï¼‰
          output_file="${{ steps.config.outputs.config_pack_sgsi }}"
          if ! zip -r "$output_file" SGSI/*; then
            echo "::error::âŒ æ‰“åŒ…å¤±è´¥ï¼ˆPackaging failedï¼‰"
            exit 1
          fi
          
          # å‡†å¤‡ä¸Šä¼ ç›®å½•ï¼ˆç”¨äºå­˜å‚¨æ‰“åŒ…åçš„æ–‡ä»¶ï¼‰
          upload_dir="${GITHUB_WORKSPACE}/upload"
          mkdir -p "$upload_dir"
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆè¶…è¿‡2GBåˆ†å·ï¼‰
          file_size=$(stat -c%s "$output_file" 2>/dev/null)
          max_size=2000000000  # 2GBï¼ˆGitHub Releaseå•æ–‡ä»¶ä¸Šä¼ é™åˆ¶ï¼‰
          
          if [[ "$file_size" -gt "$max_size" ]]; then
            echo "âš ï¸ æ–‡ä»¶è¿‡å¤§ï¼ˆ$file_size bytesï¼‰ï¼Œæ­£åœ¨åˆ†å·ï¼ˆSplitting file into partsï¼‰..."
            split -b 1500m -d -a 1 "$output_file" "${output_file}_part"  # åˆ†å·ä¸º1.5GB/part
            mv "${output_file}_part"* "$upload_dir"  # ç§»åŠ¨åˆ†å·æ–‡ä»¶åˆ°ä¸Šä¼ ç›®å½•
            rm "$output_file"  # åˆ é™¤åŸå§‹å¤§æ–‡ä»¶
            echo "âœ… åˆ†å·å®Œæˆï¼ˆFile split into $(ls "$upload_dir" | wc -l) partsï¼‰"
          else
            echo "ğŸ“¤ æ­£åœ¨ç§»åŠ¨æ–‡ä»¶åˆ°ä¸Šä¼ ç›®å½•ï¼ˆMoving file to upload directoryï¼‰..."
            mv "$output_file" "$upload_dir"  # ç§»åŠ¨æ–‡ä»¶åˆ°ä¸Šä¼ ç›®å½•
          fi
          
          # éªŒè¯ä¸Šä¼ ç›®å½•æ˜¯å¦æœ‰æ–‡ä»¶
          if [[ -z "$(ls -A "$upload_dir")" ]]; then
            echo "::error::âŒ ä¸Šä¼ ç›®å½•ä¸ºç©ºï¼ˆUpload directory is emptyï¼‰"
            exit 1
          fi
          
          # è®¾ç½®ä¸Šä¼ ç›®å½•ç¯å¢ƒå˜é‡ï¼ˆä¾›åç»­æ­¥éª¤ä½¿ç”¨ï¼‰
          echo "UPLOAD_DIR=$upload_dir" >> $GITHUB_ENV
          echo "âœ… è¾“å‡ºæ–‡ä»¶æ‰“åŒ…å®Œæˆï¼ˆOutput files packagedï¼‰"
             
      # 15. ç”Ÿæˆå‘å¸ƒæ ‡ç­¾ï¼ˆç”Ÿæˆå”¯ä¸€çš„Releaseæ ‡ç­¾ï¼Œå¦‚20250930_203015ï¼‰
      - name: "Generate Release Tag (ç”Ÿæˆå‘å¸ƒæ ‡ç­¾)"
        id: release_tag
        run: |
          # ç”Ÿæˆå”¯ä¸€æ ‡ç­¾ï¼ˆæ—¥æœŸ+æ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´ï¼‰
          release_tag=$(TZ='Asia/Shanghai' date +"%Y%m%d_%H%M%S")
          echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆæ„å»ºæ—¶é—´ï¼ˆæ ¼å¼åŒ–ï¼ŒåŒ—äº¬æ—¶é—´ï¼‰
          build_time=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %p %I:%M" | sed -e 's/AM/ä¸Šåˆ/' -e 's/PM/ä¸‹åˆ/')
          build_time="${build_time} [åŒ—äº¬æ—¶é—´]"
          echo "build_time=$build_time" >> $GITHUB_OUTPUT
          
          # ç”ŸæˆåŸåŒ…æœºå‹ä¿¡æ¯ï¼ˆå‹å·+ä»£å·ï¼‰
          model="${{ steps.build_sgsi.outputs.model }}"
          device_codename="${{ steps.build_sgsi.outputs.device_codename }}"
          source_device="$model [$device_codename]"
          if [[ "$model" == "Unknown" && "$device_codename" == "Unknown" ]]; then
            source_device="Unknown"
          fi
          echo "source_device=$source_device" >> $GITHUB_OUTPUT
          
          # ç”ŸæˆåŸæ„å»ºæ—¥æœŸï¼ˆæ ¼å¼åŒ–ï¼Œå…¼å®¹å¤šç§æ—¥æœŸæ ¼å¼ï¼‰
          original_build_date="${{ steps.build_sgsi.outputs.build_date }}"
          formatted_build_date=$(date -d "$original_build_date" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || echo "$original_build_date")
          echo "formatted_build_date=$formatted_build_date" >> $GITHUB_OUTPUT
          
          echo "âœ… å‘å¸ƒæ ‡ç­¾ç”Ÿæˆå®Œæˆï¼ˆRelease tag generated: $release_tagï¼‰"
             
      # 16. åˆ›å»ºå‘å¸ƒï¼ˆå°†æ‰“åŒ…åçš„æ–‡ä»¶ä¸Šä¼ åˆ°GitHub Releaseï¼Œå±•ç¤ºæ„å»ºä¿¡æ¯ï¼‰
      - name: "Create Release (åˆ›å»ºå‘å¸ƒ)"
        uses: softprops/action-gh-release@v1
        with:
          # å‘å¸ƒåç§°ï¼ˆåŒ…å«æ ‡ç­¾å’Œå·¥å…·ç‰ˆæœ¬ï¼‰
          name: "Auto Build SGSI - XiaoxinTools 1.9-AB [${{ steps.release_tag.outputs.release_tag }}]"
          # å‘å¸ƒæ ‡ç­¾ï¼ˆå”¯ä¸€ï¼‰
          tag_name: "${{ steps.release_tag.outputs.release_tag }}"
          # ä¸Šä¼ æ‰€æœ‰æ‰“åŒ…åçš„æ–‡ä»¶
          files: "${{ env.UPLOAD_DIR }}/*"
          # å‘å¸ƒæè¿°ï¼ˆå±•ç¤ºæ„å»ºä¿¡æ¯ï¼Œä¸­æ–‡åœ¨å‰è‹±æ–‡åœ¨åï¼‰
          body: |
            ## ğŸ“± SGSI æ„å»ºä¿¡æ¯ (Build Information)
            
            ### åŸºç¡€ä¿¡æ¯ (Basic Info)
            - **æ„å»ºæ—¶é—´ (Built at):** ${{ steps.release_tag.outputs.build_time }}  
            - **åŸåŒ…æœºå‹ (Source Device):** ${{ steps.release_tag.outputs.source_device }}  
            - **ROM ç±»å‹ (ROM Type):** ${{ steps.config.outputs.config_rom_type }}  
            - **Android ç‰ˆæœ¬ (Android Version):** ${{ steps.build_sgsi.outputs.android_version }}  
            - **ROM ç‰ˆæœ¬ (ROM Version):** ${{ steps.build_sgsi.outputs.rom_version }}  
            - **æ„å»º ID (Build ID):** ${{ steps.build_sgsi.outputs.build_id }}  
            - **å®‰å…¨è¡¥ä¸ (Security Patch):** ${{ steps.build_sgsi.outputs.security_patch }}  
            - **åŸæ„å»ºæ—¥æœŸ (Source Build Date):** ${{ steps.release_tag.outputs.formatted_build_date }}
            
            ### å…¶ä»–ä¿¡æ¯ (Other Info)
            - **æ„å»ºå·¥å…· (Build Tools):** XiaoxinTools_1.9 (Only for Android 10/AB)  
            - **å®éªŒæ€§æ„å»º (Experimental Build):** Yes (å¯èƒ½å­˜åœ¨ç¨³å®šæ€§é—®é¢˜)  
            - **æ„å»ºæ—¥å¿— (Build Log):** [æŸ¥çœ‹è¯¦ç»†æ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ---
            
            âš ï¸ **è­¦å‘Š (Warning):**  
            è¿™æ˜¯å®éªŒæ€§æ„å»ºï¼Œè¯·æµ‹è¯•åå†ä½œä¸ºä¸»åŠ›ç³»ç»Ÿä½¿ç”¨ã€‚  
            This is an experimental build. Please test before using as a daily driver.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHubä»¤ç‰Œï¼ˆç”¨äºåˆ›å»ºReleaseï¼‰
             
      # 17. å®Œæˆé€šçŸ¥ï¼ˆæ˜¾ç¤ºæ„å»ºç»“æœï¼Œæ–¹ä¾¿å¿«é€ŸæŸ¥çœ‹ï¼‰
      - name: "Completion Notification (å®Œæˆé€šçŸ¥)"
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "ğŸ‰ æ„å»ºæˆåŠŸï¼ˆBuild succeededï¼‰ï¼"
            echo "ğŸ“Œ å‘å¸ƒæ ‡ç­¾ï¼ˆRelease tagï¼‰: ${{ steps.release_tag.outputs.release_tag }}"
            echo "ğŸ“¦ äº§ç‰©é“¾æ¥ï¼ˆArtifactsï¼‰: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release_tag.outputs.release_tag }}"
          else
            echo "âŒ æ„å»ºå¤±è´¥ï¼ˆBuild failedï¼‰ï¼"
            echo "ğŸ” è¯·æŸ¥çœ‹æ—¥å¿—ï¼ˆCheck logï¼‰: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          fi
