name: build_XiaoxinSGSIs

on:
  watch:
    types: [started]

env:
  BUILD_DIR: SGSI-build-tool/10
  ROM_DIR: tmp
  TOOLKIT_URL: https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id
    timeout-minutes: 180
    
    steps:
    - name: æ¸…ç†å·¥ä½œåŒº
      run: |
        echo "ğŸ”„ æ¸…ç†å·¥ä½œåŒº..."
        rm -rf SGSI-build-tool upload || true
        df -h
        echo "âœ… å·¥ä½œåŒºæ¸…ç†å®Œæˆ"
      
    - name: å®‰è£…å¿…è¦å·¥å…·
      run: |
        echo "ğŸ› ï¸ å®‰è£…æ„å»ºå·¥å…·..."
        sudo apt-get update
        sudo apt-get install -y brotli xz-utils android-sdk-libsparse-utils \
          simg2img img2simg p7zip-full jq tree e2fsprogs
        echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"
      
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: åŠ è½½é…ç½®
      id: config
      run: |
        echo "ğŸ“ åŠ è½½é…ç½®æ–‡ä»¶..."
        [ ! -f "sgsi.json" ] && { echo "::error::æœªæ‰¾åˆ°sgsi.jsoné…ç½®æ–‡ä»¶"; exit 1; }
        
        # é…ç½®é¡¹å®šä¹‰
        declare -A CONFIG_MAP=(
          [rom_url]=required
          [rom_name]=required
          [pack_sgsi]=optional
          [make_miui]=required
          [make_flyme]=required
          [make_coloros]=required
          [make_h2os]=required
          [make_smartisanos]=required
          [make_zui]=required
          [make_super]=required
          [upload_artifact]=required
          [upload_wetransfer]=required
        )
        
        # è§£æé…ç½®
        for key in "${!CONFIG_MAP[@]}"; do
          value=$(jq -r ".$key" sgsi.json)
          required="${CONFIG_MAP[$key]}"
          
          if [ "$value" = "null" ]; then
            if [ "$required" = "required" ]; then
              echo "::error::é…ç½®é¡¹ $key ç¼ºå¤±äºsgsi.json"; exit 1
            else
              continue
            fi
          fi
          
          if [ "$key" = "uploa_wetransfer" ]; then
            echo "upload_transfer=$value" >> $GITHUB_ENV
          else
            echo "$key=$value" >> $GITHUB_ENV
          fi
        done
        
        # ç¡®å®šè¾“å‡ºæ–‡ä»¶å
        pack_name=$(jq -r '.pack_sgsi' sgsi.json)
        if [ -n "$pack_name" ] && [ "$pack_name" != "null" ]; then
          echo "OUTPUT_FILE=$pack_name" >> $GITHUB_ENV
        else
          rom_name=$(jq -r '.rom_name' sgsi.json)
          echo "OUTPUT_FILE=XiaoxinSGSI-${rom_name}-$(date +%m%d).7z" >> $GITHUB_ENV
        fi
        echo "âœ… é…ç½®åŠ è½½å®Œæˆ"
        
    - name: è·å–å·¥å…·ç®±
      run: |
        echo "ğŸ“¦ ä¸‹è½½å·¥å…·ç®±..."
        mkdir -p $BUILD_DIR/SGSI
        
        echo "ğŸš€ ä¼˜å…ˆä½¿ç”¨axelä¸‹è½½..."
        axel -n 8 -U "SGSI-Builder" --alternate -o SGSI-build-tool.tar "$TOOLKIT_URL" && echo "âœ… axelä¸‹è½½æˆåŠŸ" || {
          echo "âš ï¸ axelä¸‹è½½å¤±è´¥ï¼Œå°è¯•wget..."
          wget --progress=bar:force:noscroll -O SGSI-build-tool.tar "$TOOLKIT_URL" && echo "âœ… wgetä¸‹è½½æˆåŠŸ" || {
            echo "âš ï¸ wgetä¸‹è½½å¤±è´¥ï¼Œå°è¯•curl..."
            curl -L -o SGSI-build-tool.tar "$TOOLKIT_URL" && echo "âœ… curlä¸‹è½½æˆåŠŸ" || {
              echo "âŒ æ‰€æœ‰ä¸‹è½½æ–¹å¼å‡å¤±è´¥"; exit 1
            }
          }
        }
        
        echo "ğŸ“‚ è§£å‹å·¥å…·ç®±..."
        tar -xf SGSI-build-tool.tar
        [ ! -d "$BUILD_DIR" ] && { echo "::error::å·¥å…·ç®±è§£å‹å¤±è´¥"; exit 1; }
        echo "âœ… å·¥å…·ç®±å‡†å¤‡å°±ç»ª"
        
    - name: ä¸‹è½½ROM
      run: |
        echo "â¬‡ï¸ ä¸‹è½½ROMæ–‡ä»¶..."
        mkdir -p $ROM_DIR
        
        echo "ğŸš€ ä¼˜å…ˆä½¿ç”¨axelä¸‹è½½..."
        axel -n 8 -U "SGSI-Builder" --alternate -o "$ROM_DIR/$rom_name" "$rom_url" && echo "âœ… axelä¸‹è½½æˆåŠŸ" || {
          echo "âš ï¸ axelä¸‹è½½å¤±è´¥ï¼Œå°è¯•wget..."
          wget --progress=bar:force:noscroll -c -O "$ROM_DIR/$rom_name" "$rom_url" && echo "âœ… wgetä¸‹è½½æˆåŠŸ" || {
            echo "âš ï¸ wgetä¸‹è½½å¤±è´¥ï¼Œå°è¯•curl..."
            curl -C - -L -o "$ROM_DIR/$rom_name" "$rom_url" && echo "âœ… curlä¸‹è½½æˆåŠŸ" || {
              echo "âŒ æ‰€æœ‰ä¸‹è½½æ–¹å¼å‡å¤±è´¥"; exit 1
            }
          }
        }
        
        ROM_SIZE=$(du -sh "$ROM_DIR/$rom_name" | awk '{print $1}')
        echo "âœ… ROMä¸‹è½½å®Œæˆ (å¤§å°: $ROM_SIZE)"
        echo "ROMæ–‡ä»¶è·¯å¾„: $(pwd)/$ROM_DIR/$rom_name"
        
    - name: å¤„ç†ColorOS
      if: env.make_coloros == 'true'
      run: |
        echo "ğŸ¨ å¤„ç†ColorOSè§£å¯†..."
        cd $BUILD_DIR
        python3 oppo_ozip/ozipdecrypt.py "../$ROM_DIR/$rom_name" || {
          echo "::warning::ColorOSè§£å¯†å¤±è´¥ï¼Œå¯èƒ½ä¸æ˜¯åŠ å¯†æ–‡ä»¶"
        }
        echo "âœ… ColorOSå¤„ç†å®Œæˆ"
        
    - name: å‡†å¤‡ç³»ç»Ÿé•œåƒ
      run: |
        echo "ğŸ–¼ï¸ å‡†å¤‡ç³»ç»Ÿé•œåƒ..."
        cd $ROM_DIR
        
        # ä¸‹è½½ sdat2img å·¥å…·
        echo "ğŸ“¥ ä¸‹è½½ sdat2img å·¥å…·..."
        curl -sLO https://raw.githubusercontent.com/xpirt/sdat2img/master/sdat2img.py
        chmod +x sdat2img.py
        echo "âœ… sdat2imgå·¥å…·å‡†å¤‡å°±ç»ª"
        
        # æ£€æŸ¥ROMæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$rom_name" ]; then
          echo "::error::æœªæ‰¾åˆ°ROMæ–‡ä»¶: $rom_name"
          ls -lAh
          exit 1
        fi
        
        # è§£å‹ROMæ–‡ä»¶ï¼ˆä½¿ç”¨7zæ›¿ä»£unzipï¼‰
        echo "è§£å‹å½“å‰ç›®å½•çš„åˆ·æœºåŒ…ä¸­......"
        7z x "$rom_name" -y || {
          echo "::warning::è§£å‹å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶è§£å‹"
          7z x -t* "$rom_name" -y -oextracted || {
            echo "::error::æ— æ³•è§£å‹ROMæ–‡ä»¶"
            exit 1
          }
          # æŸ¥æ‰¾è§£å‹åçš„å†…å®¹
          echo "ç§»åŠ¨è§£å‹æ–‡ä»¶..."
          mv extracted/* . >/dev/null 2>&1 || true
          mv extracted/.* . >/dev/null 2>&1 || true
          rm -rf extracted
        }
        echo "è§£å‹å®Œæˆ"
        
        # å¤„ç†ä¸åŒæ ¼å¼çš„systemé•œåƒ
        echo "æœç´¢ç³»ç»Ÿé•œåƒ..."
        found_img=false
        
        # æƒ…å†µ1ï¼šç›´æ¥å­˜åœ¨system.img
        if [ -f "system.img" ]; then
          echo "ğŸ” æ‰¾åˆ°system.img"
          found_img=true
        
        # æƒ…å†µ2ï¼šå­˜åœ¨å‹ç¼©çš„datæ–‡ä»¶
        elif [ -f "system.new.dat.br" ]; then
          echo "ğŸ§ª è§£å‹brotliæ ¼å¼..."
          brotli -d system.new.dat.br
          rm -f system.new.dat.br
          found_img=true
          
        elif [ -f "system.new.dat.xz" ]; then
          echo "ğŸ§ª è§£å‹xzæ ¼å¼..."
          xz -d system.new.dat.xz
          found_img=true
        
        # æƒ…å†µ3ï¼šéœ€è¦è½¬æ¢datæ–‡ä»¶
        elif [ -f "system.new.dat" ] && [ -f "system.transfer.list" ]; then
          echo "ğŸ”§ è½¬æ¢datåˆ°img..."
          python3 sdat2img.py system.transfer.list system.new.dat system.img
          rm -f system.new.dat system.transfer.list
          found_img=true
        fi
        
        # å¦‚æœä»æœªæ‰¾åˆ°ï¼Œå°è¯•æ·±åº¦æœç´¢
        if [ "$found_img" = false ]; then
          echo "æ·±åº¦æœç´¢system.img..."
          system_path=$(find . -type f -name "system.img" | head -n1)
          
          if [ -n "$system_path" ]; then
            echo "åœ¨å­ç›®å½•ä¸­æ‰¾åˆ°system.img: $system_path"
            mv "$system_path" .
            found_img=true
            
            # å°è¯•ç§»åŠ¨å…¶ä»–ç›¸å…³æ–‡ä»¶
            mv $(dirname "$system_path")/system.* . >/dev/null 2>&1 || true
          fi
          
          # æ£€æŸ¥systemæ–‡ä»¶å¤¹
          if [ -d "system" ]; then
            echo "ğŸ” æ‰¾åˆ°systemç›®å½•ï¼Œå°è¯•åˆ›å»ºé•œåƒ..."
            find system -print0 | sort -z | cpio -ov -0 -H newc | gzip -9 > system.img
            found_img=true
          fi
        fi
        
        # æœ€ç»ˆæ£€æŸ¥
        if [ "$found_img" = true ] && [ -f "system.img" ]; then
          SYSTEM_SIZE=$(du -sh system.img | awk '{print $1}')
          echo "âœ… ç³»ç»Ÿé•œåƒå‡†å¤‡å®Œæˆ (å¤§å°: $SYSTEM_SIZE)"
        else
          echo "::error::æœªæ‰¾åˆ°æœ‰æ•ˆçš„system.img"
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -lAhR
          exit 1
        fi
        
    - name: æå–ç‰ˆæœ¬ä¿¡æ¯
      run: |
        echo "ğŸ“Š æå–ç‰ˆæœ¬ä¿¡æ¯..."
        cd $ROM_DIR
        
        # å°è¯•æŒ‚è½½ç³»ç»Ÿé•œåƒ
        mkdir -p system_mount
        sudo mount -t ext4 -o ro,loop system.img system_mount 2>/dev/null || {
          echo "::warning::æŒ‚è½½å¤±è´¥ï¼Œå°è¯•å…¶ä»–æ–¹æ³•"
          # å°è¯•ä½¿ç”¨simg2imgè½¬æ¢
          if file system.img | grep -q "sparse"; then
            echo "æ£€æµ‹åˆ°ç¨€ç–é•œåƒï¼Œæ­£åœ¨è½¬æ¢..."
            simg2img system.img system_raw.img
            mv system_raw.img system.img
            sudo mount -t ext4 -o ro,loop system.img system_mount || true
          fi
        }
        
        # æŸ¥æ‰¾build.propæ–‡ä»¶
        BUILD_PROPS=""
        paths=(
          "system_mount/system/build.prop"
          "system_mount/build.prop"
          "system_mount/system/system/build.prop"
          "system_mount/vendor/build.prop"
        )
        
        for path in "${paths[@]}"; do
          if [ -f "$path" ]; then
            BUILD_PROPS="$path"
            break
          fi
        done
        
        # æå–ç‰ˆæœ¬ä¿¡æ¯
        if [ -n "$BUILD_PROPS" ]; then
          echo "æ‰¾åˆ°build.prop: $BUILD_PROPS"
          ROM_VERSION=$(grep -m1 "ro.build.version.incremental" "$BUILD_PROPS" | cut -d'=' -f2)
          ANDROID_VERSION=$(grep -m1 "ro.build.version.release" "$BUILD_PROPS" | cut -d'=' -f2)
          SECURITY_PATCH=$(grep -m1 "ro.build.version.security_patch" "$BUILD_PROPS" | cut -d'=' -f2)
          echo "rom_version=$ROM_VERSION" >> $GITHUB_ENV
          echo "android_version=$ANDROID_VERSION" >> $GITHUB_ENV
          echo "security_patch=${SECURITY_PATCH:-æœªçŸ¥}" >> $GITHUB_ENV
        else
          echo "::warning::æœªæ‰¾åˆ°build.propæ–‡ä»¶"
        fi
        
        # æ¸…ç†æŒ‚è½½ç‚¹
        sudo umount system_mount 2>/dev/null || true
        rm -rf system_mount
        echo "âœ… ç‰ˆæœ¬ä¿¡æ¯æå–å®Œæˆ"
        
    - name: é…ç½®æ„å»ºé€‰é¡¹
      run: |
        echo "âš™ï¸ é…ç½®æ„å»ºé€‰é¡¹..."
        cd $BUILD_DIR
        
        # è·³è¿‡æƒé™æ›´æ”¹æ“ä½œ
        sed -i 's/chown -R root:root/# chown -R root:root/g' make.sh
        sed -i 's/chmod -R 777/# chmod -R 777/g' make.sh
        echo "ğŸ›¡ï¸ è·³è¿‡æƒé™ä¿®æ”¹æ“ä½œ"
        
        # é…ç½®superæ¨¡å¼
        if [ "$make_super" = 'true' ]; then
          sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' make.sh
          echo "ğŸ”„ å¯ç”¨superåˆ†åŒºæ¨¡å¼"
        fi
        
        # åº”ç”¨å“ç‰Œç‰¹å®šä¿®å¤
        BRANDS=("MIUI" "Flyme" "ColorOS" "H2OS" "SmartisanOS" "ZUI")
        KEYS=("make_miui" "make_flyme" "make_coloros" "make_h2os" "make_smartisanos" "make_zui")
        
        for i in "${!BRANDS[@]}"; do
          key="${KEYS[$i]}"
          brand="${BRANDS[$i]}"
          
          # ä½¿ç”¨é—´æ¥å¼•ç”¨è·å–ç¯å¢ƒå˜é‡å€¼
          key_value=$(eval echo \$$key)
          
          if [ "$key_value" = 'true' ] && [ -f "../fix/${brand}.sh" ]; then
            cp -f "../fix/${brand}.sh" fixbug/fixbug.sh
            echo "brand=$brand" >> $GITHUB_ENV
            echo "ğŸ”§ åº”ç”¨${brand}ä¿®å¤"
            break
          fi
        done
        
        # ç¡®ä¿ä¿®å¤è„šæœ¬å­˜åœ¨
        [ -f "fixbug/fixbug.sh" ] || {
          echo "# åŸºç¡€ä¿®å¤è„šæœ¬" > fixbug/fixbug.sh
          chmod +x fixbug/fixbug.sh
          echo "brand=é€šç”¨" >> $GITHUB_ENV
          echo "âš ï¸ ä½¿ç”¨åŸºç¡€ä¿®å¤è„šæœ¬"
        }
        
        echo "âœ… æ„å»ºé…ç½®å®Œæˆ"
        
    - name: æ‰§è¡Œæ„å»º
      run: |
        echo "ğŸ—ï¸ å¼€å§‹æ„å»ºSGSI..."
        cd $BUILD_DIR
        # æ·»åŠ æ‰§è¡Œæƒé™
        find . -type f -name "*.sh" -exec chmod +x {} \;
        
        time bash make.sh
        if [ ! -d "out" ]; then
          echo "::error::æ„å»ºå¤±è´¥ï¼Œæœªæ‰¾åˆ°è¾“å‡ºç›®å½•"
          echo "æ„å»ºæ—¥å¿—:"
          cat build.log || true
          exit 1
        fi
        echo "âœ… SGSIæ„å»ºå®Œæˆ"
        
    - name: æ‰“åŒ…æˆæœ
      run: |
        echo "ğŸ“¦ æ‰“åŒ…æˆæœç‰©..."
        cd $BUILD_DIR
        
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        echo "æ„å»ºä¿¡æ¯:" > version-info.txt
        echo "è®¾å¤‡: $rom_name" >> version-info.txt
        echo "å“ç‰Œ: ${brand:-é€šç”¨}" >> version-info.txt
        echo "Androidç‰ˆæœ¬: ${android_version:-æœªçŸ¥}" >> version-info.txt
        echo "å®‰å…¨è¡¥ä¸: ${security_patch:-æœªçŸ¥}" >> version-info.txt
        echo "æ„å»ºæ—¥æœŸ: $(date +"%Y-%m-%d %H:%M:%S %Z")" >> version-info.txt
        
        # åˆ›å»ºå‹ç¼©åŒ…
        7za a -t7z -mx=9 "$OUTPUT_FILE" SGSI/* version-info.txt
        if [ ! -f "$OUTPUT_FILE" ]; then
          echo "::error::æ‰“åŒ…å¤±è´¥"
          echo "SGSIç›®å½•å†…å®¹:"
          ls -lAh SGSI/
          exit 1
        fi
        
        OUTPUT_SIZE=$(du -sh "$OUTPUT_FILE" | awk '{print $1}')
        echo "âœ… æ‰“åŒ…å®Œæˆ (å¤§å°: $OUTPUT_SIZE)"
        
    - name: ä¸Šä¼ åˆ°WeTransfer
      if: env.upload_transfer == 'true'
      run: |
        echo "â˜ï¸ ä¸Šä¼ åˆ°WeTransfer..."
        cd $BUILD_DIR
        curl -sL https://git.io/file-transfer | sh
        ./transfer wet "$OUTPUT_FILE" | tee transfer.log
        DOWNLOAD_URL=$(grep -oP 'Download Link: \K.*' transfer.log)
        
        if [ -n "$DOWNLOAD_URL" ]; then
          echo "## SGSIä¸‹è½½" >> $GITHUB_STEP_SUMMARY
          echo "**æ–‡ä»¶**: $OUTPUT_FILE" >> $GITHUB_STEP_SUMMARY
          echo "**å¤§å°**: $OUTPUT_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "**ä¸‹è½½**: [WeTransfer]($DOWNLOAD_URL)" >> $GITHUB_STEP_SUMMARY
          echo "âœ… ä¸Šä¼ æˆåŠŸ"
        else
          echo "::error::WeTransferä¸Šä¼ å¤±è´¥"
          cat transfer.log
        fi
        
    - name: ä¸Šä¼ åˆ¶å“
      if: env.upload_artifact == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: XiaoxinSGSI
        path: ${{ env.BUILD_DIR }}/${{ env.OUTPUT_FILE }}
        
    - name: æœ€ç»ˆæ¸…ç†
      run: |
        echo "ğŸ§¹ æœ€ç»ˆæ¸…ç†..."
        rm -rf $ROM_DIR/* $BUILD_DIR/SGSI
        df -h
        echo "âœ… æ¸…ç†å®Œæˆ"
