name: build_XiaoxinSGSIs_old

on:
  watch:
    types: [started]
    
jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: "ğŸš€ Checkout Code (æ£€å‡ºä»£ç )"
        uses: actions/checkout@v4
       
      - name: "ğŸ§¹ Clean Environment (æ¸…ç†ç¯å¢ƒ)"
        run: |
          docker rmi -f $(docker images -q) || true
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d
          sudo apt-get purge -y azure-cli ghc* zulu* llvm* firefox google* dotnet* openjdk* mysql* php*
          sudo apt-get autoremove -y --purge
          sudo apt-get clean
          df -h
       
      - name: "âš™ï¸ Get Config Vars (è·å–é…ç½®å˜é‡)"
        id: var
        run: |
          config=$(jq -r 'to_entries[] | "\(.key)=\(.value)"' sgsi.json)
          while IFS= read -r line; do
            echo "$line" >> $GITHUB_OUTPUT
          done <<< "$config"
           
      - name: "ğŸ“¦ Install Tools (å®‰è£…å·¥å…·)"
        run: |
          sudo apt-get update
          sudo apt-get install -y axel curl wget pv aria2 jq brotli android-sdk-libsparse-utils
          echo "max-connections=32" | sudo tee -a /etc/axelrc
          echo "âœ… Tools installed (å·¥å…·å®‰è£…å®Œæˆ)"
           
      - name: "â¬‡ï¸ Download Build Tools (ä¸‹è½½æ„å»ºå·¥å…·)"
        run: |
          max_retries=3
          tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar"
          download_success=false
          
          rm -f SGSI-build-tool.tar
          
          for ((i=1; i<=max_retries; i++)); do
            echo "ğŸ“¥ ä¸‹è½½å°è¯• #$i (Attempt #$i)"
            
            if command -v aria2c &> /dev/null; then
              echo "ğŸ”§ ä½¿ç”¨aria2cä¸‹è½½ (Using aria2c)"
              if aria2c -x 16 -s 16 -k 1M -o "SGSI-build-tool.tar" "$tool_url"; then
                download_success=true
                break
              else
                echo "âš ï¸ aria2cå°è¯•å¤±è´¥ (aria2c attempt failed)"
              fi
            fi
            
            if command -v axel &> /dev/null; then
              echo "ğŸ”§ ä½¿ç”¨axelä¸‹è½½ (Using axel)"
              if axel -n 32 -U "Mozilla/5.0" -o "SGSI-build-tool.tar" "$tool_url"; then
                download_success=true
                break
              else
                echo "âš ï¸ axelå°è¯•å¤±è´¥ (axel attempt failed)"
              fi
            fi
            
            if command -v curl &> /dev/null; then
              echo "ğŸ”§ ä½¿ç”¨curlä¸‹è½½ (Using curl)"
              if curl -# -fL -o "SGSI-build-tool.tar" "$tool_url"; then
                download_success=true
                break
              else
                echo "âš ï¸ curlå°è¯•å¤±è´¥ (curl attempt failed)"
              fi
            elif command -v wget &> /dev/null; then
              echo "ğŸ”§ ä½¿ç”¨wgetä¸‹è½½ (Using wget)"
              if wget --show-progress -O "SGSI-build-tool.tar" "$tool_url"; then
                download_success=true
                break
              else
                echo "âš ï¸ wgetå°è¯•å¤±è´¥ (wget attempt failed)"
              fi
            fi
            
            [[ $i -lt max_retries ]] && sleep 10
          done
          
          if [[ -f "SGSI-build-tool.tar" ]] && [[ $(stat -c%s "SGSI-build-tool.tar") -gt 0 ]]; then
            echo "âœ… ä¸‹è½½å®Œæˆï¼æ–‡ä»¶å¤§å°: $(du -h SGSI-build-tool.tar | cut -f1) (Download completed! File size)"
          else
            echo "::error::âŒ æ‰€æœ‰ä¸‹è½½æ–¹å¼å¤±è´¥ (All download methods failed)"
            exit 1
          fi
          
      - name: "ğŸ” éªŒè¯ä¸‹è½½æ–‡ä»¶ (Verify Downloaded File)"
        run: |
          if ! tar -tf SGSI-build-tool.tar &> /dev/null; then
            echo "::error::âŒ æ–‡ä»¶æŸåæˆ–æ ¼å¼æ— æ•ˆ (File corrupted or invalid format)"
            exit 1
          fi
          echo "âœ… æ–‡ä»¶éªŒè¯é€šè¿‡ (File verification passed)"
      
      - name: "ğŸ—ï¸ Setup Env (è®¾ç½®ç¯å¢ƒ)"
        run: |
          sudo rm -rf SGSI-build-tool bin
          
          echo "ğŸ“‚ è§£å‹æ„å»ºå·¥å…· (Extracting build tools)..."
          sudo tar -xvf SGSI-build-tool.tar
          echo "âœ… è§£å‹å®Œæˆ (Extraction completed)"
          
          echo "ğŸ” ç›®å½•ç»“æ„ (Directory structure):"
          ls -l
          
          if [[ -d "SGSI-build-tool" ]]; then
            echo "âœ… æ‰¾åˆ°SGSI-build-toolç›®å½• (Found SGSI-build-tool directory)"
          else
            echo "::error::âŒ è§£å‹åæœªæ‰¾åˆ°SGSI-build-toolç›®å½• (SGSI-build-tool directory not found after extraction)"
            exit 1
          fi
          
          if [[ -f "SGSI-build-tool/10/setup.sh" ]]; then
            echo "âš™ï¸ è¿è¡Œå®‰è£…è„šæœ¬ (Running setup script)..."
            cd SGSI-build-tool/10
            sudo bash setup.sh
            cd ../..
            echo "âœ… å®‰è£…è„šæœ¬æ‰§è¡Œå®Œæˆ (Setup script executed)"
          elif [[ -f "bin/setup.sh" ]]; then
            echo "âš™ï¸ è¿è¡Œå®‰è£…è„šæœ¬ (ä»binç›®å½•) (Running setup script from bin directory)..."
            sudo bash bin/setup.sh
            echo "âœ… å®‰è£…è„šæœ¬æ‰§è¡Œå®Œæˆ (Setup script executed)"
          else
            echo "::error::âŒ æ‰¾ä¸åˆ°setup.sh (Setup script not found)"
            echo "å½“å‰ç›®å½•å†…å®¹ (Current directory contents):"
            ls -l
            exit 1
          fi
          
          echo "âœ… ç¯å¢ƒå‡†å¤‡å°±ç»ª (Environment ready)"
          
      - name: "ğŸ”§ Fix Architecture Issues (ä¿®å¤æ¶æ„é—®é¢˜)"
        run: |
          cd SGSI-build-tool/10
          
          # å¤‡ä»½ARMæ¶æ„çš„äºŒè¿›åˆ¶æ–‡ä»¶
          mkdir -p backup_arm_bin
          mv bin/* backup_arm_bin/ || true
          
          # åˆ›å»ºç¬¦å·é“¾æ¥ä½¿ç”¨ç³»ç»Ÿå·¥å…·
          ln -sf $(which brotli) bin/brotli
          ln -sf $(which simg2img) bin/simg2img
          ln -sf $(which img2simg) bin/img2simg
          ln -sf $(which mke2fs) bin/mke2fs
          ln -sf $(which e2fsdroid) bin/e2fsdroid
          
          echo "âœ… å·²ä¿®å¤äºŒè¿›åˆ¶å·¥å…·å…¼å®¹æ€§é—®é¢˜ (Fixed binary compatibility issues)"
          cd ../..

      - name: "ğŸ’¾ Download ROM (ä¸‹è½½ROM)"
        run: |
          rom_path="SGSI-build-tool/10/tmp/${{ steps.var.outputs.rom_name }}"
          rom_url="${{ steps.var.outputs.rom_url }}"
          
          for ((i=1; i<=5; i++)); do
            mkdir -p "$(dirname "$rom_path")"
            
            if command -v aria2c &> /dev/null; then
              echo "ğŸ”§ ä½¿ç”¨aria2cä¸‹è½½ROM (Using aria2c for ROM)"
              if aria2c -x 32 -s 32 -k 1M -d "$(dirname "$rom_path")" -o "$(basename "$rom_path")" "$rom_url"; then
                echo "âœ… ROMä¸‹è½½å®Œæˆ (ROM download completed)"
                break
              fi
            fi
            
            if command -v axel &> /dev/null; then
              echo "ğŸ”§ ä½¿ç”¨axelä¸‹è½½ROM (Using axel for ROM)"
              if axel -n 32 -U "Mozilla/5.0" -o "$rom_path" "$rom_url"; then
                echo "âœ… ROMä¸‹è½½å®Œæˆ (ROM download completed)"
                break
              fi
            fi
            
            if command -v curl &> /dev/null; then
              echo "ğŸ”§ ä½¿ç”¨curlä¸‹è½½ROM (Using curl for ROM)"
              if curl -# -fL -o "$rom_path" "$rom_url"; then
                echo "âœ… ROMä¸‹è½½å®Œæˆ (ROM download completed)"
                break
              fi
            fi
            
            if command -v wget &> /dev/null; then
              echo "ğŸ”§ ä½¿ç”¨wgetä¸‹è½½ROM (Using wget for ROM)"
              if wget --show-progress -O "$rom_path" "$rom_url"; then
                echo "âœ… ROMä¸‹è½½å®Œæˆ (ROM download completed)"
                break
              fi
            fi
            
            if [ $i -lt 5 ]; then
              echo "ğŸ”„ ä¸‹è½½å¤±è´¥ï¼Œé‡è¯•ä¸­ ($i/5)... (Download failed, retrying)"
              sleep 10
            else
              echo "::error::âŒ ROMä¸‹è½½å¤±è´¥ (ROM download failed)"
              exit 1
            fi
          done
          
          if [[ -f "$rom_path" ]] && [[ $(stat -c%s "$rom_path") -gt 0 ]]; then
            echo "ğŸ“¦ ROMå¤§å°: $(du -h "$rom_path" | cut -f1) (ROM size)"
          else
            echo "::error::âŒ ROMæ–‡ä»¶æ— æ•ˆ (Invalid ROM file)"
            exit 1
          fi

      - name: "âš™ï¸ Configure ROM (é…ç½®ROM)"
        id: configure_rom
        run: |
          rm -f SGSI-build-tool/10/fixbug/fixbug.sh
          
          rom_type=""
          [[ "${{ steps.var.outputs.make_super }}" = "true" ]] && \
            sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' SGSI-build-tool/10/make.sh
          
          if [[ "${{ steps.var.outputs.make_miui }}" = "true" ]]; then rom_type="MIUI"; fi
          if [[ "${{ steps.var.outputs.make_flyme }}" = "true" ]]; then rom_type="Flyme"; fi
          if [[ "${{ steps.var.outputs.make_coloros }}" = "true" ]]; then rom_type="ColorOS"; fi
          if [[ "${{ steps.var.outputs.make_h2os }}" = "true" ]]; then rom_type="H2OS"; fi
          if [[ "${{ steps.var.outputs.make_smartisanos }}" = "true" ]]; then rom_type="SmartisanOS"; fi
          if [[ "${{ steps.var.outputs.make_zui }}" = "true" ]]; then rom_type="ZUI"; fi
          
          [[ -z "$rom_type" ]] && rom_type="Generic"
          
          echo "â„¹ï¸ æ£€æµ‹åˆ°çš„ROMç±»å‹: $rom_type (Detected ROM type)"
          
          if [[ "$rom_type" = "ColorOS" ]]; then
            echo "ğŸ”“ è§£å¯†ColorOS ROM (Decrypting ColorOS ROM)..."
            sudo python3 SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py "SGSI-build-tool/10/tmp/${{ steps.var.outputs.rom_name }}"
            sudo rm -f "SGSI-build-tool/10/tmp/${{ steps.var.outputs.rom_name }}"
            echo "âœ… ColorOS ROMè§£å¯†å®Œæˆ (ColorOS ROM decrypted)"
          fi
          
          if [[ -f "fix/${rom_type}.sh" ]]; then
            echo "âš™ï¸ åº”ç”¨$rom_typeé…ç½®è„šæœ¬ (Applying $rom_type fix script)..."
            cp "fix/${rom_type}.sh" SGSI-build-tool/10/fixbug/fixbug.sh
            echo "âœ… $rom_typeé…ç½®å®Œæˆ ($rom_type configuration applied)"
          else
            echo "âš ï¸ æ‰¾ä¸åˆ°$rom_typeé…ç½®è„šæœ¬ (Fix script for $rom_type not found), ä½¿ç”¨é€šç”¨é…ç½® (using generic)"
          fi
            
          echo "rom_type=$rom_type" >> $GITHUB_OUTPUT
          
      - name: "ğŸ”§ Fix Script Errors (ä¿®å¤è„šæœ¬é”™è¯¯)"
        run: |
          cd SGSI-build-tool/10
          
          # ä¿®å¤æ¡ä»¶åˆ¤æ–­è¯­æ³•é”™è¯¯
          sed -i -e 's/\[ \]/\[ -n /g' \
                 -e 's/\] =/ \]/g' \
                 -e 's/==/=/g' SGSI.sh
                 
          echo "âœ… å·²ä¿®å¤è„šæœ¬è¯­æ³•é”™è¯¯ (Fixed script syntax errors)"
          cd ../..
          
      - name: "ğŸ› ï¸ Build SGSI (æ„å»ºSGSI)"
        run: |
          cd SGSI-build-tool/10
          
          # ç¡®ä¿å¿…è¦çš„ç›®å½•å­˜åœ¨
          [[ -d "../make" ]] && sudo mv ../make/*.sh . || echo "::warning::âš ï¸ makeç›®å½•ä¸å­˜åœ¨"
          [[ -d "../bin" ]] && sudo mv ../bin/mke2fs ../bin/e2fsdroid . || echo "::warning::âš ï¸ binç›®å½•ä¸å­˜åœ¨"
          
          echo "ğŸ—ï¸ å¼€å§‹æ„å»ºSGSI (Starting SGSI build)..."
          sudo bash make.sh || { echo "::error::âŒ æ„å»ºå¤±è´¥ (Build failed)"; exit 1; }
          echo "ğŸ‰ æ„å»ºå®Œæˆ (Build completed)"
             
      - name: "ğŸ“¦ Package Output (æ‰“åŒ…è¾“å‡º)"
        run: |
          cd SGSI-build-tool/10
          
          if [[ -d "Patch/Patch1" ]]; then
            for dir in Patch/Patch{1..3}; do
              if [[ -d "$dir" ]]; then
                zip -r "${dir##*/}.zip" "$dir"/*
                mv "${dir##*/}.zip" SGSI/
              else
                echo "::warning::âš ï¸ è¡¥ä¸ç›®å½• $dir ä¸å­˜åœ¨ (Patch directory $dir not found)"
              fi
            done
          else
            echo "::warning::âš ï¸ æœªæ‰¾åˆ°è¡¥ä¸ç›®å½• (Patch directories not found)"
          fi
          
          if [[ -d "SGSI" ]]; then
            zip -r "${{ steps.var.outputs.pack_sgsi }}" SGSI/*
          else
            echo "::error::âŒ SGSIç›®å½•ä¸å­˜åœ¨ (SGSI directory not found)"
            exit 1
          fi
          
          mkdir -p upload
          file_size=$(stat -c%s "${{ steps.var.outputs.pack_sgsi }}")
          max_size=2097152000
          
          if [[ $file_size -gt $max_size ]]; then
            echo "âš ï¸ æ–‡ä»¶è¿‡å¤§ ($(numfmt --to=iec $file_size))ï¼Œè¿›è¡Œåˆ†å·æ‰“åŒ… (File too large, splitting)..."
            split -b 1024m "${{ steps.var.outputs.pack_sgsi }}" "upload/${{ steps.var.outputs.pack_sgsi }}_"
            rm "${{ steps.var.outputs.pack_sgsi }}"
          else
            mv "${{ steps.var.outputs.pack_sgsi }}" upload/
          fi
          
          echo "ğŸ“ ä¸Šä¼ ç›®å½•å†…å®¹ (Upload directory contents):"
          ls -lh upload
          
      - name: "ğŸ·ï¸ Generate Release Tag (ç”Ÿæˆå‘å¸ƒæ ‡ç­¾)"
        id: release_tag
        run: |
          current_date=$(date +"%Y%m%d")
          release_tag="${current_date}_${{ steps.configure_rom.outputs.rom_type }}"
          echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
          echo "Generated release tag: $release_tag (ç”Ÿæˆçš„å‘å¸ƒæ ‡ç­¾: $release_tag)"
             
      - name: "ğŸš€ Upload Artifacts (ä¸Šä¼ äº§ç‰©)"
        uses: ncipollo/release-action@v1.11.0
        with:
          artifacts: upload/*
          name: xiaoxinSGSI-ab-Android10-unpack
          tag: ${{ steps.release_tag.outputs.release_tag }}
          token: ${{ secrets.GITHUB_TOKEN }}
