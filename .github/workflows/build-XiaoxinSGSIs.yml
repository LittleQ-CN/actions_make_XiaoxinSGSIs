æˆ‘ç†è§£æ‚¨éœ€è¦ä¸€ä¸ªå®Œæ•´çš„æ•´åˆæ–¹æ¡ˆï¼Œå°†å¸¦è¿›åº¦æ¡çš„ä¸‹è½½å·¥å…·å’ŒROMä¸‹è½½æ­¥éª¤æ•´åˆåˆ°æ•´ä¸ªå·¥ä½œæµä¸­ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´çš„ `build.yml` æ–‡ä»¶ï¼ŒåŒ…å«äº†ä¼˜åŒ–çš„ä¸‹è½½è¿›åº¦æ˜¾ç¤ºï¼š

```yaml
name: build_XiaoxinSGSIs

on:
  watch:
    types: [started]

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
    - name: åˆå§‹åŒ–ç¯å¢ƒ
      run: |
        rm -rf SGSI-build-tool upload || true
        df -h
        
    - name: æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: éªŒè¯é…ç½®æ–‡ä»¶å­˜åœ¨
      id: config_check
      run: |
        echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
        ls -la
        
        if [ ! -f sgsi.json ]; then
          echo "::error::âŒ sgsi.json é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
          echo "è¯·åœ¨ä»“åº“æ ¹ç›®å½•åˆ›å»ºsgsi.jsonæ–‡ä»¶å¹¶å¡«å†™é…ç½®"
          exit 1
        fi
        echo "âœ… é…ç½®æ–‡ä»¶å­˜åœ¨"
    
    - name: å®‰è£…ä¾èµ–å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y jq pigz aria2
        
        if ! command -v jq &> /dev/null; then
          echo "::error::âŒ jq æœªå®‰è£…æˆåŠŸ"
          exit 1
        fi
        echo "âœ… jq ç‰ˆæœ¬: $(jq --version)"
        
        if ! command -v pigz &> /dev/null; then
          echo "::warning::âš ï¸ pigz æœªå®‰è£…ï¼Œå°†ä½¿ç”¨gzipè¿›è¡Œå‹ç¼©"
        fi
    
    - name: è¯»å–é…ç½®æ–‡ä»¶
      id: config
      run: |
        # éªŒè¯JSONæ ¼å¼
        if ! jq empty sgsi.json; then
          echo "::error::âŒ sgsi.json æ ¼å¼æ— æ•ˆ"
          echo "è¯·æ£€æŸ¥JSONè¯­æ³•æ˜¯å¦æ­£ç¡®"
          exit 1
        fi
        
        # è¯»å–æ‰€æœ‰é…ç½®å­—æ®µ
        rom_url=$(jq -r '.rom_url' sgsi.json)
        rom_name=$(jq -r '.rom_name' sgsi.json)
        pack_sgsi=$(jq -r '.pack_sgsi' sgsi.json)
        upload_artifact=$(jq -r '.upload_artifact' sgsi.json)
        upload_wetransfer=$(jq -r '.upload_wetransfer' sgsi.json)
        make_miui=$(jq -r '.make_miui' sgsi.json)
        make_flyme=$(jq -r '.make_flyme' sgsi.json)
        make_coloros=$(jq -r '.make_coloros' sgsi.json)
        make_h2os=$(jq -r '.make_h2os' sgsi.json)
        make_smartisanos=$(jq -r '.make_smartisanos' sgsi.json)
        make_zui=$(jq -r '.make_zui' sgsi.json)
        make_super=$(jq -r '.make_super' sgsi.json)
        
        # è®¾ç½®é»˜è®¤å€¼ï¼ˆå¤„ç†nullå€¼ï¼‰
        [ "$upload_artifact" == "null" ] && upload_artifact=true
        [ "$upload_wetransfer" == "null" ] && upload_wetransfer=false
        [ "$make_super" == "null" ] && make_super=false
        
        # æ£€æŸ¥å¿…éœ€å­—æ®µ
        if [ -z "$rom_url" ] || [ "$rom_url" == "null" ]; then
          echo "::error::âŒ rom_url æœªå®šä¹‰"
          echo "è¯·åœ¨sgsi.jsonä¸­æä¾›rom_url"
          exit 1
        fi
        
        # å¦‚æœrom_nameä¸ºç©ºï¼Œåˆ™ä»URLä¸­æå–æ–‡ä»¶å
        if [ -z "$rom_name" ] || [ "$rom_name" == "null" ]; then
          rom_name=$(basename "$rom_url")
          echo "â„¹ï¸ ä»URLæå–ROMæ–‡ä»¶å: $rom_name"
        fi
        
        # ROMç±»å‹æ£€æŸ¥
        rom_types=(miui flyme coloros h2os smartisanos zui)
        type_count=0
        current_type=""
        
        echo "ğŸ” æ£€æŸ¥ROMç±»å‹é…ç½®:"
        for type in "${rom_types[@]}"; do
          # ä½¿ç”¨åŠ¨æ€å˜é‡å
          value_name="make_${type}"
          value=${!value_name}
          
          # å¤„ç†nullå€¼
          [ "$value" == "null" ] && value="false"
          
          echo "  make_$type = $value"
          
          if [ "$value" == "true" ]; then
            type_count=$((type_count + 1))
            current_type=$type
          fi
        done
        
        if [ $type_count -gt 1 ]; then
          echo "::error::âŒ åªèƒ½å¯ç”¨ä¸€ä¸ªROMç±»å‹"
          echo "è¯·æ£€æŸ¥sgsi.jsoné…ç½®ï¼Œåªèƒ½æœ‰ä¸€ä¸ªmake_*è®¾ä¸ºtrue"
          exit 1
        fi
        
        # è¾“å‡ºç¯å¢ƒå˜é‡
        echo "rom_url=$rom_url" >> $GITHUB_ENV
        echo "rom_name=$rom_name" >> $GITHUB_ENV
        echo "pack_sgsi=$pack_sgsi" >> $GITHUB_ENV
        echo "upload_artifact=$upload_artifact" >> $GITHUB_ENV
        echo "upload_wetransfer=$upload_wetransfer" >> $GITHUB_ENV
        echo "make_miui=$make_miui" >> $GITHUB_ENV
        echo "make_flyme=$make_flyme" >> $GITHUB_ENV
        echo "make_coloros=$make_coloros" >> $GITHUB_ENV
        echo "make_h2os=$make_h2os" >> $GITHUB_ENV
        echo "make_smartisanos=$make_smartisanos" >> $GITHUB_ENV
        echo "make_zui=$make_zui" >> $GITHUB_ENV
        echo "make_super=$make_super" >> $GITHUB_ENV
        echo "rom_type=$current_type" >> $GITHUB_ENV
        
        # æ˜¾ç¤ºè¯»å–çš„é…ç½®æ‘˜è¦
        echo "âœ… é…ç½®è¯»å–æˆåŠŸ:"
        echo "  ROM URL: $rom_url"
        echo "  ROMåç§°: $rom_name"
        echo "  ROMç±»å‹: ${current_type:-æ— }"
        echo "  æ‰“åŒ…åç§°: $pack_sgsi"
        echo "  Artifactä¸Šä¼ : $upload_artifact"
        echo "  WeTransferä¸Šä¼ : $upload_wetransfer"
    
    - name: ä¸‹è½½æ„å»ºå·¥å…·ï¼ˆå¸¦è¿›åº¦æ¡ï¼‰
      timeout-minutes: 5
      run: |
        tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar"
        filename="SGSI-build-tool.tar"
        
        # è·å–æ–‡ä»¶å¤§å°å‡½æ•°
        get_file_size() {
          curl -sI "$1" | grep -i 'content-length' | awk '{print $2}' | tr -d '\r'
        }
        
        # æ ¼å¼åŒ–æ–‡ä»¶å¤§å°å‡½æ•°
        format_size() {
          local size=$1
          if [ $size -ge $((1024*1024*1024)) ]; then
            printf "%.1fGB" $(echo "scale=1; $size/(1024*1024*1024)" | bc)
          elif [ $size -ge $((1024*1024)) ]; then
            printf "%.1fMB" $(echo "scale=1; $size/(1024*1024)" | bc)
          elif [ $size -ge 1024 ]; then
            printf "%.1fKB" $(echo "scale=1; $size/1024" | bc)
          else
            printf "%dB" $size
          fi
        }
        
        # è·å–æ–‡ä»¶å¤§å°
        file_size=$(get_file_size "$tool_url")
        if [ -z "$file_size" ]; then
          file_size=$((150*1024*1024))  # é»˜è®¤150MB
          echo "âš ï¸ æ— æ³•è·å–æ–‡ä»¶å¤§å°ï¼Œä½¿ç”¨é»˜è®¤å€¼: $(format_size $file_size)"
        else
          echo "â„¹ï¸ æ–‡ä»¶å¤§å°: $(format_size $file_size)"
        fi
        
        formatted_size=$(format_size $file_size)
        echo "â¬‡ï¸ ä¸‹è½½ $filename [$formatted_size]"
        
        # è¿›åº¦æ¡å‡½æ•°
        progress_bar() {
          local total=$1
          local current=$2
          local width=20  # è¿›åº¦æ¡å®½åº¦
          local percent=$((current * 100 / total))
          local progress=$((current * width / total))
          local rest=$((width - progress))
          
          printf "\r["
          printf "%${progress}s" | tr ' ' '#'
          printf "%${rest}s" | tr ' ' '-'
          printf "] %3d%%" $percent
        }
        
        # ä½¿ç”¨curlä¸‹è½½å¹¶æ˜¾ç¤ºè¿›åº¦
        download_with_curl() {
          echo "âš™ï¸ ä½¿ç”¨ curl"
          curl -L --progress-bar -o "$filename" "$tool_url" \
            | while IFS= read -r line; do
                if [[ $line =~ ([0-9]+)\ ([0-9.]+)% ]]; then
                  current=${BASH_REMATCH[1]}
                  progress_bar $file_size $current
                fi
              done
          echo  # æ–°è¡Œ
        }
        
        # ä½¿ç”¨aria2cä¸‹è½½å¹¶æ˜¾ç¤ºè¿›åº¦
        download_with_aria2c() {
          echo "âš™ï¸ ä½¿ç”¨ aria2c"
          aria2c -x8 -s8 -k1M --show-console-readout=false --summary-interval=1 \
                 "$tool_url" -o "$filename" 2>&1 \
            | while IFS= read -r line; do
                if [[ $line =~ \(([0-9]*)%\) ]]; then
                  percent=${BASH_REMATCH[1]}
                  current=$((file_size * percent / 100))
                  progress_bar $file_size $current
                fi
              done
          echo  # æ–°è¡Œ
        }
        
        # å°è¯•ä¸‹è½½
        if command -v aria2c &> /dev/null; then
          download_with_aria2c
        else
          download_with_curl
        fi
        
        # éªŒè¯ä¸‹è½½
        if [ ! -f "$filename" ]; then
          echo "::error::âŒ ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
        # éªŒè¯æ–‡ä»¶å¤§å°
        actual_size=$(stat -c%s "$filename")
        if [ $actual_size -lt $((file_size * 9 / 10)) ]; then
          echo "::error::âŒ æ–‡ä»¶å¤§å°ä¸åŒ¹é… (åº”ä¸º: $formatted_size, å®é™…: $(format_size $actual_size))"
          exit 1
        fi
        
        # éªŒè¯å‹ç¼©åŒ…å®Œæ•´æ€§
        if ! tar -tf "$filename" >/dev/null 2>&1; then
          echo "::error::âŒ å·¥å…·åŒ…æŸå"
          exit 1
        fi
        
        echo "âœ… ä¸‹è½½å®Œæˆ [$(format_size $actual_size)]"
        echo "âœ… å·¥å…·åŒ…éªŒè¯é€šè¿‡"
    
    - name: è®¾ç½®æ„å»ºç¯å¢ƒ
      run: |
        tar -xf SGSI-build-tool.tar
        chmod -R +x SGSI-build-tool
        
        cd SGSI-build-tool/10
        ./setup.sh || echo "âš ï¸ å¿½ç•¥éå…³é”®é”™è¯¯"
        cd ../..
        
        echo "ğŸ› ï¸ æ„å»ºç¯å¢ƒå·²è®¾ç½®"
    
    - name: ä¸‹è½½ROMæ–‡ä»¶ï¼ˆå¸¦è¿›åº¦æ¡ï¼‰
      timeout-minutes: 30
      run: |
        rom_path="SGSI-build-tool/10/tmp/${{ env.rom_name }}"
        rom_url="${{ env.rom_url }}"
        filename="${{ env.rom_name }}"
        echo "â¬‡ï¸ ä¸‹è½½ROM: ${{ env.rom_url }}"
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        mkdir -p "$(dirname "$rom_path")"
        
        # è·å–æ–‡ä»¶å¤§å°å‡½æ•°
        get_file_size() {
          curl -sI "$1" | grep -i 'content-length' | awk '{print $2}' | tr -d '\r'
        }
        
        # æ ¼å¼åŒ–æ–‡ä»¶å¤§å°å‡½æ•°
        format_size() {
          local size=$1
          if [ $size -ge $((1024*1024*1024)) ]; then
            printf "%.1fGB" $(echo "scale=1; $size/(1024*1024*1024)" | bc)
          elif [ $size -ge $((1024*1024)) ]; then
            printf "%.1fMB" $(echo "scale=1; $size/(1024*1024)" | bc)
          elif [ $size -ge 1024 ]; then
            printf "%.1fKB" $(echo "scale=1; $size/1024" | bc)
          else
            printf "%dB" $size
          fi
        }
        
        # è·å–æ–‡ä»¶å¤§å°
        file_size=$(get_file_size "$rom_url")
        if [ -z "$file_size" ]; then
          # ä½¿ç”¨é»˜è®¤å¤§å°æç¤ºï¼ˆä¸å¼ºåˆ¶ï¼‰
          min_size=$((100*1024*1024))  # 100MB
          echo "âš ï¸ æ— æ³•è·å–ROMæ–‡ä»¶å¤§å°ï¼Œå°†ä½¿ç”¨é»˜è®¤éªŒè¯é˜ˆå€¼: $(format_size $min_size)"
        else
          echo "â„¹ï¸ ROMå¤§å°: $(format_size $file_size)"
        fi
        
        formatted_size=$(format_size ${file_size:-0})
        echo "â¬‡ï¸ ä¸‹è½½ $filename [${formatted_size:-æœªçŸ¥å¤§å°}]"
        
        # è¿›åº¦æ¡å‡½æ•°ï¼ˆåŒä¸Šï¼‰
        progress_bar() {
          local total=$1
          local current=$2
          local width=20  # è¿›åº¦æ¡å®½åº¦
          local percent=$((current * 100 / total))
          local progress=$((current * width / total))
          local rest=$((width - progress))
          
          printf "\r["
          printf "%${progress}s" | tr ' ' '#'
          printf "%${rest}s" | tr ' ' '-'
          printf "] %3d%%" $percent
        }
        
        # ä½¿ç”¨aria2cä¸‹è½½å¹¶æ˜¾ç¤ºè¿›åº¦ï¼ˆä¼˜å…ˆï¼‰
        if command -v aria2c &> /dev/null; then
          echo "âš™ï¸ ä½¿ç”¨ aria2c"
          aria2c -x8 -s8 -k1M --show-console-readout=false --summary-interval=1 \
                 "$rom_url" -d "$(dirname "$rom_path")" -o "$filename" 2>&1 \
            | while IFS= read -r line; do
                if [[ $line =~ \(([0-9]*)%\) ]]; then
                  percent=${BASH_REMATCH[1]}
                  # å¦‚æœçŸ¥é“æ–‡ä»¶å¤§å°ï¼Œåˆ™è®¡ç®—å½“å‰å­—èŠ‚æ•°ï¼Œå¦åˆ™ç”¨ç™¾åˆ†æ¯”æ¨¡æ‹Ÿ
                  if [ -n "$file_size" ]; then
                    current=$((file_size * percent / 100))
                    progress_bar $file_size $current
                  else
                    # æœªçŸ¥æ–‡ä»¶å¤§å°æ—¶åªæ˜¾ç¤ºç™¾åˆ†æ¯”
                    printf "\r[%-20s] %3d%%" $(printf "%${percent}s" | tr ' ' '#') $percent
                  fi
                fi
              done
          echo  # æ–°è¡Œ
        else
          # ä½¿ç”¨curlä½œä¸ºå¤‡é€‰
          echo "âš™ï¸ ä½¿ç”¨ curl"
          curl -L --progress-bar -o "$rom_path" "$rom_url" \
            | while IFS= read -r line; do
                if [[ $line =~ ([0-9]+)\ ([0-9.]+)% ]]; then
                  current=${BASH_REMATCH[1]}
                  if [ -n "$file_size" ]; then
                    progress_bar $file_size $current
                  else
                    percent=${BASH_REMATCH[2]}
                    printf "\r[%-20s] %3d%%" $(printf "%${percent}s" | tr ' ' '#') ${BASH_REMATCH[2]%.*}
                  fi
                fi
              done
          echo  # æ–°è¡Œ
        fi
        
        # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
        if [ ! -f "$rom_path" ]; then
          echo "::error::âŒ ROMä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
        actual_size=$(stat -c%s "$rom_path")
        if [ -n "$file_size" ]; then
          if [ $actual_size -lt $((file_size * 9 / 10)) ]; then
            echo "::error::âŒ ROMå¤§å°ä¸åŒ¹é… (åº”ä¸º: $(format_size $file_size), å®é™…: $(format_size $actual_size))"
            exit 1
          fi
        else
          # æ²¡æœ‰åŸå§‹æ–‡ä»¶å¤§å°æ—¶ï¼ŒéªŒè¯æœ€å°å¤§å°
          min_size=$((100*1024*1024))  # 100MB
          if [ $actual_size -lt $min_size ]; then
            echo "::error::âŒ ROMæ–‡ä»¶å¼‚å¸¸ (å¤§å°: $(format_size $actual_size))"
            exit 1
          fi
        fi
        
        echo "âœ… ROMä¸‹è½½å®Œæˆ [$(format_size $actual_size)]"
    
    - name: å¤„ç†ROMç±»å‹
      run: |
        cd SGSI-build-tool/10
        
        # åº”ç”¨é€šç”¨ä¿®å¤è„šæœ¬
        if [ -f "../../fix/fixbug.sh" ]; then
          cp ../../fix/fixbug.sh fixbug/fixbug.sh
          chmod +x fixbug/fixbug.sh
          echo "ğŸ› ï¸ åº”ç”¨é€šç”¨ä¿®å¤è„šæœ¬..."
          ./fixbug/fixbug.sh || echo "âš ï¸ é€šç”¨ä¿®å¤è„šæœ¬æ‰§è¡Œå¼‚å¸¸"
        fi
        
        # åº”ç”¨ROMç±»å‹ä¸“ç”¨è„šæœ¬
        if [ -n "${{ env.rom_type }}" ] && [ -f "../../fix/${{ env.rom_type }}_fixbug.sh" ]; then
          cp "../../fix/${{ env.rom_type }}_fixbug.sh" "fixbug/${{ env.rom_type }}_fixbug.sh"
          chmod +x "fixbug/${{ env.rom_type }}_fixbug.sh"
          echo "ğŸ› ï¸ åº”ç”¨${{ env.rom_type }}ä¸“ç”¨ä¿®å¤è„šæœ¬..."
          ./fixbug/${{ env.rom_type }}_fixbug.sh || echo "âš ï¸ ${{ env.rom_type }}ä¿®å¤è„šæœ¬æ‰§è¡Œå¼‚å¸¸"
        fi
        
        # ROMç±»å‹ç‰¹æ®Šå¤„ç†
        case "${{ env.rom_type }}" in
          coloros)
            echo "ğŸ”“ è§£å¯†ColorOS ROM..."
            python3 oppo_ozip/ozipdecrypt.py "tmp/${{ env.rom_name }}"
            decrypted_file="${rom_name%.*}.img"
            if [ -f "tmp/$decrypted_file" ]; then
              rm -f "tmp/${{ env.rom_name }}"
              echo "âœ… è§£å¯†æˆåŠŸ: $decrypted_file"
              echo "rom_name=$decrypted_file" >> $GITHUB_ENV
            else
              echo "::error::âŒ ColorOSè§£å¯†å¤±è´¥"
              exit 1
            fi
            ;;
          miui)
            echo "ğŸš æ‰§è¡ŒMIUIç‰¹æ®Šå¤„ç†..."
            # è¿™é‡Œå¯ä»¥æ·»åŠ MIUIç‰¹å®šçš„å¤„ç†é€»è¾‘
            ;;
          *)
            echo "â„¹ï¸ ROMç±»å‹: ${{ env.rom_type }}ï¼Œæ— éœ€ç‰¹æ®Šå¤„ç†"
            ;;
        esac
        
        # å¤„ç†Superåˆ†åŒºæ”¯æŒ
        if [ "${{ env.make_super }}" == "true" ]; then
          sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' make.sh
          echo "ğŸ› ï¸ å¯ç”¨Superåˆ†åŒºæ”¯æŒ"
        fi
    
    - name: æ„å»ºç³»ç»Ÿé•œåƒ
      timeout-minutes: 120
      run: |
        cd SGSI-build-tool/10
        
        # å¤åˆ¶è‡ªå®šä¹‰æ–‡ä»¶
        if [ -d "../../make" ]; then
          cp -f ../../make/* ./
          echo "ğŸ“‚ å·²æ·»åŠ è‡ªå®šä¹‰makeæ–‡ä»¶"
        fi
        if [ -d "../../bin" ]; then
          cp -f ../../bin/* bin/
          echo "ğŸ“‚ å·²æ·»åŠ è‡ªå®šä¹‰binæ–‡ä»¶"
        fi
        
        # ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
        find . -name "*.sh" -exec chmod +x {} \;
        chmod +x bin/*
        
        echo "::group::ğŸ“œ æ„å»ºæ—¥å¿—"
        ./make.sh || build_failed=true
        echo "::endgroup::"
        
        if [ "$build_failed" = true ]; then
          echo "âš ï¸ æ„å»ºå¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨åˆ›å»ºé•œåƒ..."
          if [ -d "out/system" ]; then
            size_kb=$(du -sk out/system/ | cut -f1)
            img_size_kb=$((size_kb * 130 / 100))
            img_size_mb=$((img_size_kb / 1024))
            [ $img_size_mb -lt 512 ] && img_size_mb=512
            
            ./bin/make_ext4fs -T 0 -S out/config/system_file_contexts \
                              -C out/config/system_fs_config \
                              -l ${img_size_mb}M -a system out/system.img out/system/
            
            if [ -f "out/system.img" ]; then
              mkdir -p SGSI
              mv out/system.img SGSI/
              echo "âœ… æ‰‹åŠ¨åˆ›å»ºé•œåƒæˆåŠŸ"
            else
              echo "::error::âŒ æ— æ³•æ‰‹åŠ¨åˆ›å»ºé•œåƒ"
              exit 1
            fi
          else
            echo "::error::âŒ æ„å»ºå¤±è´¥ä¸”æ— å¯ç”¨ç³»ç»Ÿæ–‡ä»¶"
            exit 1
          fi
        else
          echo "âœ… æ„å»ºæˆåŠŸ"
        fi
        
        # æ•´ç†è¾“å‡ºæ–‡ä»¶
        mkdir -p ../final_out
        mv SGSI/* ../final_out/ 2>/dev/null || true
        mv out/*.img ../final_out/ 2>/dev/null || true
        
        if [ -f "../final_out/system.img" ]; then
          orig_size=$(du -h "../final_out/system.img" | cut -f1)
          echo "åŸå§‹å¤§å°: $orig_size" >> ../final_out/build_info.txt
        fi
        
        echo "ğŸ“ è¾“å‡ºæ–‡ä»¶åˆ—è¡¨:"
        ls -l ../final_out/
    
    - name: æ‰“åŒ…è¡¥ä¸
      if: ${{ success() }}
      run: |
        if [ -d "Patch" ]; then
          cd Patch
          for dir in */; do
            if [ -d "$dir" ]; then
              dir_name="${dir%/}"
              echo "ğŸ“¦ æ‰“åŒ…è¡¥ä¸: $dir_name"
              zip -r -0 "../../SGSI-build-tool/final_out/${dir_name}.zip" "$dir_name"
            fi
          done
          cd ..
        else
          echo "â„¹ï¸ æœªæ‰¾åˆ°Patchç›®å½•ï¼Œè·³è¿‡è¡¥ä¸æ‰“åŒ…"
        fi
    
    - name: å‹ç¼©ç³»ç»Ÿé•œåƒ
      if: ${{ success() }}
      run: |
        cd SGSI-build-tool/final_out
        
        if [ -f "system.img" ]; then
          echo "ğŸ“¦ å¼€å§‹å‹ç¼©system.img..."
          original_size=$(du -h system.img | cut -f1)
          
          if command -v pigz &> /dev/null; then
            echo "âš™ï¸ ä½¿ç”¨pigzè¿›è¡Œå¤šçº¿ç¨‹å‹ç¼©..."
            pigz -k -f -9 system.img
          else
            echo "âš™ï¸ ä½¿ç”¨gzipè¿›è¡Œå‹ç¼©..."
            gzip -k -f -9 system.img
          fi
          
          compressed_size=$(du -h system.img.gz | cut -f1)
          echo "å‹ç¼©åå¤§å°: $compressed_size" >> build_info.txt
          
          orig_bytes=$(stat -c%s system.img)
          comp_bytes=$(stat -c%s system.img.gz)
          ratio=$(echo "scale=2; (1 - $comp_bytes/$orig_bytes) * 100" | bc)
          echo "å‹ç¼©ç‡: $ratio%" >> build_info.txt
          
          echo "âœ… å‹ç¼©å®Œæˆ: ${original_size} â†’ ${compressed_size} (èŠ‚çœ ${ratio}%)"
          ls -lh system.img*
        else
          echo "â„¹ï¸ æœªæ‰¾åˆ°system.imgï¼Œè·³è¿‡å‹ç¼©"
        fi
    
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      if: ${{ success() }}
      run: |
        cd SGSI-build-tool/final_out
        
        if [ -z "$(ls -A .)" ]; then
          echo "::error::âŒ æ— å¯ç”¨è¾“å‡ºæ–‡ä»¶"
          exit 1
        fi
        
        pack_name="${{ env.pack_sgsi }}"
        
        # æ˜¾ç¤ºæ„å»ºä¿¡æ¯
        if [ -f "build_info.txt" ]; then
          echo "::group::ğŸ“Š é•œåƒå‹ç¼©ä¿¡æ¯"
          cat build_info.txt
          echo "::endgroup::"
          
          orig_size=$(grep "åŸå§‹å¤§å°" build_info.txt | cut -d: -f2 | xargs)
          comp_size=$(grep "å‹ç¼©åå¤§å°" build_info.txt | cut -d: -f2 | xargs)
          ratio=$(grep "å‹ç¼©ç‡" build_info.txt | cut -d: -f2 | xargs)
          
          if [ -n "$orig_size" ] && [ -n "$comp_size" ]; then
            echo "âœ… å‹ç¼©ç»“æœ: ${orig_size} â†’ ${comp_size} (èŠ‚çœ $ratio)"
          fi
        fi
        
        # æ‰“åŒ…æ–‡ä»¶
        echo "ğŸ“¦ åˆ›å»ºå‘å¸ƒåŒ…: $pack_name"
        zip -r -0 "../$pack_name" .
        
        # å¤„ç†å¤§æ–‡ä»¶åˆ†å‰²
        cd ..
        file_size=$(stat -c%s "$pack_name")
        max_size=1400000000  # 1.4GB
        
        if [ $file_size -gt $max_size ]; then
          echo "âœ‚ï¸ åˆ†å‰²å¤§æ–‡ä»¶ (å¤§å°: $((file_size/1024/1024))MB)"
          split -b 1000M -d "$pack_name" "${pack_name}_part"
          rm "$pack_name"
          packed_files=($(ls "${pack_name}"_part*))
        else
          packed_files=("$pack_name")
          echo "â„¹ï¸ æ–‡ä»¶å¤§å°: $((file_size/1024/1024))MBï¼Œæ— éœ€åˆ†å‰²"
        fi
        
        # å‡†å¤‡ä¸Šä¼ 
        mkdir -p ../upload
        mv "${packed_files[@]}" ../upload/ || true
        
        # è®¾ç½®ä¸Šä¼ æ–‡ä»¶è·¯å¾„
        output_file=$(ls $PWD/../upload/$pack_name* | head -n1)
        if [ -n "$output_file" ]; then
          echo "ğŸ“ ä¸Šä¼ æ–‡ä»¶: $(basename "$output_file")"
          echo "OUTPUT_FILE=$output_file" >> $GITHUB_ENV
        else
          echo "::error::âŒ æœªæ‰¾åˆ°è¾“å‡ºæ–‡ä»¶"
          exit 1
        fi
    
    - name: å‘å¸ƒGitHubç‰ˆæœ¬
      uses: softprops/action-gh-release@v1
      with:
        files: upload/*
        tag_name: build-${{ github.run_number }}
        generate_release_notes: true
        body: |
          æ„å»º #${{ github.run_number }} å·²å®Œæˆï¼
          
          **å…³é”®ä¿¡æ¯**:
          - ROMåç§°: ${{ env.rom_name }}
          - ROMç±»å‹: ${{ env.rom_type || 'æ— ' }}
          - æ„å»ºæ—¶é—´: ${{ steps.date.outputs.formattedDate }}
          
          ${{ env.upload_wetransfer == 'true' && '>  ï¸ **é‡è¦æç¤º**ï¼šæœ¬æ„å»ºåŒ…å«WeTransferä¸‹è½½é“¾æ¥ï¼ˆæœ‰æ•ˆæœŸ7å¤©ï¼‰ï¼Œè¯·åœ¨ä½œä¸šæ‘˜è¦ä¸­æŸ¥çœ‹è¯¦æƒ…ï¼' || '' }}
    
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      if: ${{ env.upload_artifact == 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: SGSI-build-output
        path: upload/*
        retention-days: 7
        
    - name: ä¸Šä¼ åˆ°WeTransfer
      if: ${{ env.upload_wetransfer == 'true' }}
      run: |
        echo "â˜ï¸ ä¸Šä¼ åˆ°WeTransfer..."
        cd $GITHUB_WORKSPACE
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$OUTPUT_FILE" ]; then
          echo "::error::âŒ è¦ä¸Šä¼ çš„æ–‡ä»¶ä¸å­˜åœ¨: $OUTPUT_FILE"
          exit 1
        fi
        
        # è·å–æ–‡ä»¶å¤§å°ä¿¡æ¯
        FILE_SIZE=$(du -h "$OUTPUT_FILE" | cut -f1)
        echo "â¬†ï¸ å¼€å§‹ä¸Šä¼ æ–‡ä»¶: $(basename "$OUTPUT_FILE") (å¤§å°: $FILE_SIZE)..."
        
        # è®¡ç®—åˆ°æœŸæ—¥æœŸ
        EXPIRY_DATE=$(date -d "+7 days" "+%Y-%m-%d")
        
        # ä¸Šä¼ å¹¶è·å–ç»“æœ
        curl -sL https://git.io/file-transfer | sh
        TRANSFER_OUTPUT=$(./transfer wet "$OUTPUT_FILE")
        echo "$TRANSFER_OUTPUT"
        
        # æå–ä¸‹è½½é“¾æ¥
        DOWNLOAD_LINK=$(echo "$TRANSFER_OUTPUT" | grep -o 'https://we.tl/[^ ]*' | head -n1)
        if [ -n "$DOWNLOAD_LINK" ]; then
          # æ·»åŠ åˆ°å·¥ä½œæµæ‘˜è¦ï¼ˆå¸¦æœ‰æ•ˆæœŸå£°æ˜ï¼‰
          echo "##   WeTransfer ä¸‹è½½åœ°å€" >> $GITHUB_STEP_SUMMARY
          echo ">   **é“¾æ¥æœ‰æ•ˆæœŸè‡³ ${EXPIRY_DATE}**" >> $GITHUB_STEP_SUMMARY
          echo "[ç‚¹å‡»ä¸‹è½½]($DOWNLOAD_LINK)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "æ–‡ä»¶: $(basename "$OUTPUT_FILE")" >> $GITHUB_STEP_SUMMARY
          echo "å¤§å°: $FILE_SIZE" >> $GITHUB_STEP_SUMMARY
          
          # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "WETRANSFER_LINK=$DOWNLOAD_LINK" >> $GITHUB_ENV
          echo "EXPIRY_DATE=$EXPIRY_DATE" >> $GITHUB_ENV
        else
          echo "::warning::âš ï¸ æœªæ‰¾åˆ°ä¸‹è½½é“¾æ¥"
          echo "å®Œæ•´è¾“å‡º: $TRANSFER_OUTPUT" # è¾“å‡ºå®Œæ•´ç»“æœç”¨äºè°ƒè¯•
        fi
    
    - name: æ˜¾ç¤ºæœ€ç»ˆæ‘˜è¦
      if: always()
      run: |
        echo "âœ… æ„å»ºæµç¨‹å·²å®Œæˆ"
        echo "::group::ğŸ“Š æ„å»ºæ‘˜è¦"
        echo "ROM URL: ${{ env.rom_url }}"
        echo "ROMåç§°: ${{ env.rom_name }}"
        echo "ROMç±»å‹: ${{ env.rom_type }}"
        echo "æ„å»ºç¼–å·: ${{ github.run_number }}"
        
        # é•œåƒå‹ç¼©ä¿¡æ¯
        if [ -f "SGSI-build-tool/final_out/build_info.txt" ]; then
          orig_size=$(grep "åŸå§‹å¤§å°" SGSI-build-tool/final_out/build_info.txt | cut -d: -f2 | xargs)
          comp_size=$(grep "å‹ç¼©åå¤§å°" SGSI-build-tool/final_out/build_info.txt | cut -d: -f2 | xargs)
          ratio=$(grep "å‹ç¼©ç‡" SGSI-build-tool/final_out/build_info.txt | cut -d: -f2 | xargs)
          
          if [ -n "$orig_size" ] && [ -n "$comp_size" ]; then
            echo "âœ¨ é•œåƒå¤§å°å¯¹æ¯”: ${orig_size} â†’ ${comp_size} (èŠ‚çœ ${ratio})"
          fi
        fi
        
        # WeTransferé“¾æ¥ä¿¡æ¯
        if [[ -n "$WETRANSFER_LINK" && -n "$EXPIRY_DATE" ]]; then
          echo ""
          echo "ğŸŒ WeTransferä¸‹è½½é“¾æ¥: $WETRANSFER_LINK"
          echo "â³ é“¾æ¥æœ‰æ•ˆæœŸè‡³: $EXPIRY_DATE"
        fi
        
        echo "::endgroup::"
