name: build_XiaoxinSGSIs_Ai_Edit

on:
  watch:
    types: [started]

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
      - name: "Checkout Code (æ£€å‡ºä»£ç )"
        uses: actions/checkout@v4
        
      - name: "ğŸ“‹ æ£€æŸ¥é…ç½®æ–‡ä»¶çŠ¶æ€"
        run: |
          # æ£€æŸ¥sgsi.jsoné…ç½®æ–‡ä»¶
          if [[ ! -f "sgsi.json" ]]; then
            echo "::error::âŒ ç¼ºå°‘sgsi.jsoné…ç½®æ–‡ä»¶"
            exit 1
          fi
          
          # æ£€æŸ¥sgsi.shæ–‡ä»¶
          if [[ -f "SGSI-build-tool/10/sgsi.sh" ]]; then
            echo "âœ… æ£€æµ‹åˆ°å·²é…ç½®sgsi.shæ–‡ä»¶"
            echo "æ–‡ä»¶å†…å®¹é¢„è§ˆï¼š"
            head -10 SGSI-build-tool/10/sgsi.sh || true
          else
            echo "â„¹ï¸ æœªæ£€æµ‹åˆ°è‡ªå®šä¹‰sgsi.shæ–‡ä»¶ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
          fi
       
      - name: "ğŸ§¹ Clean Up Environment (æ¸…ç†ç¯å¢ƒ)"
        run: |
          echo "ğŸ—‘ï¸ å¯åŠ¨å…¨é¢æ¸…ç†..."
          # ä½¿ç”¨æ›´å®‰å…¨çš„æ¸…ç†å‘½ä»¤
          sudo docker system prune -af >/dev/null 2>&1 || true
          sudo apt-get autoremove -y --purge
          sudo apt-get clean
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d || true
          echo "âœ… æ¸…ç†å®Œæˆï¼ç£ç›˜ç©ºé—´:"
          df -h
       
      - name: "âš™ï¸ è§£æé…ç½®å˜é‡"
        id: config
        run: |
          # ä½¿ç”¨æ›´å¥å£®çš„JSONè§£ææ–¹å¼
          rom_url=$(jq -r '.rom_url // empty' sgsi.json)
          if [[ -z "$rom_url" ]]; then
            echo "::error::âŒ sgsi.jsonä¸­ç¼ºå°‘rom_urlå­—æ®µ"
            exit 1
          fi
          
          {
            echo "rom_url=$rom_url"
            echo "rom_name=$(jq -r '.rom_name // "unknown_rom"' sgsi.json)"
            echo "pack_sgsi=$(jq -r '.pack_sgsi // "SGSI.zip"' sgsi.json)"
            echo "make_miui=$(jq -r '.make_miui // "false"' sgsi.json)"
            echo "make_flyme=$(jq -r '.make_flyme // "false"' sgsi.json)"
            echo "make_coloros=$(jq -r '.make_coloros // "false"' sgsi.json)"
            echo "make_h2os=$(jq -r '.make_h2os // "false"' sgsi.json)"
            echo "make_smartisanos=$(jq -r '.make_smartisanos // "false"' sgsi.json)"
            echo "make_zui=$(jq -r '.make_zui // "false"' sgsi.json)"
            echo "make_super=$(jq -r '.make_super // "false"' sgsi.json)"
          } >> $GITHUB_OUTPUT
           
      - name: "ğŸ“¦ å®‰è£…å¿…è¦å·¥å…·"
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            aria2 \
            curl \
            jq \
            brotli \
            android-sdk-libsparse-utils \
            python3 \
            python3-pip \
            p7zip-full \
            zip \
            unzip
          
          echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"
          
      - name: "â¬‡ï¸ ä¸‹è½½æ„å»ºå·¥å…·"
        run: |
          tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar"
          filename="SGSI-build-tool.tar"
          
          echo "ğŸ”§ å¼€å§‹ä¸‹è½½æ„å»ºå·¥å…·..."
          max_retries=5
          retry_delay=10
          
          for i in $(seq 1 $max_retries); do
            if curl -fL -o "$filename" "$tool_url"; then
              echo "âœ… ä¸‹è½½æˆåŠŸ"
              break
            else
              echo "âŒ ä¸‹è½½å¤±è´¥ (å°è¯• $i/$max_retries)"
              if [ $i -eq $max_retries ]; then
                echo "::error::âŒ æ„å»ºå·¥å…·ä¸‹è½½å¤±è´¥"
                exit 1
              fi
              echo "ğŸ”„ ${retry_delay}ç§’åé‡è¯•..."
              sleep $retry_delay
            fi
          done
          
      - name: "ğŸ—ï¸ åˆå§‹åŒ–æ„å»ºç¯å¢ƒ"
        run: |
          echo "ğŸ“‚ è§£å‹æ„å»ºå·¥å…·..."
          if ! sudo tar -xf SGSI-build-tool.tar; then
            echo "::error::âŒ è§£å‹æ„å»ºå·¥å…·å¤±è´¥"
            exit 1
          fi
          
          # è®¾ç½®æ‰§è¡Œæƒé™
          sudo find SGSI-build-tool -name "*.sh" -exec chmod +x {} \;
          
          echo "ğŸ”„ å‡†å¤‡è¿è¡Œç¯å¢ƒè®¾ç½®è„šæœ¬..."
          if [[ -f "SGSI-build-tool/10/setup.sh" ]]; then
            echo "ğŸ”§ è¿è¡Œç¯å¢ƒè®¾ç½®è„šæœ¬..."
            cd SGSI-build-tool/10
            # æ•è·setup.shçš„è¾“å‡ºå’Œé”™è¯¯
            if ! sudo bash setup.sh 2>&1 | tee setup.log; then
              echo "::warning::âš ï¸ å®‰è£…è„šæœ¬è¿”å›éé›¶çŠ¶æ€ï¼Œæ£€æŸ¥æ—¥å¿—åç»§ç»­"
              cat setup.log
            fi
            cd ../..
          else
            echo "::warning::âš ï¸ æœªæ‰¾åˆ°setup.shè„šæœ¬ï¼Œè·³è¿‡ç¯å¢ƒè®¾ç½®"
          fi
          
          echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
          
      - name: "ğŸ”§ ä¿®å¤å·¥å…·é“¾é—®é¢˜"
        run: |
          cd SGSI-build-tool/10
          echo "ğŸ› ï¸ ä¿®å¤äºŒè¿›åˆ¶å…¼å®¹æ€§..."
          
          # åˆ›å»ºå¿…è¦çš„ç›®å½•
          sudo mkdir -p bin
          
          # åˆ›å»ºç¬¦å·é“¾æ¥
          for tool in brotli simg2img img2simg mke2fs e2fsdroid; do
            if command -v $tool >/dev/null 2>&1; then
              sudo ln -sf $(which $tool) bin/$tool
              echo "âœ… é“¾æ¥ $tool"
            else
              echo "::warning::âš ï¸ æœªæ‰¾åˆ°å·¥å…·: $tool"
            fi
          done
          
          echo "âœ… å·²ä¿®å¤äºŒè¿›åˆ¶å·¥å…·å…¼å®¹æ€§é—®é¢˜"
          cd ../..
          
      - name: "ğŸ”’ ä¿®å¤ç›®å½•æƒé™"
        run: |
          echo "ä¿®å¤SGSI-build-toolç›®å½•æƒé™..."
          sudo chown -R $(id -u):$(id -g) SGSI-build-tool
          sudo chmod -R 755 SGSI-build-tool
          echo "âœ… ç›®å½•æƒé™å·²ä¿®å¤"
          
      - name: "ğŸ’¾ ä¸‹è½½ROMæ–‡ä»¶"
        run: |
          rom_path="SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
          rom_url="${{ steps.config.outputs.rom_url }}"
          filename="${{ steps.config.outputs.rom_name }}"
          
          # åˆ›å»ºç›®æ ‡ç›®å½•
          sudo mkdir -p "$(dirname "$rom_path")"
          
          echo "ğŸš€ å¼€å§‹ä¸‹è½½ROM: $filename"
          echo "ğŸ“¥ URL: $rom_url"
          
          max_retries=5
          retry_delay=30
          
          for i in $(seq 1 $max_retries); do
            echo "å°è¯• $i/$max_retries..."
            
            # ä¼˜å…ˆä½¿ç”¨aria2ï¼ˆå¦‚æœå¯ç”¨ï¼‰
            if command -v aria2c &> /dev/null; then
              echo "âš¡ ä½¿ç”¨aria2ä¸‹è½½ (å¤šçº¿ç¨‹)"
              if sudo aria2c -x 8 -s 8 -k 1M -d "$(dirname "$rom_path")" -o "$(basename "$rom_path")" "$rom_url"; then
                echo "âœ… aria2ä¸‹è½½æˆåŠŸ"
                break
              fi
            fi
            
            # å›é€€åˆ°curl
            if command -v curl &> /dev/null; then
              echo "âš¡ ä½¿ç”¨curlä¸‹è½½"
              if sudo curl -fL -C - -o "$rom_path" "$rom_url"; then
                echo "âœ… curlä¸‹è½½æˆåŠŸ"
                break
              fi
            fi
            
            if [ $i -eq $max_retries ]; then
              echo "::error::âŒ ROMä¸‹è½½å¤±è´¥"
              exit 1
            fi
            
            echo "ğŸ”„ ${retry_delay}ç§’åé‡è¯•..."
            sleep $retry_delay
          done
          
          echo -e "\nğŸ‰ ä¸‹è½½å®Œæˆ"
          echo "ğŸ“¦ æ–‡ä»¶ä¿¡æ¯: $(sudo ls -lh "$rom_path")"

      - name: "âš™ï¸ é…ç½®ROMç‰¹å®šè®¾ç½®"
        run: |
          echo "å¼€å§‹é…ç½®ROMç‰¹å®šè®¾ç½®..."
          
          # ç¡®å®šROMç±»å‹
          rom_type="Generic"
          if [ "${{ steps.config.outputs.make_miui }}" = "true" ]; then rom_type="MIUI"; fi
          if [ "${{ steps.config.outputs.make_flyme }}" = "true" ]; then rom_type="Flyme"; fi
          if [ "${{ steps.config.outputs.make_coloros }}" = "true" ]; then rom_type="ColorOS"; fi
          if [ "${{ steps.config.outputs.make_h2os }}" = "true" ]; then rom_type="H2OS"; fi
          if [ "${{ steps.config.outputs.make_smartisanos }}" = "true" ]; then rom_type="SmartisanOS"; fi
          if [ "${{ steps.config.outputs.make_zui }}" = "true" ]; then rom_type="ZUI"; fi
          
          echo "â„¹ï¸ æ£€æµ‹åˆ°çš„ROMç±»å‹: $rom_type"
          
          # é…ç½®Super SGSI
          if [ "${{ steps.config.outputs.make_super }}" = "true" ]; then
            echo "é…ç½®Super SGSI..."
            if [[ -f "SGSI-build-tool/10/make.sh" ]]; then
              sudo sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' SGSI-build-tool/10/make.sh
              echo "Super SGSIé…ç½®å®Œæˆ"
            else
              echo "::warning::âš ï¸ æœªæ‰¾åˆ°make.shè„šæœ¬ï¼Œè·³è¿‡Super SGSIé…ç½®"
            fi
          fi
          
          # æ¸…ç†æ—§çš„fixbugè„šæœ¬
          sudo rm -f SGSI-build-tool/10/fixbug/fixbug.sh
          
          # ColorOSç‰¹æ®Šå¤„ç†
          if [ "$rom_type" = "ColorOS" ]; then
            echo "è§£å¯†ColorOS OZIPåŒ…..."
            if [[ -f "SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py" ]]; then
              sudo python3 SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py "SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
              sudo rm -f "SGSI-build-tool/10/tmp/${{ steps.config.outputs.rom_name }}"
              echo "ColorOS ROMè§£å¯†å®Œæˆ"
            else
              echo "::error::âŒ æœªæ‰¾åˆ°ozipdecrypt.pyè„šæœ¬"
              exit 1
            fi
          fi
          
          # åº”ç”¨ç‰¹å®šROMçš„ä¿®å¤è„šæœ¬
          if [[ -f "fix/${rom_type}.sh" ]]; then
            echo "åº”ç”¨$rom_typeé…ç½®è„šæœ¬..."
            sudo cp "fix/${rom_type}.sh" SGSI-build-tool/10/fixbug/fixbug.sh
            sudo chmod +x SGSI-build-tool/10/fixbug/fixbug.sh
            echo "$rom_typeé…ç½®å®Œæˆ"
          else
            echo "â„¹ï¸ æ‰¾ä¸åˆ°$rom_typeé…ç½®è„šæœ¬ï¼Œä½¿ç”¨é€šç”¨é…ç½®"
          fi
            
          echo "ROMç‰¹å®šè®¾ç½®é…ç½®å®Œæˆ"
          
      - name: "ğŸ”§ ä¿®å¤è„šæœ¬è¯­æ³•é”™è¯¯"
        run: |
          cd SGSI-build-tool/10
          
          echo "æ£€æŸ¥å¹¶ä¿®å¤SGSI.shè„šæœ¬é”™è¯¯..."
          if [[ -f "SGSI.sh" ]]; then
            # æ›´ç²¾ç¡®çš„ä¿®å¤ï¼Œé¿å…è¿‡åº¦æ›¿æ¢
            sudo sed -i 's/\[ *\] *== *"\(.*\)" *]/\[ -n "\1" ]/g' SGSI.sh
            sudo sed -i 's/==/=/g' SGSI.sh
            echo "âœ… å·²ä¿®å¤è„šæœ¬è¯­æ³•é”™è¯¯"
          else
            echo "::warning::âš ï¸ æœªæ‰¾åˆ°SGSI.shè„šæœ¬"
          fi
          cd ../..
          
      - name: "ğŸ› ï¸ å‡†å¤‡æ„å»ºæ–‡ä»¶"
        run: |
          echo "å‡†å¤‡æ„å»ºè„šæœ¬å’Œå·¥å…·..."
          
          # å¤åˆ¶è‡ªå®šä¹‰æ„å»ºè„šæœ¬
          if [[ -d "make" ]]; then
            echo "ç§»åŠ¨æ„å»ºè„šæœ¬..."
            sudo cp -v make/*.sh SGSI-build-tool/10/
          fi
          
          # å¤åˆ¶äºŒè¿›åˆ¶å·¥å…·
          if [[ -d "bin" ]]; then
            echo "ç§»åŠ¨äºŒè¿›åˆ¶å·¥å…·..."
            sudo mkdir -p SGSI-build-tool/10/bin
            sudo cp -v bin/mke2fs bin/e2fsdroid SGSI-build-tool/10/bin/
          fi
          
          # æ›´æ–°ç¬¦å·é“¾æ¥
          cd SGSI-build-tool/10
          for tool in brotli simg2img; do
            if command -v $tool >/dev/null 2>&1; then
              sudo ln -sf $(which $tool) bin/$tool
            fi
          done
          cd ../..
          
          echo "âœ… æ„å»ºæ–‡ä»¶å‡†å¤‡å®Œæˆ"
          
      - name: "ğŸ­ æ„å»ºSGSIé•œåƒ"
        run: |
          cd SGSI-build-tool/10
          
          echo "ğŸ—ï¸ å¼€å§‹æ„å»ºSGSI..."
          # è®¾ç½®æ›´é•¿çš„è¶…æ—¶æ—¶é—´
          timeout 60m bash -c '
            if ! sudo bash make.sh 2>&1 | tee make.log; then
              echo "::error::âŒ æ„å»ºå¤±è´¥ï¼"
              echo "=== æ„å»ºæ—¥å¿—æœ€å100è¡Œ ==="
              tail -100 make.log
              echo "========================"
              exit 1
            fi
          ' || exit $?
          
          echo "ğŸ‰ SGSIé•œåƒæ„å»ºå®Œæˆ"
           
      - name: "ğŸ“¦ æ‰“åŒ…è¾“å‡ºæ–‡ä»¶"
        run: |
          cd SGSI-build-tool/10
          
          echo "=== æ‰“åŒ…æ­¥éª¤ ==="
          
          # éªŒè¯SGSIç›®å½•æ˜¯å¦å­˜åœ¨
          if [[ ! -d "SGSI" ]]; then
            echo "::error::âŒ SGSIç›®å½•ä¸å­˜åœ¨ï¼"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            ls -la
            exit 1
          fi
          
          # åˆ›å»ºè¾“å‡ºæ–‡ä»¶å
          output_file="${{ steps.config.outputs.pack_sgsi }}"
          
          # æ‰“åŒ…æ–‡ä»¶
          echo "æ‰“åŒ…SGSIåˆ°: $output_file"
          if ! sudo zip -r "$output_file" SGSI/*; then
            echo "::error::âŒ æ‰“åŒ…å¤±è´¥ï¼"
            exit 1
          fi
          
          # å‡†å¤‡ä¸Šä¼ ç›®å½•
          sudo mkdir -p "${GITHUB_WORKSPACE}/upload"
          file_size=$(sudo stat -c%s "$output_file")
          max_size=2000000000  # 2GB
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°å¹¶åˆ†å·å¤„ç†
          if [[ $file_size -gt $max_size ]]; then
            echo "âš ï¸ æ–‡ä»¶è¿‡å¤§ ($(numfmt --to=iec-i $file_size))ï¼Œè¿›è¡Œåˆ†å·æ‰“åŒ…..."
            sudo split -b 1000m -d -a 1 "$output_file" "${output_file}_part"
            # ç§»åŠ¨åˆ†å·æ–‡ä»¶åˆ°ä¸Šä¼ ç›®å½•
            sudo mv "${output_file}_part"* "${GITHUB_WORKSPACE}/upload/"
            # åˆ é™¤åŸå§‹å¤§æ–‡ä»¶
            sudo rm "$output_file"
            echo "åˆ†å·æ–‡ä»¶åˆ—è¡¨:"
            sudo ls -lh "${GITHUB_WORKSPACE}/upload"
          else
            echo "ç§»åŠ¨æ–‡ä»¶åˆ°ä¸Šä¼ ç›®å½•"
            sudo mv "$output_file" "${GITHUB_WORKSPACE}/upload/"
          fi
          
          # ç¡®ä¿ä¸Šä¼ ç›®å½•æœ‰å†…å®¹
          echo "=== ä¸Šä¼ ç›®å½•å†…å®¹ ==="
          sudo ls -lh "${GITHUB_WORKSPACE}/upload" || true
          echo "===================="
          
          # ä¿å­˜ä¸Šä¼ ç›®å½•è·¯å¾„
          echo "UPLOAD_DIR=${GITHUB_WORKSPACE}/upload" >> $GITHUB_ENV
             
      - name: "ğŸ·ï¸ ç”Ÿæˆå‘å¸ƒæ ‡ç­¾"
        id: release_tag
        run: |
          current_date=$(date +"%Y%m%d")
          
          # æ£€æµ‹ROMç±»å‹
          rom_type="Generic"
          if [ "${{ steps.config.outputs.make_miui }}" = "true" ]; then rom_type="MIUI"; fi
          if [ "${{ steps.config.outputs.make_flyme }}" = "true" ]; then rom_type="Flyme"; fi
          if [ "${{ steps.config.outputs.make_coloros }}" = "true" ]; then rom_type="ColorOS"; fi
          if [ "${{ steps.config.outputs.make_h2os }}" = "true" ]; then rom_type="H2OS"; fi
          if [ "${{ steps.config.outputs.make_smartisanos }}" = "true" ]; then rom_type="SmartisanOS"; fi
          if [ "${{ steps.config.outputs.make_zui }}" = "true" ]; then rom_type="ZUI"; fi
          
          # æ·»åŠ å”¯ä¸€æ ‡è¯†ç¬¦é¿å…å†²çª
          unique_id=$(echo $GITHUB_RUN_ID | tail -c 4)
          
          # ç”Ÿæˆå”¯ä¸€æ ‡ç­¾
          release_tag="Old-1.9-${current_date}-${rom_type}-${unique_id}"
          echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
          echo "ç”Ÿæˆçš„å‘å¸ƒæ ‡ç­¾: $release_tag"
             
      - name: "ğŸš€ ä¸Šä¼ æ„å»ºäº§ç‰©"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.release_tag.outputs.release_tag }}
          path: ${{ env.UPLOAD_DIR }}/*
          if-no-files-found: error
          
      - name: "âœ… å®Œæˆé€šçŸ¥"
        if: success()
        run: |
          echo "ğŸ‰ æ„å»ºå®Œæˆ!"
          echo "å‘å¸ƒæ ‡ç­¾: ${{ steps.release_tag.outputs.release_tag }}"
          echo "äº§ç‰©ä½ç½®: ${{ env.UPLOAD_DIR }}"
