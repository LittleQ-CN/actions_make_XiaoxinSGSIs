name: build_XiaoxinSGSIs_old

on:
  watch:
    types: [started]
    
jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: "ðŸš€ Checkout Code (æ£€å‡ºä»£ç )"
        uses: actions/checkout@v4
       
      - name: "ðŸ§¹ Clean Up Environment (æ¸…ç†çŽ¯å¢ƒ)"
        run: |
          docker rmi -f $(docker images -q) || true
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d
          sudo -E apt-get -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php* || true
          sudo -E apt-get update
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean 
          df -h
       
      - name: "âš™ï¸ Get Configuration Variables (èŽ·å–é…ç½®å˜é‡)"
        run: |
          {
            echo "rom_url=$(jq -r '.rom_url' sgsi.json)"
            echo "rom_name=$(jq -r '.rom_name' sgsi.json)"
            echo "pack_sgsi=$(jq -r '.pack_sgsi' sgsi.json)"
            echo "make_miui=$(jq -r '.make_miui' sgsi.json)"
            echo "make_flyme=$(jq -r '.make_flyme' sgsi.json)"
            echo "make_coloros=$(jq -r '.make_coloros' sgsi.json)"
            echo "make_h2os=$(jq -r '.make_h2os' sgsi.json)"
            echo "make_smartisanos=$(jq -r '.make_smartisanos' sgsi.json)"
            echo "make_zui=$(jq -r '.make_zui' sgsi.json)"
            echo "make_super=$(jq -r '.make_super' sgsi.json)"
          } >> $GITHUB_OUTPUT
        id: var
           
      - name: "ðŸ“¦ Install Download Tools (å®‰è£…ä¸‹è½½å·¥å…·)"
        run: |
          sudo apt-get update
          # å®‰è£…åŸºç¡€å·¥å…·å’Œå¿…è¦ä¾èµ–
          sudo apt-get install -y axel curl wget pv aria2 git make gcc libfuse-dev libssl-dev autoconf automake pkg-config e2fsprogs
          
          # å°è¯•å®‰è£… libcom-err-dev æˆ–æ›¿ä»£åŒ…
          echo "ðŸ” æŸ¥æ‰¾ libcom-err-dev æˆ–æ›¿ä»£åŒ…..."
          if apt-cache show libcom-err-dev > /dev/null 2>&1; then
            echo "ðŸ“¦ å®‰è£… libcom-err-dev"
            sudo apt-get install -y libcom-err-dev
          elif apt-cache show libcomerr-dev > /dev/null 2>&1; then
            echo "ðŸ“¦ å®‰è£… libcomerr-dev (æ›¿ä»£åŒ…)"
            sudo apt-get install -y libcomerr-dev
          elif apt-cache show e2fsprogs-dev > /dev/null 2>&1; then
            echo "ðŸ“¦ å®‰è£… e2fsprogs-dev (åŒ…å« libcom-err)"
            sudo apt-get install -y e2fsprogs-dev
          else
            echo "âš ï¸ æ— æ³•æ‰¾åˆ° libcom-err-dev æˆ–ç›´æŽ¥æ›¿ä»£åŒ…ï¼Œå°è¯•å®‰è£…ç›¸å…³å¼€å‘åŒ…"
            sudo apt-get install -y libext2fs-dev libblkid-dev libuuid-dev
          fi
          
          # è®¾ç½®axelé…ç½®
          echo "max-connections = 32" | sudo tee -a /etc/axelrc
          
          # å®‰è£… fuse-ext2 - ä½¿ç”¨å¤šç§æ–¹æ³•ç¡®ä¿æˆåŠŸ
          echo "ðŸ”§ å®‰è£… fuse-ext2..."
          
          # æ–¹æ³•1: å°è¯•ä»Ž Ubuntu ä»“åº“å®‰è£…ï¼ˆå¦‚æžœå¯ç”¨ï¼‰
          if apt-cache show fuse-ext2 > /dev/null 2>&1; then
            echo "ðŸ“¦ ä»Ž Ubuntu ä»“åº“å®‰è£… fuse-ext2"
            sudo apt-get install -y fuse-ext2
          else
            echo "âš ï¸ Ubuntu ä»“åº“ä¸­æ²¡æœ‰ fuse-ext2ï¼Œå°è¯•å…¶ä»–æ–¹æ³•"
          fi
          
          # æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ
          if command -v fuse-ext2 &> /dev/null; then
            echo "âœ… fuse-ext2 å·²é€šè¿‡åŒ…ç®¡ç†å™¨å®‰è£…"
          else
            # æ–¹æ³•2: ä»Žæºç ç¼–è¯‘å®‰è£…
            echo "ðŸ”¨ ä»Žæºç ç¼–è¯‘å®‰è£… fuse-ext2..."
            
            # ç¡®ä¿å®‰è£…ç¼–è¯‘ä¾èµ–
            sudo apt-get install -y libext2fs-dev
            
            # å…‹éš†æºç 
            git clone https://github.com/alperakcan/fuse-ext2.git
            cd fuse-ext2
            
            # é…ç½®å’Œç¼–è¯‘
            ./autogen.sh || (aclocal && autoreconf -i)
            ./configure --prefix=/usr
            make
            sudo make install
            sudo ldconfig
            
            # æ£€æŸ¥ç¼–è¯‘æ˜¯å¦æˆåŠŸ
            if command -v fuse-ext2 &> /dev/null; then
              echo "âœ… fuse-ext2 æºç ç¼–è¯‘å®‰è£…æˆåŠŸ"
            else
              echo "âš ï¸ fuse-ext2 å®‰è£…å¤±è´¥ï¼Œå°†ä½¿ç”¨ debugfs ä½œä¸ºæ›¿ä»£"
            fi
          fi
          
          # ç¡®ä¿ debugfs å¯ç”¨
          if ! command -v debugfs &> /dev/null; then
            echo "ðŸ“¦ å®‰è£… debugfs (e2fsprogs)"
            sudo apt-get install -y e2fsprogs
          fi
           
      - name: "â¬‡ï¸ Download Build Tools (ä¸‹è½½æž„å»ºå·¥å…·)"
        run: |
          tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar"
          filename="SGSI-build-tool.tar"
          echo "ðŸ”§ æ­£åœ¨ä¸‹è½½æž„å»ºå·¥å…·: $tool_url"
          
          max_retries=3
          for i in $(seq 1 $max_retries); do
            if command -v curl &> /dev/null; then
              echo "âš¡ ä½¿ç”¨curlä¸‹è½½ [$filename]"
              if curl -# -fL -o "$filename" "$tool_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              else
                echo "âŒ curlå¤±è´¥ï¼Œå°è¯•aria2"
              fi
            fi
            
            if command -v aria2c &> /dev/null; then
              echo "âš¡ ä½¿ç”¨aria2ä¸‹è½½ [$filename] (16çº¿ç¨‹)"
              if aria2c -x 16 -s 16 -k 1M --file-allocation=trunc -U "Mozilla/5.0" -o "$filename" "$tool_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              else
                echo "âŒ aria2å¤±è´¥ï¼Œå°è¯•axel"
              fi
            fi
            
            if command -v axel &> /dev/null; then
              echo "âš¡ ä½¿ç”¨32çº¿ç¨‹Axelä¸‹è½½ [$filename]"
              if axel -q -n 32 -U "Mozilla/5.0" -s -k -o "$filename" "$tool_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              else
                echo "âŒ Axelå¤±è´¥ï¼Œå°è¯•wget"
              fi
            fi
            
            if command -v wget &> /dev/null; then
              echo "âš¡ ä½¿ç”¨wgetä¸‹è½½ [$filename]"
              if wget -q --show-progress -O "$filename" "$tool_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              else
                echo "âŒ wgetå¤±è´¥"
              fi
            fi
            
            if [ $i -lt $max_retries ]; then
              echo "ðŸ”„ æ‰€æœ‰ä¸‹è½½æ–¹å¼å¤±è´¥ï¼Œé‡è¯•ä¸­ ($i/$max_retries)..."
              sleep 10
            else
              echo "::error::âŒ æž„å»ºå·¥å…·ä¸‹è½½å¤±è´¥"
              exit 1
            fi
          done
          
      - name: "ðŸ—ï¸ Initialize Environment (åˆå§‹åŒ–çŽ¯å¢ƒ)"
        run: |
          sudo tar -xf SGSI-build-tool.tar
          sudo rm -rf SGSI-build-tool/10/setup.sh
          sudo mv bin/setup.sh SGSI-build-tool/10/
          cd SGSI-build-tool/10
          sudo bash setup.sh
          echo "âœ… çŽ¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
           
      - name: "ðŸ’¾ Download ROM File (ä¸‹è½½ROMæ–‡ä»¶)"
        run: |
          rom_path="SGSI-build-tool/10/tmp/${{ steps.var.outputs.rom_name }}"
          rom_url="${{ steps.var.outputs.rom_url }}"
          filename="${{ steps.var.outputs.rom_name }}"
          
          echo "ðŸš€ å¼€å§‹ä¸‹è½½: $filename"
          max_retries=5
          
          for i in $(seq 1 $max_retries); do
            if command -v aria2c &> /dev/null; then
              echo "âš¡ ä½¿ç”¨aria2ä¸‹è½½ [$filename] (32çº¿ç¨‹)"
              aria2c -x 32 -s 32 -k 1M --file-allocation=trunc -U "Mozilla/5.0" -o "$rom_path" "$rom_url" && echo "âœ… ä¸‹è½½æˆåŠŸ" && break || echo "âŒ aria2å¤±è´¥ï¼Œå°è¯•axel"
            fi
            
            if command -v axel &> /dev/null; then
              echo "âš¡ ä½¿ç”¨32çº¿ç¨‹Axelä¸‹è½½ [$filename]"
              axel -q -n 32 -U "Mozilla/5.0" -s -k -o "$rom_path" "$rom_url" && echo "âœ… ä¸‹è½½æˆåŠŸ" && break || echo "âŒ Axelå¤±è´¥ï¼Œå°è¯•curl"
            fi
            
            if command -v curl &> /dev/null; then
              echo "âš¡ ä½¿ç”¨curlä¸‹è½½ [$filename]"
              curl -# -L -o "$rom_path" "$rom_url" && echo "âœ… ä¸‹è½½æˆåŠŸ" && break || echo "âŒ curlå¤±è´¥ï¼Œå°è¯•wget"
            fi
            
            if command -v wget &> /dev/null; then
              echo "âš¡ ä½¿ç”¨wgetä¸‹è½½ [$filename]"
              wget -q --show-progress -O "$rom_path" "$rom_url" && echo "âœ… ä¸‹è½½æˆåŠŸ" && break || echo "âŒ wgetå¤±è´¥"
            fi
            
            if [ $i -lt $max_retries ]; then
              echo "ðŸ”„ æ‰€æœ‰ä¸‹è½½æ–¹å¼å¤±è´¥ï¼Œé‡è¯•ä¸­ ($i/$max_retries)..."
              sleep 10
            else
              echo "::error::âŒ ROMä¸‹è½½å¤±è´¥"
              exit 1
            fi
          done
          
          echo -e "\nðŸŽ‰ ä¸‹è½½å®Œæˆ"
          echo "ðŸ“¦ æ–‡ä»¶å¤§å°: $(du -h "$rom_path" | cut -f1)"

      - name: "âš™ï¸ Configure ROM Specific Settings (é…ç½®ROMç‰¹å®šè®¾ç½®)"
        run: |
          echo "å¼€å§‹é…ç½®ROMç‰¹å®šè®¾ç½®..."
          
          # Super SGSIé…ç½®
          if [ "${{ steps.var.outputs.make_super }}" = "true" ]; then
            echo "é…ç½®Super SGSI..."
            sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' SGSI-build-tool/10/make.sh
            echo "Super SGSIé…ç½®å®Œæˆ"
          fi
          
          # åˆ é™¤æ—§çš„fixbugè„šæœ¬ï¼ˆä¸ºåŽç»­é…ç½®åšå‡†å¤‡ï¼‰
          sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
          
          # MIUIé…ç½®
          if [ "${{ steps.var.outputs.make_miui }}" = "true" ]; then
            echo "é…ç½®MIUI..."
            cp fix/MIUI.sh SGSI-build-tool/10/fixbug/fixbug.sh
            echo "MIUIé…ç½®å®Œæˆ"
          
          # Flymeé…ç½®
          elif [ "${{ steps.var.outputs.make_flyme }}" = "true" ]; then
            echo "é…ç½®Flyme..."
            cp fix/Flyme.sh SGSI-build-tool/10/fixbug/fixbug.sh
            echo "Flymeé…ç½®å®Œæˆ"
          
          # ColorOSé…ç½®ï¼ˆç‰¹æ®Šå¤„ç†ï¼‰
          elif [ "${{ steps.var.outputs.make_coloros }}" = "true" ]; then
            echo "é…ç½®ColorOS..."
            echo "è§£å¯†ColorOS OZIPåŒ…..."
            sudo python3 SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py "SGSI-build-tool/10/tmp/${{ steps.var.outputs.rom_name }}"
            sudo rm -rf "SGSI-build-tool/10/tmp/${{ steps.var.outputs.rom_name }}"
            cp fix/ColorOS.sh SGSI-build-tool/10/fixbug/fixbug.sh
            echo "ColorOSé…ç½®å®Œæˆ"
          
          # H2OSé…ç½®
          elif [ "${{ steps.var.outputs.make_h2os }}" = "true" ]; then
            echo "é…ç½®H2OS..."
            cp fix/H2OS.sh SGSI-build-tool/10/fixbug/fixbug.sh
            echo "H2OSé…ç½®å®Œæˆ"
          
          # SmartisanOSé…ç½®
          elif [ "${{ steps.var.outputs.make_smartisanos }}" = "true" ]; then
            echo "é…ç½®SmartisanOS..."
            cp fix/SmartisanOS.sh SGSI-build-tool/10/fixbug/fixbug.sh
            echo "SmartisanOSé…ç½®å®Œæˆ"
          
          # ZUIé…ç½®
          elif [ "${{ steps.var.outputs.make_zui }}" = "true" ]; then
            echo "é…ç½®ZUI..."
            cp fix/ZUI.sh SGSI-build-tool/10/fixbug/fixbug.sh
            echo "ZUIé…ç½®å®Œæˆ"
          
          else
            echo "æœªé€‰æ‹©ç‰¹å®šROMé…ç½®ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®"
          fi
          
          echo "ROMç‰¹å®šè®¾ç½®é…ç½®å®Œæˆ"
            
      - name: "ðŸ› ï¸ Build SGSI Images (æž„å»ºSGSIé•œåƒ)"
        run: |
          rm -rf SGSI-build-tool/10/SGSI.sh SGSI-build-tool/10/makeimg.sh SGSI-build-tool/10/bin/mke2fs SGSI-build-tool/10/bin/e2fsdroid SGSI-build-tool/10/dynamic_SGSI.sh SGSI-build-tool/10/oppo.sh SGSI-build-tool/10/make.sh
          mv make/makeimg.sh make/SGSI.sh make/dynamic_SGSI.sh make/oppo.sh make/make.sh SGSI-build-tool/10/
          mv bin/mke2fs bin/e2fsdroid SGSI-build-tool/10/bin/
          cd SGSI-build-tool/10
          sudo bash make.sh
          echo "ðŸŽ‰ SGSIé•œåƒæž„å»ºå®Œæˆ"

      - name: "ðŸ” Extract Version Info from SGSI (ä»ŽSGSIé•œåƒæå–ç‰ˆæœ¬ä¿¡æ¯)"
        id: sgsi_info
        run: |
          echo "å¼€å§‹ä»ŽSGSIé•œåƒæå–ç‰ˆæœ¬ä¿¡æ¯..."
          
          # æŸ¥æ‰¾SGSIé•œåƒæ–‡ä»¶
          sgsi_dir="SGSI-build-tool/10/SGSI"
          system_img=$(find "$sgsi_dir" -name "system.img" -o -name "system_*.img" | head -1)
          
          if [ -z "$system_img" ]; then
            echo "æœªæ‰¾åˆ°SGSIé•œåƒæ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤ç‰ˆæœ¬ä¿¡æ¯"
            echo "android_version=Android10" >> $GITHUB_OUTPUT
            echo "rom_version=Unknown" >> $GITHUB_OUTPUT
            echo "security_patch=Unknown" >> $GITHUB_OUTPUT
            echo "build_date=Unknown" >> $GITHUB_OUTPUT
            echo "build_id=Unknown" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "æ‰¾åˆ°SGSIé•œåƒ: $system_img"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p /tmp/sgsi_info
          
          # å‡½æ•°ï¼šä½¿ç”¨fuse-ext2æå–ä¿¡æ¯
          extract_with_fuse_ext2() {
            if command -v fuse-ext2 &> /dev/null; then
              echo "å°è¯•ä½¿ç”¨fuse-ext2æŒ‚è½½é•œåƒ..."
              mkdir -p /mnt/sgsi_temp
              fuse-ext2 "$system_img" /mnt/sgsi_temp -o ro,allow_other && sleep 2
              if [ -f "/mnt/sgsi_temp/build.prop" ]; then
                cp /mnt/sgsi_temp/build.prop /tmp/sgsi_info/
                fusermount -u /mnt/sgsi_temp
                rmdir /mnt/sgsi_temp
                return 0
              else
                fusermount -u /mnt/sgsi_temp
                rmdir /mnt/sgsi_temp
                return 1
              fi
            else
              return 1
            fi
          }
          
          # å‡½æ•°ï¼šä½¿ç”¨debugfsæå–ä¿¡æ¯
          extract_with_debugfs() {
            if command -v debugfs &> /dev/null; then
              echo "å°è¯•ä½¿ç”¨debugfsæå–build.prop..."
              if debugfs -R "cat /build.prop" "$system_img" > /tmp/sgsi_info/build.prop 2>/dev/null; then
                # æ£€æŸ¥æå–çš„æ–‡ä»¶æ˜¯å¦åŒ…å«buildå±žæ€§
                if grep -q "ro.build" /tmp/sgsi_info/build.prop; then
                  return 0
                else
                  return 1
                fi
              else
                return 1
              fi
            else
              return 1
            fi
          }
          
          # å‡½æ•°ï¼šä»Žbuild.propä¸­æå–ä¿¡æ¯
          extract_info_from_build_prop() {
            if [ -f /tmp/sgsi_info/build.prop ]; then
              # æå–Androidç‰ˆæœ¬
              android_version=$(grep -oP 'ro.build.version.release=\K.*' /tmp/sgsi_info/build.prop | head -1)
              # æå–å®‰å…¨è¡¥ä¸æ—¥æœŸ
              security_patch=$(grep -oP 'ro.build.version.security_patch=\K.*' /tmp/sgsi_info/build.prop | head -1)
              # æå–æž„å»ºæ—¥æœŸ
              build_date=$(grep -oP 'ro.build.date=\K.*' /tmp/sgsi_info/build.prop | head -1)
              if [ -z "$build_date" ]; then
                build_date=$(grep -oP 'ro.build.date.utc=\K.*' /tmp/sgsi_info/build.prop | head -1)
                if [ -n "$build_date" ]; then
                  build_date=$(date -d "@$build_date" +"%Y-%m-%d" 2>/dev/null || echo "UTC-$build_date")
                fi
              fi
              # æå–æž„å»ºID
              build_id=$(grep -oP 'ro.build.id=\K.*' /tmp/sgsi_info/build.prop | head -1)
              # æå–ROMæ˜¾ç¤ºç‰ˆæœ¬
              rom_display=$(grep -oP 'ro.build.display.id=\K.*' /tmp/sgsi_info/build.prop | head -1)
              # æå–MIUIç‰ˆæœ¬
              miui_version=$(grep -oP 'ro.miui.ui.version.name=\K.*' /tmp/sgsi_info/build.prop | head -1)
              miui_code=$(grep -oP 'ro.miui.ui.version.code=\K.*' /tmp/sgsi_info/build.prop | head -1)
              
              # ç»„åˆROMç‰ˆæœ¬ä¿¡æ¯
              if [ -n "$miui_version" ]; then
                rom_version="MIUI${miui_version}"
                if [ -n "$miui_code" ]; then
                  rom_version="${rom_version}_${miui_code}"
                fi
              elif [ -n "$rom_display" ]; then
                rom_version="$rom_display"
              else
                rom_version=$(grep -oP 'ro.product.name=\K.*' /tmp/sgsi_info/build.prop | head -1)
                if [ -z "$rom_version" ]; then
                  rom_version=$(grep -oP 'ro.product.system.name=\K.*' /tmp/sgsi_info/build.prop | head -1)
                fi
              fi
              
              # è®¾ç½®è¾“å‡º
              echo "android_version=${android_version:-Android10}" >> $GITHUB_OUTPUT
              echo "rom_version=${rom_version:-Unknown}" >> $GITHUB_OUTPUT
              echo "security_patch=${security_patch:-Unknown}" >> $GITHUB_OUTPUT
              echo "build_date=${build_date:-Unknown}" >> $GITHUB_OUTPUT
              echo "build_id=${build_id:-Unknown}" >> $GITHUB_OUTPUT
              return 0
            else
              return 1
            fi
          }
          
          # å°è¯•æå–build.prop
          if extract_with_fuse_ext2; then
            echo "ä½¿ç”¨fuse-ext2æå–æˆåŠŸ"
          elif extract_with_debugfs; then
            echo "ä½¿ç”¨debugfsæå–æˆåŠŸ"
          else
            echo "æ— æ³•æå–build.propï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•"
          fi
          
          # ä»Žbuild.propä¸­æå–ä¿¡æ¯
          if [ -f /tmp/sgsi_info/build.prop ]; then
            extract_info_from_build_prop
          else
            # å¤‡ç”¨æ–¹æ³•ï¼šä»ŽROMæ–‡ä»¶åæŽ¨æ–­
            rom_name="${{ steps.var.outputs.rom_name }}"
            if echo "$rom_name" | grep -qi "android.*[0-9]"; then
              android_version=$(echo "$rom_name" | grep -oi "android.*[0-9]" | head -1 | tr '[:upper:]' '[:lower:]')
            else
              android_version="Android10"
            fi
            clean_name=$(echo "$rom_name" | cut -d'.' -f1 | tr -cd '[:alnum:]._-')
            echo "android_version=${android_version}" >> $GITHUB_OUTPUT
            echo "rom_version=${clean_name}" >> $GITHUB_OUTPUT
            echo "security_patch=Unknown" >> $GITHUB_OUTPUT
            echo "build_date=Unknown" >> $GITHUB_OUTPUT
            echo "build_id=Unknown" >> $GITHUB_OUTPUT
          fi
          
          # æ¸…ç†
          rm -rf /tmp/sgsi_info
          echo "ç‰ˆæœ¬ä¿¡æ¯æå–å®Œæˆ"
           
      - name: "ðŸ” Extract Device Info from SGSI (ä»ŽSGSIé•œåƒæå–è®¾å¤‡ä¿¡æ¯)"
        id: device_info
        run: |
          echo "æå–åŸºç¡€è®¾å¤‡ä¿¡æ¯..."
          
          # ç®€å•åœ°ä»Žä¹‹å‰æ­¥éª¤ä¸­å¯èƒ½å·²ç»æå–çš„build.propè¯»å–
          if [ -f /tmp/sgsi_info/build.prop ]; then
            device_codename=$(grep -oP 'ro.product.device=\K.*' /tmp/sgsi_info/build.prop | head -1 || echo "Unknown")
            manufacturer=$(grep -oP 'ro.product.manufacturer=\K.*' /tmp/sgsi_info/build.prop | head -1 || echo "Unknown")
          else
            device_codename="Unknown"
            manufacturer="Unknown"
          fi
          
          # æºè®¾å¤‡é€šå¸¸ä¸Žè®¾å¤‡ä»£å·ç›¸åŒï¼Œæˆ–è€…æˆ‘ä»¬å¯ä»¥ç”¨ROMåç§°
          source_device="$device_codename"
          if [ "$source_device" = "Unknown" ]; then
            rom_name="${{ steps.var.outputs.rom_name }}"
            source_device="${rom_name%.*}"  # åŽ»æŽ‰æ–‡ä»¶æ‰©å±•å
          fi
          
          echo "source_device=${source_device}" >> $GITHUB_OUTPUT
          echo "device_codename=${device_codename}" >> $GITHUB_OUTPUT
          echo "device_manufacturer=${manufacturer}" >> $GITHUB_OUTPUT

      - name: "ðŸ“¦ Package Patches (æ‰“åŒ…è¡¥ä¸æ–‡ä»¶)"
        run: |
          zip -r Patch1.zip Patch/Patch1/*
          zip -r Patch2.zip Patch/Patch2/*
          zip -r Patch3.zip Patch/Patch3/*
          sudo mv Patch1.zip Patch2.zip Patch3.zip SGSI-build-tool/10/SGSI/
          echo "âœ… è¡¥ä¸æ–‡ä»¶æ‰“åŒ…å®Œæˆ"

      - name: "ðŸ“¦ Package SGSI Output (æ‰“åŒ…SGSIè¾“å‡º)"
        run: |
          mkdir -p upload
          zip -r ${{ steps.var.outputs.pack_sgsi }} SGSI-build-tool/10/SGSI/*
          file_size=$(du -sb ${{ steps.var.outputs.pack_sgsi }} | awk '{print $1}')
          max_size=2097152000
          
          if [ $file_size -gt $max_size ]; then
            echo "âš ï¸ æ–‡ä»¶è¿‡å¤§ ($(numfmt --to=iec $file_size))ï¼Œè¿›è¡Œåˆ†å‰²æ‰“åŒ…..."
            split -b 1024m -d ${{ steps.var.outputs.pack_sgsi }} upload/${{ steps.var.outputs.pack_sgsi }}_
            rm ${{ steps.var.outputs.pack_sgsi }}
            echo "âœ… åˆ†å‰²å®Œæˆ: 1GBåˆ†å—"
          else
            echo "ðŸ“¦ ç§»åŠ¨æ–‡ä»¶åˆ°ä¸Šä¼ ç›®å½•"
            mv ${{ steps.var.outputs.pack_sgsi }} upload/
          fi
          
          echo "ðŸ“ ä¸Šä¼ ç›®å½•å†…å®¹:"
          ls -lh "upload"

      - name: "ðŸ“ Generate Release Notes (ç”Ÿæˆå‘å¸ƒè¯´æ˜Ž)"
        id: release_notes
        run: |
          # èŽ·å–å½“å‰æ—¥æœŸä½œä¸ºå‘å¸ƒæ—¥æœŸ
          release_date=$(date +"%Y-%m-%d")
          release_date_tag=$(date +"%Y%m%d")
          
          # è®¡ç®—ç³»ç»Ÿå¤§å°ï¼ˆSGSIç›®å½•çš„å¤§å°ï¼‰
          system_size=$(du -sh SGSI-build-tool/10/SGSI | awk '{print $1}')
          
          # è®¡ç®—åŽ‹ç¼©åŒ…å¤§å°
          zip_file="${{ steps.var.outputs.pack_sgsi }}"
          if [ -f "$zip_file" ]; then
            zip_size=$(du -h "$zip_file" | awk '{print $1}')
          else
            # æ£€æŸ¥ä¸Šä¼ ç›®å½•
            if [ -f "upload/$zip_file" ]; then
              zip_size=$(du -h "upload/$zip_file" | awk '{print $1}')
            else
              # å¦‚æžœåˆ†å‰²äº†ï¼Œåˆ™è®¡ç®—æ‰€æœ‰åˆ†å·çš„æ€»å¤§å°
              parts=$(ls upload/${zip_file}_* 2>/dev/null | wc -l)
              if [ $parts -gt 0 ]; then
                total_size=0
                for part in upload/${zip_file}_*; do
                  part_size=$(du -b "$part" | awk '{print $1}')
                  total_size=$((total_size + part_size))
                done
                zip_size=$(echo "$total_size" | awk '{ split( "B KB MB GB" , v ); s=1; while( $1>1024 ){ $1/=1024; s++ } printf "%.2f %s", $1, v[s] }')
                zip_size="$zip_size (åˆ†å‰²ä¸º $parts éƒ¨åˆ†)"
              else
                zip_size="æœªçŸ¥"
              fi
            fi
          fi
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜Žæ–‡ä»¶
          cat > release_notes.md << EOF
          # xiaoxinSGSI å‘å¸ƒä¿¡æ¯
          
          ## åŸºæœ¬ä¿¡æ¯
          - **ç³»ç»Ÿ**: ${{ steps.sgsi_info.outputs.android_version }}
          - **ç³»ç»Ÿç‰ˆæœ¬**: ${{ steps.sgsi_info.outputs.rom_version }}
          - **ä»Žå“ªä¸ªæœºåž‹ç§»æ¤**: ${{ steps.device_info.outputs.source_device }}
          - **è®¾å¤‡ä»£å·**: ${{ steps.device_info.outputs.device_codename }}
          - **åŽŸæž„å»ºæ—¥æœŸ**: ${{ steps.sgsi_info.outputs.build_date }}
          - **å®‰å…¨è¡¥ä¸**: ${{ steps.sgsi_info.outputs.security_patch }}
          
          ## å¤§å°ä¿¡æ¯
          - **ç³»ç»Ÿå¤§å°**: ${system_size}
          - **åŽ‹ç¼©åŒ…å¤§å°**: ${zip_size}
          - **å‘å¸ƒæ—¥æœŸ**: ${release_date}
          
          ## æž„å»ºä¿¡æ¯
          - **æž„å»ºID**: ${{ steps.sgsi_info.outputs.build_id }}
          EOF
          
          # è¾“å‡ºå‘å¸ƒè¯´æ˜Žå†…å®¹
          cat release_notes.md
          
          # å°†å‘å¸ƒè¯´æ˜Žæ–‡ä»¶ç§»åŠ¨åˆ°ä¸Šä¼ ç›®å½•
          mv release_notes.md upload/
          
          # è®¾ç½®è¾“å‡ºå˜é‡
          echo "release_date=${release_date}" >> $GITHUB_OUTPUT
          echo "release_date_tag=${release_date_tag}" >> $GITHUB_OUTPUT
          echo "system_size=${system_size}" >> $GITHUB_OUTPUT
          echo "zip_size=${zip_size}" >> $GITHUB_OUTPUT
             
      - name: "ðŸš€ Upload Build Artifacts (ä¸Šä¼ æž„å»ºäº§ç‰©)"
        uses: ncipollo/release-action@v1.11.0
        with:
          artifacts: upload/*
          name: ${{ steps.sgsi_info.outputs.rom_version }}
          tag: ${{ steps.release_notes.outputs.release_date_tag }}_${{ steps.sgsi_info.outputs.rom_version }}
          bodyFile: upload/release_notes.md
          token: ${{ secrets.GITHUB_TOKEN }}
