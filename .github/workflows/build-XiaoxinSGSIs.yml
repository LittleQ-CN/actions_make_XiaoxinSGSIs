name: build_XiaoxinSGSIs_old

on:
  watch:
    types: [started]
    
jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: "ğŸš€ Checkout Code (æ£€å‡ºä»£ç )"
        uses: actions/checkout@v4
       
      - name: "ğŸ§¹ Clean Up Environment (æ¸…ç†ç¯å¢ƒ)"
        run: |
          docker rmi -f $(docker images -q) || true
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d
          sudo -E apt-get -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php* || true
          sudo -E apt-get update
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean 
          df -h
       
      - name: "âš™ï¸ Get Configuration Variables (è·å–é…ç½®å˜é‡)"
        run: |
          {
            echo "rom_url=$(jq -r '.rom_url' sgsi.json)"
            echo "rom_name=$(jq -r '.rom_name' sgsi.json)"
            echo "pack_sgsi=$(jq -r '.pack_sgsi' sgsi.json)"
            echo "make_miui=$(jq -r '.make_miui' sgsi.json)"
            echo "make_flyme=$(jq -r '.make_flyme' sgsi.json)"
            echo "make_coloros=$(jq -r '.make_coloros' sgsi.json)"
            echo "make_h2os=$(jq -r '.make_h2os' sgsi.json)"
            echo "make_smartisanos=$(jq -r '.make_smartisanos' sgsi.json)"
            echo "make_zui=$(jq -r '.make_zui' sgsi.json)"
            echo "make_super=$(jq -r '.make_super' sgsi.json)"
          } >> $GITHUB_OUTPUT
        id: var
           
      - name: "ğŸ“¦ Install Download Tools (å®‰è£…ä¸‹è½½å·¥å…·)"
        run: |
          sudo apt-get update
          sudo apt-get install -y axel curl wget pv aria2
          echo "max-connections = 32" | sudo tee -a /etc/axelrc
          echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"
           
      - name: "â¬‡ï¸ Download Build Tools (ä¸‹è½½æ„å»ºå·¥å…·)"
        run: |
          tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar"
          filename="SGSI-build-tool.tar"
          echo "ğŸ”§ æ­£åœ¨ä¸‹è½½æ„å»ºå·¥å…·: $tool_url"
          
          max_retries=3
          for i in $(seq 1 $max_retries); do
            # é¦–é€‰curlï¼ˆç®€æ´è¿›åº¦æ¡ï¼‰
            if command -v curl &> /dev/null; then
              echo "âš¡ ä½¿ç”¨curlä¸‹è½½ [$filename]"
              if curl -# -fL -o "$filename" "$tool_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              else
                echo "âŒ curlå¤±è´¥ï¼Œå°è¯•aria2"
              fi
            fi
            
            # å¤‡é€‰aria2ï¼ˆå¤šçº¿ç¨‹ä¸‹è½½ï¼‰
            if command -v aria2c &> /dev/null; then
              echo "âš¡ ä½¿ç”¨aria2ä¸‹è½½ [$filename] (16çº¿ç¨‹)"
              if aria2c -x 16 -s 16 -k 1M --file-allocation=trunc -U "Mozilla/5.0" -o "$filename" "$tool_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              else
                echo "âŒ aria2å¤±è´¥ï¼Œå°è¯•axel"
              fi
            fi
            
            # å¤‡é€‰axelï¼ˆç²¾ç®€è¿›åº¦æ¡ï¼‰
            if command -v axel &> /dev/null; then
              echo "âš¡ ä½¿ç”¨32çº¿ç¨‹Axelä¸‹è½½ [$filename]"
              
              # è·å–æ–‡ä»¶å¤§å°
              if size=$(curl -sI "$tool_url" | grep -i content-length | awk '{print $2}' | tr -d '\r'); then
                echo "ğŸ“Š æ–‡ä»¶å¤§å°: $((size / 1024 / 1024)) MB"
              else
                size=0
              fi
              
              # å¯åŠ¨è¿›åº¦ç›‘æ§
              start_progress_monitor() {
                local file="$1"
                local size="$2"
                echo -n "ğŸ“¥ ${file}: 0%"
                while true; do
                  if [ -f "$file" ]; then
                    current=$(du -b "$file" | cut -f1 2>/dev/null || echo 0)
                    if [ "$size" -gt 0 ] && [ "$current" -gt 0 ]; then
                      percent=$((current * 100 / size))
                      # é¿å…ç™¾åˆ†æ¯”è¶…è¿‡100
                      if [ $percent -gt 100 ]; then percent=100; fi
                      echo -ne "\rğŸ“¥ ${file}: ${percent}%"
                    fi
                  fi
                  sleep 0.5
                done
              }
              
              # åå°è¿è¡Œè¿›åº¦æ˜¾ç¤º
              start_progress_monitor "$filename" "$size" &
              monitor_pid=$!
              
              # è¿è¡Œaxelä¸‹è½½ï¼ˆé™é»˜æ¨¡å¼ï¼‰
              if axel -q -n 32 -U "Mozilla/5.0" -s -k -o "$filename" "$tool_url"; then
                kill $monitor_pid 2>/dev/null
                echo -e "\rğŸ“¥ ${filename}: 100%"
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              else
                kill $monitor_pid 2>/dev/null
                echo -e "\nâŒ Axelå¤±è´¥ï¼Œå°è¯•wget"
              fi
            fi
            
            # æœ€åå°è¯•wget
            if command -v wget &> /dev/null; then
              echo "âš¡ ä½¿ç”¨wgetä¸‹è½½ [$filename]"
              if wget -q --show-progress -O "$filename" "$tool_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              else
                echo "âŒ wgetå¤±è´¥"
              fi
            fi
            
            if [ $i -lt $max_retries ]; then
              echo "ğŸ”„ æ‰€æœ‰ä¸‹è½½æ–¹å¼å¤±è´¥ï¼Œé‡è¯•ä¸­ ($i/$max_retries)..."
              sleep 10
            else
              echo "::error::âŒ æ„å»ºå·¥å…·ä¸‹è½½å¤±è´¥"
              exit 1
            fi
          done
          
      - name: "ğŸ—ï¸ Initialize Environment (åˆå§‹åŒ–ç¯å¢ƒ)"
        run: |
          sudo tar -xf SGSI-build-tool.tar
          sudo rm -rf SGSI-build-tool/10/setup.sh
          sudo mv bin/setup.sh SGSI-build-tool/10/
          cd SGSI-build-tool/10
          sudo bash setup.sh
          echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
           
      - name: "ğŸ’¾ Download ROM File (ä¸‹è½½ROMæ–‡ä»¶)"
        run: |
          rom_path="SGSI-build-tool/10/tmp/${{ steps.var.outputs.rom_name }}"
          rom_url="${{ steps.var.outputs.rom_url }}"
          filename="${{ steps.var.outputs.rom_name }}"
          
          echo "ğŸš€ å¼€å§‹ä¸‹è½½: $filename"
          max_retries=5
          
          for i in $(seq 1 $max_retries); do
            # é¦–é€‰aria2ï¼ˆå¤šçº¿ç¨‹ä¸‹è½½ï¼‰
            if command -v aria2c &> /dev/null; then
              echo "âš¡ ä½¿ç”¨aria2ä¸‹è½½ [$filename] (32çº¿ç¨‹)"
              # ä½¿ç”¨ç®€æ´è¿›åº¦æ¡ï¼ˆé€šè¿‡awkè§£æè¾“å‡ºï¼‰
              aria2c -x 32 -s 32 -k 1M --file-allocation=trunc -U "Mozilla/5.0" -o "$rom_path" "$rom_url" 2>&1 | \
                awk '
                  /\[#/ {
                    gsub(/#/, "", $0)
                    split($0, parts, /[()]/)
                    if (length(parts) >= 2) {
                      percent = substr(parts[1], length(parts[1])-4, 5)
                      speed = parts[2]
                      gsub(/ /, "", percent)
                      gsub(/%|,/, "", percent)
                      printf "\rğŸ“¥ %s: %s%% (%s)", "'"$filename"'", percent, speed
                    }
                  }
                  END {
                    printf "\n"
                  }'
              if [ ${PIPESTATUS[0]} -eq 0 ]; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              else
                echo "âŒ aria2å¤±è´¥ï¼Œå°è¯•axel"
              fi
            fi
            
            # å¤‡é€‰axelï¼ˆç²¾ç®€è¿›åº¦æ¡ï¼‰
            if command -v axel &> /dev/null; then
              echo "âš¡ ä½¿ç”¨32çº¿ç¨‹Axelä¸‹è½½ [$filename]"
              
              # è·å–æ–‡ä»¶å¤§å°
              if size=$(curl -sI "$rom_url" | grep -i content-length | awk '{print $2}' | tr -d '\r'); then
                echo "ğŸ“Š æ–‡ä»¶å¤§å°: $((size / 1024 / 1024)) MB"
              else
                size=0
              fi
              
              # å¯åŠ¨è¿›åº¦ç›‘æ§
              start_progress_monitor() {
                local file="$1"
                local size="$2"
                local filename=$(basename "$file")
                echo -n "ğŸ“¥ ${filename}: 0%"
                while true; do
                  if [ -f "$file" ]; then
                    current=$(du -b "$file" | cut -f1 2>/dev/null || echo 0)
                    if [ "$size" -gt 0 ] && [ "$current" -gt 0 ]; then
                      percent=$((current * 100 / size))
                      # é¿å…ç™¾åˆ†æ¯”è¶…è¿‡100
                      if [ $percent -gt 100 ]; then percent=100; fi
                      echo -ne "\rğŸ“¥ ${filename}: ${percent}%"
                    fi
                  fi
                  sleep 0.5
                done
              }
              
              # åå°è¿è¡Œè¿›åº¦æ˜¾ç¤º
              start_progress_monitor "$rom_path" "$size" &
              monitor_pid=$!
              
              # è¿è¡Œaxelä¸‹è½½ï¼ˆé™é»˜æ¨¡å¼ï¼‰
              if axel -q -n 32 -U "Mozilla/5.0" -s -k -o "$rom_path" "$rom_url"; then
                kill $monitor_pid 2>/dev/null
                echo -e "\rğŸ“¥ ${filename}: 100%"
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              else
                kill $monitor_pid 2>/dev/null
                echo -e "\nâŒ Axelå¤±è´¥ï¼Œå°è¯•curl"
              fi
            fi
            
            # å¤‡é€‰curlï¼ˆç®€æ´è¿›åº¦æ¡ï¼‰
            if command -v curl &> /dev/null; then
              echo "âš¡ ä½¿ç”¨curlä¸‹è½½ [$filename]"
              if curl -# -L -o "$rom_path" "$rom_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              else
                echo "âŒ curlå¤±è´¥ï¼Œå°è¯•wget"
              fi
            fi
            
            # æœ€åå°è¯•wget
            if command -v wget &> /dev/null; then
              echo "âš¡ ä½¿ç”¨wgetä¸‹è½½ [$filename]"
              if wget -q --show-progress -O "$rom_path" "$rom_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              else
                echo "âŒ wgetå¤±è´¥"
              fi
            fi
            
            if [ $i -lt $max_retries ]; then
              echo "ğŸ”„ æ‰€æœ‰ä¸‹è½½æ–¹å¼å¤±è´¥ï¼Œé‡è¯•ä¸­ ($i/$max_retries)..."
              sleep 10
            else
              echo "::error::âŒ ROMä¸‹è½½å¤±è´¥"
              exit 1
            fi
          done
          
          echo -e "\nğŸ‰ ä¸‹è½½å®Œæˆ"
          echo "ğŸ“¦ æ–‡ä»¶å¤§å°: $(du -h "$rom_path" | cut -f1)"
       
      - name: "ğŸ“¦ Package SGSI Output (æ‰“åŒ…SGSIè¾“å‡º)"
        run: |
          mkdir -p upload
          zip -r ${{ steps.var.outputs.pack_sgsi }} SGSI-build-tool/10/SGSI/*
          file_size=$(du -sb ${{ steps.var.outputs.pack_sgsi }} | awk '{print $1}')
          max_size=2097152000
          
          if [ $file_size -gt $max_size ]; then
            echo "âš ï¸ æ–‡ä»¶è¿‡å¤§ ($(numfmt --to=iec $file_size))ï¼Œè¿›è¡Œåˆ†å‰²æ‰“åŒ…..."
            split -b 1024m -d ${{ steps.var.outputs.pack_sgsi }} upload/${{ steps.var.outputs.pack_sgsi }}_
            rm ${{ steps.var.outputs.pack_sgsi }}
            echo "âœ… åˆ†å‰²å®Œæˆ: 1GBåˆ†å—"
          else
            echo "ğŸ“¦ ç§»åŠ¨æ–‡ä»¶åˆ°ä¸Šä¼ ç›®å½•"
            mv ${{ steps.var.outputs.pack_sgsi }} upload/
          fi
          
          echo "ğŸ“ ä¸Šä¼ ç›®å½•å†…å®¹:"
          ls -lh "upload"
             
      - name: "ğŸš€ Upload Build Artifacts (ä¸Šä¼ æ„å»ºäº§ç‰©)"
        uses: ncipollo/release-action@v1.11.0
        with:
          artifacts: upload/*
          name: xiaoxinSGSI-ab-Android10-unpack
          tag: xiaoxinSGSI-ab-Android10-${{ github.run_number }}
          token: ${{ secrets.GITHUB_TOKEN }}
