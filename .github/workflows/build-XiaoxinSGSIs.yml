name: build_XiaoxinSGSIs

on:
  workflow_dispatch:
  watch:
    types: [started]

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: "ğŸš€ Checkout Code (æ£€å‡ºä»£ç )"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
       
      - name: "ğŸ§¹ Clean Up Environment (æ¸…ç†ç¯å¢ƒ)"
        run: |
          echo "ğŸ§¹ æ¸…ç†ç¯å¢ƒ..."
          docker rmi -f $(docker images -q) 2>/dev/null || true
          sudo rm -rf /usr/share/docker /etc/mysql /etc/php /etc/apt/sources.list.d/* || true
          sudo apt-get -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php* 2>/dev/null || true
          sudo apt-get update
          sudo apt-get -y autoremove --purge
          sudo apt-get clean 
          echo "ğŸ“Š ç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ:"
          df -h
          echo "âœ… ç¯å¢ƒæ¸…ç†å®Œæˆ"
       
      - name: "âš™ï¸ Get Configuration Variables (è·å–é…ç½®å˜é‡)"
        run: |
          echo "ğŸ“‹ è¯»å–é…ç½®æ–‡ä»¶..."
          if [ -f sgsi.json ]; then
            {
              echo "rom_url=$(jq -r '.rom_url // empty' sgsi.json)"
              echo "rom_name=$(jq -r '.rom_name // empty' sgsi.json)"
              echo "pack_sgsi=$(jq -r '.pack_sgsi // "SGSI.zip"' sgsi.json)"
              echo "make_miui=$(jq -r '.make_miui // "false"' sgsi.json)"
              echo "make_flyme=$(jq -r '.make_flyme // "false"' sgsi.json)"
              echo "make_coloros=$(jq -r '.make_coloros // "false"' sgsi.json)"
              echo "make_h2os=$(jq -r '.make_h2os // "false"' sgsi.json)"
              echo "make_smartisanos=$(jq -r '.make_smartisanos // "false"' sgsi.json)"
              echo "make_zui=$(jq -r '.make_zui // "false"' sgsi.json)"
              echo "make_super=$(jq -r '.make_super // "false"' sgsi.json)"
            } >> $GITHUB_OUTPUT
          else
            echo "âŒ é”™è¯¯: sgsi.json é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            echo "ğŸ’¡ è¯·åˆ›å»º sgsi.json æ–‡ä»¶å¹¶é…ç½®å¿…è¦çš„å‚æ•°"
            exit 1
          fi
        id: config
           
      - name: "ğŸ“¦ Install Required Tools (å®‰è£…å¿…è¦å·¥å…·)"
        run: |
          echo "ğŸ”„ æ›´æ–°åŒ…åˆ—è¡¨..."
          sudo apt-get update -qq
          
          echo "ğŸ”§ å®‰è£…åŸºç¡€å·¥å…·..."
          sudo apt-get install -y \
            axel \
            curl \
            wget \
            pv \
            aria2 \
            git \
            make \
            gcc \
            libfuse-dev \
            libssl-dev \
            autoconf \
            automake \
            pkg-config \
            jq \
            unzip
          
          echo "ğŸ“¦ å®‰è£…æ–‡ä»¶ç³»ç»Ÿå·¥å…·..."
          # å®‰è£… e2fsprogs (åŒ…å« debugfs)
          sudo apt-get install -y e2fsprogs
          
          # å®‰è£…å¼€å‘æ–‡ä»¶ - ä½¿ç”¨ Ubuntu 22.04 æ­£ç¡®çš„åŒ…å
          echo "ğŸ” å®‰è£…å¼€å‘åº“..."
          if apt-cache show uuid-dev > /dev/null 2>&1; then
            sudo apt-get install -y uuid-dev
          fi
          
          if apt-cache show libext2fs-dev > /dev/null 2>&1; then
            sudo apt-get install -y libext2fs-dev
          fi
          
          if apt-cache show libblkid-dev > /dev/null 2>&1; then
            sudo apt-get install -y libblkid-dev
          fi
          
          # å®‰è£… e2fsprogs å¼€å‘åŒ…ï¼ˆåŒ…å«æ‰€æœ‰å¿…è¦ç»„ä»¶ï¼‰
          if apt-cache show e2fsprogs-dev > /dev/null 2>&1; then
            sudo apt-get install -y e2fsprogs-dev
          fi
          
          # é…ç½® axel å¤šçº¿ç¨‹ä¸‹è½½
          echo "âš¡ é…ç½® Axel å¤šçº¿ç¨‹ä¸‹è½½..."
          sudo mkdir -p /etc/axel
          echo "max_connections=32" | sudo tee /etc/axelrc > /dev/null
          
          echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"
          echo "ğŸ”§ å¯ç”¨å·¥å…·æ£€æŸ¥:"
          command -v debugfs && echo "âœ… debugfs: $(debugfs -V 2>&1 | head -1)" || echo "âŒ debugfs ä¸å¯ç”¨"
          command -v axel && echo "âœ… axel å·²å®‰è£…" || echo "âŒ axel ä¸å¯ç”¨"
          command -v aria2c && echo "âœ… aria2 å·²å®‰è£…" || echo "âŒ aria2 ä¸å¯ç”¨"
           
      - name: "â¬‡ï¸ Download Build Tools (ä¸‹è½½æ„å»ºå·¥å…·)"
        run: |
          tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar"
          filename="SGSI-build-tool.tar"
          echo "ğŸ”§ ä¸‹è½½æ„å»ºå·¥å…·: $tool_url"
          
          max_retries=5
          for i in $(seq 1 $max_retries); do
            echo "ğŸ”„ å°è¯• #$i"
            
            # å°è¯• curl
            if command -v curl > /dev/null; then
              echo "âš¡ ä½¿ç”¨ curl ä¸‹è½½..."
              if curl -fL --connect-timeout 30 --retry 3 -o "$filename" "$tool_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              fi
            fi
            
            # å°è¯• aria2
            if command -v aria2c > /dev/null; then
              echo "âš¡ ä½¿ç”¨ aria2 ä¸‹è½½ (16çº¿ç¨‹)..."
              if aria2c -x 16 -s 16 --connect-timeout=30 --timeout=30 --retry-wait=10 -o "$filename" "$tool_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              fi
            fi
            
            # å°è¯• axel
            if command -v axel > /dev/null; then
              echo "âš¡ ä½¿ç”¨ axel ä¸‹è½½ (32çº¿ç¨‹)..."
              if axel -n 32 -o "$filename" "$tool_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              fi
            fi
            
            # å°è¯• wget
            if command -v wget > /dev/null; then
              echo "âš¡ ä½¿ç”¨ wget ä¸‹è½½..."
              if wget --timeout=30 --tries=3 -O "$filename" "$tool_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              fi
            fi
            
            if [ $i -eq $max_retries ]; then
              echo "âŒ æ‰€æœ‰ä¸‹è½½æ–¹å¼éƒ½å¤±è´¥äº†"
              exit 1
            fi
            
            echo "â³ ç­‰å¾… 10 ç§’åé‡è¯•..."
            sleep 10
          done
          
          # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
          if [ -f "$filename" ] && [ -s "$filename" ]; then
            echo "âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸ: $(du -h "$filename")"
          else
            echo "âŒ æ–‡ä»¶ä¸‹è½½å¤±è´¥æˆ–ä¸ºç©º"
            exit 1
          fi
          
      - name: "ğŸ—ï¸ Initialize Environment (åˆå§‹åŒ–ç¯å¢ƒ)"
        run: |
          echo "ğŸ—ï¸ åˆå§‹åŒ–æ„å»ºç¯å¢ƒ..."
          
          # è§£å‹æ„å»ºå·¥å…·
          if [ -f "SGSI-build-tool.tar" ]; then
            echo "ğŸ“¦ è§£å‹æ„å»ºå·¥å…·..."
            sudo tar -xf SGSI-build-tool.tar
            if [ -d "SGSI-build-tool" ]; then
              echo "âœ… è§£å‹æˆåŠŸ"
            else
              echo "âŒ è§£å‹åç›®å½•ä¸å­˜åœ¨"
              exit 1
            fi
          else
            echo "âŒ æ„å»ºå·¥å…·å‹ç¼©åŒ…ä¸å­˜åœ¨"
            exit 1
          fi
          
          # è®¾ç½®æ‰§è¡Œæƒé™
          echo "ğŸ”’ è®¾ç½®æ‰§è¡Œæƒé™..."
          sudo chmod -R +x SGSI-build-tool/
          
          echo "âœ… ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
           
      - name: "ğŸ’¾ Download ROM File (ä¸‹è½½ROMæ–‡ä»¶)"
        run: |
          rom_url="${{ steps.config.outputs.rom_url }}"
          rom_name="${{ steps.config.outputs.rom_name }}"
          
          if [ -z "$rom_url" ] || [ "$rom_url" = "null" ]; then
            echo "âš ï¸ æœªé…ç½® ROM URLï¼Œè·³è¿‡ä¸‹è½½"
            exit 0
          fi
          
          echo "ğŸš€ å¼€å§‹ä¸‹è½½ ROM: $rom_name"
          echo "ğŸ”— URL: $rom_url"
          
          rom_path="SGSI-build-tool/10/tmp/$rom_name"
          sudo mkdir -p "$(dirname "$rom_path")"
          
          max_retries=5
          for i in $(seq 1 $max_retries); do
            echo "ğŸ”„ ä¸‹è½½å°è¯• #$i"
            
            # å°è¯• aria2
            if command -v aria2c > /dev/null; then
              echo "âš¡ ä½¿ç”¨ aria2 ä¸‹è½½ (32çº¿ç¨‹)..."
              if sudo aria2c -x 32 -s 32 --connect-timeout=30 --timeout=300 --retry-wait=10 -d "$(dirname "$rom_path")" -o "$(basename "$rom_path")" "$rom_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              fi
            fi
            
            # å°è¯• axel
            if command -v axel > /dev/null; then
              echo "âš¡ ä½¿ç”¨ axel ä¸‹è½½ (32çº¿ç¨‹)..."
              if sudo axel -n 32 -o "$rom_path" "$rom_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              fi
            fi
            
            # å°è¯• curl
            if command -v curl > /dev/null; then
              echo "âš¡ ä½¿ç”¨ curl ä¸‹è½½..."
              if sudo curl -fL --connect-timeout 30 --retry 3 -o "$rom_path" "$rom_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              fi
            fi
            
            # å°è¯• wget
            if command -v wget > /dev/null; then
              echo "âš¡ ä½¿ç”¨ wget ä¸‹è½½..."
              if sudo wget --timeout=30 --tries=3 -O "$rom_path" "$rom_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              fi
            fi
            
            if [ $i -eq $max_retries ]; then
              echo "âŒ ROM ä¸‹è½½å¤±è´¥"
              exit 1
            fi
            
            echo "â³ ç­‰å¾… 15 ç§’åé‡è¯•..."
            sleep 15
          done
          
          # éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
          if [ -f "$rom_path" ] && [ -s "$rom_path" ]; then
            echo "ğŸ‰ ROM ä¸‹è½½å®Œæˆ"
            echo "ğŸ“¦ æ–‡ä»¶å¤§å°: $(sudo du -h "$rom_path" | cut -f1)"
            echo "ğŸ“ ä¿å­˜è·¯å¾„: $rom_path"
          else
            echo "âŒ ROM æ–‡ä»¶ä¸‹è½½å¤±è´¥æˆ–ä¸ºç©º"
            exit 1
          fi

      - name: "âš™ï¸ Configure ROM Specific Settings (é…ç½®ROMç‰¹å®šè®¾ç½®)"
        run: |
          echo "âš™ï¸ é…ç½®ROMç‰¹å®šè®¾ç½®..."
          
          # ç¡®ä¿ fixbug ç›®å½•å­˜åœ¨
          sudo mkdir -p SGSI-build-tool/10/fixbug
          
          # æ ¹æ®é…ç½®é€‰æ‹©ç›¸åº”çš„ä¿®å¤è„šæœ¬
          if [ "${{ steps.config.outputs.make_miui }}" = "true" ]; then
            echo "ğŸ”§ é…ç½® MIUI..."
            if [ -f "fix/MIUI.sh" ]; then
              sudo cp fix/MIUI.sh SGSI-build-tool/10/fixbug/fixbug.sh
              sudo chmod +x SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          
          elif [ "${{ steps.config.outputs.make_flyme }}" = "true" ]; then
            echo "ğŸ”§ é…ç½® Flyme..."
            if [ -f "fix/Flyme.sh" ]; then
              sudo cp fix/Flyme.sh SGSI-build-tool/10/fixbug/fixbug.sh
              sudo chmod +x SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          
          elif [ "${{ steps.config.outputs.make_coloros }}" = "true" ]; then
            echo "ğŸ”§ é…ç½® ColorOS..."
            # æ£€æŸ¥æ˜¯å¦æ˜¯ OZIP æ–‡ä»¶éœ€è¦è§£å¯†
            if [[ "${{ steps.config.outputs.rom_name }}" == *.ozip ]]; then
              echo "ğŸ”“ è§£å¯† ColorOS OZIP æ–‡ä»¶..."
              if [ -f "SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py" ]; then
                cd SGSI-build-tool/10/oppo_ozip
                sudo python3 ozipdecrypt.py "../tmp/${{ steps.config.outputs.rom_name }}"
                cd ../../..
              fi
            fi
            if [ -f "fix/ColorOS.sh" ]; then
              sudo cp fix/ColorOS.sh SGSI-build-tool/10/fixbug/fixbug.sh
              sudo chmod +x SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          
          elif [ "${{ steps.config.outputs.make_h2os }}" = "true" ]; then
            echo "ğŸ”§ é…ç½® H2OS..."
            if [ -f "fix/H2OS.sh" ]; then
              sudo cp fix/H2OS.sh SGSI-build-tool/10/fixbug/fixbug.sh
              sudo chmod +x SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          
          elif [ "${{ steps.config.outputs.make_smartisanos }}" = "true" ]; then
            echo "ğŸ”§ é…ç½® SmartisanOS..."
            if [ -f "fix/SmartisanOS.sh" ]; then
              sudo cp fix/SmartisanOS.sh SGSI-build-tool/10/fixbug/fixbug.sh
              sudo chmod +x SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          
          elif [ "${{ steps.config.outputs.make_zui }}" = "true" ]; then
            echo "ğŸ”§ é…ç½® ZUI..."
            if [ -f "fix/ZUI.sh" ]; then
              sudo cp fix/ZUI.sh SGSI-build-tool/10/fixbug/fixbug.sh
              sudo chmod +x SGSI-build-tool/10/fixbug/fixbug.sh
            fi
          
          else
            echo "â„¹ï¸ ä½¿ç”¨é»˜è®¤é…ç½®"
          fi
          
          # Super SGSI é…ç½®
          if [ "${{ steps.config.outputs.make_super }}" = "true" ]; then
            echo "ğŸ”§ é…ç½® Super SGSI..."
            if [ -f "SGSI-build-tool/10/make.sh" ]; then
              sudo sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' SGSI-build-tool/10/make.sh
            fi
          fi
          
          echo "âœ… ROM é…ç½®å®Œæˆ"
            
      - name: "ğŸ› ï¸ Build SGSI Images (æ„å»ºSGSIé•œåƒ)"
        run: |
          echo "ğŸ› ï¸ å¼€å§‹æ„å»º SGSI é•œåƒ..."
          
          # è¿›å…¥æ„å»ºç›®å½•
          cd SGSI-build-tool/10
          
          # ç¡®ä¿æœ‰æ‰§è¡Œæƒé™
          sudo chmod +x make.sh
          sudo chmod +x bin/*
          
          # æ‰§è¡Œæ„å»º
          echo "ğŸ—ï¸ æ‰§è¡Œæ„å»ºè„šæœ¬..."
          if sudo bash make.sh; then
            echo "ğŸ‰ SGSI é•œåƒæ„å»ºæˆåŠŸ"
          else
            echo "âŒ SGSI é•œåƒæ„å»ºå¤±è´¥"
            exit 1
          fi
          
          # æ£€æŸ¥æ„å»ºç»“æœ
          if [ -d "SGSI" ]; then
            echo "ğŸ“ æ„å»ºç»“æœ:"
            sudo find SGSI -name "*.img" -o -name "*.zip" | sudo xargs -I {} sh -c 'echo "  - {} ($(sudo du -h {} | cut -f1))"'
          else
            echo "âŒ æ„å»ºç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi

      - name: "ğŸ” Extract System Version Info (æå–ç³»ç»Ÿç‰ˆæœ¬ä¿¡æ¯)"
        id: version_info
        run: |
          echo "ğŸ” æå–ç³»ç»Ÿç‰ˆæœ¬ä¿¡æ¯..."
          
          # æŸ¥æ‰¾ system.img æ–‡ä»¶
          system_img=$(find SGSI-build-tool/10/SGSI -name "system.img" -o -name "system_*.img" | head -1)
          
          if [ -z "$system_img" ]; then
            echo "âŒ æœªæ‰¾åˆ° system.img æ–‡ä»¶"
            echo "android_version=Unknown" >> $GITHUB_OUTPUT
            echo "rom_version=Unknown" >> $GITHUB_OUTPUT
            echo "security_patch=Unknown" >> $GITHUB_OUTPUT
            echo "build_date=Unknown" >> $GITHUB_OUTPUT
            echo "build_id=Unknown" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ğŸ“ æ‰¾åˆ° system.img: $system_img"
          
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p /tmp/system_info
          
          # å°è¯•ä½¿ç”¨ debugfs æå– build.prop
          echo "ğŸ”§ å°è¯•æå– build.prop..."
          if command -v debugfs > /dev/null; then
            if sudo debugfs -R "cat /build.prop" "$system_img" > /tmp/system_info/build.prop 2>/dev/null; then
              # æ£€æŸ¥æå–çš„å†…å®¹æ˜¯å¦æœ‰æ•ˆ
              if grep -q "ro.build" /tmp/system_info/build.prop; then
                echo "âœ… build.prop æå–æˆåŠŸ"
              else
                echo "âŒ æå–çš„ build.prop å†…å®¹æ— æ•ˆ"
                rm /tmp/system_info/build.prop
              fi
            else
              echo "âŒ debugfs æå–å¤±è´¥"
            fi
          else
            echo "âŒ debugfs ä¸å¯ç”¨"
          fi
          
          # è§£æç‰ˆæœ¬ä¿¡æ¯
          if [ -f /tmp/system_info/build.prop ]; then
            echo "ğŸ“‹ è§£æç‰ˆæœ¬ä¿¡æ¯..."
            
            # æå– Android ç‰ˆæœ¬
            android_version=$(grep -oP 'ro.build.version.release=\K.*' /tmp/system_info/build.prop | head -1)
            # æå–å®‰å…¨è¡¥ä¸æ—¥æœŸ
            security_patch=$(grep -oP 'ro.build.version.security_patch=\K.*' /tmp/system_info/build.prop | head -1)
            # æå–æ„å»ºæ—¥æœŸ
            build_date=$(grep -oP 'ro.build.date=\K.*' /tmp/system_info/build.prop | head -1)
            # æå–æ„å»º ID
            build_id=$(grep -oP 'ro.build.id=\K.*' /tmp/system_info/build.prop | head -1)
            
            # æå– ROM ç‰ˆæœ¬ä¿¡æ¯
            rom_display=$(grep -oP 'ro.build.display.id=\K.*' /tmp/system_info/build.prop | head -1)
            miui_version=$(grep -oP 'ro.miui.ui.version.name=\K.*' /tmp/system_info/build.prop | head -1)
            miui_code=$(grep -oP 'ro.miui.ui.version.code=\K.*' /tmp/system_info/build.prop | head -1)
            
            # ç¡®å®š ROM ç‰ˆæœ¬
            if [ -n "$miui_version" ]; then
              rom_version="MIUI $miui_version"
              if [ -n "$miui_code" ]; then
                rom_version="$rom_version ($miui_code)"
              fi
            elif [ -n "$rom_display" ]; then
              rom_version="$rom_display"
            else
              rom_version=$(grep -oP 'ro.product.name=\K.*' /tmp/system_info/build.prop | head -1)
              if [ -z "$rom_version" ]; then
                rom_version=$(grep -oP 'ro.product.system.name=\K.*' /tmp/system_info/build.prop | head -1)
              fi
            fi
            
            # è®¾ç½®é»˜è®¤å€¼ï¼ˆå¦‚æœæå–å¤±è´¥ï¼‰
            android_version=${android_version:-"Unknown"}
            rom_version=${rom_version:-"Unknown"}
            security_patch=${security_patch:-"Unknown"}
            build_date=${build_date:-"Unknown"}
            build_id=${build_id:-"Unknown"}
            
            echo "ğŸ“Š æå–çš„ç‰ˆæœ¬ä¿¡æ¯:"
            echo "  - Android ç‰ˆæœ¬: $android_version"
            echo "  - ROM ç‰ˆæœ¬: $rom_version"
            echo "  - å®‰å…¨è¡¥ä¸: $security_patch"
            echo "  - æ„å»ºæ—¥æœŸ: $build_date"
            echo "  - æ„å»º ID: $build_id"
            
          else
            # å¤‡ç”¨æ–¹æ¡ˆï¼šä» ROM æ–‡ä»¶åæ¨æ–­ä¿¡æ¯
            echo "âš ï¸ æ— æ³•æå– build.propï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ"
            rom_name="${{ steps.config.outputs.rom_name }}"
            
            # ä½¿ç”¨æ”¹è¿›çš„ç‰ˆæœ¬ä¿¡æ¯æå–
            # å°è¯•æå–æ—¥æœŸä¿¡æ¯ï¼ˆé€šå¸¸ä¸º8ä½æ•°å­—ï¼šYYYYMMDDï¼‰
            build_date_from_name=$(echo "$rom_name" | grep -oE '[0-9]{8}')
            if [ -n "$build_date_from_name" ]; then
                date_part="$build_date_from_name"
            else
                # å¦‚æœæ²¡æœ‰8ä½æ—¥æœŸï¼Œå°è¯•æå–å…¶ä»–æ ¼å¼çš„æ—¥æœŸ
                date_part=$(echo "$rom_name" | grep -oE '[0-9]{6,}' | head -1)
                date_part=${date_part:-"NODATE"}
            fi

            # å°è¯•æå–ç³»ç»Ÿç±»å‹
            if echo "$rom_name" | grep -qi "miui"; then
                sys_part="MIUI"
            elif echo "$rom_name" | grep -qi "flyme"; then
                sys_part="Flyme"
            elif echo "$rom_name" | grep -qi "coloros\|oppo"; then
                sys_part="ColorOS"
            elif echo "$rom_name" | grep -qi "h2os\|hydrogen"; then
                sys_part="H2OS"
            elif echo "$rom_name" | grep -qi "smartisan"; then
                sys_part="SmartisanOS"
            elif echo "$rom_name" | grep -qi "zui\|lenovo"; then
                sys_part="ZUI"
            else
                # å¦‚æœæ²¡æœ‰æ˜ç¡®ç³»ç»Ÿæ ‡è¯†ï¼Œä½¿ç”¨æ–‡ä»¶åçš„ä¸»è¦éƒ¨åˆ†
                sys_part=$(echo "$rom_name" | sed 's/\.zip$//' | sed 's/\.img$//' | tr -cd '[:alnum:]._-')
                # å–ç›¸å¯¹ç®€çŸ­çš„æ–‡ä»¶åéƒ¨åˆ†
                sys_part=$(echo "$sys_part" | cut -d'_' -f1-3)
            fi

            # ç»„åˆç‰ˆæœ¬ä¿¡æ¯
            if [ "$date_part" != "NODATE" ]; then
                rom_version="${date_part}_${sys_part}"
            else
                rom_version="$sys_part"
            fi

            android_version="Unknown"
            security_patch="Unknown"
            build_date="Unknown"
            build_id="Unknown"
          fi
          
          # è¾“å‡ºåˆ° GitHub Actions
          echo "android_version=${android_version}" >> $GITHUB_OUTPUT
          echo "rom_version=${rom_version}" >> $GITHUB_OUTPUT
          echo "security_patch=${security_patch}" >> $GITHUB_OUTPUT
          echo "build_date=${build_date}" >> $GITHUB_OUTPUT
          echo "build_id=${build_id}" >> $GITHUB_OUTPUT
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -rf /tmp/system_info
          
          echo "âœ… ç‰ˆæœ¬ä¿¡æ¯æå–å®Œæˆ"

      - name: "ğŸ“¦ Package SGSI Output (æ‰“åŒ…SGSIè¾“å‡º)"
        run: |
          echo "ğŸ“¦ æ‰“åŒ… SGSI è¾“å‡º..."
          
          pack_name="${{ steps.config.outputs.pack_sgsi }}"
          if [ -z "$pack_name" ] || [ "$pack_name" = "null" ]; then
            pack_name="SGSI.zip"
          fi
          
          # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
          mkdir -p upload
          
          # æ‰“åŒ… SGSI ç›®å½•
          if [ -d "SGSI-build-tool/10/SGSI" ]; then
            echo "ğŸ“ æ‰“åŒ… SGSI ç›®å½•..."
            cd SGSI-build-tool/10
            sudo zip -r "../../$pack_name" SGSI/*
            cd ../..
            
            # æ£€æŸ¥æ–‡ä»¶å¤§å°
            file_size=$(du -b "$pack_name" | awk '{print $1}')
            max_size=2000000000  # 2GB
            
            if [ $file_size -gt $max_size ]; then
              echo "âš ï¸ æ–‡ä»¶è¿‡å¤§ ($(echo "scale=2; $file_size/1024/1024/1024" | bc)GB)ï¼Œè¿›è¡Œåˆ†å‰²..."
              split -b 1024M -d "$pack_name" "upload/${pack_name%.zip}_part"
              rm "$pack_name"
              echo "âœ… åˆ†å‰²å®Œæˆ"
            else
              mv "$pack_name" upload/
              echo "âœ… æ‰“åŒ…å®Œæˆ: upload/$pack_name ($(du -h upload/$pack_name | cut -f1))"
            fi
          else
            echo "âŒ SGSI ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          # åˆ—å‡ºä¸Šä¼ ç›®å½•å†…å®¹
          echo "ğŸ“ ä¸Šä¼ ç›®å½•å†…å®¹:"
          ls -lh upload/

      - name: "ğŸ“ Generate Release Notes (ç”Ÿæˆå‘å¸ƒè¯´æ˜)"
        run: |
          echo "ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜..."
          
          # åˆ›å»ºå‘å¸ƒè¯´æ˜æ–‡ä»¶
          cat > upload/release_notes.md << EOF
          # xiaoxinSGSI æ„å»ºç»“æœ
          
          ## ç³»ç»Ÿä¿¡æ¯
          - **Android ç‰ˆæœ¬**: ${{ steps.version_info.outputs.android_version }}
          - **ROM ç‰ˆæœ¬**: ${{ steps.version_info.outputs.rom_version }}
          - **å®‰å…¨è¡¥ä¸**: ${{ steps.version_info.outputs.security_patch }}
          - **æ„å»ºæ—¥æœŸ**: ${{ steps.version_info.outputs.build_date }}
          - **æ„å»º ID**: ${{ steps.version_info.outputs.build_id }}
          
          ## æ„å»ºä¿¡æ¯
          - **æº ROM**: ${{ steps.config.outputs.rom_name }}
          - **æ„å»ºæ—¶é—´**: $(date +"%Y-%m-%d %H:%M:%S")
          
          ## ä¸‹è½½å†…å®¹
          æ­¤æ„å»ºåŒ…å«ä»¥ä¸‹æ–‡ä»¶:
          $(cd upload && ls -la | grep -E ".(zip|img)$" | awk '{print "- " $9 " (" $5 " bytes)"}')
          EOF
          
          echo "âœ… å‘å¸ƒè¯´æ˜ç”Ÿæˆå®Œæˆ"
          echo "ğŸ“„ å‘å¸ƒè¯´æ˜å†…å®¹:"
          cat upload/release_notes.md

      - name: "ğŸ“… Generate Release Tag (ç”Ÿæˆå‘å¸ƒæ ‡ç­¾)"
        id: release_tag
        run: |
          # ç”Ÿæˆå‘å¸ƒæ—¥æœŸæ ‡ç­¾ï¼Œæ ¼å¼ä¸º YYYYMMDD
          release_date_tag=$(date +"%Y%m%d")
          echo "release_date_tag=$release_date_tag" >> $GITHUB_OUTPUT
          
          # ä»ç‰ˆæœ¬ä¿¡æ¯ä¸­æå–é€‚åˆä½œä¸ºæ ‡ç­¾çš„éƒ¨åˆ†
          rom_version="${{ steps.version_info.outputs.rom_version }}"
          # ç§»é™¤å¯èƒ½ä¸é€‚åˆæ ‡ç­¾çš„å­—ç¬¦
          tag_safe_version=$(echo "$rom_version" | tr -cd '[:alnum:]._-' | sed 's/[_ ]/-/g')
          echo "tag_safe_version=$tag_safe_version" >> $GITHUB_OUTPUT
          
          echo "ğŸ“… å‘å¸ƒæ ‡ç­¾: $release_date_tag"
          echo "ğŸ·ï¸ ç‰ˆæœ¬æ ‡ç­¾: $tag_safe_version"

      - name: "ğŸš€ Create GitHub Release (åˆ›å»ºGitHubå‘å¸ƒ)"
        uses: ncipollo/release-action@v1.11.0
        with:
          artifacts: upload/*
          name: ${{ steps.version_info.outputs.rom_version }}
          tag: ${{ steps.release_tag.outputs.release_date_tag }}_${{ steps.release_tag.outputs.tag_safe_version }}
          bodyFile: upload/release_notes.md
          token: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: "âœ… Build Completion (æ„å»ºå®Œæˆ)"
        run: |
          echo "ğŸ‰ æ„å»ºæµç¨‹å®Œæˆ!"
          echo "ğŸ“Š æœ€ç»ˆç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h
          echo "ğŸ“¦ æ„å»ºäº§ç‰©å·²ä¸Šä¼ åˆ° GitHub Release"
          echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯:"
          echo "  - Android: ${{ steps.version_info.outputs.android_version }}"
          echo "  - ROM: ${{ steps.version_info.outputs.rom_version }}"
          echo "  - å®‰å…¨è¡¥ä¸: ${{ steps.version_info.outputs.security_patch }}"
          echo "  - æ„å»ºæ—¥æœŸ: ${{ steps.version_info.outputs.build_date }}"
