name: build_XiaoxinSGSIs

on:
  watch:
    types: [started]

env:
  BUILD_DIR: SGSI-build-tool/10
  ROM_DIR: tmp
  TOOLKIT_URL: https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id
    timeout-minutes: 180
    
    steps:
    - name: Á≥ªÁªüÂàùÂßãÂåñ
      run: |
        sudo timedatectl set-timezone Asia/Shanghai
        sudo docker rmi $(docker images -q) || true
        sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d
        sudo apt-get purge -y azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php*
        sudo apt-get update
        sudo apt-get autoremove -y --purge
        sudo apt-get clean
        sudo apt-get install -y axel jq curl wget p7zip-full python3-pip \
          simg2img img2simg brotli xz-utils android-sdk-libsparse-utils zip unzip \
          file bc pv tree e2fsprogs
        df -h
        echo "‚úÖ Á≥ªÁªüÂàùÂßãÂåñÂÆåÊàê"
      
    - name: Ê£ÄÂá∫‰ª£Á†Å
      uses: actions/checkout@v4
      
    - name: Âä†ËΩΩÈÖçÁΩÆ
      id: config
      run: |
        echo "Ê£ÄÊü•sgsi.jsonÈÖçÁΩÆÊñá‰ª∂..."
        [ ! -f "sgsi.json" ] && { echo "::error::Êú™ÊâæÂà∞sgsi.jsonÈÖçÁΩÆÊñá‰ª∂"; exit 1; }
        
        echo "Âä†ËΩΩsgsi.jsonÈÖçÁΩÆ..."
        declare -A CONFIG_MAP
        CONFIG_MAP[rom_url]=required
        CONFIG_MAP[rom_name]=required
        CONFIG_MAP[pack_sgsi]=optional
        CONFIG_MAP[make_miui]=required
        CONFIG_MAP[make_flyme]=required
        CONFIG_MAP[make_coloros]=required
        CONFIG_MAP[make_h2os]=required
        CONFIG_MAP[make_smartisanos]=required
        CONFIG_MAP[make_zui]=required
        CONFIG_MAP[make_super]=required
        CONFIG_MAP[upload_artifact]=required
        CONFIG_MAP[uploa_wetransfer]=required
        
        for key in "${!CONFIG_MAP[@]}"; do
          value=$(jq -r ".$key" sgsi.json)
          required="${CONFIG_MAP[$key]}"
          
          if [ "$value" = "null" ]; then
            if [ "$required" = "required" ]; then
              echo "::error::ÈÖçÁΩÆÈ°π $key Áº∫Â§±‰∫ésgsi.json"
              exit 1
            else
              echo "ÂèØÈÄâÈÖçÁΩÆ $key Áº∫Â§±ÔºåË∑≥Ëøá"
              continue
            fi
          fi
          
          if [ "$key" = "uploa_wetransfer" ]; then
            echo "upload_transfer=$value" >> $GITHUB_ENV
            echo "ÈÖçÁΩÆ upload_transfer = $value"
          else
            echo "$key=$value" >> $GITHUB_ENV
            echo "ÈÖçÁΩÆ $key = $value"
          fi
        done
        
        pack_name=$(jq -r '.pack_sgsi' sgsi.json)
        if [ -n "$pack_name" ] && [ "$pack_name" != "null" ]; then
          echo "OUTPUT_FILE=$pack_name" >> $GITHUB_ENV
        else
          rom_name=$(jq -r '.rom_name' sgsi.json)
          echo "OUTPUT_FILE=XiaoxinSGSI-${rom_name}-$(date +%m%d).7z" >> $GITHUB_ENV
        fi
        echo "‚úÖ ÈÖçÁΩÆÂä†ËΩΩÂÆåÊàê"
        
    - name: Ëé∑ÂèñÂ∑•ÂÖ∑ÁÆ±
      run: |
        echo "‰∏ãËΩΩÂ∑•ÂÖ∑ÁÆ±: $TOOLKIT_URL"
        mkdir -p $BUILD_DIR/SGSI
        
        echo "üöÄ ‰ΩøÁî®axel‰∏ãËΩΩÂ∑•ÂÖ∑ÁÆ±..."
        axel -n 8 -U "SGSI-Builder" --alternate --verbose -o SGSI-build-tool.tar "$TOOLKIT_URL" && echo "‚úÖ axel‰∏ãËΩΩÊàêÂäü" || {
          echo "‚ö†Ô∏è axel‰∏ãËΩΩÂ§±Ë¥•ÔºåÂ∞ùËØïÂÖ∂‰ªñÊñπÂºè..."
          wget --progress=bar:force:noscroll --show-progress -O SGSI-build-tool.tar "$TOOLKIT_URL" && echo "‚úÖ wget‰∏ãËΩΩÊàêÂäü" || {
            curl -# -L -o SGSI-build-tool.tar "$TOOLKIT_URL" && echo "‚úÖ curl‰∏ãËΩΩÊàêÂäü" || {
              echo "‚ùå ÊâÄÊúâ‰∏ãËΩΩÊñπÂºèÂùáÂ§±Ë¥•"
              exit 1
            }
          }
        }
        
        tar -xf SGSI-build-tool.tar
        [ ! -d "$BUILD_DIR" ] && { echo "::error::Â∑•ÂÖ∑ÁÆ±Ëß£ÂéãÂ§±Ë¥•"; exit 1; }
        echo "‚úÖ Â∑•ÂÖ∑ÁÆ±ÂáÜÂ§áÂ∞±Áª™"
        
    - name: ‰∏ãËΩΩROM
      run: |
        mkdir -p $ROM_DIR
        echo "üì• ‰∏ãËΩΩROM: $rom_url"
        echo "üíæ ‰øùÂ≠ò‰∏∫: $ROM_DIR/$rom_name"
        
        echo "üöÄ ‰ΩøÁî®axel‰∏ãËΩΩROM..."
        axel -n 8 -U "SGSI-Builder" --alternate --verbose -o "$ROM_DIR/$rom_name" "$rom_url" && echo "‚úÖ axel‰∏ãËΩΩÊàêÂäü" || {
          echo "‚ö†Ô∏è axel‰∏ãËΩΩÂ§±Ë¥•ÔºåÂ∞ùËØïÂÖ∂‰ªñÊñπÂºè..."
          wget --progress=bar:force:noscroll --show-progress -c -O "$ROM_DIR/$rom_name" "$rom_url" && echo "‚úÖ wget‰∏ãËΩΩÊàêÂäü" || {
            curl -# -L -C - -o "$ROM_DIR/$rom_name" "$rom_url" && echo "‚úÖ curl‰∏ãËΩΩÊàêÂäü" || {
              echo "‚ùå ÊâÄÊúâ‰∏ãËΩΩÊñπÂºèÂùáÂ§±Ë¥•"
              exit 1
            }
          }
        }
        
        [ ! -f "$ROM_DIR/$rom_name" ] && { echo "‚ùå ROM‰∏ãËΩΩÂ§±Ë¥•"; exit 1; }
        ROM_SIZE=$(du -sh "$ROM_DIR/$rom_name" | awk '{print $1}')
        echo "üéâ ROM‰∏ãËΩΩÂÆåÊàê"
        echo "üìÅ Êñá‰ª∂Âêç: $rom_name"
        echo "üìä Â§ßÂ∞è: $ROM_SIZE"
        echo "üìÇ Ë∑ØÂæÑ: $ROM_DIR/$rom_name"
        
    - name: Â§ÑÁêÜColorOS
      if: env.make_coloros == 'true'
      run: |
        echo "Â§ÑÁêÜColorOSËß£ÂØÜ..."
        cd $BUILD_DIR
        python3 oppo_ozip/ozipdecrypt.py "../$ROM_DIR/$rom_name" || { echo "::error::ColorOSËß£ÂØÜÂ§±Ë¥•"; exit 1; }
        DECRYPTED_FILE=$(ls *.ozip 2>/dev/null || ls *.zip)
        [ -n "$DECRYPTED_FILE" ] && {
          mv "$DECRYPTED_FILE" "../$ROM_DIR/$rom_name"
          echo "Ëß£ÂØÜÊàêÂäü: $DECRYPTED_FILE"
        } || echo "::warning::Êú™ÊâæÂà∞Ëß£ÂØÜÊñá‰ª∂Ôºå‰ΩøÁî®ÂéüÊñá‰ª∂"
        
    - name: ÂáÜÂ§áÁ≥ªÁªüÈïúÂÉè
      run: |
        cd $ROM_DIR
        echo "Ëß£ÂéãROMÊñá‰ª∂..."
        unzip -q "$rom_name"
        
        if [ -f "system.img" ]; then
          echo "ÊâæÂà∞system.img"
        elif [ -f "system.new.dat.br" ]; then
          echo "Ëß£ÂéãbrotliÊ†ºÂºè..."
          brotli -d system.new.dat.br
          rm system.new.dat.br
        elif [ -f "system.new.dat.xz" ]; then
          echo "Ëß£ÂéãxzÊ†ºÂºè..."
          xz -d system.new.dat.xz
        fi
        
        if [ -f "system.new.dat" ] && [ -f "system.transfer.list" ]; then
          echo "ËΩ¨Êç¢datÂà∞img..."
          sdat2img system.transfer.list system.new.dat system.img
          rm system.new.dat system.transfer.list
        fi
        
        [ ! -f "system.img" ] && { echo "::error::Êú™ÊâæÂà∞ÊúâÊïàÁöÑÁ≥ªÁªüÈïúÂÉè"; exit 1; }
        ORIG_SIZE=$(du -sh system.img | awk '{print $1}')
        echo "ÂéüÂßãÈïúÂÉèÂ§ßÂ∞è: $ORIG_SIZE"
        echo "ÂéãÁº©Á≥ªÁªüÈïúÂÉè..."
        img2simg system.img system_sparse.img
        resize2fs -M system.img
        rm -f system_sparse.img
        COMP_SIZE=$(du -sh system.img | awk '{print $1}')
        echo "ÂéãÁº©ÂêéÈïúÂÉèÂ§ßÂ∞è: $COMP_SIZE (ËäÇÁúÅ $((100 - COMP_SIZE * 100 / ORIG_SIZE))%)"
        find . -maxdepth 1 -type f ! -name 'system.img' -delete
        echo "‚úÖ Á≥ªÁªüÈïúÂÉèÂáÜÂ§áÂÆåÊàê"
        
    - name: ÊèêÂèñÁâàÊú¨‰ø°ÊÅØ
      run: |
        cd $ROM_DIR
        echo "ÊèêÂèñÁ≥ªÁªüÁâàÊú¨‰ø°ÊÅØ..."
        mkdir -p system_mount
        sudo mount -t ext4 -o ro,loop system.img system_mount 2>/dev/null || true
        
        BUILD_PROPS=""
        [ -f "system_mount/system/build.prop" ] && BUILD_PROPS="system_mount/system/build.prop"
        [ -f "system_mount/build.prop" ] && BUILD_PROPS="system_mount/build.prop"
        
        if [ -n "$BUILD_PROPS" ]; then
          ROM_VERSION=$(grep -m1 "ro.build.version.incremental" "$BUILD_PROPS" | cut -d'=' -f2)
          ANDROID_VERSION=$(grep -m1 "ro.build.version.release" "$BUILD_PROPS" | cut -d'=' -f2)
          SECURITY_PATCH=$(grep -m1 "ro.build.version.security_patch" "$BUILD_PROPS" | cut -d'=' -f2)
          ORIG_BUILD_DATE=$(grep -m1 "ro.build.date" "$BUILD_PROPS" | cut -d'=' -f2 | sed 's/ //g')
          
          echo "rom_version=$ROM_VERSION" >> $GITHUB_ENV
          echo "android_version=$ANDROID_VERSION" >> $GITHUB_ENV
          echo "security_patch=${SECURITY_PATCH:-Êú™Áü•}" >> $GITHUB_ENV
          echo "orig_build_date=${ORIG_BUILD_DATE:-Êú™Áü•}" >> $GITHUB_ENV
        else
          echo "::warning::Êú™ÊâæÂà∞build.propÔºå‰ΩøÁî®ÈªòËÆ§‰ø°ÊÅØ"
          echo "rom_version=Êú™Áü•" >> $GITHUB_ENV
          echo "android_version=Êú™Áü•" >> $GITHUB_ENV
          echo "security_patch=Êú™Áü•" >> $GITHUB_ENV
          echo "orig_build_date=Êú™Áü•" >> $GITHUB_ENV
        fi
        
        sudo umount system_mount 2>/dev/null || true
        rm -rf system_mount
        echo "‚úÖ ÁâàÊú¨‰ø°ÊÅØÊèêÂèñÂÆåÊàê"
        
    - name: ÈÖçÁΩÆÊûÑÂª∫ÈÄâÈ°π
      run: |
        cd $BUILD_DIR
        echo "ÈÖçÁΩÆÊûÑÂª∫ÈÄâÈ°π..."
        
        # ÁÆÄÂåñÊù°‰ª∂ËØ≠Âè•
        [ "$make_super" = 'true' ] && sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' make.sh && echo "ÂêØÁî®Super SGSI"
        
        # ÁÆÄÂåñÊï∞ÁªÑÂ§ÑÁêÜ
        FIX_NAMES=("MIUI" "Flyme" "ColorOS" "H2OS" "SmartisanOS" "ZUI")
        FIX_KEYS=("make_miui" "make_flyme" "make_coloros" "make_h2os" "make_smartisanos" "make_zui")
        
        FIX_APPLIED=false
        for i in ${!FIX_NAMES[@]}; do
          key="${FIX_KEYS[$i]}"
          brand="${FIX_NAMES[$i]}"
          [ "${!key}" = 'true' ] && {
            echo "Â∫îÁî®${brand}‰øÆÂ§ç"
            [ -f "../fix/${brand}.sh" ] && {
              cp -f "../fix/${brand}.sh" fixbug/fixbug.sh
              chmod +x fixbug/fixbug.sh
              echo "brand=$brand" >> $GITHUB_ENV
              echo "rom_version=${brand}_${rom_version}" >> $GITHUB_ENV
              FIX_APPLIED=true
              break
            } || echo "::warning::Êú™ÊâæÂà∞${brand}.sh‰øÆÂ§çËÑöÊú¨"
          }
        done
        
        $FIX_APPLIED || {
          echo "‰ΩøÁî®Âü∫Á°Ä‰øÆÂ§ç"
          echo '#!/bin/bash' > fixbug/fixbug.sh
          echo 'echo "ÊâßË°åÂü∫Á°Ä‰øÆÂ§ç..."' >> fixbug/fixbug.sh
          chmod +x fixbug/fixbug.sh
          echo "brand=ÈÄöÁî®" >> $GITHUB_ENV
        }
        
        # Â§çÂà∂ÂøÖË¶ÅÁöÑËÑöÊú¨ÂíåÂ∑•ÂÖ∑
        cp -f toolkit/makeimg.sh .
        [ -f "../fix/SGSI.sh" ] && cp -f "../fix/SGSI.sh" . || cp -f "toolkit/SGSI.sh" .
        [ -f "../fix/dynamic_SGSI.sh" ] && cp -f "../fix/dynamic_SGSI.sh" . || cp -f "toolkit/dynamic_SGSI.sh" .
        
        [ -f "../fix/mke2fs" ] && cp -f "../fix/mke2fs" bin/
        [ -f "../fix/e2fsdroid" ] && cp -f "../fix/e2fsdroid" bin/
        
        chmod +x bin/*
        echo "‚úÖ ÊûÑÂª∫ÈÖçÁΩÆÂÆåÊàê"
        
    - name: ÊâßË°åÊûÑÂª∫
      run: |
        cd $BUILD_DIR
        echo "ÂºÄÂßãÊûÑÂª∫SGSI..."
        time bash make.sh
        [ ! -d "out" ] && { echo "::error::ÊûÑÂª∫Â§±Ë¥•"; exit 1; }
        echo "‚úÖ SGSIÊûÑÂª∫ÂÆåÊàê"
        
    - name: ÊâìÂåÖÊàêÊûú
      run: |
        cd $BUILD_DIR
        echo "ÊâìÂåÖÊàêÊûúÁâ©..."
        
        # ÁÆÄÂåñÊó∂Èó¥Â§ÑÁêÜ
        current_date=$(TZ='Asia/Shanghai' date "+%Y/%m/%d %H:%M")
        echo "ÊâìÂåÖÊó•Êúü: $current_date"
        
        # ÁÆÄÂåñÁâàÊú¨‰ø°ÊÅØÊñá‰ª∂
        echo "XiaoxinSGSI ÊûÑÂª∫‰ø°ÊÅØ" > version-info.txt
        echo "ËÆæÂ§á: $rom_name" >> version-info.txt
        echo "ROMÂéÇÂïÜ: ${brand:-ÈÄöÁî®}" >> version-info.txt
        echo "ROMÁâàÊú¨: ${rom_version:-Êú™Áü•}" >> version-info.txt
        echo "AndroidÁâàÊú¨: ${android_version:-Êú™Áü•}" >> version-info.txt
        echo "ÂÆâÂÖ®Ë°•‰∏ÅÊó•Êúü: ${security_patch:-Êú™Áü•}" >> version-info.txt
        echo "ÂéüÊûÑÂª∫Êó•Êúü: ${orig_build_date:-Êú™Áü•}" >> version-info.txt
        echo "ÊâìÂåÖÊó•Êúü: $current_date" >> version-info.txt
        echo "ÊûÑÂª∫Á±ªÂûã: ${build_type:-userdebug}" >> version-info.txt

        7za a -t7z -m0=lzma2 -mx=9 "$OUTPUT_FILE" SGSI/* version-info.txt
        [ ! -f "$OUTPUT_FILE" ] && { echo "::error::SGSIÊâìÂåÖÂ§±Ë¥•"; exit 1; }
        OUTPUT_SIZE=$(du -sh "$OUTPUT_FILE" | awk '{print $1}')
        echo "SGSIÂåÖÂ§ßÂ∞è: $OUTPUT_SIZE"
        echo "‚úÖ ÊàêÊûúÊâìÂåÖÂÆåÊàê"
        
    - name: ‰∏ä‰º†Âà∞WeTransfer
      if: env.upload_transfer == 'true'
      run: |
        cd $BUILD_DIR
        echo "‰∏ä‰º†Âà∞WeTransfer..."
        curl -sL https://git.io/file-transfer | sh
        ./transfer wet "$OUTPUT_FILE" | tee transfer.log
        DOWNLOAD_URL=$(grep 'Download Link:' transfer.log | cut -d' ' -f3-)
        [ -n "$DOWNLOAD_URL" ] && {
          echo "## SGSI‰∏ãËΩΩ" >> $GITHUB_STEP_SUMMARY
          echo "**Êñá‰ª∂Âêç**: ${OUTPUT_FILE}" >> $GITHUB_STEP_SUMMARY
          echo "**Â§ßÂ∞è**: ${OUTPUT_SIZE}" >> $GITHUB_STEP_SUMMARY
          echo "**‰∏ãËΩΩÈìæÊé•**: [WeTransfer]($DOWNLOAD_URL)" >> $GITHUB_STEP_SUMMARY
        } || echo "::error::WeTransfer‰∏ä‰º†Â§±Ë¥•"
        
    - name: ‰∏ä‰º†Âà∂ÂìÅ
      if: env.upload_artifact == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: XiaoxinSGSI
        path: ${{ env.BUILD_DIR }}/${{ env.OUTPUT_FILE }}
