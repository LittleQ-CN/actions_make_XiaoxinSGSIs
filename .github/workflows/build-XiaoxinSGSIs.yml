name: build_XiaoxinSGSIs

on:
  watch:
    types: [started]

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
    - name: åˆå§‹åŒ–ç¯å¢ƒ
      run: |
        rm -rf SGSI-build-tool upload tmp_fix || true
        mkdir -p tmp_fix
        df -h
        
    - name: æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v3

    - name: è¯»å–é…ç½®æ–‡ä»¶
      id: config
      run: |
        if [ ! -f sgsi.json ]; then
          echo "::error::sgsi.json é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
          exit 1
        fi
        
        rom_url=$(jq -r '.rom_url' sgsi.json)
        rom_name=$(jq -r '.rom_name' sgsi.json)
        pack_sgsi=$(jq -r '.pack_sgsi' sgsi.json)
        upload_artifact=$(jq -r '.upload_artifact' sgsi.json)
        upload_wetransfer=$(jq -r '.upload_wetransfer' sgsi.json)
        
        [ "$upload_artifact" == "null" ] && upload_artifact=true
        [ "$upload_wetransfer" == "null" ] && upload_wetransfer=false
        
        if [ -z "$rom_url" ] || [ "$rom_url" == "null" ]; then
          echo "::error::rom_url æœªå®šä¹‰"
          exit 1
        fi
        
        rom_types=(miui flyme coloros h2os smartisanos zui)
        type_count=0
        for type in "${rom_types[@]}"; do
          value=$(jq -r ".make_$type" sgsi.json)
          if [ "$value" == "true" ]; then
            ((type_count++))
            current_type=$type
          fi
        done
        
        if [ $type_count -gt 1 ]; then
          echo "::error::åªèƒ½å¯ç”¨ä¸€ä¸ªROMç±»å‹"
          exit 1
        fi
        
        echo "rom_url=$rom_url" >> $GITHUB_ENV
        echo "rom_name=$rom_name" >> $GITHUB_ENV
        echo "pack_sgsi=$pack_sgsi" >> $GITHUB_ENV
        echo "rom_type=${current_type:-none}" >> $GITHUB_ENV
        echo "upload_artifact=$upload_artifact" >> $GITHUB_ENV
        echo "upload_wetransfer=$upload_wetransfer" >> $GITHUB_ENV
        
        if [ -n "$current_type" ]; then
          cp "fix/${current_type^}.sh" tmp_fix/fixbug.sh
        fi
    
    - name: ä¸‹è½½æ„å»ºå·¥å…·
      timeout-minutes: 5
      run: |
        tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar"
        attempts=0
        max_attempts=3
        
        while [ $attempts -lt $max_attempts ]; do
          ((attempts++))
          echo "å°è¯• #$attempts ä¸‹è½½æ„å»ºå·¥å…·..."
          
          if curl -L --fail --retry 3 -o SGSI-build-tool.tar "$tool_url"; then
            echo "ä¸‹è½½æˆåŠŸ"
            break
          elif wget -c -O SGSI-build-tool.tar "$tool_url"; then
            echo "ä¸‹è½½æˆåŠŸ"
            break
          else
            echo "ä¸‹è½½å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
            sleep 10
          fi
        done
        
        if [ ! -f SGSI-build-tool.tar ]; then
          echo "::error::å·¥å…·åŒ…ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
        if ! tar -tf SGSI-build-tool.tar >/dev/null; then
          echo "::error::å·¥å…·åŒ…æŸå"
          exit 1
        fi
        
    - name: è®¾ç½®æ„å»ºç¯å¢ƒ
      run: |
        tar -xf SGSI-build-tool.tar
        chmod -R +x SGSI-build-tool
        
        cd SGSI-build-tool/10
        ./setup.sh || echo "å¿½ç•¥éå…³é”®é”™è¯¯"
        cd ../..
        
    - name: ä¸‹è½½ROMæ–‡ä»¶
      timeout-minutes: 30
      run: |
        rom_path="SGSI-build-tool/10/tmp/${{ env.rom_name }}"
        echo "ä¸‹è½½ROM: ${{ env.rom_url }}"
        
        if command -v aria2c &>/dev/null; then
          aria2c -x8 -s8 -k1M --retry-wait=30 "${{ env.rom_url }}" -o "$rom_path"
        else
          curl -L -C - --retry 30 --retry-delay 30 "${{ env.rom_url }}" -o "$rom_path"
        fi
        
        min_size=$((100*1024*1024))
        file_size=$(stat -c%s "$rom_path" 2>/dev/null || echo 0)
        
        if [ $file_size -lt $min_size ]; then
          echo "::error::ROMæ–‡ä»¶å¼‚å¸¸ (å¤§å°: $((file_size/1024/1024))MB)"
          exit 1
        fi
        
        echo "ä¸‹è½½å®Œæˆï¼Œå¤§å°: $((file_size/1024/1024))MB"
    
    - name: å¤„ç†ROMç±»å‹
      if: ${{ env.rom_type != 'none' }}
      run: |
        cd SGSI-build-tool/10
        
        case "${{ env.rom_type }}" in
          coloros)
            python3 oppo_ozip/ozipdecrypt.py "tmp/${{ env.rom_name }}"
            decrypted_file="${rom_name%.*}.img"
            if [ -f "tmp/$decrypted_file" ]; then
              rm -f "tmp/${{ env.rom_name }}"
              echo "è§£å¯†æˆåŠŸ: $decrypted_file"
              echo "rom_name=$decrypted_file" >> $GITHUB_ENV
            else
              echo "::error::ColorOSè§£å¯†å¤±è´¥"
              exit 1
            fi
            ;;
        esac
        
        if [ -f "../../tmp_fix/fixbug.sh" ]; then
          cp -f "../../tmp_fix/fixbug.sh" fixbug/
          chmod +x fixbug/fixbug.sh
          echo "å·²åº”ç”¨ ${{ env.rom_type }} ä¿®å¤è„šæœ¬"
        fi
        
        if [ "$(jq -r '.make_super' ../sgsi.json)" == "true" ]; then
          sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' make.sh
          echo "å¯ç”¨Superåˆ†åŒºæ”¯æŒ"
        fi
    
    - name: æ„å»ºç³»ç»Ÿé•œåƒ
      timeout-minutes: 120
      run: |
        cd SGSI-build-tool/10
        
        if [ -d "../../make" ]; then
          cp -f ../../make/* ./
        fi
        
        if [ -d "../../bin" ]; then
          cp -f ../../bin/* bin/
        fi
        
        find . -name "*.sh" -exec chmod +x {} \;
        chmod +x bin/*
        
        echo "::group::æ„å»ºæ—¥å¿—"
        ./make.sh || build_failed=true
        echo "::endgroup::"
        
        if [ "$build_failed" = true ]; then
          if [ -d "out/system" ]; then
            echo "::warning::æ„å»ºå¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨åˆ›å»ºé•œåƒ"
            size_kb=$(du -sk out/system/ | cut -f1)
            img_size_kb=$((size_kb * 130 / 100))
            img_size_mb=$((img_size_kb / 1024))
            [ $img_size_mb -lt 512 ] && img_size_mb=512
            
            ./bin/make_ext4fs -T 0 -S out/config/system_file_contexts \
                              -C out/config/system_fs_config \
                              -l ${img_size_mb}M -a system out/system.img out/system/
            
            if [ -f "out/system.img" ]; then
              mkdir -p SGSI
              mv out/system.img SGSI/
            else
              echo "::error::æ— æ³•åˆ›å»ºé•œåƒ"
              exit 1
            fi
          else
            echo "::error::æ„å»ºå¤±è´¥ä¸”æ— å¯ç”¨ç³»ç»Ÿæ–‡ä»¶"
            exit 1
          fi
        fi
        
        mkdir -p ../final_out
        mv SGSI/* ../final_out/ || true
        mv out/*.img ../final_out/ || true
        
        # è®°å½•åŸå§‹å¤§å°
        if [ -f "../final_out/system.img" ]; then
          orig_size=$(du -h "../final_out/system.img" | cut -f1)
          echo "åŸå§‹å¤§å°: $orig_size" >> ../final_out/build_info.txt
        fi
    
    - name: æ‰“åŒ…è¡¥ä¸
      run: |
        if [ -d "Patch" ]; then
          cd Patch
          for dir in */; do
            if [ -d "$dir" ]; then
              dir_name="${dir%/}"
              echo "æ‰“åŒ…è¡¥ä¸: $dir_name"
              zip -r -0 "../../SGSI-build-tool/final_out/${dir_name}.zip" "$dir_name"
            fi
          done
          cd ..
        fi
    
    - name: å‹ç¼©ç³»ç»Ÿé•œåƒ
      run: |
        cd SGSI-build-tool/final_out
        
        if [ -f "system.img" ]; then
          echo "å¼€å§‹å‹ç¼©system.img..."
          original_size=$(du -h system.img | cut -f1)
          
          # å®‰è£…pigzï¼ˆå¤šçº¿ç¨‹å‹ç¼©å·¥å…·ï¼‰
          if ! command -v pigz &>/dev/null; then
            echo "å®‰è£…pigzä»¥è·å¾—æ›´å¿«å‹ç¼©é€Ÿåº¦..."
            sudo apt-get update
            sudo apt-get install -y pigz
          fi
          
          # å‹ç¼©é•œåƒ
          echo "ä½¿ç”¨pigzè¿›è¡Œå¤šçº¿ç¨‹å‹ç¼©..."
          pigz -k -f -9 system.img
          
          # è®°å½•å‹ç¼©åå¤§å°
          compressed_size=$(du -h system.img.gz | cut -f1)
          echo "å‹ç¼©åå¤§å°: $compressed_size" >> build_info.txt
          
          # è®¡ç®—å‹ç¼©ç‡
          orig_bytes=$(du -b system.img | cut -f1)
          comp_bytes=$(du -b system.img.gz | cut -f1)
          ratio=$(echo "scale=2; (1 - $comp_bytes/$orig_bytes) * 100" | bc)
          echo "å‹ç¼©ç‡: $ratio%" >> build_info.txt
          
          echo "å‹ç¼©å®Œæˆ: ${original_size} â†’ ${compressed_size} (èŠ‚çœ ${ratio}%)"
          ls -lh system.img*
        else
          echo "æœªæ‰¾åˆ°system.imgï¼Œè·³è¿‡å‹ç¼©"
        fi
    
    - name: åˆ›å»ºå‘å¸ƒåŒ…
      run: |
        cd SGSI-build-tool/final_out
        
        if [ -z "$(ls -A .)" ]; then
          echo "::error::æ— å¯ç”¨è¾“å‡ºæ–‡ä»¶"
          exit 1
        fi
        
        pack_name="${{ env.pack_sgsi }}"
        
        # æ˜¾ç¤ºå‹ç¼©ä¿¡æ¯
        if [ -f "build_info.txt" ]; then
          echo "::group::ğŸ“¦ é•œåƒå‹ç¼©ä¿¡æ¯"
          cat build_info.txt
          echo "::endgroup::"
          
          orig_size=$(grep "åŸå§‹å¤§å°" build_info.txt | cut -d: -f2 | xargs)
          comp_size=$(grep "å‹ç¼©åå¤§å°" build_info.txt | cut -d: -f2 | xargs)
          ratio=$(grep "å‹ç¼©ç‡" build_info.txt | cut -d: -f2 | xargs)
          
          if [ -n "$orig_size" ] && [ -n "$comp_size" ]; then
            echo "âœ… å‹ç¼©ç»“æœ: ${orig_size} â†’ ${comp_size} (èŠ‚çœ $ratio)"
          fi
        fi
        
        # åˆ›å»ºå‹ç¼©åŒ…
        zip -r -0 "../$pack_name" .
        
        # åˆ†å‰²å¤§æ–‡ä»¶
        cd ..
        file_size=$(stat -c%s "$pack_name")
        max_size=1400000000
        
        if [ $file_size -gt $max_size ]; then
          echo "åˆ†å‰²å¤§æ–‡ä»¶ (å¤§å°: $((file_size/1024/1024))MB)"
          split -b 1000M -d "$pack_name" "${pack_name}_part"
          rm "$pack_name"
        fi
        
        mkdir -p ../upload
        mv "${pack_name}"* ../upload/ || true
    
    - name: å‘å¸ƒGitHubç‰ˆæœ¬
      uses: softprops/action-gh-release@v1
      with:
        files: upload/*
        tag_name: build-${{ github.run_number }}
        generate_release_notes: true
        body: |
          æ„å»º #${{ github.run_number }} å·²å®Œæˆï¼
          ${{ contains(steps.create-release.outputs.body, 'å‹ç¼©ç»“æœ') && format('é•œåƒå¤§å°: {0}', steps.create-release.outputs.body.match(/å‹ç¼©ç»“æœ: (.+)/)[1]) }}
    
    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      if: ${{ env.upload_artifact == 'true' }}
      uses: actions/upload-artifact@v3
      with:
        name: SGSI-build-output
        path: upload/*
        retention-days: 7
        
    - name: ä¸Šä¼ åˆ°WeTransfer
      if: ${{ env.upload_wetransfer == 'true' }}
      uses: cschleiden/wetransfer@v1
      with:
        api-key: ${{ secrets.WETRANSFER_API_KEY }}
        sources: upload/*
        message: "SGSIæ„å»ºäº§ç‰© #${{ github.run_number }}"
        recipients: >
          ["${{ github.actor }}@users.noreply.github.com"]
    
    - name: æ˜¾ç¤ºæœ€ç»ˆæ‘˜è¦
      run: |
        echo "âœ… æ„å»ºæµç¨‹å·²å®Œæˆ"
        echo "::group::ğŸ“Š æ„å»ºæ‘˜è¦"
        echo "ROM URL: ${{ env.rom_url }}"
        echo "ROMåç§°: ${{ env.rom_name }}"
        echo "ROMç±»å‹: ${{ env.rom_type }}"
        echo "æ„å»ºç¼–å·: ${{ github.run_number }}"
        
        if [ -f "SGSI-build-tool/final_out/build_info.txt" ]; then
          echo "é•œåƒå‹ç¼©ä¿¡æ¯:"
          cat SGSI-build-tool/final_out/build_info.txt
        fi
        
        echo "::endgroup::"
        
        # åœ¨æ—¥å¿—æœ«å°¾æ˜¾ç¤ºå¤§å°å¯¹æ¯”
        if [ -f "SGSI-build-tool/final_out/build_info.txt" ]; then
          orig_size=$(grep "åŸå§‹å¤§å°" SGSI-build-tool/final_out/build_info.txt | cut -d: -f2 | xargs)
          comp_size=$(grep "å‹ç¼©åå¤§å°" SGSI-build-tool/final_out/build_info.txt | cut -d: -f2 | xargs)
          ratio=$(grep "å‹ç¼©ç‡" SGSI-build-tool/final_out/build_info.txt | cut -d: -f2 | xargs)
          
          if [ -n "$orig_size" ] && [ -n "$comp_size" ]; then
            echo "âœ¨ é•œåƒå¤§å°å¯¹æ¯”: ${orig_size} â†’ ${comp_size} (èŠ‚çœ ${ratio})"
          fi
        fi
