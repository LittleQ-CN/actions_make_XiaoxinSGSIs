name: build_XiaoxinSGSIs_old

on:
  watch:
    types: [started]
    
jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: "ğŸš€ Checkout Code (æ£€å‡ºä»£ç )"
        uses: actions/checkout@v4
       
      - name: "ğŸ§¹ Clean Up Environment (æ¸…ç†ç¯å¢ƒ)"
        run: |
          # Remove all Docker images (æ¸…é™¤æ‰€æœ‰Dockeré•œåƒ)
          docker rmi -f $(docker images -q) || true
          # Remove unnecessary files (æ¸…é™¤ä¸å¿…è¦çš„æ–‡ä»¶)
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d
          # Purge unnecessary packages (æ¸…é™¤ä¸å¿…è¦çš„è½¯ä»¶åŒ…)
          sudo -E apt-get -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php* || true
          # Update and clean apt cache (æ›´æ–°å¹¶æ¸…ç†aptç¼“å­˜)
          sudo -E apt-get update
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean 
          # Show disk space usage (æ˜¾ç¤ºç£ç›˜ç©ºé—´ä½¿ç”¨æƒ…å†µ)
          df -h
       
      - name: "âš™ï¸ Get Configuration Variables (è·å–é…ç½®å˜é‡)"
        run: |
          {
            echo "rom_url=$(jq -r '.rom_url' sgsi.json)"
            echo "rom_name=$(jq -r '.rom_name' sgsi.json)"
            echo "pack_sgsi=$(jq -r '.pack_sgsi' sgsi.json)"
            echo "make_miui=$(jq -r '.make_miui' sgsi.json)"
            echo "make_flyme=$(jq -r '.make_flyme' sgsi.json)"
            echo "make_coloros=$(jq -r '.make_coloros' sgsi.json)"
            echo "make_h2os=$(jq -r '.make_h2os' sgsi.json)"
            echo "make_smartisanos=$(jq -r '.make_smartisanos' sgsi.json)"
            echo "make_zui=$(jq -r '.make_zui' sgsi.json)"
            echo "make_super=$(jq -r '.make_super' sgsi.json)"
          } >> $GITHUB_OUTPUT
        id: var
           
      - name: "ğŸ“¦ Install Download Tools (å®‰è£…ä¸‹è½½å·¥å…·)"
        run: |
          # Install Axel, curl and wget (å®‰è£…Axelã€curlå’Œwget)
          sudo apt-get update
          sudo apt-get install -y axel curl wget
          echo "âœ… Tool installation completed (å·¥å…·å®‰è£…å®Œæˆ)"
           
      - name: "â¬‡ï¸ Download Build Tools (ä¸‹è½½æ„å»ºå·¥å…·)"
        run: |
          tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar"
          echo "ğŸ”§ Downloading build tools: $tool_url (æ­£åœ¨ä¸‹è½½æ„å»ºå·¥å…·)"
          
          max_retries=3
          for i in $(seq 1 $max_retries); do
            # ä¼˜å…ˆä½¿ç”¨curlä¸‹è½½ï¼ˆåªè¦curlå¯ç”¨ï¼‰
            if command -v curl &> /dev/null; then
              echo "âš¡ Using curl (ä½¿ç”¨curlä¸‹è½½)"
              if curl -# -fL -o SGSI-build-tool.tar "$tool_url"; then
                echo "âœ… Download successful (ä¸‹è½½æˆåŠŸ)"
                break
              else
                echo "âŒ curl failed, trying axel (curlå¤±è´¥ï¼Œå°è¯•axel)"
              fi
            fi
            
            # å…¶æ¬¡ä½¿ç”¨Axelä¸‹è½½
            if command -v axel &> /dev/null; then
              echo "âš¡ Using Axel (ä½¿ç”¨Axelä¸‹è½½)"
              if axel -n 8 -a -o SGSI-build-tool.tar "$tool_url"; then
                echo "âœ… Download successful (ä¸‹è½½æˆåŠŸ)"
                break
              else
                echo "âŒ Axel failed, trying wget (Axelå¤±è´¥ï¼Œå°è¯•wget)"
              fi
            fi
            
            # æœ€åä½¿ç”¨wgetä¸‹è½½
            if command -v wget &> /dev/null; then
              echo "âš¡ Using wget (ä½¿ç”¨wgetä¸‹è½½)"
              if wget -q --show-progress -O SGSI-build-tool.tar "$tool_url"; then
                echo "âœ… Download successful (ä¸‹è½½æˆåŠŸ)"
                break
              else
                echo "âŒ wget failed (wgetå¤±è´¥)"
              fi
            fi
            
            # æ‰€æœ‰ä¸‹è½½å™¨éƒ½å¤±è´¥
            if [ $i -lt $max_retries ]; then
              echo "ğŸ”„ All download methods failed, retrying ($i/$max_retries)... (æ‰€æœ‰ä¸‹è½½æ–¹å¼å¤±è´¥ï¼Œé‡è¯•ä¸­)"
              sleep 10
            else
              echo "::error::âŒ Failed to download build tools after $max_retries attempts (æ„å»ºå·¥å…·ä¸‹è½½å¤±è´¥)"
              exit 1
            fi
          done
          
      - name: "ğŸ—ï¸ Initialize Environment (åˆå§‹åŒ–ç¯å¢ƒ)"
        run: |
          # Extract and setup build tools (è§£å‹å¹¶è®¾ç½®æ„å»ºå·¥å…·)
          sudo tar -xf SGSI-build-tool.tar
          sudo rm -rf SGSI-build-tool/10/setup.sh
          sudo mv bin/setup.sh SGSI-build-tool/10/
          cd SGSI-build-tool/10
          sudo bash setup.sh
          echo "âœ… Environment setup completed (ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ)"
           
      - name: "ğŸ’¾ Download ROM File (ä¸‹è½½ROMæ–‡ä»¶)"
        run: |
          # è®¾ç½®ä¸‹è½½è·¯å¾„
          rom_path="SGSI-build-tool/10/tmp/${{ steps.var.outputs.rom_name }}"
          rom_url="${{ steps.var.outputs.rom_url }}"
          
          echo "ğŸš€ Starting download of ${{ steps.var.outputs.rom_name }} (å¼€å§‹ä¸‹è½½ROMæ–‡ä»¶)"
          max_retries=5
          
          for i in $(seq 1 $max_retries); do
            # ä¼˜å…ˆä½¿ç”¨Axelä¸‹è½½ï¼ˆROMä¸‹è½½ä¿æŒAxelä¼˜å…ˆï¼‰
            if command -v axel &> /dev/null; then
              echo "âš¡ Using Axel with 10 threads (ä½¿ç”¨10çº¿ç¨‹Axelä¸‹è½½)"
              if axel -n 10 -a -o "$rom_path" "$rom_url"; then
                echo "âœ… Download successful (ä¸‹è½½æˆåŠŸ)"
                break
              else
                echo "âŒ Axel failed, trying curl (Axelå¤±è´¥ï¼Œå°è¯•curl)"
              fi
            fi
            
            # å…¶æ¬¡ä½¿ç”¨curlä¸‹è½½
            if command -v curl &> /dev/null; then
              echo "âš¡ Using curl (ä½¿ç”¨curlä¸‹è½½)"
              if curl -# -L -o "$rom_path" "$rom_url"; then
                echo "âœ… Download successful (ä¸‹è½½æˆåŠŸ)"
                break
              else
                echo "âŒ curl failed, trying wget (curlå¤±è´¥ï¼Œå°è¯•wget)"
              fi
            fi
            
            # æœ€åä½¿ç”¨wgetä¸‹è½½
            if command -v wget &> /dev/null; then
              echo "âš¡ Using wget (ä½¿ç”¨wgetä¸‹è½½)"
              if wget -q --show-progress -O "$rom_path" "$rom_url"; then
                echo "âœ… Download successful (ä¸‹è½½æˆåŠŸ)"
                break
              else
                echo "âŒ wget failed (wgetå¤±è´¥)"
              fi
            fi
            
            # æ‰€æœ‰ä¸‹è½½å™¨éƒ½å¤±è´¥
            if [ $i -lt $max_retries ]; then
              echo "ğŸ”„ All download methods failed, retrying ($i/$max_retries)... (æ‰€æœ‰ä¸‹è½½æ–¹å¼å¤±è´¥ï¼Œé‡è¯•ä¸­)"
              sleep 10
            else
              echo "::error::âŒ Failed to download ROM after $max_retries attempts (ROMä¸‹è½½å¤±è´¥)"
              exit 1
            fi
          done
          
          # ä¸‹è½½å®Œæˆåæ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          echo -e "\nğŸ‰ Download completed (ä¸‹è½½å®Œæˆ)"
          echo "ğŸ“¦ File size: $(du -h "$rom_path" | cut -f1) (æ–‡ä»¶å¤§å°)"
       
      - name: "âš™ï¸ Configure for Super SGSI (é…ç½®Super SGSI)"
        if: steps.var.outputs.make_super == 'true'
        run: |
          # Modify script for super SGSI (ä¿®æ”¹è„šæœ¬ä»¥æ”¯æŒsuper SGSI)
          sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' SGSI-build-tool/10/make.sh
          echo "âœ… Super SGSI configured (Super SGSIé…ç½®å®Œæˆ)"
       
      - name: "âš™ï¸ Configure for MIUI SGSI (é…ç½®MIUI SGSI)"
        if: steps.var.outputs.make_miui == 'true'
        run: |
          # Setup MIUI fix script (è®¾ç½®MIUIä¿®å¤è„šæœ¬)
          sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
          mv fix/MIUI.sh SGSI-build-tool/10/fixbug/fixbug.sh
          echo "âœ… MIUI configuration completed (MIUIé…ç½®å®Œæˆ)"
           
      - name: "âš™ï¸ Configure for Flyme SGSI (é…ç½®Flyme SGSI)"
        if: steps.var.outputs.make_flyme == 'true'
        run: |
          # Setup Flyme fix script (è®¾ç½®Flymeä¿®å¤è„šæœ¬)
          sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
          mv fix/Flyme.sh SGSI-build-tool/10/fixbug/fixbug.sh
          echo "âœ… Flyme configuration completed (Flymeé…ç½®å®Œæˆ)"
           
      - name: "ğŸ”“ Process ColorOS ROM (å¤„ç†ColorOS ROM)"
        if: steps.var.outputs.make_coloros == 'true'
        run: |
          # Decrypt ColorOS OZIP package (è§£å¯†ColorOS OZIPåŒ…)
          sudo python3 SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py SGSI-build-tool/10/tmp/${{ steps.var.outputs.rom_name }}
          sudo rm -rf SGSI-build-tool/10/tmp/${{ steps.var.outputs.rom_name }} SGSI-build-tool/10/fixbug/fixbug.sh
          # Setup ColorOS fix script (è®¾ç½®ColorOSä¿®å¤è„šæœ¬)
          mv fix/ColorOS.sh SGSI-build-tool/10/fixbug/fixbug.sh
          echo "âœ… ColorOS ROM processed (ColorOS ROMå¤„ç†å®Œæˆ)"
           
      - name: "âš™ï¸ Configure for H2OS SGSI (é…ç½®H2OS SGSI)"
        if: steps.var.outputs.make_h2os == 'true'
        run: |
          # Setup H2OS fix script (è®¾ç½®H2OSä¿®å¤è„šæœ¬)
          sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
          mv fix/H2OS.sh SGSI-build-tool/10/fixbug/fixbug.sh
          echo "âœ… H2OS configuration completed (H2OSé…ç½®å®Œæˆ)"
           
      - name: "âš™ï¸ Configure for SmartisanOS SGSI (é…ç½®SmartisanOS SGSI)"
        if: steps.var.outputs.make_smartisanos == 'true'
        run: |
          # Setup SmartisanOS fix script (è®¾ç½®SmartisanOSä¿®å¤è„šæœ¬)
          sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
          mv fix/SmartisanOS.sh SGSI-build-tool/10/fixbug/fixbug.sh
          echo "âœ… SmartisanOS configuration completed (SmartisanOSé…ç½®å®Œæˆ)"
           
      - name: "âš™ï¸ Configure for ZUI SGSI (é…ç½®ZUI SGSI)"
        if: steps.var.outputs.make_zui == 'true'
        run: |
          # Setup ZUI fix script (è®¾ç½®ZUIä¿®å¤è„šæœ¬)
          sudo rm -rf SGSI-build-tool/10/fixbug/fixbug.sh
          mv fix/ZUI.sh SGSI-build-tool/10/fixbug/fixbug.sh
          echo "âœ… ZUI configuration completed (ZUIé…ç½®å®Œæˆ)"
            
      - name: "ğŸ› ï¸ Build SGSI Images (æ„å»ºSGSIé•œåƒ)"
        run: |
          # Prepare scripts and binaries (å‡†å¤‡è„šæœ¬å’ŒäºŒè¿›åˆ¶æ–‡ä»¶)
          rm -rf SGSI-build-tool/10/SGSI.sh SGSI-build-tool/10/makeimg.sh SGSI-build-tool/10/bin/mke2fs SGSI-build-tool/10/bin/e2fsdroid SGSI-build-tool/10/dynamic_SGSI.sh SGSI-build-tool/10/oppo.sh SGSI-build-tool/10/make.sh
          mv make/makeimg.sh make/SGSI.sh make/dynamic_SGSI.sh make/oppo.sh make/make.sh SGSI-build-tool/10/
          mv bin/mke2fs bin/e2fsdroid SGSI-build-tool/10/bin/
          # Run build script (è¿è¡Œæ„å»ºè„šæœ¬)
          cd SGSI-build-tool/10
          sudo bash make.sh
          echo "ğŸ‰ SGSI images built successfully (SGSIé•œåƒæ„å»ºå®Œæˆ)"
           
      - name: "ğŸ“¦ Package Patches (æ‰“åŒ…è¡¥ä¸æ–‡ä»¶)"
        run: |
          # Create patch archives (åˆ›å»ºè¡¥ä¸å½’æ¡£æ–‡ä»¶)
          zip -r Patch1.zip Patch/Patch1/*
          zip -r Patch2.zip Patch/Patch2/*
          zip -r Patch3.zip Patch/Patch3/*
          sudo mv Patch1.zip Patch2.zip Patch3.zip SGSI-build-tool/10/SGSI/
          echo "âœ… Patches packaged (è¡¥ä¸æ–‡ä»¶æ‰“åŒ…å®Œæˆ)"

      - name: "ğŸ“¦ Package SGSI Output (æ‰“åŒ…SGSIè¾“å‡º)"
        run: |
          # Prepare upload directory (å‡†å¤‡ä¸Šä¼ ç›®å½•)
          mkdir -p upload
          # Create SGSI archive (åˆ›å»ºSGSIå½’æ¡£æ–‡ä»¶)
          zip -r ${{ steps.var.outputs.pack_sgsi }} SGSI-build-tool/10/SGSI/*
          # Check file size and split if too large (æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼Œè¿‡å¤§åˆ™åˆ†å‰²)
          file_size=$(du -sb ${{ steps.var.outputs.pack_sgsi }} | awk '{print $1}')
          max_size=2097152000  # 2GB in bytes
          
          if [ $file_size -gt $max_size ]; then
            echo "âš ï¸ File too large ($(numfmt --to=iec $file_size)), splitting for packaging... (æ–‡ä»¶è¿‡å¤§ï¼Œè¿›è¡Œåˆ†å‰²æ‰“åŒ…)"
            split -b 1024m -d ${{ steps.var.outputs.pack_sgsi }} upload/${{ steps.var.outputs.pack_sgsi }}_
            rm ${{ steps.var.outputs.pack_sgsi }}
            echo "âœ… Split completed: 1GB chunks (åˆ†å‰²å®Œæˆï¼š1GBåˆ†å—)"
          else
            echo "ğŸ“¦ Moving file to upload directory (ç§»åŠ¨æ–‡ä»¶åˆ°ä¸Šä¼ ç›®å½•)"
            mv ${{ steps.var.outputs.pack_sgsi }} upload/
          fi
          
          # List upload directory (åˆ—å‡ºä¸Šä¼ ç›®å½•å†…å®¹)
          echo "ğŸ“ Upload directory contents: (ä¸Šä¼ ç›®å½•å†…å®¹)"
          ls -lh "upload"
             
      - name: "ğŸš€ Upload Build Artifacts (ä¸Šä¼ æ„å»ºäº§ç‰©)"
        uses: ncipollo/release-action@v1.11.0
        with:
          artifacts: upload/*
          name: xiaoxinSGSI-ab-Android10-unpack
          tag: xiaoxinSGSI-ab-Android10-${{ github.run_number }}
          token: ${{ secrets.GITHUB_TOKEN }}
