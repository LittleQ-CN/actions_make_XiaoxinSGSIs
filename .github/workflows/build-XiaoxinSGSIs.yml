name: build_XiaoxinSGSIs

on:
  watch:
    types: [started]

env:
  BUILD_DIR: SGSI-build-tool/10
  ROM_DIR: tmp
  TOOLKIT_URL: https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar
  MAX_LOG_LINES: 1000

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: 检出仓库
      uses: actions/checkout@v4
      
    - name: 清理工作区
      run: |
        echo "🔄 清理工作区..."
        rm -rf SGSI-build-tool upload || true
        df -h
        
    - name: 安装必要工具
      run: |
        echo "🛠️ 安装构建工具..."
        sudo apt-get update
        sudo apt-get install -y axel brotli xz-utils \
          simg2img img2simg p7zip-full jq tree e2fsprogs cpio coreutils
        
    - name: 加载配置
      run: |
        echo "📝 加载配置文件..."
        [ ! -f "sgsi.json" ] && echo "::error::sgsi.json文件缺失" && exit 1
        
        # 读取所有配置选项
        ROM_URL=$(jq -r '.rom_url' sgsi.json)
        ROM_NAME=$(jq -r '.rom_name' sgsi.json)
        PACK_SGSI=$(jq -r '.pack_sgsi' sgsi.json)
        MAKE_MIUI=$(jq -r '.make_miui' sgsi.json)
        MAKE_FLYME=$(jq -r '.make_flyme' sgsi.json)
        MAKE_COLOROS=$(jq -r '.make_coloros' sgsi.json)
        MAKE_H2OS=$(jq -r '.make_h2os' sgsi.json)
        MAKE_SMARTISANOS=$(jq -r '.make_smartisanos' sgsi.json)
        MAKE_ZUI=$(jq -r '.make_zui' sgsi.json)
        MAKE_SUPER=$(jq -r '.make_super' sgsi.json)
        UPLOAD_ARTIFACT=$(jq -r '.upload_artifact' sgsi.json)
        UPLOAD_WETRANSFER=$(jq -r '.upload_wetransfer' sgsi.json)
        
        # 设置环境变量
        echo "ROM_URL=$ROM_URL" >> $GITHUB_ENV
        echo "ROM_NAME=$ROM_NAME" >> $GITHUB_ENV
        echo "PACK_SGSI=$PACK_SGSI" >> $GITHUB_ENV
        echo "MAKE_MIUI=$MAKE_MIUI" >> $GITHUB_ENV
        echo "MAKE_FLYME=$MAKE_FLYME" >> $GITHUB_ENV
        echo "MAKE_COLOROS=$MAKE_COLOROS" >> $GITHUB_ENV
        echo "MAKE_H2OS=$MAKE_H2OS" >> $GITHUB_ENV
        echo "MAKE_SMARTISANOS=$MAKE_SMARTISANOS" >> $GITHUB_ENV
        echo "MAKE_ZUI=$MAKE_ZUI" >> $GITHUB_ENV
        echo "MAKE_SUPER=$MAKE_SUPER" >> $GITHUB_ENV
        echo "UPLOAD_ARTIFACT=$UPLOAD_ARTIFACT" >> $GITHUB_ENV
        echo "UPLOAD_WETRANSFER=$UPLOAD_WETRANSFER" >> $GITHUB_ENV
        
        # 设置输出文件名
        if [ "$PACK_SGSI" != "null" ]; then
          OUTPUT_FILE="${PACK_SGSI}"
        else
          OUTPUT_FILE="XiaoxinSGSI-${ROM_NAME}-$(date +%m%d).7z"
        fi
        echo "OUTPUT_FILE=$OUTPUT_FILE" >> $GITHUB_ENV

    # 更新后的下载构建工具步骤 ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
    - name: 下载构建工具
      run: |
        echo "📦 下载构建工具..."
        echo "工具包URL: $TOOLKIT_URL"
        
        # 创建构建目录
        mkdir -p $BUILD_DIR
        
        # 检查并选择下载工具
        if command -v curl &> /dev/null; then
          echo "使用curl下载工具包..."
          curl -sSL -o SGSI-build-tool.tar "$TOOLKIT_URL"
        elif command -v wget &> /dev/null; then
          echo "使用wget下载工具包..."
          wget -q -c "$TOOLKIT_URL" -O SGSI-build-tool.tar
        else
          echo "::error::未找到curl或wget，无法下载工具包"
          exit 1
        fi
        
        # 验证下载是否成功
        if [ ! -f SGSI-build-tool.tar ]; then
          echo "::error::工具包下载失败"
          exit 1
        fi
        
        # 解压工具包
        echo "解压工具包到 $BUILD_DIR..."
        tar -xf SGSI-build-tool.tar -C $BUILD_DIR/
        
        # 检查解压内容
        echo "工具包包含的文件:"
        find $BUILD_DIR -type f | sort
        
        # 验证关键文件
        if [ ! -f "$BUILD_DIR/make.sh" ]; then
          echo "::error::make.sh文件缺失！目录内容:"
          tree $BUILD_DIR || ls -R $BUILD_DIR
          exit 1
        fi
        
        # 授予执行权限
        chmod +x $BUILD_DIR/*.sh
        echo "✅ 工具包准备完成"
    # 更新后的下载构建工具步骤 ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

    - name: 下载ROM
      run: |
        echo "⬇️ 下载ROM文件..."
        echo "ROM URL: $ROM_URL"
        echo "目标文件名: $ROM_NAME"
        mkdir -p $ROM_DIR
        cd $ROM_DIR
        
        # 使用相同方法下载ROM
        if command -v curl &> /dev/null; then
          curl -sSL -O "$ROM_URL"
        elif command -v wget &> /dev/null; then
          wget -q -c "$ROM_URL"
        else
          echo "::error::未找到下载工具，无法下载ROM"
          exit 1
        fi
        
        # 检查下载是否成功
        if [ ! -f "$ROM_NAME" ]; then
          echo "::error::ROM下载失败！"
          exit 1
        fi
        echo "✅ ROM下载完成 | 大小: $(du -h $ROM_NAME | cut -f1)"

    - name: 准备构建环境
      run: |
        echo "📂 准备构建环境..."
        mkdir -p $BUILD_DIR/tmp
        echo "复制ROM文件到构建目录..."
        cp $ROM_DIR/"$ROM_NAME" $BUILD_DIR/tmp/
        echo "构建目录内容:"
        ls -la $BUILD_DIR/

    - name: 配置构建选项
      run: |
        echo "⚙️ 配置构建选项..."
        cd $BUILD_DIR
        
        # 确保make.sh存在
        if [ ! -f "make.sh" ]; then
          echo "::error::make.sh文件不存在，无法配置构建选项"
          ls -la
          exit 1
        fi
        
        # 跳过权限更改
        sed -i 's/chown -R root:root/# chown -R root:root/g' make.sh
        sed -i 's/chmod -R 777/# chmod -R 777/g' make.sh
        
        # 禁用交互
        sed -i 's/read pause/# read pause/g' make.sh
        
        # 配置构建模式
        echo "激活的构建模式:"
        if [ "$MAKE_SUPER" = 'true' ]; then
          sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' make.sh
          echo "🔄 super分区模式"
        fi
        
        if [ "$MAKE_MIUI" = 'true' ]; then
          sed -i 's/SGSI.sh/make_miui.sh/g' make.sh
          echo "🔄 MIUI模式"
        fi
        
        if [ "$MAKE_FLYME" = 'true' ]; then
          sed -i 's/SGSI.sh/make_flyme.sh/g' make.sh
          echo "🔄 Flyme模式"
        fi
        
        if [ "$MAKE_COLOROS" = 'true' ]; then
          sed -i 's/SGSI.sh/make_coloros.sh/g' make.sh
          echo "🔄 ColorOS模式"
        fi
        
        if [ "$MAKE_H2OS" = 'true' ]; then
          sed -i 's/SGSI.sh/make_h2os.sh/g' make.sh
          echo "🔄 H2OS模式"
        fi
        
        if [ "$MAKE_SMARTISANOS" = 'true' ]; then
          sed -i 's/SGSI.sh/make_smartisan.sh/g' make.sh
          echo "🔄 SmartisanOS模式"
        fi
        
        if [ "$MAKE_ZUI" = 'true' ]; then
          sed -i 's/SGSI.sh/make_zui.sh/g' make.sh
          echo "🔄 ZUI模式"
        fi

    - name: 执行构建
      run: |
        echo "🏗️ 开始构建SGSI..."
        cd $BUILD_DIR
        echo "当前目录: $(pwd)"
        echo "目录内容:"
        ls -la
        
        # 带进度监控的构建
        bash make.sh 2>&1 | tee build.log
        
        # 检查构建结果
        if [ ! -d "out" ] && [ ! -d "SGSI" ]; then
          echo "::error::构建失败，未找到输出目录"
          echo "=== 构建日志最后100行 ==="
          tail -n 100 build.log
          exit 1
        fi

    - name: 打包成果
      run: |
        echo "📦 打包成果物..."
        cd $BUILD_DIR
        
        # 检查输出内容
        echo "SGSI目录内容:"
        ls -la SGSI/ || echo "无SGSI目录"
        echo "out目录内容:"
        ls -la out/ || echo "无out目录"
        
        7za a -t7z -mx=9 "$OUTPUT_FILE" SGSI/* out/* > package.log 2>&1
        
        if [ -f "$OUTPUT_FILE" ]; then
          FILE_SIZE=$(stat -c %s "$OUTPUT_FILE")
          echo "✅ 打包完成 | 大小: $(numfmt --to=iec-i --suffix=B $FILE_SIZE)"
        else
          echo "::error::打包失败"
          tail -n 20 package.log
          exit 1
        fi

    - name: 上传制品
      if: env.UPLOAD_ARTIFACT == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.OUTPUT_FILE }}
        path: ${{ env.BUILD_DIR }}/${{ env.OUTPUT_FILE }}

    - name: 上传日志
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ${{ env.BUILD_DIR }}/build.log
          ${{ env.BUILD_DIR }}/package.log

    - name: 上传WeTransfer
      if: env.UPLOAD_WETRANSFER == 'true'
      run: |
        echo "☁️ 上传到WeTransfer..."
        cd $BUILD_DIR
        
        if [ ! -f "$OUTPUT_FILE" ]; then
          echo "::error::要上传的文件不存在: $OUTPUT_FILE"
          exit 1
        fi
        
        curl -sL https://git.io/file-transfer | sh
        echo "开始上传文件 (大小: $(du -h $OUTPUT_FILE | cut -f1))..."
        
        # 上传并获取结果
        TRANSFER_OUTPUT=$(./transfer wet "$OUTPUT_FILE")
        echo "$TRANSFER_OUTPUT"
        
        # 提取下载链接
        DOWNLOAD_LINK=$(echo "$TRANSFER_OUTPUT" | grep -o 'https://we.tl/[^ ]*')
        if [ -n "$DOWNLOAD_LINK" ]; then
          echo "## WeTransfer 下载地址" >> $GITHUB_STEP_SUMMARY
          echo "[$OUTPUT_FILE]($DOWNLOAD_LINK)" >> $GITHUB_STEP_SUMMARY
        else
          echo "::warning::未找到下载链接"
        fi
        
    - name: 清理工作区
      run: |
        echo "🧹 最终清理..."
        rm -rf $ROM_DIR $BUILD_DIR
        df -h
        echo "✅ 构建流程完成"
