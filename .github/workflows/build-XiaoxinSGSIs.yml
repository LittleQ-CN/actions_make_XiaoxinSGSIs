name: Build_XiaoxinSGSIs_For_A10_AB_old

on:
  watch:
    types: [started]

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
    - name: "ğŸ“¥ æ£€å‡ºä»£ç åº“"
      uses: actions/checkout@v3
      
    - name: "ğŸ§¹ æ¸…ç†å·¥ä½œåŒº"
      run: |
        rm -rf SGSI-build-tool upload || true
        df -h
        
    - name: "ğŸ“ è¯»å–é…ç½®æ–‡ä»¶"
      id: var
      run: |
        rom_url=$(jq -r '.rom_url' sgsi.json)
        rom_name=$(jq -r '.rom_name' sgsi.json)
        pack_sgsi=$(jq -r '.pack_sgsi' sgsi.json)
        make_miui=$(jq -r '.make_miui' sgsi.json)
        make_flyme=$(jq -r '.make_flyme' sgsi.json)
        make_coloros=$(jq -r '.make_coloros' sgsi.json)
        make_h2os=$(jq -r '.make_h2os' sgsi.json)
        make_smartisanos=$(jq -r '.make_smartisanos' sgsi.json)
        make_zui=$(jq -r '.make_zui' sgsi.json)
        make_super=$(jq -r '.make_super' sgsi.json)
        
        echo "rom_url=$rom_url" >> $GITHUB_ENV
        echo "rom_name=$rom_name" >> $GITHUB_ENV
        echo "pack_sgsi=$pack_sgsi" >> $GITHUB_ENV
        echo "make_miui=$make_miui" >> $GITHUB_ENV
        echo "make_flyme=$make_flyme" >> $GITHUB_ENV
        echo "make_coloros=$make_coloros" >> $GITHUB_ENV
        echo "make_h2os=$make_h2os" >> $GITHUB_ENV
        echo "make_smartisanos=$make_smartisanos" >> $GITHUB_ENV
        echo "make_zui=$make_zui" >> $GITHUB_ENV
        echo "make_super=$make_super" >> $GITHUB_ENV
        
    - name: "â¬‡ï¸ ä¸‹è½½æ„å»ºå·¥å…·"
      run: |
        if command -v curl &> /dev/null; then
          curl -sSL -o SGSI-build-tool.tar https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar
        else
          wget -q -c https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar
        fi
        
        if [ ! -f SGSI-build-tool.tar ]; then
          echo "::error::âŒ å·¥å…·åŒ…ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
    - name: "âš™ï¸ è®¾ç½®æ„å»ºç¯å¢ƒ"
      run: |
        tar -xf SGSI-build-tool.tar --no-same-owner --no-overwrite-dir
        
        if [ ! -d "SGSI-build-tool" ]; then
          echo "::error::âŒ æœªæ‰¾åˆ°SGSI-build-toolç›®å½•"
          ls -la
          exit 1
        fi
        
        find SGSI-build-tool -type f -name "*.sh" -exec chmod +x {} \;
        chmod +x SGSI-build-tool/10/bin/*
        
        cd SGSI-build-tool/10
        ./setup.sh || true
        cd ../..
    
    - name: "ğŸ“¥ ä¸‹è½½ROMæ–‡ä»¶"
      run: |
        mkdir -p SGSI-build-tool/10/tmp
        rom_path="SGSI-build-tool/10/tmp/${{ env.rom_name }}"
        
        if command -v curl &> /dev/null; then
          curl -L -k -sS -C - "${{ env.rom_url }}" -o "$rom_path" || true
        fi
        
        if [ ! -f "$rom_path" ] && command -v wget &> /dev/null; then
          wget -q -c "${{ env.rom_url }}" -O "$rom_path" || true
        fi
        
        if [ ! -f "$rom_path" ]; then
          echo "::error::âŒ ROMæ–‡ä»¶ä¸‹è½½å¤±è´¥"
          exit 1
        else
          echo "âœ… ROMæ–‡ä»¶ä¸‹è½½æˆåŠŸ! æ–‡ä»¶å¤§å°: $(du -sh "$rom_path" | cut -f1)"
        fi
    
    - name: "âœ¨ å¯ç”¨Superåˆ†åŒºæ”¯æŒ"
      if: ${{ env.make_super == 'true' }}
      run: |
        echo "ğŸ”“ å¯ç”¨Superåˆ†åŒºæ”¯æŒ"
        sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' SGSI-build-tool/10/make.sh
    
    - name: "ğŸ­ ç”Ÿæˆå‚å•†ç³»ç»Ÿé•œåƒ"
      run: |
        if [ "${{ env.make_miui }}" = "true" ]; then
          echo "âš™ï¸ é…ç½®MIUIæ„å»º"
          rm -f SGSI-build-tool/10/fixbug/fixbug.sh
          mv fix/MIUI.sh SGSI-build-tool/10/fixbug/fixbug.sh
          chmod +x SGSI-build-tool/10/fixbug/fixbug.sh
          echo "âœ… å°ç±³MIUIé…ç½®æ–‡ä»¶å·²åº”ç”¨"
        fi
        
        if [ "${{ env.make_flyme }}" = "true" ]; then
          echo "âš™ï¸ é…ç½®Flymeæ„å»º"
          rm -f SGSI-build-tool/10/fixbug/fixbug.sh
          mv fix/Flyme.sh SGSI-build-tool/10/fixbug/fixbug.sh
          chmod +x SGSI-build-tool/10/fixbug/fixbug.sh
          echo "âœ… é­…æ—Flymeé…ç½®æ–‡ä»¶å·²åº”ç”¨"
        fi
        
        if [ "${{ env.make_coloros }}" = "true" ]; then
          echo "âš™ï¸ é…ç½®ColorOSæ„å»º"
          python3 SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py SGSI-build-tool/10/tmp/${{ env.rom_name }}
          rm -f SGSI-build-tool/10/tmp/${{ env.rom_name }} SGSI-build-tool/10/fixbug/fixbug.sh
          mv fix/ColorOS.sh SGSI-build-tool/10/fixbug/fixbug.sh
          chmod +x SGSI-build-tool/10/fixbug/fixbug.sh
          echo "âœ… OPPO/realme ColorOSé…ç½®æ–‡ä»¶å·²åº”ç”¨"
        fi
        
        if [ "${{ env.make_h2os }}" = "true" ]; then
          echo "âš™ï¸ é…ç½®HydrogenOSæ„å»º"
          rm -f SGSI-build-tool/10/fixbug/fixbug.sh
          mv fix/H2OS.sh SGSI-build-tool/10/fixbug/fixbug.sh
          chmod +x SGSI-build-tool/10/fixbug/fixbug.sh
          echo "âœ… ä¸€åŠ HydrogenOSé…ç½®æ–‡ä»¶å·²åº”ç”¨"
        fi
        
        if [ "${{ env.make_smartisanos }}" = "true" ]; then
          echo "âš™ï¸ é…ç½®SmartisanOSæ„å»º"
          rm -f SGSI-build-tool/10/fixbug/fixbug.sh
          mv fix/SmartisanOS.sh SGSI-build-tool/10/fixbug/fixbug.sh
          chmod +x SGSI-build-tool/10/fixbug/fixbug.sh
          echo "âœ… é”¤å­SmartisanOSé…ç½®æ–‡ä»¶å·²åº”ç”¨"
        fi
        
        if [ "${{ env.make_zui }}" = "true" ]; then
          echo "âš™ï¸ é…ç½®ZUIæ„å»º"
          rm -f SGSI-build-tool/10/fixbug/fixbug.sh
          mv fix/ZUI.sh SGSI-build-tool/10/fixbug/fixbug.sh
          chmod +x SGSI-build-tool/10/fixbug/fixbug.sh
          echo "âœ… è”æƒ³ZUIé…ç½®æ–‡ä»¶å·²åº”ç”¨"
        fi
        
        if [ "${{ env.make_miui }}" != "true" ] && \
           [ "${{ env.make_flyme }}" != "true" ] && \
           [ "${{ env.make_coloros }}" != "true" ] && \
           [ "${{ env.make_h2os }}" != "true" ] && \
           [ "${{ env.make_smartisanos }}" != "true" ] && \
           [ "${{ env.make_zui }}" != "true" ]; then
          echo "âš ï¸ è­¦å‘Š: æœªé…ç½®ä»»ä½•å‚å•†ç³»ç»Ÿé•œåƒç”Ÿæˆ"
        fi
         
    - name: "ğŸ”¨ æ„å»ºSGSIç³»ç»Ÿé•œåƒ"
      timeout-minutes: 120
      run: |
        rm -f SGSI-build-tool/10/{SGSI.sh,makeimg.sh,dynamic_SGSI.sh,oppo.sh}
        mv make/* SGSI-build-tool/10/
        mv bin/* SGSI-build-tool/10/bin/
        
        find SGSI-build-tool/10 -name "*.sh" -exec chmod +x {} \;
        chmod +x SGSI-build-tool/10/bin/*
        
        cd SGSI-build-tool/10
        mkdir -p out/{system,config}
        mkdir -p out/system/{bin,etc,lib,usr,framework,app,priv-app,vendor}
        
        echo -e "# é»˜è®¤æ–‡ä»¶ä¸Šä¸‹æ–‡\n/system(/.*)? u:object_r:system_file:s0\n/vendor(/.*)? u:object_r:vendor_file:s0" > out/config/system_file_contexts
        echo -e "# é»˜è®¤æ–‡ä»¶ç³»ç»Ÿé…ç½®\n/system 0 0 755\n/vendor 0 0 755" > out/config/system_fs_config
        
        echo "::group::ğŸ“œ æ„å»ºæ—¥å¿—"
        build_output=$(./make.sh 2>&1 || true)
        echo "$build_output"
        
        if echo "$build_output" | grep -q "sdat2img: failed"; then
          echo "::error::âŒ sdat2imgè½¬æ¢å¤±è´¥"
          exit 1
        fi
        echo "::endgroup::"
        
        if [ ! -f "out/system.img" ]; then
          echo "::warning::âš ï¸ system.imgæœªç”Ÿæˆï¼Œå°è¯•æ‰‹åŠ¨åˆ›å»º"
          
          if [ ! -d "out/system" ]; then
            echo "::error::âŒ out/systemç›®å½•ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»ºé•œåƒ"
            exit 1
          fi
          
          size_kb=$(du -sk out/system/ | cut -f1)
          img_size_kb=$((size_kb * 130 / 100))
          img_size_mb=$((img_size_kb / 1024))
          [ $img_size_mb -lt 512 ] && img_size_mb=512
          
          echo "ğŸ“¦ åˆ›å»º ${img_size_mb}MB é•œåƒ"
          ./bin/mke2fs -t ext4 -L /system -b 4096 -m 0 out/system.img ${img_size_mb}M
          ./bin/e2fsdroid -e -T 1230768000 -C out/config/system_fs_config -S out/config/system_file_contexts -f out/system/ -a /system out/system.img
          
          if [ ! -f "out/system.img" ]; then
            echo "::error::âŒ æ— æ³•ç”Ÿæˆsystem.img"
            exit 1
          fi
        fi
        
        mkdir -p SGSI
        mv out/system.img SGSI/
        cd ../..
        
    - name: "ğŸ“¦ æ‰“åŒ…ç³»ç»Ÿè¡¥ä¸"
      run: |
        for i in 1 2 3; do
          if [ -d "Patch/Patch$i" ]; then
            echo "ğŸ“¦ æ‰“åŒ…è¡¥ä¸åŒ… Patch$i"
            zip -r -0 "Patch$i.zip" "Patch/Patch$i"/*
            mkdir -p SGSI-build-tool/10/SGSI
            mv "Patch$i.zip" SGSI-build-tool/10/SGSI/
          fi
        done

    - name: "ğŸ“¦ åˆ›å»ºæœ€ç»ˆåŒ…"
      run: |
        echo "::group::ğŸ“¦ åˆ›å»ºæœ€ç»ˆåŒ…"
        mkdir -p SGSI-build-tool/10/SGSI
        
        if [ -z "$(ls -A SGSI-build-tool/10/SGSI/* 2>/dev/null)" ]; then
          echo "::error::âŒ SGSIç›®å½•ä¸ºç©ºï¼Œæ— æ³•åˆ›å»ºå‹ç¼©åŒ…"
          exit 1
        fi
        
        pack_name="${{ env.pack_sgsi }}"
        zip -r -0 "$pack_name" SGSI-build-tool/10/SGSI/*
        
        if [ ! -f "$pack_name" ]; then
          echo "::error::âŒ å‹ç¼©åŒ…åˆ›å»ºå¤±è´¥: $pack_name"
          exit 1
        fi
        
        echo "âœ… å‹ç¼©åŒ…åˆ›å»ºæˆåŠŸ! å¤§å°: $(du -sh "$pack_name" | cut -f1)"
        echo "::endgroup::"
        
    - name: "â±ï¸ ç”Ÿæˆæ—¶é—´æˆ³"
      id: timestamp
      run: |
        echo "BUILD_TIME=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV
        echo "time=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT
        
    - name: "ğŸ“¤ å‡†å¤‡ä¸Šä¼ æ–‡ä»¶"
      run: |
        echo "::group::ğŸ“¤ å‡†å¤‡ä¸Šä¼ æ–‡ä»¶"
        pack_name="${{ env.pack_sgsi }}"
        
        if [ ! -f "$pack_name" ]; then
          echo "::error::âŒ æœ€ç»ˆå‹ç¼©åŒ…ä¸å­˜åœ¨: $pack_name"
          exit 1
        fi
        
        mkdir -p upload
        file_size=$(stat -c%s "$pack_name")
        max_size=1900000000
        
        echo "FILE_SIZE=$file_size" >> $GITHUB_ENV
        
        split_needed=false
        
        if [ $file_size -gt $max_size ]; then
          echo "âœ‚ï¸ æ–‡ä»¶è¿‡å¤§ï¼Œè¿›è¡Œåˆ†å‰²..."
          split_needed=true
          split -b 1800m -d "$pack_name" "upload/${pack_name}_part"
        else
          mv -v "$pack_name" upload/
        fi
        
        echo "SPLIT_NEEDED=$split_needed" >> $GITHUB_ENV
        echo "::endgroup::"
        
    - name: "ğŸ” éªŒè¯ä¸Šä¼ æ–‡ä»¶"
      run: |
        echo "::group::ğŸ” éªŒè¯ä¸Šä¼ æ–‡ä»¶"
        if [ ! -d "upload" ] || [ -z "$(ls -A upload)" ]; then
          echo "::error::âŒ ä¸Šä¼ æ–‡ä»¶éªŒè¯å¤±è´¥"
          exit 1
        else
          echo "âœ… ä¸Šä¼ æ–‡ä»¶éªŒè¯é€šè¿‡"
          ls -lh upload
        fi
        echo "::endgroup::"
        
    - name: "ğŸ“ ç”Ÿæˆå‘å¸ƒè¯´æ˜"
      run: |
        # è‡ªåŠ¨æ£€æµ‹ç‰ˆæœ¬ä¿¡æ¯å‡½æ•°
        detect_version() {
          local system_dir="SGSI-build-tool/10/out/system"
          local version_info=""
          
          # æ£€æµ‹MIUIç‰ˆæœ¬
          if [ "${{ env.make_miui }}" = "true" ]; then
            if [ -f "$system_dir/system/build.prop" ]; then
              miui_ver=$(grep -E 'ro.miui.ui.version.name|ro.miui.ui.version.code' $system_dir/system/build.prop | head -1 | cut -d= -f2)
              miui_type=$(grep 'ro.miui.ui.version.type' $system_dir/system/build.prop | cut -d= -f2)
              [ -z "$miui_type" ] && miui_type="ç¨³å®šç‰ˆ"  # é»˜è®¤ä¸ºç¨³å®šç‰ˆ
              android_ver=$(grep 'ro.build.version.release' $system_dir/system/build.prop | cut -d= -f2)
              build_date=$(grep 'ro.build.date' $system_dir/system/build.prop | cut -d= -f2)
              security_patch=$(grep 'ro.build.version.security_patch' $system_dir/system/build.prop | cut -d= -f2)
              
              version_info+="- MIUI$miui_ver [$miui_type] + Android $android_ver\n"
              version_info+="  - æ„å»ºæ—¥æœŸ: $build_date\n"
              version_info+="  - å®‰å…¨è¡¥ä¸: $security_patch\n"
            else
              version_info+="- MIUI [è‡ªåŠ¨æ£€æµ‹å¤±è´¥]\n"
            fi
          fi
          
          # æ£€æµ‹Flymeç‰ˆæœ¬
          if [ "${{ env.make_flyme }}" = "true" ]; then
            if [ -f "$system_dir/system/build.prop" ]; then
              flyme_ver=$(grep 'ro.build.display.id' $system_dir/system/build.prop | cut -d= -f2 | sed 's/Flyme //')
              android_ver=$(grep 'ro.build.version.release' $system_dir/system/build.prop | cut -d= -f2)
              build_date=$(grep 'ro.build.date' $system_dir/system/build.prop | cut -d= -f2)
              security_patch=$(grep 'ro.build.version.security_patch' $system_dir/system/build.prop | cut -d= -f2)
              
              version_info+="- Flyme$flyme_ver + Android $android_ver\n"
              version_info+="  - æ„å»ºæ—¥æœŸ: $build_date\n"
              version_info+="  - å®‰å…¨è¡¥ä¸: $security_patch\n"
            else
              version_info+="- Flyme [è‡ªåŠ¨æ£€æµ‹å¤±è´¥]\n"
            fi
          fi
          
          # æ£€æµ‹ColorOSç‰ˆæœ¬
          if [ "${{ env.make_coloros }}" = "true" ]; then
            if [ -f "$system_dir/system/build.prop" ]; then
              coloros_ver=$(grep 'ro.rom.version' $system_dir/system/build.prop | cut -d= -f2)
              android_ver=$(grep 'ro.build.version.release' $system_dir/system/build.prop | cut -d= -f2)
              build_date=$(grep 'ro.build.date' $system_dir/system/build.prop | cut -d= -f2)
              security_patch=$(grep 'ro.build.version.security_patch' $system_dir/system/build.prop | cut -d= -f2)
              
              version_info+="- ColorOS$coloros_ver + Android $android_ver\n"
              version_info+="  - æ„å»ºæ—¥æœŸ: $build_date\n"
              version_info+="  - å®‰å…¨è¡¥ä¸: $security_patch\n"
            else
              version_info+="- ColorOS [è‡ªåŠ¨æ£€æµ‹å¤±è´¥]\n"
            fi
          fi
          
          # æ£€æµ‹HydrogenOSç‰ˆæœ¬
          if [ "${{ env.make_h2os }}" = "true" ]; then
            if [ -f "$system_dir/system/build.prop" ]; then
              h2os_ver=$(grep 'ro.rom.version' $system_dir/system/build.prop | cut -d= -f2)
              android_ver=$(grep 'ro.build.version.release' $system_dir/system/build.prop | cut -d= -f2)
              build_date=$(grep 'ro.build.date' $system_dir/system/build.prop | cut -d= -f2)
              security_patch=$(grep 'ro.build.version.security_patch' $system_dir/system/build.prop | cut -d= -f2)
              
              version_info+="- HydrogenOS$h2os_ver + Android $android_ver\n"
              version_info+="  - æ„å»ºæ—¥æœŸ: $build_date\n"
              version_info+="  - å®‰å…¨è¡¥ä¸: $security_patch\n"
            else
              version_info+="- HydrogenOS [è‡ªåŠ¨æ£€æµ‹å¤±è´¥]\n"
            fi
          fi
          
          # æ£€æµ‹SmartisanOSç‰ˆæœ¬
          if [ "${{ env.make_smartisanos }}" = "true" ]; then
            if [ -f "$system_dir/system/build.prop" ]; then
              smartisan_ver=$(grep 'ro.smartisan.version' $system_dir/system/build.prop | cut -d= -f2)
              android_ver=$(grep 'ro.build.version.release' $system_dir/system/build.prop | cut -d= -f2)
              build_date=$(grep 'ro.build.date' $system_dir/system/build.prop | cut -d= -f2)
              security_patch=$(grep 'ro.build.version.security_patch' $system_dir/system/build.prop | cut -d= -f2)
              
              version_info+="- SmartisanOS$smartisan_ver + Android $android_ver\n"
              version_info+="  - æ„å»ºæ—¥æœŸ: $build_date\n"
              version_info+="  - å®‰å…¨è¡¥ä¸: $security_patch\n"
            else
              version_info+="- SmartisanOS [è‡ªåŠ¨æ£€æµ‹å¤±è´¥]\n"
            fi
          fi
          
          # æ£€æµ‹ZUIç‰ˆæœ¬
          if [ "${{ env.make_zui }}" = "true" ]; then
            if [ -f "$system_dir/system/build.prop" ]; then
              zui_ver=$(grep 'ro.zui.version' $system_dir/system/build.prop | cut -d= -f2)
              android_ver=$(grep 'ro.build.version.release' $system_dir/system/build.prop | cut -d= -f2)
              build_date=$(grep 'ro.build.date' $system_dir/system/build.prop | cut -d= -f2)
              security_patch=$(grep 'ro.build.version.security_patch' $system_dir/system/build.prop | cut -d= -f2)
              
              version_info+="- ZUI$zui_ver + Android $android_ver\n"
              version_info+="  - æ„å»ºæ—¥æœŸ: $build_date\n"
              version_info+="  - å®‰å…¨è¡¥ä¸: $security_patch\n"
            else
              version_info+="- ZUI [è‡ªåŠ¨æ£€æµ‹å¤±è´¥]\n"
            fi
          fi
          
          # å¦‚æœæ²¡æœ‰é…ç½®ä»»ä½•ç³»ç»Ÿï¼Œæ·»åŠ æç¤º
          if [ -z "$version_info" ]; then
            version_info="âš ï¸ æœªé…ç½®ä»»ä½•å‚å•†ç³»ç»Ÿé•œåƒç”Ÿæˆ"
          fi
          
          echo -e "$version_info"
        }
        
        # åˆ›å»ºå‘å¸ƒè¯´æ˜æ–‡ä»¶
        echo "## ğŸŒŸ SGSIé•œåƒæ„å»ºæˆåŠŸ" > release_body.md
        echo "" >> release_body.md
        echo "### ğŸ“‹ æ„å»ºè¯¦æƒ…" >> release_body.md
        echo "- **æºROM**: ${{ env.rom_name }}" >> release_body.md
        echo "- **æ„å»ºæ—¶é—´**: ${{ env.BUILD_TIME }}" >> release_body.md
        echo "- **æ–‡ä»¶å¤§å°**: $(numfmt --to=iec ${{ env.FILE_SIZE }})" >> release_body.md
        echo "- **æ„å»ºæ—¥å¿—**: [${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}]" >> release_body.md
        echo "" >> release_body.md
        echo "### âš™ï¸ ç³»ç»Ÿé…ç½®" >> release_body.md
        detect_version >> release_body.md
        echo "" >> release_body.md
        echo "> **æ³¨æ„**: è¯·ç¡®ä¿ä¸‹è½½æ‰€æœ‰æ–‡ä»¶ï¼ˆå¦‚æœè¢«åˆ†å‰²ï¼‰" >> release_body.md
        
        echo "ç”Ÿæˆå‘å¸ƒè¯´æ˜:"
        cat release_body.md
        
    - name: "ğŸš€ å‘å¸ƒSGSIæˆå“"
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        files: upload/*
        tag_name: "sgs-img-${{ env.BUILD_TIME }}"
        body_file: release_body.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
