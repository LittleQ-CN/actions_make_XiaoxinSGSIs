name: build_XiaoxinSGSIs_old

on:
  watch:
    types: [started]
    
jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: "ğŸš€ Checkout Code (æ£€å‡ºä»£ç )"
        uses: actions/checkout@v4
       
      - name: "ğŸ§¹ Clean Environment (æ¸…ç†ç¯å¢ƒ)"
        run: |
          docker rmi -f $(docker images -q) || true
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d
          sudo apt-get purge -y azure-cli ghc* zulu* llvm* firefox google* dotnet* openjdk* mysql* php*
          sudo apt-get autoremove -y --purge
          sudo apt-get clean
          df -h
       
      - name: "âš™ï¸ Get Config Vars (è·å–é…ç½®å˜é‡)"
        id: var
        run: |
          config=$(jq -r 'to_entries[] | "\(.key)=\(.value)"' sgsi.json)
          while IFS= read -r line; do
            echo "$line" >> $GITHUB_OUTPUT
          done <<< "$config"
           
      - name: "ğŸ“¦ Install Tools (å®‰è£…å·¥å…·)"
        run: |
          sudo apt-get update
          sudo apt-get install -y axel curl wget pv aria2 jq
          echo "max-connections=32" | sudo tee -a /etc/axelrc
          echo "âœ… Tools installed (å·¥å…·å®‰è£…å®Œæˆ)"
           
      - name: "â¬‡ï¸ Download Build Tools (ä¸‹è½½æ„å»ºå·¥å…·)"
        run: |
          max_retries=3
          tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar"
          
          for ((i=1; i<=max_retries; i++)); do
            [[ -f SGSI-build-tool.tar ]] && rm SGSI-build-tool.tar
            
            if aria2c -x 16 -s 16 -k 1M -o "SGSI-build-tool.tar" "$tool_url"; then
              echo "âœ… Download success (ä¸‹è½½æˆåŠŸ)"; break
            elif axel -n 32 -U "Mozilla/5.0" -o "SGSI-build-tool.tar" "$tool_url"; then
              echo "âœ… Download success (ä¸‹è½½æˆåŠŸ)"; break
            elif curl -# -fL -o "SGSI-build-tool.tar" "$tool_url"; then
              echo "âœ… Download success (ä¸‹è½½æˆåŠŸ)"; break
            elif wget --show-progress -O "SGSI-build-tool.tar" "$tool_url"; then
              echo "âœ… Download success (ä¸‹è½½æˆåŠŸ)"; break
            else
              echo "âŒ Attempt $i failed (å°è¯• $i å¤±è´¥)"
              [[ $i -lt max_retries ]] && sleep 10
            fi
          done
          
          [[ ! -f SGSI-build-tool.tar ]] && { echo "::error::âŒ All downloads failed (å…¨éƒ¨ä¸‹è½½å¤±è´¥)"; exit 1; }
          
      - name: "ğŸ—ï¸ Setup Env (è®¾ç½®ç¯å¢ƒ)"
        run: |
          sudo tar -xf SGSI-build-tool.tar
          sudo mv bin/setup.sh SGSI-build-tool/10/
          cd SGSI-build-tool/10 && sudo bash setup.sh
          echo "âœ… Environment ready (ç¯å¢ƒå°±ç»ª)"
           
      - name: "ğŸ’¾ Download ROM (ä¸‹è½½ROM)"
        run: |
          rom_path="SGSI-build-tool/10/tmp/${{ steps.var.outputs.rom_name }}"
          rom_url="${{ steps.var.outputs.rom_url }}"
          
          for ((i=1; i<=5; i++)); do
            if aria2c -x 32 -s 32 -k 1M -d "$(dirname "$rom_path")" -o "$(basename "$rom_path")" "$rom_url"; then
              echo "âœ… ROM downloaded (ROMä¸‹è½½å®Œæˆ)"; break
            elif axel -n 32 -U "Mozilla/5.0" -o "$rom_path" "$rom_url"; then
              echo "âœ… ROM downloaded (ROMä¸‹è½½å®Œæˆ)"; break
            else
              echo "âŒ Attempt $i failed (å°è¯• $i å¤±è´¥)"
              [[ $i -lt 5 ]] && sleep 10
            fi
          done
          
          [[ ! -f "$rom_path" ]] && { echo "::error::âŒ ROM download failed (ROMä¸‹è½½å¤±è´¥)"; exit 1; }
          echo "ğŸ“¦ Size: $(du -h "$rom_path" | cut -f1) (æ–‡ä»¶å¤§å°)"

      - name: "âš™ï¸ Configure ROM (é…ç½®ROM)"
        id: configure_rom
        run: |
          # æ¸…ç†æ—§é…ç½®
          rm -f SGSI-build-tool/10/fixbug/fixbug.sh
          
          # ç¡®å®šROMç±»å‹
          rom_type=""
          [[ "${{ steps.var.outputs.make_super }}" = "true" ]] && \
            sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' SGSI-build-tool/10/make.sh
          
          # æ£€æµ‹ROMç±»å‹
          if [[ "${{ steps.var.outputs.make_miui }}" = "true" ]]; then rom_type="MIUI"; fi
          if [[ "${{ steps.var.outputs.make_flyme }}" = "true" ]]; then rom_type="Flyme"; fi
          if [[ "${{ steps.var.outputs.make_coloros }}" = "true" ]]; then rom_type="ColorOS"; fi
          if [[ "${{ steps.var.outputs.make_h2os }}" = "true" ]]; then rom_type="H2OS"; fi
          if [[ "${{ steps.var.outputs.make_smartisanos }}" = "true" ]]; then rom_type="SmartisanOS"; fi
          if [[ "${{ steps.var.outputs.make_zui }}" = "true" ]]; then rom_type="ZUI"; fi
          
          # é»˜è®¤ä½¿ç”¨é€šç”¨ç±»å‹
          [[ -z "$rom_type" ]] && rom_type="Generic"
          
          # ColorOSç‰¹æ®Šè§£å¯†
          if [[ "$rom_type" = "ColorOS" ]]; then
            sudo python3 SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py "SGSI-build-tool/10/tmp/${{ steps.var.outputs.rom_name }}"
            sudo rm -f "SGSI-build-tool/10/tmp/${{ steps.var.outputs.rom_name }}"
          fi
          
          # åº”ç”¨é…ç½®è„šæœ¬
          [[ -f "fix/${rom_type}.sh" ]] && \
            cp "fix/${rom_type}.sh" SGSI-build-tool/10/fixbug/fixbug.sh && \
            echo "âœ… $rom_type configured (${rom_type}é…ç½®å®Œæˆ)"
            
          # è¾“å‡ºROMç±»å‹
          echo "rom_type=$rom_type" >> $GITHUB_OUTPUT
          
      - name: "ğŸ› ï¸ Build SGSI (æ„å»ºSGSI)"
        run: |
          cd SGSI-build-tool/10
          sudo mv ../make/*.sh ../bin/{mke2fs,e2fsdroid} .
          sudo bash make.sh
          echo "ğŸ‰ Build completed (æ„å»ºå®Œæˆ)"
             
      - name: "ğŸ“¦ Package Output (æ‰“åŒ…è¾“å‡º)"
        run: |
          # æ‰“åŒ…è¡¥ä¸
          cd SGSI-build-tool/10
          for dir in Patch/Patch{1..3}; do
            zip -r "${dir##*/}.zip" "$dir"/*
            mv "${dir##*/}.zip" SGSI/
          done
          
          # ä¸»æ‰“åŒ…
          zip -r "${{ steps.var.outputs.pack_sgsi }}" SGSI/*
          
          # åˆ†å·å¤„ç†
          mkdir -p upload
          file_size=$(stat -c%s "${{ steps.var.outputs.pack_sgsi }}")
          [[ $file_size -gt 2097152000 ]] && \
            split -b 1024m "${{ steps.var.outputs.pack_sgsi }}" "upload/${{ steps.var.outputs.pack_sgsi }}_" || \
            mv "${{ steps.var.outputs.pack_sgsi }}" upload/
            
          echo "ğŸ“ Upload contents (ä¸Šä¼ å†…å®¹):"
          ls -lh upload
          
      - name: "ğŸ·ï¸ Generate Release Tag (ç”Ÿæˆå‘å¸ƒæ ‡ç­¾)"
        id: release_tag
        run: |
          # è·å–å½“å‰æ—¥æœŸ
          current_date=$(date +"%Y%m%d")
          # ç»„åˆæ ‡ç­¾æ ¼å¼: æ—¥æœŸ_ç³»ç»Ÿç‰ˆæœ¬ (å¦‚: 20240530_MIUI11)
          release_tag="${current_date}_${{ steps.configure_rom.outputs.rom_type }}"
          echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
          echo "Generated release tag: $release_tag (ç”Ÿæˆçš„å‘å¸ƒæ ‡ç­¾: $release_tag)"
             
      - name: "ğŸš€ Upload Artifacts (ä¸Šä¼ äº§ç‰©)"
        uses: ncipollo/release-action@v1.11.0
        with:
          artifacts: upload/*
          name: xiaoxinSGSI-ab-Android10-unpack
          tag: ${{ steps.release_tag.outputs.release_tag }}  # ä½¿ç”¨ç”Ÿæˆçš„æ—¥æœŸ_ç³»ç»Ÿç‰ˆæœ¬æ ‡ç­¾
          token: ${{ secrets.GITHUB_TOKEN }}
