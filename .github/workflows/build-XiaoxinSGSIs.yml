name: build_XiaoxinSGSIs_old

on:
  watch:
    types: [started]
    
jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: "ðŸš€ Checkout Code (æ£€å‡ºä»£ç )"
        uses: actions/checkout@v4
       
      - name: "ðŸ§¹ Clean Up Environment (æ¸…ç†çŽ¯å¢ƒ)"
        run: |
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php
          sudo -E apt-get -y purge azure-cli zulu* hhvm llvm* firefox dotnet* powershell
          sudo -E apt-get update
          sudo -E apt-get -y autoremove --purge
          df -h
       
      - name: "âš™ï¸ Get Configuration Variables (èŽ·å–é…ç½®å˜é‡)"
        run: |
          {
            echo "rom_url=$(jq -r '.rom_url' sgsi.json)"
            echo "rom_name=$(jq -r '.rom_name' sgsi.json)"
            echo "pack_sgsi=$(jq -r '.pack_sgsi' sgsi.json)"
            echo "make_miui=$(jq -r '.make_miui' sgsi.json)"
            echo "make_flyme=$(jq -r '.make_flyme' sgsi.json)"
            echo "make_coloros=$(jq -r '.make_coloros' sgsi.json)"
            echo "make_h2os=$(jq -r '.make_h2os' sgsi.json)"
            echo "make_smartisanos=$(jq -r '.make_smartisanos' sgsi.json)"
            echo "make_zui=$(jq -r '.make_zui' sgsi.json)"
            echo "make_super=$(jq -r '.make_super' sgsi.json)"
          } >> $GITHUB_OUTPUT
        id: var
           
      - name: "ðŸ“¦ Install Essential Tools (å®‰è£…åŸºç¡€å·¥å…·)"
        run: |
          sudo apt-get update
          sudo apt-get install -y aria2 curl jq brotli android-sdk-libsparse-utils
          echo "âœ… åŸºç¡€å·¥å…·å®‰è£…å®Œæˆ"
          
      - name: "â¬‡ï¸ Download Build Tools (ä¸‹è½½æž„å»ºå·¥å…·)"
        run: |
          tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v1.9/SGSI-build-tool.tar"
          filename="SGSI-build-tool.tar"
          
          echo "ðŸ”§ å¼€å§‹ä¸‹è½½æž„å»ºå·¥å…·..."
          max_retries=5
          retry_delay=5
          
          for i in $(seq 1 $max_retries); do
            if curl -# -fL -o "$filename" "$tool_url"; then
              echo "âœ… ä¸‹è½½æˆåŠŸ"
              break
            else
              echo "âŒ ä¸‹è½½å¤±è´¥ (å°è¯• $i/$max_retries)"
              if [ $i -lt $max_retries ]; then
                echo "ðŸ”„ ${retry_delay}ç§’åŽé‡è¯•..."
                sleep $retry_delay
              else
                echo "::error::âŒ æž„å»ºå·¥å…·ä¸‹è½½å¤±è´¥"
                exit 1
              fi
            fi
          done
          
      - name: "ðŸ—ï¸ Initialize Environment (åˆå§‹åŒ–çŽ¯å¢ƒ)"
        run: |
          echo "ðŸ“‚ è§£åŽ‹æž„å»ºå·¥å…·..."
          sudo tar -xf SGSI-build-tool.tar
          
          echo "ðŸ”„ å‡†å¤‡è¿è¡ŒçŽ¯å¢ƒè®¾ç½®è„šæœ¬..."
          if [[ -f "SGSI-build-tool/10/setup.sh" ]]; then
            echo "ðŸ”§ è®¾ç½®setup.shæ‰§è¡Œæƒé™..."
            sudo chmod +x SGSI-build-tool/10/setup.sh
            
            echo "ðŸ”„ è¿è¡ŒçŽ¯å¢ƒè®¾ç½®è„šæœ¬..."
            cd SGSI-build-tool/10
            sudo bash setup.sh || { echo "::warning::âš ï¸ å®‰è£…è„šæœ¬è¿”å›žéžé›¶çŠ¶æ€ï¼Œä½†ç»§ç»­æ‰§è¡Œ"; }
            cd ../..
          else
            echo "::error::âŒ æœªæ‰¾åˆ°setup.shè„šæœ¬ï¼"
            exit 1
          fi
          
          echo "âœ… çŽ¯å¢ƒåˆå§‹åŒ–å®Œæˆ"
          
      - name: "ðŸ”§ Fix Architecture Issues (ä¿®å¤æž¶æž„é—®é¢˜)"
        run: |
          cd SGSI-build-tool/10
          
          echo "ðŸ› ï¸ ä¿®å¤äºŒè¿›åˆ¶å…¼å®¹æ€§..."
          ln -sf $(which brotli) bin/brotli
          ln -sf $(which simg2img) bin/simg2img
          ln -sf $(which img2simg) bin/img2simg
          ln -sf $(which mke2fs) bin/mke2fs
          ln -sf $(which e2fsdroid) bin/e2fsdroid
          
          echo "âœ… å·²ä¿®å¤äºŒè¿›åˆ¶å·¥å…·å…¼å®¹æ€§é—®é¢˜"
          cd ../..

      - name: "ðŸ’¾ Download ROM File (ä¸‹è½½ROMæ–‡ä»¶)"
        run: |
          rom_path="SGSI-build-tool/10/tmp/${{ steps.var.outputs.rom_name }}"
          rom_url="${{ steps.var.outputs.rom_url }}"
          filename="${{ steps.var.outputs.rom_name }}"
          
          echo "ðŸš€ å¼€å§‹ä¸‹è½½ROM: $filename"
          max_retries=5
          retry_delay=10
          
          for i in $(seq 1 $max_retries); do
            if command -v aria2c &> /dev/null; then
              echo "âš¡ ä½¿ç”¨aria2ä¸‹è½½ [$filename] (15çº¿ç¨‹)"
              if aria2c -x 15 -s 15 -k 1M -d "$(dirname "$rom_path")" -o "$(basename "$rom_path")" "$rom_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              else
                echo "âŒ aria2ä¸‹è½½å¤±è´¥ (å°è¯• $i/$max_retries)"
              fi
            fi
            
            if command -v curl &> /dev/null; then
              echo "âš¡ ä½¿ç”¨curlä¸‹è½½ [$filename] (å¸¦æ–­ç‚¹ç»­ä¼ )"
              if curl -# -fL -C - -o "$rom_path" "$rom_url"; then
                echo "âœ… ä¸‹è½½æˆåŠŸ"
                break
              else
                echo "âŒ curlä¸‹è½½å¤±è´¥ (å°è¯• $i/$max_retries)"
              fi
            fi
            
            if [ $i -lt $max_retries ]; then
              echo "ðŸ”„ ${retry_delay}ç§’åŽé‡è¯•..."
              sleep $retry_delay
            else
              echo "::error::âŒ ROMä¸‹è½½å¤±è´¥"
              exit 1
            fi
          done
          
          echo -e "\nðŸŽ‰ ä¸‹è½½å®Œæˆ"
          echo "ðŸ“¦ æ–‡ä»¶å¤§å°: $(du -h "$rom_path" | cut -f1)"

      - name: "âš™ï¸ Configure ROM Specific Settings (é…ç½®ROMç‰¹å®šè®¾ç½®)"
        run: |
          echo "å¼€å§‹é…ç½®ROMç‰¹å®šè®¾ç½®..."
          
          rom_type="Generic"
          if [ "${{ steps.var.outputs.make_miui }}" = "true" ]; then rom_type="MIUI"; fi
          if [ "${{ steps.var.outputs.make_flyme }}" = "true" ]; then rom_type="Flyme"; fi
          if [ "${{ steps.var.outputs.make_coloros }}" = "true" ]; then rom_type="ColorOS"; fi
          if [ "${{ steps.var.outputs.make_h2os }}" = "true" ]; then rom_type="H2OS"; fi
          if [ "${{ steps.var.outputs.make_smartisanos }}" = "true" ]; then rom_type="SmartisanOS"; fi
          if [ "${{ steps.var.outputs.make_zui }}" = "true" ]; then rom_type="ZUI"; fi
          
          echo "â„¹ï¸ æ£€æµ‹åˆ°çš„ROMç±»åž‹: $rom_type"
          
          if [ "${{ steps.var.outputs.make_super }}" = "true" ]; then
            echo "é…ç½®Super SGSI..."
            sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' SGSI-build-tool/10/make.sh
            echo "Super SGSIé…ç½®å®Œæˆ"
          fi
          
          sudo rm -f SGSI-build-tool/10/fixbug/fixbug.sh
          
          if [ "$rom_type" = "ColorOS" ]; then
            echo "è§£å¯†ColorOS OZIPåŒ…..."
            sudo python3 SGSI-build-tool/10/oppo_ozip/ozipdecrypt.py "SGSI-build-tool/10/tmp/${{ steps.var.outputs.rom_name }}"
            sudo rm -f "SGSI-build-tool/10/tmp/${{ steps.var.outputs.rom_name }}"
            echo "ColorOS ROMè§£å¯†å®Œæˆ"
          fi
          
          if [[ -f "fix/${rom_type}.sh" ]]; then
            echo "åº”ç”¨$rom_typeé…ç½®è„šæœ¬..."
            cp "fix/${rom_type}.sh" SGSI-build-tool/10/fixbug/fixbug.sh
            echo "$rom_typeé…ç½®å®Œæˆ"
          else
            echo "âš ï¸ æ‰¾ä¸åˆ°$rom_typeé…ç½®è„šæœ¬ï¼Œä½¿ç”¨é€šç”¨é…ç½®"
          fi
            
          echo "ROMç‰¹å®šè®¾ç½®é…ç½®å®Œæˆ"
          
      - name: "ðŸ”§ Fix Script Errors (ä¿®å¤è„šæœ¬é”™è¯¯)"
        run: |
          cd SGSI-build-tool/10
          
          echo "ä¿®å¤SGSI.shè„šæœ¬é”™è¯¯..."
          sed -i -e 's/\[ \]/\[ -n /g' \
                 -e 's/\] =/ \]/g' \
                 -e 's/==/=/g' SGSI.sh
                 
          echo "âœ… å·²ä¿®å¤è„šæœ¬è¯­æ³•é”™è¯¯"
          cd ../..
          
      - name: "ðŸ› ï¸ Prepare Build Files (å‡†å¤‡æž„å»ºæ–‡ä»¶)"
        run: |
          echo "å‡†å¤‡æž„å»ºè„šæœ¬..."
          
          if [[ -d "make" ]]; then
            echo "ç§»åŠ¨æž„å»ºè„šæœ¬..."
            cp make/*.sh SGSI-build-tool/10/
          fi
          
          if [[ -d "bin" ]]; then
            echo "ç§»åŠ¨äºŒè¿›åˆ¶å·¥å…·..."
            cp bin/mke2fs bin/e2fsdroid SGSI-build-tool/10/bin/
          fi
          
          cd SGSI-build-tool/10
          ln -sf $(which brotli) bin/brotli
          ln -sf $(which simg2img) bin/simg2img
          cd ../..
          
          echo "âœ… æž„å»ºæ–‡ä»¶å‡†å¤‡å®Œæˆ"
          
      - name: "ðŸ­ Build SGSI Images (æž„å»ºSGSIé•œåƒ)"
        run: |
          cd SGSI-build-tool/10
          
          echo "ðŸ—ï¸ å¼€å§‹æž„å»ºSGSI..."
          sudo bash make.sh || { echo "::error::âŒ æž„å»ºå¤±è´¥"; exit 1; }
          echo "ðŸŽ‰ SGSIé•œåƒæž„å»ºå®Œæˆ"
           
      - name: "ðŸ“¦ Package Output (æ‰“åŒ…è¾“å‡º)"
        run: |
          cd SGSI-build-tool/10
          
          echo "æ‰“åŒ…SGSIè¾“å‡º..."
          if [[ -d "SGSI" ]]; then
            zip -r "${{ steps.var.outputs.pack_sgsi }}" SGSI/*
          else
            echo "::error::âŒ SGSIç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "å‡†å¤‡ä¸Šä¼ æ–‡ä»¶..."
          mkdir -p upload
          file_size=$(stat -c%s "${{ steps.var.outputs.pack_sgsi }}")
          max_size=2097152000
          
          if [[ $file_size -gt $max_size ]]; then
            echo "âš ï¸ æ–‡ä»¶è¿‡å¤§ ($(numfmt --to=iec $file_size))ï¼Œè¿›è¡Œåˆ†å·æ‰“åŒ…..."
            split -b 1024m -d "${{ steps.var.outputs.pack_sgsi }}" "upload/${{ steps.var.outputs.pack_sgsi }}_"
            rm "${{ steps.var.outputs.pack_sgsi }}"
          else
            mv "${{ steps.var.outputs.pack_sgsi }}" upload/
          fi
          
          echo "ðŸ“ ä¸Šä¼ ç›®å½•å†…å®¹:"
          ls -lh upload
             
      - name: "ðŸ·ï¸ Generate Release Tag (ç”Ÿæˆå‘å¸ƒæ ‡ç­¾)"
        id: release_tag
        run: |
          current_date=$(date +"%Y%m%d")
          rom_type="$(if [ \"${{ steps.var.outputs.make_miui}}\" = \"true\" ]; then echo \"MIUI\"; elif [ \"${{ steps.var.outputs.make_flyme}}\" = \"true\" ]; then echo \"Flyme\"; elif [ \"${{ steps.var.outputs.make_coloros}}\" = \"true\" ]; then echo \"ColorOS\"; elif [ \"${{ steps.var.outputs.make_h2os}}\" = \"true\" ]; then echo \"H2OS\"; elif [ \"${{ steps.var.outputs.make_smartisanos}}\" = \"true\" ]; then echo \"SmartisanOS\"; elif [ \"${{ steps.var.outputs.make_zui}}\" = \"true\" ]; then echo \"ZUI\"; else echo \"Generic\"; fi)"
          release_tag="${current_date}_$rom_type"
          echo "release_tag=$release_tag" >> $GITHUB_OUTPUT
          echo "Generated release tag: $release_tag"
             
      - name: "ðŸš€ Upload Build Artifacts (ä¸Šä¼ æž„å»ºäº§ç‰©)"
        uses: ncipollo/release-action@v1.11.0
        with:
          artifacts: upload/*
          name: xiaoxinSGSI-ab-Android10-unpack
          tag: ${{ steps.release_tag.outputs.release_tag }}
          token: ${{ secrets.GITHUB_TOKEN }}
