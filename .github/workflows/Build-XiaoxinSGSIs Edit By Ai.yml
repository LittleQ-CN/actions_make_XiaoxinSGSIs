name: build_XiaoxinSGSIs_test

on:
  watch:
    types: [started]
    
jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: Checkout
        uses: actions/checkout@main
      
      - name: Clean Up
        run: |
          docker rmi $(docker images -q) || true
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d
          sudo -E apt-get -y purge azure-cli ghc* zulu* hhvm llvm* firefox google* dotnet* powershell openjdk* mysql* php* || true
          sudo -E apt-get update
          sudo -E apt-get -y autoremove --purge
          sudo -E apt-get clean 
      
      - name: Get variables
        id: var
        run: |
          echo "rom_url=$(jq -r '.rom_url' sgsi.json)" >> $GITHUB_OUTPUT
          echo "rom_name=$(jq -r '.rom_name' sgsi.json)" >> $GITHUB_OUTPUT
          echo "pack_sgsi=$(jq -r '.pack_sgsi' sgsi.json)" >> $GITHUB_OUTPUT
          echo "make_miui=$(jq -r '.make_miui' sgsi.json)" >> $GITHUB_OUTPUT
          echo "make_flyme=$(jq -r '.make_flyme' sgsi.json)" >> $GITHUB_OUTPUT
          echo "make_coloros=$(jq -r '.make_coloros' sgsi.json)" >> $GITHUB_OUTPUT
          echo "make_h2os=$(jq -r '.make_h2os' sgsi.json)" >> $GITHUB_OUTPUT
          echo "make_smartisanos=$(jq -r '.make_smartisanos' sgsi.json)" >> $GITHUB_OUTPUT
          echo "make_zui=$(jq -r '.make_zui' sgsi.json)" >> $GITHUB_OUTPUT
          echo "make_super=$(jq -r '.make_super' sgsi.json)" >> $GITHUB_OUTPUT
          echo "upload_transfer=$(jq -r '.upload_transfer' sgsi.json)" >> $GITHUB_OUTPUT
          echo "upload_artifact=$(jq -r '.upload_artifact' sgsi.json)" >> $GITHUB_OUTPUT
          
      - name: Download XiaoxinSGSIs Tools
        run: |
          tool_url="https://github.com/xiaoxindada/SGSI-build-tool/releases/download/v2.1/SGSI-build-tool.tar"
          filename="SGSI-build-tool.tar"
          
          echo "ğŸ”§ Starting build tools download (å¼€å§‹ä¸‹è½½æ„å»ºå·¥å…·)..."
          max_retries=5
          retry_delay=10
          
          for i in $(seq 1 $max_retries); do
            if curl -fL -o "$filename" "$tool_url"; then
              echo "âœ… Download successful (ä¸‹è½½æˆåŠŸ)"
              break
            else
              echo "âŒ Download failed (å°è¯• $i/$max_retries) (ä¸‹è½½å¤±è´¥)"
              if [ $i -eq $max_retries ]; then
                echo "::error::âŒ Build tools download failed (æ„å»ºå·¥å…·ä¸‹è½½å¤±è´¥)"
                exit 1
              fi
              echo "ğŸ”„ Retrying in ${retry_delay}seconds (${retry_delay}ç§’åé‡è¯•)..."
              sleep $retry_delay
            fi
          done
           
      - name: Initialization environment
        run: |
          # è§£å‹å·¥å…·åŒ…
          sudo tar -xf SGSI-build-tool.tar
          
          # æ›¿æ¢setup.sh
          sudo rm -rf SGSI-build-tool/10/setup.sh
          sudo mv bin/setup.sh SGSI-build-tool/10/
          
          cd SGSI-build-tool/10
          
          # è®¾ç½®æ‰§è¡Œæƒé™
          sudo find . -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true
          sudo chmod +x bin/mke2fs bin/e2fsdroid 2>/dev/null || true
          
          # è¿è¡Œç¯å¢ƒè®¾ç½®
          sudo bash setup.sh
           
      - name: Download Rom
        run: |
          echo "ğŸ“¥ Downloading ROM from ${{ steps.var.outputs.rom_url }}"
          cd SGSI-build-tool/10/tmp
          sudo wget -c "${{ steps.var.outputs.rom_url }}" -O "${{ steps.var.outputs.rom_name }}" || exit 1
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ
          if [ ! -f "${{ steps.var.outputs.rom_name }}" ]; then
            echo "âŒ ROMä¸‹è½½å¤±è´¥: ${{ steps.var.outputs.rom_name }}"
            exit 1
          fi
          
          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          file_size=$(sudo stat -c%s "${{ steps.var.outputs.rom_name }}" 2>/dev/null || echo "0")
          echo "ğŸ“¦ ROMæ–‡ä»¶å¤§å°: $file_size å­—èŠ‚"
          
          if [ "$file_size" -lt 1000000 ]; then
            echo "âŒ ä¸‹è½½çš„æ–‡ä»¶å¤ªå°ï¼Œå¯èƒ½ä¸‹è½½å¤±è´¥"
            exit 1
          fi
       
      - name: Build Super SGSI
        if: ${{ steps.var.outputs.make_super == 'true' }}
        run: |
          cd SGSI-build-tool/10
          sudo sed -i 's/SGSI.sh/dynamic_SGSI.sh/g' make.sh
       
      - name: Make MIUI SGSI
        if: ${{ steps.var.outputs.make_miui == 'true' }}
        run: |
          cd SGSI-build-tool/10
          sudo rm -rf fixbug/fixbug.sh
          sudo cp ../../fix/MIUI.sh fixbug/fixbug.sh
          sudo chmod +x fixbug/fixbug.sh
           
      - name: Make Flyme SGSI
        if: ${{ steps.var.outputs.make_flyme == 'true' }}
        run: |
          cd SGSI-build-tool/10
          sudo rm -rf fixbug/fixbug.sh
          sudo cp ../../fix/Flyme.sh fixbug/fixbug.sh
          sudo chmod +x fixbug/fixbug.sh
           
      - name: Make ColorOS SGSI
        if: ${{ steps.var.outputs.make_coloros == 'true' }}
        run: |
          cd SGSI-build-tool/10
          sudo python3 oppo_ozip/ozipdecrypt.py "tmp/${{ steps.var.outputs.rom_name }}"
          sudo rm -rf "tmp/${{ steps.var.outputs.rom_name }}" fixbug/fixbug.sh
          sudo cp ../../fix/ColorOS.sh fixbug/fixbug.sh
          sudo chmod +x fixbug/fixbug.sh
           
      - name: Make H2OS SGSI
        if: ${{ steps.var.outputs.make_h2os == 'true' }}
        run: |
          cd SGSI-build-tool/10
          sudo rm -rf fixbug/fixbug.sh
          sudo cp ../../fix/H2OS.sh fixbug/fixbug.sh
          sudo chmod +x fixbug/fixbug.sh
           
      - name: Make SmartisanOS SGSI
        if: ${{ steps.var.outputs.make_smartisanos == 'true' }}
        run: |
          cd SGSI-build-tool/10
          sudo rm -rf fixbug/fixbug.sh
          sudo cp ../../fix/SmartisanOS.sh fixbug/fixbug.sh
          sudo chmod +x fixbug/fixbug.sh
           
      - name: Make ZUI SGSI
        if: ${{ steps.var.outputs.make_zui == 'true' }}
        run: |
          cd SGSI-build-tool/10
          sudo rm -rf fixbug/fixbug.sh
          sudo cp ../../fix/ZUI.sh fixbug/fixbug.sh
          sudo chmod +x fixbug/fixbug.sh
            
      - name: Generate SGSI
        run: |
          cd SGSI-build-tool/10
          
          # æ£€æŸ¥ROMæ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "tmp/${{ steps.var.outputs.rom_name }}" ]; then
            echo "âŒ ROMæ–‡ä»¶ä¸å­˜åœ¨: tmp/${{ steps.var.outputs.rom_name }}"
            echo "å½“å‰tmpç›®å½•å†…å®¹:"
            sudo ls -la tmp/
            exit 1
          fi
          
          # åªå¤åˆ¶å¿…è¦çš„é…ç½®å’ŒäºŒè¿›åˆ¶æ–‡ä»¶
          sudo cp -r ../../bin/. bin/ 2>/dev/null || echo "binç›®å½•å¤åˆ¶å®Œæˆæˆ–å·²å­˜åœ¨"
          sudo cp -r ../../make/. . 2>/dev/null || echo "makeç›®å½•å¤åˆ¶å®Œæˆæˆ–å·²å­˜åœ¨"
          
          # ç¡®ä¿æ‰€æœ‰è„šæœ¬éƒ½æœ‰æ‰§è¡Œæƒé™
          sudo find . -name "*.sh" -exec chmod +x {} \; 2>/dev/null || true
          sudo chmod +x bin/mke2fs bin/e2fsdroid 2>/dev/null || true
          
          # ä½¿ç”¨éäº¤äº’æ¨¡å¼è¿è¡Œæ„å»º
          echo "ğŸ—ï¸ å¼€å§‹æ„å»ºSGSI..."
          sudo bash make.sh

      - name: Make Patch Module
        run: |
          cd SGSI-build-tool/10
          
          # æ£€æŸ¥outç›®å½•æ˜¯å¦å­˜åœ¨
          if [ ! -d "out" ]; then
            echo "âŒ outç›®å½•ä¸å­˜åœ¨ï¼Œæ„å»ºå¯èƒ½å¤±è´¥"
            exit 1
          fi
          
          # ç¡®ä¿outç›®å½•å­˜åœ¨
          if [ -d "out/vendor" ]; then
            sudo zip -r Patchmod.zip out/vendor/app/* out/vendor/bin/* out/vendor/etc/* out/vendor/lib/* out/vendor/lib64/* out/vendor/overlay/*
            sudo mv Patchmod.zip SGSI/
            echo "âœ… Patchmodåˆ›å»ºæˆåŠŸ"
          else
            echo "::warning::out/vendor directory not found (out/vendorç›®å½•ä¸å­˜åœ¨)"
          fi
           
      - name: Zip Patch  
        run: |
          cd SGSI-build-tool/10
          
          # ç¡®ä¿Patchç›®å½•å­˜åœ¨
          if [ -d "../../Patch" ]; then
            cd ../../Patch
            sudo zip -r Patch1.zip Patch1/*
            sudo zip -r Patch2.zip Patch2/*
            sudo zip -r Patch3.zip Patch3/*
            sudo mv Patch1.zip Patch2.zip Patch3.zip ../SGSI-build-tool/10/SGSI/
            echo "âœ… Patchæ–‡ä»¶åˆ›å»ºæˆåŠŸ"
          else
            echo "::warning::Patch directory not found (Patchç›®å½•ä¸å­˜åœ¨)"
          fi

      - name: 7z SGSI
        run: |
          cd SGSI-build-tool/10
          
          # ç¡®ä¿SGSIç›®å½•å­˜åœ¨
          if [ -d "SGSI" ]; then
            echo "ğŸ“¦ æ‰“åŒ…SGSIæ–‡ä»¶..."
            sudo 7za a -t7z -r "${{ steps.var.outputs.pack_sgsi }}" SGSI/*
            echo "âœ… æ‰“åŒ…å®Œæˆ: ${{ steps.var.outputs.pack_sgsi }}"
            
            # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            echo "ğŸ“Š æ‰“åŒ…æ–‡ä»¶ä¿¡æ¯:"
            sudo ls -lh "${{ steps.var.outputs.pack_sgsi }}"
          else
            echo "::error::SGSI directory not found (SGSIç›®å½•ä¸å­˜åœ¨)"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            sudo ls -la
            exit 1
          fi

      - name: Upload SGSI to WeTransfer
        if: ${{ steps.var.outputs.upload_transfer == 'true' }}
        run: |
          cd SGSI-build-tool/10
          if [ -f "${{ steps.var.outputs.pack_sgsi }}" ]; then
            echo "ğŸ“¤ ä¸Šä¼ åˆ°WeTransfer..."
            curl -sL https://git.io/file-transfer | sh
            sudo chmod +x transfer
            sudo ./transfer wet "${{ steps.var.outputs.pack_sgsi }}"
          else
            echo "âŒ æ‰“åŒ…æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•ä¸Šä¼ "
          fi
          
      - name: Upload SGSI to Artifact
        if: ${{ steps.var.outputs.upload_artifact == 'true' }}
        uses: actions/upload-artifact@v4
        with: 
          name: XiaoxinSGSIs
          path: "SGSI-build-tool/10/${{ steps.var.outputs.pack_sgsi }}"
